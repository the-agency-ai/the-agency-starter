#!/bin/bash
# Create a new workstream directory structure
#
# Usage: ./tools/workstream-create <name> [--verbose]
#
# Creates:
#   claude/workstreams/{name}/
#     - KNOWLEDGE.md
#     - epic001/ (placeholder for past work)
#     - epic002/ (current epic)

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.1.0-20260114-000005"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Defaults
VERBOSE=false

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "workstream-create $TOOL_VERSION"
    exit 0
fi

# Parse arguments
NAME=""
for arg in "$@"; do
    case $arg in
        --verbose)
            VERBOSE=true
            ;;
        *)
            if [[ -z "$NAME" ]]; then
                NAME="$arg"
            fi
            ;;
    esac
done

if [ -z "$NAME" ]; then
  log_error "Missing required argument"
  echo ""
  echo "Usage: ./tools/workstream-create <name> [--verbose]"
  echo ""
  echo "Example: ./tools/workstream-create billing"
  exit 1
fi

DIR="claude/workstreams/$NAME"
TIMESTAMP=$(./tools/now 2>/dev/null || date '+%Y-%m-%d %H:%M')

# Main function
main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    RUN_ID=$(log_start "workstream-create" "agency-tool" "$@" 2>/dev/null) || true
    echo "workstream-create [run: ${RUN_ID:-none}]"

    if [ -d "$DIR" ]; then
      log_error "Workstream '$NAME' already exists at $DIR"
      trap - EXIT
      log_end "$RUN_ID" "failure" 1 0 "Workstream already exists"
      exit 1
    fi

    log_step "Creating workstream: $NAME"
    mkdir -p "$DIR/epic001"
    mkdir -p "$DIR/epic002"

    cat > "$DIR/KNOWLEDGE.md" << EOF
# $NAME Workstream Knowledge

**Created:** $TIMESTAMP

## Overview

[Description of what this workstream covers]

## Key Concepts

[Domain-specific knowledge]

## Patterns

[Common patterns used]

## References

- [Relevant documentation links]
EOF

    echo "Created:"
    verbose_echo "  $DIR/"
    verbose_echo "  $DIR/KNOWLEDGE.md"
    verbose_echo "  $DIR/epic001/"
    verbose_echo "  $DIR/epic002/"
    echo ""
    echo "Next: Create an agent with ./tools/agent-create <name> $NAME"

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Workstream $NAME created"
}

main
