#!/bin/bash
# Regenerate the instructions index at claude/principals/INDEX.md
#
# Usage:
#   instruction-index-update
#
# This tool scans all principals' instructions and generates a summary index.
# Called automatically by instruction-capture and instruction-complete.

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "instruction-index-update" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "instruction-index-update $TOOL_VERSION"
    exit 0
fi

# Help
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  sed -n '2,8p' "$0" | sed 's/^# //' | sed 's/^#//'
  exit 0
fi

# Find repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

PRINCIPALS_DIR="$REPO_ROOT/claude/principals"
INDEX_FILE="$PRINCIPALS_DIR/INDEX.md"

# Get timezone from config or default to UTC
TIMEZONE=$("$SCRIPT_DIR/config" get project.timezone 2>/dev/null || echo "UTC")
TIMESTAMP=$(TZ="$TIMEZONE" date '+%Y-%m-%d %H:%M %Z')

# Start building the index
cat > "$INDEX_FILE" << EOF
# Instructions Index

**Last updated:** $TIMESTAMP

This index is auto-generated by \`./tools/instruction-index-update\`.

## Summary

EOF

# Count by status
ACTIVE_COUNT=0
COMPLETED_COUNT=0
TOTAL_COUNT=0

# Collect all instructions for the table
INSTRUCTIONS=""

for principal_dir in "$PRINCIPALS_DIR"/*/; do
  PRINCIPAL_NAME=$(basename "$principal_dir")
  INSTRUCTIONS_DIR="$principal_dir/instructions"

  if [[ ! -d "$INSTRUCTIONS_DIR" ]]; then
    continue
  fi

  for filepath in "$INSTRUCTIONS_DIR"/INSTR-*.md; do
    if [[ ! -f "$filepath" ]]; then
      continue
    fi

    TOTAL_COUNT=$((TOTAL_COUNT + 1))

    # Extract info
    FILENAME=$(basename "$filepath" .md)
    INSTR_NUM=$(echo "$FILENAME" | grep -oE 'INSTR-[0-9]+' | head -1)

    # Get fields from file
    TITLE=$(grep -m1 "^# INSTR-" "$filepath" 2>/dev/null | sed 's/^# INSTR-[0-9]*: //' || echo "Unknown")
    STATUS=$(grep -m1 "^\*\*Status:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*Status:\*\* //' || echo "Unknown")
    PRINCIPAL=$(grep -m1 "^\*\*Principal:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*Principal:\*\* //' || echo "?")
    TO=$(grep -m1 "^\*\*To:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*To:\*\* //' || echo "?")
    DATE=$(grep -m1 "^\*\*Date:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*Date:\*\* //' || echo "?")
    ORIGIN=$(grep -m1 "^\*\*Origin:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*Origin:\*\* //' || echo "principal-directed")

    # Count by status
    case "$STATUS" in
      Active)    ACTIVE_COUNT=$((ACTIVE_COUNT + 1)); EMOJI="ðŸ”µ" ;;
      Completed) COMPLETED_COUNT=$((COMPLETED_COUNT + 1)); EMOJI="âœ…" ;;
      *)         EMOJI="âšª" ;;
    esac

    # Add to instructions list (will be sorted later)
    INSTRUCTIONS="$INSTRUCTIONS
| $EMOJI $INSTR_NUM | $TITLE | $PRINCIPAL | $TO | $STATUS | $DATE |"

  done
done

# Write summary counts
cat >> "$INDEX_FILE" << EOF
| Status | Count |
|--------|-------|
| ðŸ”µ Active | $ACTIVE_COUNT |
| âœ… Completed | $COMPLETED_COUNT |
| **Total** | **$TOTAL_COUNT** |

## All Instructions

| ID | Title | Principal | To | Status | Date |
|----|-------|-----------|----|---------| -----|
EOF

# Sort instructions by ID (descending - newest first) and append
echo "$INSTRUCTIONS" | grep -v '^$' | sort -t'|' -k2 -r >> "$INDEX_FILE"

# Add footer
cat >> "$INDEX_FILE" << EOF

---

*Use \`./tools/instruction-list\` for filtered views.*
*Use \`./tools/open-instruction INSTR-####\` to open an instruction.*
EOF

echo "Updated: $INDEX_FILE"
echo "  Active: $ACTIVE_COUNT"
echo "  Completed: $COMPLETED_COUNT"
echo "  Total: $TOTAL_COUNT"
