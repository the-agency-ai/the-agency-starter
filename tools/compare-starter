#!/bin/bash
#
# compare-starter - Compare starter source to install
#
# Usage:
#   ./tools/compare-starter                     # Compare source vs test/
#   ./tools/compare-starter --install           # Fresh install then compare
#   ./tools/compare-starter --install-dir DIR   # Compare against specific dir
#   ./tools/compare-starter --verbose           # Show all file comparisons
#   ./tools/compare-starter --fix               # Remove cruft from source
#
# Compares:
#   SOURCE:  the-agency/the-agency-starter/
#   INSTALL: the-agency/test/the-agency-starter/
#
# This tool verifies that install.sh produces an exact copy of the source.
#

set -e

TOOL_VERSION="1.0.0-20260110-000001"

# ============================================================================
# Logging
# ============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

LOG_FILE=""
VERBOSE=false

# Initialize logging
init_logging() {
    local log_dir="${PROJECT_ROOT}/claude/logs"
    mkdir -p "$log_dir"
    LOG_FILE="${log_dir}/compare-starter-$(date +%Y%m%d-%H%M%S).log"
    echo "# compare-starter log - $(date)" > "$LOG_FILE"
    echo "# Source: $SOURCE_DIR" >> "$LOG_FILE"
    echo "# Install: $INSTALL_DIR" >> "$LOG_FILE"
    echo "" >> "$LOG_FILE"
}

log() {
    local level="$1"
    local message="$2"
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    # Write to log file
    if [[ -n "$LOG_FILE" ]]; then
        echo "[$timestamp] [$level] $message" >> "$LOG_FILE"
    fi
}

log_info() {
    log "INFO" "$1"
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    log "WARN" "$1"
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    log "ERROR" "$1"
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    log "STEP" "$1"
    echo -e "${BLUE}[STEP]${NC} $1"
}

log_detail() {
    log "DETAIL" "$1"
    if [[ "$VERBOSE" == "true" ]]; then
        echo -e "${DIM}       $1${NC}"
    fi
}

log_pass() {
    log "PASS" "$1"
    echo -e "  ${GREEN}✓${NC} $1"
}

log_fail() {
    log "FAIL" "$1"
    echo -e "  ${RED}✗${NC} $1"
}

log_diff() {
    log "DIFF" "$1"
    echo -e "  ${YELLOW}≠${NC} $1"
}

# ============================================================================
# Configuration
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SOURCE_DIR="$PROJECT_ROOT/the-agency-starter"
INSTALL_DIR="$PROJECT_ROOT/test/the-agency-starter"

# Options
DO_INSTALL=false
DO_FIX=false

# Exclusions (not compared)
EXCLUDE_PATTERNS=(
    '.git'
    '.DS_Store'
    'node_modules'
    'target'
    '.next'
    'out'
)

# Required files that MUST exist in both
REQUIRED_FILES=(
    "CLAUDE.md"
    "README.md"
    "VERSION"
    "install.sh"
    "tools/myclaude"
    "tools/tag"
    "tools/commit"
    "tools/release"
    "claude/agents/housekeeping/agent.md"
    "apps/agency-bench/package.json"
    "apps/agency-bench/src-tauri/tauri.conf.json"
    "apps/agency-bench/src/app/bench/(apps)/bugbench/page.tsx"
    "apps/agency-bench/src/app/bench/(apps)/docbench/page.tsx"
    "services/agency-service/package.json"
    "services/agency-service/src/index.ts"
    "services/agency-service/src/embedded/bug-service/index.ts"
    "services/agency-service/src/embedded/secret-service/index.ts"
)

# Cruft patterns (should not exist in source)
CRUFT_PATTERNS=(
    '*.db'
    '*.db-wal'
    '*.db-shm'
    '*.log'
    '*.pid'
)

# ============================================================================
# Argument Parsing
# ============================================================================

print_help() {
    cat << 'EOF'
compare-starter - Compare starter source to install

USAGE:
    ./tools/compare-starter [OPTIONS]

OPTIONS:
    --install, -i       Create fresh install before comparing
    --install-dir DIR   Use specific directory for install comparison
    --verbose, -V       Show detailed file-by-file comparison
    --fix, -f           Remove cruft from source directory
    --help, -h          Show this help message
    --version, -v       Show version

EXAMPLES:
    ./tools/compare-starter                    # Basic comparison
    ./tools/compare-starter --install          # Fresh install + compare
    ./tools/compare-starter --verbose          # Detailed output
    ./tools/compare-starter --fix              # Clean source + compare

COMPARISON:
    SOURCE:  the-agency/the-agency-starter/
    INSTALL: the-agency/test/the-agency-starter/

The tool verifies that the install is an exact copy of the source.
EOF
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --version|-v)
                echo "compare-starter $TOOL_VERSION"
                exit 0
                ;;
            --help|-h)
                print_help
                exit 0
                ;;
            --install|-i)
                DO_INSTALL=true
                shift
                ;;
            --install-dir)
                INSTALL_DIR="$2"
                shift 2
                ;;
            --verbose|-V)
                VERBOSE=true
                shift
                ;;
            --fix|-f)
                DO_FIX=true
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                echo "Use --help for usage information"
                exit 1
                ;;
        esac
    done
}

# ============================================================================
# Functions
# ============================================================================

# Build find exclusion arguments
build_find_excludes() {
    local excludes=""
    for pattern in "${EXCLUDE_PATTERNS[@]}"; do
        excludes="$excludes -not -path '*/$pattern/*' -not -name '$pattern'"
    done
    echo "$excludes"
}

# Get file list from directory
get_file_list() {
    local dir="$1"
    local excludes
    excludes=$(build_find_excludes)

    (cd "$dir" && eval "find . -type f $excludes" 2>/dev/null | sort)
}

# Create fresh install
create_install() {
    log_step "Creating fresh install..."

    # Create parent directory
    mkdir -p "$(dirname "$INSTALL_DIR")"

    # Remove existing
    if [[ -d "$INSTALL_DIR" ]]; then
        log_detail "Removing existing: $INSTALL_DIR"
        rm -rf "$INSTALL_DIR"
    fi

    # Copy source to install (simulating install.sh behavior)
    log_detail "Copying source to install directory"
    cp -R "$SOURCE_DIR" "$INSTALL_DIR"

    # Make tools executable (like install.sh does)
    chmod +x "$INSTALL_DIR/tools/"* 2>/dev/null || true

    log_info "Fresh install created at: $INSTALL_DIR"
}

# Remove cruft from source
fix_source() {
    log_step "Cleaning cruft from source..."

    local removed=0

    for pattern in "${CRUFT_PATTERNS[@]}"; do
        while IFS= read -r file; do
            if [[ -n "$file" ]]; then
                log_detail "Removing: $file"
                rm -f "$SOURCE_DIR/$file"
                ((removed++))
            fi
        done < <(cd "$SOURCE_DIR" && find . -name "$pattern" -type f 2>/dev/null)
    done

    if [[ $removed -gt 0 ]]; then
        log_info "Removed $removed cruft file(s) from source"
    else
        log_info "No cruft found in source"
    fi
}

# Check required files exist
check_required_files() {
    log_step "Checking required files..."

    local missing=0

    for file in "${REQUIRED_FILES[@]}"; do
        local in_source=false
        local in_install=false

        [[ -f "$SOURCE_DIR/$file" ]] && in_source=true
        [[ -f "$INSTALL_DIR/$file" ]] && in_install=true

        if $in_source && $in_install; then
            log_pass "$file"
        elif $in_source && ! $in_install; then
            log_fail "$file ${RED}(missing from install)${NC}"
            ((missing++))
        elif ! $in_source && $in_install; then
            log_fail "$file ${RED}(missing from source)${NC}"
            ((missing++))
        else
            log_fail "$file ${RED}(missing from both!)${NC}"
            ((missing++))
        fi
    done

    return $missing
}

# Temp files for comparison (secure)
TEMP_SOURCE_FILES=""
TEMP_INSTALL_FILES=""

cleanup_temp() {
    [[ -n "$TEMP_SOURCE_FILES" && -f "$TEMP_SOURCE_FILES" ]] && rm -f "$TEMP_SOURCE_FILES"
    [[ -n "$TEMP_INSTALL_FILES" && -f "$TEMP_INSTALL_FILES" ]] && rm -f "$TEMP_INSTALL_FILES"
}

trap cleanup_temp EXIT

# Compare file lists
compare_file_lists() {
    log_step "Comparing file lists..."

    local source_files
    local install_files

    source_files=$(get_file_list "$SOURCE_DIR")
    install_files=$(get_file_list "$INSTALL_DIR")

    # Write to secure temp files for comm
    TEMP_SOURCE_FILES=$(mktemp)
    TEMP_INSTALL_FILES=$(mktemp)
    echo "$source_files" > "$TEMP_SOURCE_FILES"
    echo "$install_files" > "$TEMP_INSTALL_FILES"

    # Find differences
    local only_in_source
    local only_in_install

    only_in_source=$(comm -23 "$TEMP_SOURCE_FILES" "$TEMP_INSTALL_FILES")
    only_in_install=$(comm -13 "$TEMP_SOURCE_FILES" "$TEMP_INSTALL_FILES")

    # Count files
    SOURCE_COUNT=$(echo "$source_files" | grep -c . || echo 0)
    INSTALL_COUNT=$(echo "$install_files" | grep -c . || echo 0)
    COMMON_COUNT=$(comm -12 "$TEMP_SOURCE_FILES" "$TEMP_INSTALL_FILES" | grep -c . || echo 0)

    log_info "Source files:  $SOURCE_COUNT"
    log_info "Install files: $INSTALL_COUNT"
    log_info "Common files:  $COMMON_COUNT"

    # Report differences
    ONLY_SOURCE_COUNT=0
    ONLY_INSTALL_COUNT=0

    if [[ -n "$only_in_source" ]]; then
        ONLY_SOURCE_COUNT=$(echo "$only_in_source" | grep -c . || echo 0)
        echo ""
        log_warn "Files only in SOURCE ($ONLY_SOURCE_COUNT):"
        echo "$only_in_source" | head -20 | while read -r f; do
            echo -e "  ${YELLOW}+${NC} $f"
            log "ONLY_SOURCE" "$f"
        done
        [[ $ONLY_SOURCE_COUNT -gt 20 ]] && echo -e "  ${DIM}... and $((ONLY_SOURCE_COUNT - 20)) more${NC}"
    fi

    if [[ -n "$only_in_install" ]]; then
        ONLY_INSTALL_COUNT=$(echo "$only_in_install" | grep -c . || echo 0)
        echo ""
        log_warn "Files only in INSTALL ($ONLY_INSTALL_COUNT):"
        echo "$only_in_install" | head -20 | while read -r f; do
            echo -e "  ${YELLOW}-${NC} $f"
            log "ONLY_INSTALL" "$f"
        done
        [[ $ONLY_INSTALL_COUNT -gt 20 ]] && echo -e "  ${DIM}... and $((ONLY_INSTALL_COUNT - 20)) more${NC}"
    fi

    # Return non-zero if differences found
    [[ $ONLY_SOURCE_COUNT -eq 0 && $ONLY_INSTALL_COUNT -eq 0 ]]
}

# Compare file contents
compare_contents() {
    log_step "Comparing file contents..."

    local diff_count=0
    local checked=0

    # Get common files
    local common_files
    common_files=$(comm -12 "$TEMP_SOURCE_FILES" "$TEMP_INSTALL_FILES")

    while IFS= read -r file; do
        [[ -z "$file" ]] && continue

        ((checked++))

        if ! diff -q "$SOURCE_DIR/$file" "$INSTALL_DIR/$file" > /dev/null 2>&1; then
            log_diff "$file"
            log "CONTENT_DIFF" "$file"
            ((diff_count++))

            # Show first few lines of diff in verbose mode
            if [[ "$VERBOSE" == "true" ]]; then
                diff "$SOURCE_DIR/$file" "$INSTALL_DIR/$file" 2>/dev/null | head -5 | while read -r line; do
                    echo -e "       ${DIM}$line${NC}"
                done
            fi
        else
            log_detail "= $file"
        fi
    done <<< "$common_files"

    log_info "Checked $checked files, $diff_count differ"

    DIFF_COUNT=$diff_count
    return $diff_count
}

# Print summary
print_summary() {
    local errors=$1

    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}Summary${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "  Source:       $SOURCE_DIR"
    echo "  Install:      $INSTALL_DIR"
    echo ""
    echo "  Files in source:     $SOURCE_COUNT"
    echo "  Files in install:    $INSTALL_COUNT"
    echo "  Files in common:     $COMMON_COUNT"
    echo "  Only in source:      $ONLY_SOURCE_COUNT"
    echo "  Only in install:     $ONLY_INSTALL_COUNT"
    echo "  Content differs:     $DIFF_COUNT"
    echo ""

    if [[ -n "$LOG_FILE" ]]; then
        echo -e "  Log: ${DIM}$LOG_FILE${NC}"
        echo ""
    fi

    if [[ $errors -eq 0 ]]; then
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${GREEN}  COMPARISON PASSED - Source and Install are identical${NC}"
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    else
        echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${RED}  COMPARISON FAILED - $errors difference(s) found${NC}"
        echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    fi
}

# ============================================================================
# Main
# ============================================================================

main() {
    parse_args "$@"

    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  compare-starter $TOOL_VERSION${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Validate directories
    if [[ ! -d "$SOURCE_DIR" ]]; then
        log_error "Source directory not found: $SOURCE_DIR"
        exit 1
    fi

    # Initialize logging
    init_logging
    log "INFO" "Starting comparison"
    log "INFO" "Options: install=$DO_INSTALL fix=$DO_FIX verbose=$VERBOSE"

    # Fix source if requested
    if [[ "$DO_FIX" == "true" ]]; then
        fix_source
        echo ""
    fi

    # Create fresh install if requested
    if [[ "$DO_INSTALL" == "true" ]]; then
        create_install
        echo ""
    fi

    # Check install directory exists
    if [[ ! -d "$INSTALL_DIR" ]]; then
        log_error "Install directory not found: $INSTALL_DIR"
        echo ""
        echo "Run with --install to create a fresh installation:"
        echo "  ./tools/compare-starter --install"
        exit 1
    fi

    echo "Comparing:"
    echo -e "  ${CYAN}SOURCE:${NC}  $SOURCE_DIR"
    echo -e "  ${CYAN}INSTALL:${NC} $INSTALL_DIR"
    echo ""

    # Track errors
    local errors=0

    # Initialize counters
    SOURCE_COUNT=0
    INSTALL_COUNT=0
    COMMON_COUNT=0
    ONLY_SOURCE_COUNT=0
    ONLY_INSTALL_COUNT=0
    DIFF_COUNT=0

    # Run checks
    check_required_files || ((errors += $?))
    echo ""

    compare_file_lists || ((errors++))
    echo ""

    compare_contents || ((errors += $?))

    # Print summary
    print_summary $errors

    log "INFO" "Comparison complete. Errors: $errors"

    exit $errors
}

main "$@"
