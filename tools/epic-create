#!/bin/bash
# Create a new epic directory
#
# Usage: ./tools/epic-create <number> [--verbose]
#
# Creates:
#   claude/epics/epic{number}/
#     - feedback/
#   Also creates epic{number}/ in all workstreams

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.1.0-20260114-000007"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Defaults
VERBOSE=false

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "epic-create $TOOL_VERSION"
    exit 0
fi

# Find repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_ROOT"

# Parse arguments
NUM=""
for arg in "$@"; do
    case $arg in
        --verbose)
            VERBOSE=true
            ;;
        *)
            if [[ -z "$NUM" ]]; then
                NUM="$arg"
            fi
            ;;
    esac
done

if [ -z "$NUM" ]; then
  log_error "Missing required argument"
  echo ""
  echo "Usage: ./tools/epic-create <number> [--verbose]"
  echo ""
  echo "Example: ./tools/epic-create 003"
  exit 1
fi

# Pad to 3 digits
EPIC=$(printf "epic%03d" "$NUM")
DIR="claude/epics/$EPIC"

# Get timezone from config or default to UTC
TIMEZONE=$("$SCRIPT_DIR/config" get project.timezone 2>/dev/null || echo "UTC")
TIMESTAMP=$(TZ="$TIMEZONE" date '+%Y-%m-%d %H:%M %Z')

# Main function
main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    RUN_ID=$(log_start "epic-create" "agency-tool" "$@" 2>/dev/null) || true
    echo "epic-create [run: ${RUN_ID:-none}]"

    if [ -d "$DIR" ]; then
      log_error "Epic '$EPIC' already exists at $DIR"
      trap - EXIT
      log_end "$RUN_ID" "failure" 1 0 "Epic already exists"
      exit 1
    fi

    log_step "Creating epic: $EPIC"

    # Create epic directory
    mkdir -p "$DIR/feedback"

    cat > "$DIR/${EPIC}-plan.md" << EOF
# $EPIC Plan

**Created:** $TIMESTAMP
**Status:** Draft

## Overview

[Epic description]

## Goals

1. [Goal 1]
2. [Goal 2]

## Scope

### In Scope

- [Item 1]

### Out of Scope

- [Item 1]

## Schedule

| Day | Workstream | Sprint | Task |
|-----|------------|--------|------|
| 1   |            |        |      |

## Success Criteria

- [ ] [Criterion 1]
EOF

    echo "Created: $DIR/"
    verbose_echo "  - ${EPIC}-plan.md"
    verbose_echo "  - feedback/"

    # Create epic directory in all workstreams
    verbose_echo ""
    verbose_echo "Adding $EPIC/ to workstreams:"
    for ws in claude/workstreams/*/; do
      if [ -d "$ws" ]; then
        wsname=$(basename "$ws")
        if [ ! -d "$ws$EPIC" ]; then
          mkdir -p "$ws$EPIC"
          verbose_echo "  - $ws$EPIC/"
        fi
      fi
    done

    echo ""
    echo "Edit plan: $DIR/${EPIC}-plan.md"

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Epic $EPIC created"
}

main
