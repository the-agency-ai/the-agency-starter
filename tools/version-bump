#!/bin/bash
#
# version-bump - Increment build number with date prefix
#
# Usage:
#   ./tools/version-bump           # Increment build number
#   ./tools/version-bump --show    # Show current version
#
# Version format: YYYY-MM-DD-BUILDNUMBER
# Example: 2026-01-09-000042
# Build numbers have 6-digit leading zeros.
#
# Build number increments continuously across days.

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "version-bump" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "version-bump $TOOL_VERSION"
    exit 0
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
VERSION_FILE="$PROJECT_ROOT/VERSION"
CHANGELOG_FILE="$PROJECT_ROOT/CHANGELOG.md"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get current version
if [ ! -f "$VERSION_FILE" ]; then
    # Initialize with today's date and build 000001
    echo "$(date +%Y-%m-%d)-000001" > "$VERSION_FILE"
fi

CURRENT_VERSION=$(cat "$VERSION_FILE" | tr -d '[:space:]')

# Parse arguments
case "${1:-}" in
    --show|-s)
        echo "$CURRENT_VERSION"
        exit 0
        ;;
    --help|-h)
        echo "Usage: ./tools/version-bump [--show|--help]"
        echo ""
        echo "Increments the build number with today's date prefix."
        echo ""
        echo "Format: YYYY-MM-DD-BUILDNUMBER"
        echo "Example: 2026-01-09-000042"
        echo ""
        echo "Current version: $CURRENT_VERSION"
        exit 0
        ;;
esac

# Parse current version to extract build number
# Format: YYYY-MM-DD-BUILD
if [[ "$CURRENT_VERSION" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}-([0-9]+)$ ]]; then
    BUILD_NUMBER="${BASH_REMATCH[1]}"
else
    # Handle old format or invalid - start at build 0
    BUILD_NUMBER=0
fi

# Increment build number (strip leading zeros for arithmetic, then re-pad)
BUILD_NUMBER_CLEAN=$((10#$BUILD_NUMBER))  # Force base 10 to handle leading zeros
NEW_BUILD=$((BUILD_NUMBER_CLEAN + 1))
NEW_BUILD_PADDED=$(printf "%06d" $NEW_BUILD)
TODAY=$(date +%Y-%m-%d)
NEW_VERSION="$TODAY-$NEW_BUILD_PADDED"

# Update VERSION file
echo "$NEW_VERSION" > "$VERSION_FILE"

# Update CHANGELOG.md if it exists
if [ -f "$CHANGELOG_FILE" ]; then
    # Replace [Unreleased] with new version section
    if grep -q "## \[Unreleased\]" "$CHANGELOG_FILE"; then
        sed -i.bak "s/## \[Unreleased\]/## [Unreleased]\n\n## [$NEW_VERSION]/" "$CHANGELOG_FILE"
        rm -f "$CHANGELOG_FILE.bak"
        echo -e "${GREEN}Updated CHANGELOG.md${NC}"
    fi
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}Version bumped: $CURRENT_VERSION → $NEW_VERSION${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
