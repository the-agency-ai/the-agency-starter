#!/bin/bash
# Create a new sprint directory
#
# Usage: ./tools/sprint-create <workstream> <epic-num> <sprint-num> [--verbose]
#
# Creates:
#   claude/workstreams/{workstream}/epic{epic}/sprint{sprint}/
#     - sprint-plan.md

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.1.0-20260114-000006"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Defaults
VERBOSE=false

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "sprint-create $TOOL_VERSION"
    exit 0
fi

# Find repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_ROOT"

# Parse arguments
WORKSTREAM=""
EPIC_NUM=""
SPRINT_NUM=""

for arg in "$@"; do
    case $arg in
        --verbose)
            VERBOSE=true
            ;;
        *)
            if [[ -z "$WORKSTREAM" ]]; then
                WORKSTREAM="$arg"
            elif [[ -z "$EPIC_NUM" ]]; then
                EPIC_NUM="$arg"
            elif [[ -z "$SPRINT_NUM" ]]; then
                SPRINT_NUM="$arg"
            fi
            ;;
    esac
done

if [ -z "$WORKSTREAM" ] || [ -z "$EPIC_NUM" ] || [ -z "$SPRINT_NUM" ]; then
  log_error "Missing required arguments"
  echo ""
  echo "Usage: ./tools/sprint-create <workstream> <epic-num> <sprint-num> [--verbose]"
  echo ""
  echo "Example: ./tools/sprint-create web 002 001"
  echo "Creates: claude/workstreams/web/epic002/sprint001/"
  exit 1
fi

# Pad numbers
EPIC=$(printf "epic%03d" "$EPIC_NUM")
SPRINT=$(printf "sprint%03d" "$SPRINT_NUM")
DIR="claude/workstreams/$WORKSTREAM/$EPIC/$SPRINT"

# Get timezone from config or default to UTC
TIMEZONE=$("$SCRIPT_DIR/config" get project.timezone 2>/dev/null || echo "UTC")
TIMESTAMP=$(TZ="$TIMEZONE" date '+%Y-%m-%d %H:%M %Z')

# Main function
main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    RUN_ID=$(log_start "sprint-create" "agency-tool" "$@" 2>/dev/null) || true
    echo "sprint-create [run: ${RUN_ID:-none}]"

    # Check workstream exists
    if [ ! -d "claude/workstreams/$WORKSTREAM" ]; then
      log_error "Workstream '$WORKSTREAM' doesn't exist"
      trap - EXIT
      log_end "$RUN_ID" "failure" 1 0 "Workstream not found"
      exit 1
    fi

    # Check epic exists in workstream
    if [ ! -d "claude/workstreams/$WORKSTREAM/$EPIC" ]; then
      log_error "Epic '$EPIC' doesn't exist in workstream '$WORKSTREAM'"
      echo ""
      echo "Create epic first: ./tools/epic-create $EPIC_NUM"
      trap - EXIT
      log_end "$RUN_ID" "failure" 1 0 "Epic not found"
      exit 1
    fi

    if [ -d "$DIR" ]; then
      log_error "Sprint already exists at $DIR"
      trap - EXIT
      log_end "$RUN_ID" "failure" 1 0 "Sprint already exists"
      exit 1
    fi

    log_step "Creating sprint: $WORKSTREAM/$EPIC/$SPRINT"
    mkdir -p "$DIR"

    cat > "$DIR/sprint-plan.md" << EOF
# $WORKSTREAM $EPIC $SPRINT Plan

**Created:** $TIMESTAMP
**Workstream:** $WORKSTREAM
**Status:** Not Started

## Objective

[Sprint objective]

## Scope

- [ ] [Task 1]
- [ ] [Task 2]

## Estimate

[X hours]

## Dependencies

- [Dependency 1]

## Acceptance Criteria

- [ ] [Criterion 1]
EOF

    echo "Created: $DIR/"
    verbose_echo "  - sprint-plan.md"
    echo ""
    echo "Edit plan: $DIR/sprint-plan.md"

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Sprint $WORKSTREAM/$EPIC/$SPRINT created"
}

main
