#!/bin/bash
# List instructions, optionally filtered by status or principal
#
# Usage:
#   instruction-list              # All instructions
#   instruction-list --active     # Only active
#   instruction-list --completed  # Only completed
#   instruction-list -p jordan    # Only from jordan

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "instruction-list" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260114-000003"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "instruction-list $TOOL_VERSION"
    exit 0
fi

# Find repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

PRINCIPALS_DIR="$REPO_ROOT/claude/principals"

# Defaults
VERBOSE=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Parse options
FILTER_STATUS=""
FILTER_PRINCIPAL=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --active|-a)
      FILTER_STATUS="Active"
      shift
      ;;
    --completed|-c)
      FILTER_STATUS="Completed"
      shift
      ;;
    -p|--principal)
      FILTER_PRINCIPAL="$2"
      shift 2
      ;;
    --verbose)
      VERBOSE=true
      shift
      ;;
    -h|--help)
      echo "Usage: instruction-list [--active|--completed] [-p principal] [--verbose]"
      exit 0
      ;;
    *)
      shift
      ;;
  esac
done

# Main function
main() {
  # Trap unexpected exits
  trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

  echo "instruction-list [run: ${RUN_ID:-none}]"

  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  Instructions"
  if [[ -n "$FILTER_STATUS" ]]; then
    echo "  Filter: $FILTER_STATUS"
  fi
  if [[ -n "$FILTER_PRINCIPAL" ]]; then
    echo "  Principal: $FILTER_PRINCIPAL"
  fi
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""

  # Find all instruction files
  if [[ -n "$FILTER_PRINCIPAL" ]]; then
    SEARCH_PATH="$PRINCIPALS_DIR/$FILTER_PRINCIPAL/instructions"
  else
    SEARCH_PATH="$PRINCIPALS_DIR"
  fi

  find "$SEARCH_PATH" -name "INSTR-*.md" 2>/dev/null | sort | while read filepath; do
    # Extract info from file
    FILENAME=$(basename "$filepath" .md)

    # Get status from file
    STATUS=$(grep -m1 "^\*\*Status:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*Status:\*\* //' || echo "Unknown")

    # Apply status filter
    if [[ -n "$FILTER_STATUS" ]] && [[ "$STATUS" != "$FILTER_STATUS" ]]; then
      continue
    fi

    # Get title from first heading
    TITLE=$(grep -m1 "^# INSTR-" "$filepath" 2>/dev/null | sed 's/^# INSTR-[0-9]*: //' || echo "Unknown")

    # Get principal and target
    PRINCIPAL=$(grep -m1 "^\*\*Principal:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*Principal:\*\* //' || echo "?")
    TO=$(grep -m1 "^\*\*To:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*To:\*\* //' || echo "?")

    # Status emoji
    case "$STATUS" in
      Active)    EMOJI="ğŸ”µ" ;;
      Completed) EMOJI="âœ…" ;;
      *)         EMOJI="âšª" ;;
    esac

    # Parse instruction number for display
    INSTR_NUM=$(echo "$FILENAME" | grep -oE 'INSTR-[0-9]+' | head -1)

    echo "$EMOJI $INSTR_NUM: $TITLE"
    echo "   Principal: $PRINCIPAL â†’ $TO | Status: $STATUS"
    echo ""
  done

  COUNT=$(find "$SEARCH_PATH" -name "INSTR-*.md" 2>/dev/null | wc -l | tr -d ' ')
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  Total: $COUNT instructions"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  trap - EXIT
  log_end "$RUN_ID" "success" 0 0 "Listed $COUNT instructions"
}

main
