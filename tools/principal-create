#!/bin/bash
# Create a new principal (human stakeholder)
#
# Usage: ./tools/principal-create <principalname> [projectname] [--verbose]
#
# Creates:
#   claude/principals/{principalname}/
#     - projects/, resources/, sessions/, config/
#
# Optional integrations (if projectname provided):
#   - iCloud cloud storage setup
#   - iTerm profile setup

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.1.0-20260114-000008"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Defaults
VERBOSE=false

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Usage function
usage() {
    cat << EOF
Usage: principal-create <principalname> [projectname] [--verbose]

Create a new principal directory structure.

Arguments:
  principalname  - Name for the principal (must start with letter, alphanumeric/hyphens/underscores only)
  projectname    - Optional: project name for iCloud setup

Options:
  --verbose      - Show detailed logging
  -v, --version  - Show version
  -h, --help     - Show this help

Examples:
  ./tools/principal-create jordan
  ./tools/principal-create jordan the-agency
  ./tools/principal-create alice --verbose
EOF
}

# Parse arguments
PRINCIPALNAME=""
PROJECTNAME=""

for arg in "$@"; do
    case $arg in
        -v|--version)
            echo "principal-create $TOOL_VERSION"
            exit 0
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --verbose)
            VERBOSE=true
            ;;
        *)
            if [[ -z "$PRINCIPALNAME" ]]; then
                PRINCIPALNAME="$arg"
            elif [[ -z "$PROJECTNAME" ]]; then
                PROJECTNAME="$arg"
            fi
            ;;
    esac
done

if [ -z "$PRINCIPALNAME" ]; then
  log_error "Missing required argument"
  echo ""
  usage
  exit 1
fi

# Validate principal name format
if [[ ! "$PRINCIPALNAME" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
    log_error "Invalid principal name: $PRINCIPALNAME"
    echo "Name must start with a letter and contain only letters, numbers, hyphens, underscores."
    exit 1
fi

# Convert to lowercase
PRINCIPALNAME=$(echo "$PRINCIPALNAME" | tr '[:upper:]' '[:lower:]')

DIR="claude/principals/$PRINCIPALNAME"
TIMESTAMP=$(./tools/now 2>/dev/null || date '+%Y-%m-%d %H:%M')

# Main function
main() {
    # Initialize RUN_ID before trap to avoid referencing undefined variable
    RUN_ID=$(log_start "principal-create" "agency-tool" "$@" 2>/dev/null) || true

    # Trap unexpected exits
    trap 'log_end "${RUN_ID:-}" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "principal-create [run: ${RUN_ID:-none}]"

    # Check principal doesn't exist
    if [ -d "$DIR" ]; then
      log_error "Principal '$PRINCIPALNAME' already exists at $DIR"
      trap - EXIT
      log_end "$RUN_ID" "failure" 1 0 "Principal already exists"
      exit 1
    fi

    log_step "Creating principal: $PRINCIPALNAME"
    mkdir -p "$DIR/projects"
    mkdir -p "$DIR/resources"
    mkdir -p "$DIR/sessions"
    mkdir -p "$DIR/config"

    # Create principal README
    cat > "$DIR/README.md" << EOF
# Principal: $PRINCIPALNAME

**Created:** $TIMESTAMP

## Structure

- \`projects/\` - Project-specific instructions and artifacts
- \`resources/\` - Files and resources for this principal
  - \`cloud/\` - Symlink to iCloud storage (if set up)
  - \`secrets/\` - Credentials and keys (gitignored)
- \`sessions/\` - Session archives
- \`config/\` - App configurations (iTerm, etc.)

## Setup

Run integrations:
\`\`\`bash
# iCloud storage
./tools/icloud-setup <projectname> $PRINCIPALNAME

# iTerm profiles
./tools/iterm-setup $PRINCIPALNAME
\`\`\`
EOF

    # Create secrets directory with .gitkeep
    mkdir -p "$DIR/resources/secrets"
    touch "$DIR/resources/secrets/.gitkeep"

    echo "Created: $DIR/"

    # Run iCloud setup if project name provided
    if [ -n "$PROJECTNAME" ]; then
      verbose_echo ""
      log_step "Setting up iCloud integration..."
      ./tools/icloud-setup "$PROJECTNAME" "$PRINCIPALNAME"
    fi

    # Run iTerm setup
    verbose_echo ""
    log_step "Setting up iTerm profiles..."
    ./tools/iterm-setup "$PRINCIPALNAME"

    # Update principals index
    INDEX="claude/principals/INDEX.md"
    if [ -f "$INDEX" ]; then
      if ! grep -q "| $PRINCIPALNAME |" "$INDEX"; then
        echo "| $PRINCIPALNAME | $TIMESTAMP | Active |" >> "$INDEX"
        verbose_echo "Updated: $INDEX"
      fi
    fi

    echo ""
    echo "Principal '$PRINCIPALNAME' created successfully!"
    echo ""
    echo "Next steps:"
    echo "  1. Review: $DIR/README.md"
    if [ -z "$PROJECTNAME" ]; then
      echo "  2. Set up iCloud: ./tools/icloud-setup <projectname> $PRINCIPALNAME"
    fi
    echo "  3. Configure: claude/config/agency.yaml to map your system user"

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Principal $PRINCIPALNAME created"
}

main
