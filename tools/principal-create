#!/bin/bash
# Create a new principal (human stakeholder)
#
# Usage: ./tools/principal-create <principalname> [projectname]
#
# Creates:
#   claude/principals/{principalname}/
#     - projects/, resources/, sessions/, config/
#
# Optional integrations (if projectname provided):
#   - iCloud cloud storage setup
#   - iTerm profile setup

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "principal-create" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "principal-create $TOOL_VERSION"
    exit 0
fi

PRINCIPALNAME="$1"
PROJECTNAME="$2"

if [ -z "$PRINCIPALNAME" ]; then
  echo "Usage: ./tools/principal-create <principalname> [projectname]"
  echo ""
  echo "Examples:"
  echo "  ./tools/principal-create jordan"
  echo "  ./tools/principal-create jordan the-agency"
  echo ""
  echo "Options:"
  echo "  principalname  - Name for the principal (lowercase)"
  echo "  projectname    - Optional: project name for iCloud setup"
  exit 1
fi

DIR="claude/principals/$PRINCIPALNAME"
TIMESTAMP=$(./tools/now 2>/dev/null || date '+%Y-%m-%d %H:%M')

# Check principal doesn't exist
if [ -d "$DIR" ]; then
  echo "Error: Principal '$PRINCIPALNAME' already exists at $DIR"
  exit 1
fi

echo "Creating principal: $PRINCIPALNAME"
mkdir -p "$DIR/projects"
mkdir -p "$DIR/resources"
mkdir -p "$DIR/sessions"
mkdir -p "$DIR/config"

# Create principal README
cat > "$DIR/README.md" << EOF
# Principal: $PRINCIPALNAME

**Created:** $TIMESTAMP

## Structure

- \`projects/\` - Project-specific instructions and artifacts
- \`resources/\` - Files and resources for this principal
  - \`cloud/\` - Symlink to iCloud storage (if set up)
  - \`secrets/\` - Credentials and keys (gitignored)
- \`sessions/\` - Session archives
- \`config/\` - App configurations (iTerm, etc.)

## Setup

Run integrations:
\`\`\`bash
# iCloud storage
./tools/icloud-setup <projectname> $PRINCIPALNAME

# iTerm profiles
./tools/iterm-setup $PRINCIPALNAME
\`\`\`
EOF

# Create secrets directory with .gitkeep
mkdir -p "$DIR/resources/secrets"
touch "$DIR/resources/secrets/.gitkeep"

echo "Created: $DIR/"

# Run iCloud setup if project name provided
if [ -n "$PROJECTNAME" ]; then
  echo ""
  echo "Setting up iCloud integration..."
  ./tools/icloud-setup "$PROJECTNAME" "$PRINCIPALNAME"
fi

# Run iTerm setup
echo ""
echo "Setting up iTerm profiles..."
./tools/iterm-setup "$PRINCIPALNAME"

# Update principals index
INDEX="claude/principals/INDEX.md"
if [ -f "$INDEX" ]; then
  if ! grep -q "| $PRINCIPALNAME |" "$INDEX"; then
    echo "| $PRINCIPALNAME | $TIMESTAMP | Active |" >> "$INDEX"
    echo "Updated: $INDEX"
  fi
fi

echo ""
echo "Principal '$PRINCIPALNAME' created successfully!"
echo ""
echo "Next steps:"
echo "  1. Review: $DIR/README.md"
if [ -z "$PROJECTNAME" ]; then
  echo "  2. Set up iCloud: ./tools/icloud-setup <projectname> $PRINCIPALNAME"
fi
echo "  3. Configure: claude/config/agency.yaml to map your system user"
