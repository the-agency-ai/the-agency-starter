#!/bin/bash
# Launch AgencyBench desktop app
#
# Usage: ./tools/bench [command]
#
# Commands:
#   (none)  - Run production app (default)
#   dev     - Run in development mode with hot reload
#   build   - Build production app
#
# The production app must be built first with 'build'

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "bench" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "bench $TOOL_VERSION"
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
BENCH_DIR="$REPO_ROOT/source/apps/agency-bench"
BUILD_BUNDLE="$BENCH_DIR/src-tauri/target/release/bundle/macos/AgencyBench.app"
INSTALLED_APP="$HOME/.local/share/the-agency/AgencyBench.app"
APP_BUNDLE="${INSTALLED_APP}"

if [ ! -d "$BENCH_DIR" ]; then
  echo "Error: AgencyBench not found at $BENCH_DIR"
  exit 1
fi

cd "$BENCH_DIR"

install_app() {
  mkdir -p "$(dirname "$INSTALLED_APP")"
  rm -rf "$INSTALLED_APP"
  cp -R "$BUILD_BUNDLE" "$INSTALLED_APP"
}

case "${1:-run}" in
  run|"")
    if [ ! -d "$APP_BUNDLE" ]; then
      echo "Production app not built yet. Building now..."
      echo "(This takes a few minutes the first time)"
      echo ""
      npm run tauri:build 2>&1 | grep -E '(Compiling|Building|Finished|Bundling|Error|error)'
      echo ""
      echo "Installing AgencyBench..."
      install_app
    fi
    echo "Launching AgencyBench..."
    open "$APP_BUNDLE"
    ;;
  dev)
    echo "Starting AgencyBench in development mode..."
    npm run tauri:dev
    ;;
  build)
    echo "Building AgencyBench..."
    npm run tauri:build
    echo ""
    echo "Installing AgencyBench..."
    install_app
    echo "Installed: $INSTALLED_APP"
    ;;
  *)
    echo "Usage: ./tools/bench [command]"
    echo ""
    echo "Commands:"
    echo "  (none)  - Run production app (default)"
    echo "  dev     - Run in development mode with hot reload"
    echo "  build   - Build production app"
    exit 1
    ;;
esac
