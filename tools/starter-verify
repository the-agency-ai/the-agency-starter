#!/bin/bash
# Verify the-agency-starter contents against a test installation
#
# Usage:
#   ./tools/starter-verify                    # Compare against test/the-agency-starter
#   ./tools/starter-verify /path/to/testbed   # Compare against specific directory
#   ./tools/starter-verify --install          # Install fresh copy to test/ then compare
#
# This tool:
#   1. Optionally installs a fresh copy to test/
#   2. Compares the-agency-starter/ against the test installation
#   3. Reports any differences
#   4. Verifies required files exist

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "starter-verify" "agency-tool" "$@" 2>/dev/null) || true

TOOL_VERSION="1.0.0-20260110-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get script directory and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
STARTER_DIR="$PROJECT_ROOT/the-agency-starter"
DEFAULT_TEST_DIR="$(dirname "$PROJECT_ROOT")/test/the-agency-starter"

# Parse arguments
INSTALL_FRESH=false
TEST_DIR=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --version|-v)
            echo "starter-verify $TOOL_VERSION"
            exit 0
            ;;
        --help|-h)
            head -16 "$0" | tail -15 | sed 's/^# //' | sed 's/^#//'
            exit 0
            ;;
        --install|-i)
            INSTALL_FRESH=true
            shift
            ;;
        *)
            TEST_DIR="$1"
            shift
            ;;
    esac
done

# Default test directory
TEST_DIR="${TEST_DIR:-$DEFAULT_TEST_DIR}"

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  starter-verify - Starter Verification Tool${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Check starter exists
if [[ ! -d "$STARTER_DIR" ]]; then
    echo -e "${RED}Error: Starter directory not found: $STARTER_DIR${NC}"
    exit 1
fi

# Install fresh copy if requested
if [[ "$INSTALL_FRESH" == "true" ]]; then
    echo -e "${BLUE}Installing fresh copy to test directory...${NC}"

    # Create test directory
    mkdir -p "$(dirname "$TEST_DIR")"

    # Remove existing test installation
    if [[ -d "$TEST_DIR" ]]; then
        echo "  Removing existing: $TEST_DIR"
        rm -rf "$TEST_DIR"
    fi

    # Copy starter to test directory (simulating what install.sh does)
    echo "  Copying starter to: $TEST_DIR"
    cp -R "$STARTER_DIR" "$TEST_DIR"

    # Make tools executable (like install.sh does)
    chmod +x "$TEST_DIR/tools/"* 2>/dev/null || true

    echo -e "${GREEN}  ✓ Fresh copy installed${NC}"
    echo ""
fi

# Check test directory exists
if [[ ! -d "$TEST_DIR" ]]; then
    echo -e "${RED}Error: Test directory not found: $TEST_DIR${NC}"
    echo ""
    echo "Run with --install to create a fresh test installation:"
    echo "  ./tools/starter-verify --install"
    exit 1
fi

echo -e "${BLUE}Comparing:${NC}"
echo "  Source: $STARTER_DIR"
echo "  Test:   $TEST_DIR"
echo ""

# Required files that MUST exist
REQUIRED_FILES=(
    "CLAUDE.md"
    "README.md"
    "VERSION"
    "install.sh"
    "tools/myclaude"
    "tools/welcomeback"
    "tools/agent-create"
    "tools/workstream-create"
    "tools/tag"
    "tools/commit"
    "tools/release"
    "claude/config/agency.yaml"
    "claude/agents/housekeeping/agent.md"
    "source/apps/agency-bench/package.json"
    "source/apps/agency-bench/src-tauri/tauri.conf.json"
    "source/apps/agency-bench/src/app/bench/(apps)/bugbench/page.tsx"
    "source/apps/agency-bench/src/app/bench/(apps)/docbench/page.tsx"
    "source/services/agency-service/package.json"
    "source/services/agency-service/src/index.ts"
    "source/services/agency-service/src/embedded/bug-service/index.ts"
    "source/services/agency-service/src/embedded/secret-service/index.ts"
)

# Check required files
echo -e "${BLUE}Checking required files...${NC}"
missing_count=0
for file in "${REQUIRED_FILES[@]}"; do
    if [[ -f "$TEST_DIR/$file" ]]; then
        echo -e "  ${GREEN}✓${NC} $file"
    else
        echo -e "  ${RED}✗${NC} $file ${RED}(MISSING)${NC}"
        ((missing_count++))
    fi
done
echo ""

# Compare directory structures
echo -e "${BLUE}Comparing directory structures...${NC}"

# Get file lists (excluding .git, node_modules, target, .next, out)
STARTER_FILES=$(cd "$STARTER_DIR" && find . -type f \
    ! -path './.git/*' \
    ! -path '*/node_modules/*' \
    ! -path '*/target/*' \
    ! -path '*/.next/*' \
    ! -path '*/out/*' \
    ! -name '.DS_Store' \
    | sort)

TEST_FILES=$(cd "$TEST_DIR" && find . -type f \
    ! -path './.git/*' \
    ! -path '*/node_modules/*' \
    ! -path '*/target/*' \
    ! -path '*/.next/*' \
    ! -path '*/out/*' \
    ! -name '.DS_Store' \
    | sort)

# Find files only in starter
ONLY_IN_STARTER=$(comm -23 <(echo "$STARTER_FILES") <(echo "$TEST_FILES"))
# Find files only in test
ONLY_IN_TEST=$(comm -13 <(echo "$STARTER_FILES") <(echo "$TEST_FILES"))
# Find files in both
IN_BOTH=$(comm -12 <(echo "$STARTER_FILES") <(echo "$TEST_FILES"))

# Report differences
if [[ -n "$ONLY_IN_STARTER" ]]; then
    echo -e "${YELLOW}Files only in starter (missing from test):${NC}"
    echo "$ONLY_IN_STARTER" | head -20 | while read -r f; do
        echo -e "  ${YELLOW}+${NC} $f"
    done
    only_starter_count=$(echo "$ONLY_IN_STARTER" | wc -l | tr -d ' ')
    if [[ $only_starter_count -gt 20 ]]; then
        echo -e "  ${YELLOW}... and $((only_starter_count - 20)) more${NC}"
    fi
    echo ""
fi

if [[ -n "$ONLY_IN_TEST" ]]; then
    echo -e "${YELLOW}Files only in test (extra):${NC}"
    echo "$ONLY_IN_TEST" | head -20 | while read -r f; do
        echo -e "  ${YELLOW}-${NC} $f"
    done
    only_test_count=$(echo "$ONLY_IN_TEST" | wc -l | tr -d ' ')
    if [[ $only_test_count -gt 20 ]]; then
        echo -e "  ${YELLOW}... and $((only_test_count - 20)) more${NC}"
    fi
    echo ""
fi

# Compare content of files in both
echo -e "${BLUE}Checking file contents...${NC}"
diff_count=0
checked_count=0

# Only check key files to avoid long runtime
KEY_FILES=(
    "./CLAUDE.md"
    "./VERSION"
    "./source/apps/agency-bench/package.json"
    "./source/apps/agency-bench/src-tauri/tauri.conf.json"
    "./source/services/agency-service/package.json"
    "./source/services/agency-service/src/index.ts"
    "./tools/myclaude"
    "./tools/tag"
    "./tools/commit"
    "./tools/release"
)

for file in "${KEY_FILES[@]}"; do
    if [[ -f "$STARTER_DIR/$file" && -f "$TEST_DIR/$file" ]]; then
        ((checked_count++))
        if ! diff -q "$STARTER_DIR/$file" "$TEST_DIR/$file" > /dev/null 2>&1; then
            echo -e "  ${RED}≠${NC} $file ${RED}(differs)${NC}"
            ((diff_count++))
        else
            echo -e "  ${GREEN}=${NC} $file"
        fi
    fi
done
echo ""

# Count totals
starter_count=$(echo "$STARTER_FILES" | wc -l | tr -d ' ')
test_count=$(echo "$TEST_FILES" | wc -l | tr -d ' ')
common_count=$(echo "$IN_BOTH" | wc -l | tr -d ' ')

# Summary
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}Summary${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo "  Files in starter:     $starter_count"
echo "  Files in test:        $test_count"
echo "  Files in common:      $common_count"
echo "  Required files:       ${#REQUIRED_FILES[@]}"
echo ""

# Determine pass/fail
errors=0

if [[ $missing_count -gt 0 ]]; then
    echo -e "  ${RED}✗ $missing_count required files missing${NC}"
    ((errors++))
else
    echo -e "  ${GREEN}✓ All required files present${NC}"
fi

if [[ -n "$ONLY_IN_STARTER" ]]; then
    only_starter_count=$(echo "$ONLY_IN_STARTER" | wc -l | tr -d ' ')
    echo -e "  ${YELLOW}⚠ $only_starter_count files missing from test${NC}"
fi

if [[ $diff_count -gt 0 ]]; then
    echo -e "  ${RED}✗ $diff_count key files differ${NC}"
    ((errors++))
else
    echo -e "  ${GREEN}✓ All key files match${NC}"
fi

echo ""

if [[ $errors -eq 0 ]]; then
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  VERIFICATION PASSED${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    exit 0
else
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}  VERIFICATION FAILED${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    exit 1
fi
