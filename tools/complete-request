#!/bin/bash
# complete-request - Mark a request as complete with git tag
#
# Usage:
#   ./tools/complete-request REQUEST-jordan-0013 "Brief summary"
#
# Creates a git tag: REQUEST-jordan-0013-complete
# with metadata about what was accomplished.

set -e

# Tool version
TOOL_VERSION="1.0.0-4"

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Parse arguments
VERBOSE=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --version)
            echo "complete-request $TOOL_VERSION"
            exit 0
            ;;
        --help|-h)
            echo "complete-request - Mark a request as complete with git tag"
            echo ""
            echo "Usage:"
            echo "  ./tools/complete-request <request-id> \"<summary>\""
            echo ""
            echo "Examples:"
            echo "  ./tools/complete-request REQUEST-jordan-0013 \"Added test-service\""
            echo "  ./tools/complete-request REQUEST-jordan-0014 \"Directory cleanup\""
            echo ""
            echo "Options:"
            echo "  --verbose, -v  Show detailed output"
            echo "  --version      Show version"
            echo "  --help, -h     Show this help"
            echo ""
            echo "Creates annotated git tag: <request-id>-complete"
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

REQUEST_ID="$1"
SUMMARY="${2:-}"

if [[ -z "$REQUEST_ID" ]]; then
    echo "Usage: ./tools/complete-request <request-id> \"<summary>\""
    echo ""
    echo "Example: ./tools/complete-request REQUEST-jordan-0013 \"Added test-service\""
    exit 1
fi

# Validate request ID format
if [[ ! "$REQUEST_ID" =~ ^REQUEST-[a-z]+-[0-9]+$ ]]; then
    echo "Error: Invalid request ID format"
    echo "Expected: REQUEST-<principal>-<number> (e.g., REQUEST-jordan-0013)"
    exit 1
fi

# Check if request file exists
REQUEST_FILE=$(find "$PROJECT_ROOT/claude/principals" -name "${REQUEST_ID}*.md" 2>/dev/null | head -1)
if [[ -z "$REQUEST_FILE" ]]; then
    echo "Warning: Request file not found for $REQUEST_ID"
    echo "Continuing anyway..."
fi

# Extract info from request file if it exists
REQUEST_TITLE=""
if [[ -n "$REQUEST_FILE" && -f "$REQUEST_FILE" ]]; then
    REQUEST_TITLE=$(head -5 "$REQUEST_FILE" | grep -E "^#" | head -1 | sed 's/^#* *//')
fi

# Build tag name
TAG_NAME="${REQUEST_ID}-complete"

# Check if tag already exists
if git -C "$PROJECT_ROOT" tag -l "$TAG_NAME" | grep -q .; then
    echo "Error: Tag $TAG_NAME already exists"
    echo "Use 'git tag -d $TAG_NAME' to delete it first if needed"
    exit 1
fi

# Get recent commits since last request tag (or last 20)
LAST_REQUEST_TAG=$(git -C "$PROJECT_ROOT" tag -l "REQUEST-*-complete" --sort=-creatordate | head -1)
if [[ -n "$LAST_REQUEST_TAG" ]]; then
    COMMIT_COUNT=$(git -C "$PROJECT_ROOT" rev-list "$LAST_REQUEST_TAG"..HEAD --count)
    COMMITS=$(git -C "$PROJECT_ROOT" log --oneline "$LAST_REQUEST_TAG"..HEAD | head -10)
else
    COMMIT_COUNT=$(git -C "$PROJECT_ROOT" rev-list HEAD --count)
    COMMITS=$(git -C "$PROJECT_ROOT" log --oneline -10)
fi

# Get test count if agency-service tests exist
TEST_COUNT=""
if [[ -d "$PROJECT_ROOT/services/agency-service" ]]; then
    TEST_COUNT=$(cd "$PROJECT_ROOT/services/agency-service" && ~/.bun/bin/bun test 2>&1 | grep -oE "[0-9]+ pass" | head -1 || true)
fi

# Build tag message
TAG_MESSAGE="$REQUEST_ID: ${REQUEST_TITLE:-$SUMMARY}

${SUMMARY:-No summary provided}

Commits: $COMMIT_COUNT since last request
${TEST_COUNT:+Tests: $TEST_COUNT}

Recent changes:
$COMMITS"

# Create the tag
if [[ "$VERBOSE" == "true" ]]; then
    echo "Creating tag: $TAG_NAME"
    echo ""
    echo "Message:"
    echo "$TAG_MESSAGE"
    echo ""
fi

git -C "$PROJECT_ROOT" tag -a "$TAG_NAME" -m "$TAG_MESSAGE"

echo "SUCCESS: Created tag $TAG_NAME"
echo ""
echo "View with: git show $TAG_NAME"
echo "Push with: git push origin $TAG_NAME"
