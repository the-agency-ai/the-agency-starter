#!/bin/bash
# Tool: news-post
# Purpose: Post a new message to the agent news/MOTD system
# Usage: ./tools/news-post "Subject" "Message body"
# Example: ./tools/news-post "New API Convention" "All API routes now follow /api/{service}/v{n}/{resource} pattern"

set -e

# Tool version
TOOL_VERSION="1.0.1-20260114-000003"

# Defaults
VERBOSE=false

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "news-post $TOOL_VERSION"
    exit 0
fi

# Parse flags
while [[ $# -gt 0 ]]; do
    case $1 in
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help|-h)
            echo "Usage: ./tools/news-post [--verbose] \"Subject\" \"Message body\""
            echo "Example: ./tools/news-post \"New Tool Available\" \"The ./tools/news-post tool is now available for inter-agent announcements.\""
            echo ""
            echo "Options:"
            echo "  --verbose    Show detailed output"
            echo "  --version    Show tool version"
            echo "  --help       Show this help"
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Auto-load .env.local if it exists
if [[ -f ".env.local" ]]; then
  set -a
  source .env.local
  set +a
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

NEWS_FILE="claude/agents/collaboration/NEWS.md"

# Validate arguments
if [[ $# -lt 2 ]]; then
  echo "Usage: ./tools/news-post [--verbose] \"Subject\" \"Message body\""
  echo "Example: ./tools/news-post \"New Tool Available\" \"The ./tools/news-post tool is now available for inter-agent announcements.\""
  exit 1
fi

SUBJECT="$1"
MESSAGE="$2"

# Main function
main() {
    # Trap unexpected exits
    trap 'if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then log_end "$RUN_ID" "failure" $? 0 "Unexpected exit"; fi' EXIT

    echo "news-post [run: ${RUN_ID:-none}]"

    RUN_ID=$(log_start "news-post" "agency-tool" "$@" 2>/dev/null) || true

    # Get current timestamp
    TIMESTAMP=$(./tools/now 2>/dev/null || date "+%Y-%m-%d %H:%M:%S %Z")

    # Get agent name for attribution
    AGENTNAME=$(./tools/agentname 2>/dev/null || echo "unknown")
    COMMIT_PREFIX=$(./tools/commit-prefix 2>/dev/null || echo "unknown/unknown:")

    # Function to handle merge conflicts
    handle_merge_conflict() {
      log_info "Merge conflict detected. Attempting to resolve..."
      # For news file, prefer remote version and add our message on top
      git checkout --theirs "$NEWS_FILE" 2>/dev/null || true
      git add "$NEWS_FILE"
      log_info "Resolved by accepting remote version. Will add message on top."
      return 0
    }

    # Step 1: Pull latest
    log_step "Pulling latest changes..."
    git pull --rebase 2>/dev/null || {
      # If rebase fails due to conflicts, abort and try regular pull
      git rebase --abort 2>/dev/null || true
      git pull || {
        # If regular pull also has conflicts, handle them
        if git diff --name-only --diff-filter=U | grep -q "$NEWS_FILE"; then
          handle_merge_conflict
        fi
      }
    }

    # Step 2: Ensure the NEWS.md file exists
    if [[ ! -f "$NEWS_FILE" ]]; then
      log_step "Creating NEWS.md..."
      mkdir -p "$(dirname "$NEWS_FILE")"
      cat > "$NEWS_FILE" << 'INIT_EOF'
# Agent News / MOTD

Shared announcements and updates for all agents.

## Instructions

- New messages appear at the top
- Use `./tools/news-read` to read and mark as read
- Use `./tools/news-post "Subject" "Message"` to post
- Use `./tools/fetch-news NEWS-####` to view specific message
- ACTIVE = unread by some agents, READ = all agents have read

---

## Messages

---
INIT_EOF
    fi

    # Step 3: Find the highest existing NEWS ID
    HIGHEST_ID=$(grep -oE 'NEWS-[0-9]+' "$NEWS_FILE" 2>/dev/null | grep -oE '[0-9]+' | sed 's/^0*//' | sort -n | tail -1)
    if [[ -z "$HIGHEST_ID" ]]; then
      HIGHEST_ID=0
    fi
    NEW_ID=$((HIGHEST_ID + 1))
    NEW_ID_FORMATTED=$(printf "%04d" $NEW_ID)

    # Step 4: Insert the new message using Python for reliable multiline handling
    log_step "Posting NEWS-$NEW_ID_FORMATTED: $SUBJECT"
    python3 - "$NEWS_FILE" "$NEW_ID_FORMATTED" "$TIMESTAMP" "$AGENTNAME" "$SUBJECT" "$MESSAGE" << 'PYTHON_EOF'
import sys

news_file = sys.argv[1]
news_id = sys.argv[2]
timestamp = sys.argv[3]
agentname = sys.argv[4]
subject = sys.argv[5]
message = sys.argv[6]

with open(news_file, 'r') as f:
    content = f.read()

# Create the new message
new_message = f"""### NEWS-{news_id}

- **Status:** ACTIVE
- **Posted:** {timestamp}
- **Posted by:** {agentname}
- **Subject:** {subject}

{message}

- **Read by:** {agentname}

---"""

# Find "## Messages" and insert after it
lines = content.split('\n')
output = []
i = 0
inserted = False

while i < len(lines):
    line = lines[i]
    output.append(line)

    if line.strip() == '## Messages' and not inserted:
        i += 1
        # Skip the placeholder if present
        if i < len(lines) and lines[i].strip() == '':
            output.append('')
            i += 1
        if i < len(lines) and lines[i].startswith('(No messages yet'):
            i += 1
            if i < len(lines) and lines[i].strip() == '':
                i += 1
            if i < len(lines) and lines[i].strip() == '---':
                i += 1

        # Insert the new message
        output.append('')
        output.append(new_message)
        inserted = True
        continue

    i += 1

with open(news_file, 'w') as f:
    f.write('\n'.join(output))
PYTHON_EOF

    verbose_echo "Posted NEWS-$NEW_ID_FORMATTED: $SUBJECT"

    # Step 6: Stage and commit
    log_step "Committing news post..."
    git add "$NEWS_FILE"
    COMMIT_MSG="$COMMIT_PREFIX chore: post NEWS-$NEW_ID_FORMATTED

Subject: $SUBJECT

Posted by: $AGENTNAME

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

    git commit -m "$COMMIT_MSG

[skip ci]" || {
      log_error "Nothing to commit"
      trap - EXIT
      if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then
          log_end "$RUN_ID" "success" "0" "0" "Nothing to commit"
      fi
      exit 0
    }

    # Step 7: Push using sync tool
    log_step "Syncing changes..."
    ./tools/sync || {
      log_error "Sync failed"
      trap - EXIT
      if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then
          log_end "$RUN_ID" "failure" "1" "0" "Sync failed"
      fi
      exit 1
    }

    echo ""
    echo "Successfully posted news:"
    echo "  ID: NEWS-$NEW_ID_FORMATTED"
    echo "  Subject: $SUBJECT"
    echo "  Posted by: $AGENTNAME"
    echo "  File: $NEWS_FILE"

    trap - EXIT
    if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then
        log_end "$RUN_ID" "success" "0" "0" "NEWS-$NEW_ID_FORMATTED: $SUBJECT"
    fi
}

main
