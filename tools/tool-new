#!/bin/bash
# tool-new - Create a new tool from template
#
# Usage:
#   ./tools/tool-new <name> "<description>"
#
# Creates a new tool that:
# - Uses context-efficient logging (1-line output)
# - Logs details to log-service
# - Supports --verbose for immediate output
# - Returns run-id for debugging

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "tool-new" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260114-000006"

# Defaults
VERBOSE=false

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEMPLATE_FILE="$PROJECT_ROOT/claude/templates/TOOL.sh"
TOOLS_DIR="$PROJECT_ROOT/tools"
BUILD_FILE="$PROJECT_ROOT/claude/data/tool-build-number"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Get next build number (monotonically increasing)
get_next_build() {
    mkdir -p "$(dirname "$BUILD_FILE")"

    if [[ -f "$BUILD_FILE" ]]; then
        local current
        current=$(cat "$BUILD_FILE")
        local next=$((current + 1))
        echo "$next" > "$BUILD_FILE"
        echo "$next"
    else
        echo "1" > "$BUILD_FILE"
        echo "1"
    fi
}

# Main
main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "tool-new [run: ${RUN_ID:-none}]"

    local tool_name="$1"
    local tool_description="${2:-A new tool}"

    # Handle --version
    if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
        echo "tool-new $TOOL_VERSION"
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "Version displayed" 2>/dev/null || true
        exit 0
    fi

    # Handle --verbose
    for arg in "$@"; do
        case $arg in
            --verbose)
                VERBOSE=true
                ;;
        esac
    done

    # Handle --help
    if [[ "${1:-}" == "--help" || "${1:-}" == "-h" || -z "$tool_name" ]]; then
        echo "tool-new - Create a new tool from template"
        echo ""
        echo "Usage:"
        echo "  ./tools/tool-new <name> \"<description>\""
        echo ""
        echo "Options:"
        echo "  --verbose  Show detailed output"
        echo ""
        echo "Example:"
        echo "  ./tools/tool-new sync-data \"Sync data between environments\""
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "Help displayed" 2>/dev/null || true
        exit 1
    fi

    # Validate name
    if [[ ! "$tool_name" =~ ^[a-z][a-z0-9-]*$ ]]; then
        log_error "Tool name must be lowercase, start with letter, contain only letters, numbers, hyphens"
        trap - EXIT
        log_end "$RUN_ID" "failure" 1 0 "Invalid tool name" 2>/dev/null || true
        exit 1
    fi

    # Check if tool already exists
    local tool_file="$TOOLS_DIR/$tool_name"
    if [[ -f "$tool_file" ]]; then
        log_error "Tool already exists: $tool_file"
        trap - EXIT
        log_end "$RUN_ID" "failure" 1 0 "Tool already exists" 2>/dev/null || true
        exit 1
    fi

    # Check template exists
    if [[ ! -f "$TEMPLATE_FILE" ]]; then
        log_error "Template not found: $TEMPLATE_FILE"
        trap - EXIT
        log_end "$RUN_ID" "failure" 1 0 "Template not found" 2>/dev/null || true
        exit 1
    fi

    # Get build number and date
    local build_number
    build_number=$(get_next_build)
    local tool_date
    tool_date=$(date '+%Y%m%d')

    # Generate tool
    log_step "Creating tool: $tool_name"

    sed \
        -e "s/{{TOOL_NAME}}/$tool_name/g" \
        -e "s/{{TOOL_DESCRIPTION}}/$tool_description/g" \
        -e "s/{{BUILD_NUMBER}}/$build_number/g" \
        "$TEMPLATE_FILE" > "$tool_file"

    chmod +x "$tool_file"

    log_info "Created: $tool_file"
    log_info "Build: $build_number"
    verbose_echo ""
    verbose_echo "Next steps:"
    verbose_echo "  1. Edit $tool_file and add your logic"
    verbose_echo "  2. Test with: ./tools/$tool_name --verbose"
    verbose_echo "  3. Test logging: ./tools/$tool_name"

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Created $tool_name" 2>/dev/null || true
}

main "$@"
