#!/bin/bash
# Create a new agent identity
#
# Usage: ./tools/create-agent <agentname> <workstream> [--type=<template>]
#
# Many-to-one mapping: Multiple agents can work on the same workstream
# Agent name may differ from workstream name
#
# Options:
#   --type=<template>  Use a specific agent template (default: generic)
#
# Creates:
#   claude/agents/{agentname}/
#     - agent.md, WORKLOG.md, ADHOC-WORKLOG.md
#     - IDEAS.md, KNOWLEDGE.md, ONBOARDING.md
#     - backups/, logs/

set -e

# Tool version
TOOL_VERSION="1.1.0-20260113-000001"

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEMPLATE_DIR="$PROJECT_ROOT/claude/agents/templates"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "create-agent $TOOL_VERSION"
    exit 0
fi

# Help
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    echo "create-agent - Create a new agent identity"
    echo ""
    echo "Usage: ./tools/create-agent <agentname> <workstream> [--type=<template>]"
    echo ""
    echo "Arguments:"
    echo "  agentname     Name for the new agent"
    echo "  workstream    Workstream the agent belongs to (must exist)"
    echo ""
    echo "Options:"
    echo "  --type=<template>  Use a specific agent template (default: generic)"
    echo "  --list-types       List available agent templates"
    echo "  --version, -v      Show version"
    echo "  --help, -h         Show this help"
    echo ""
    echo "Examples:"
    echo "  ./tools/create-agent agent-manager agents"
    echo "  ./tools/create-agent ui-specialist web --type=ux-dev"
    echo "  ./tools/create-agent backend-dev api --type=generic"
    echo ""
    echo "Available templates:"
    if [[ -d "$TEMPLATE_DIR" ]]; then
        for dir in "$TEMPLATE_DIR"/*/; do
            if [[ -d "$dir" ]]; then
                type_name=$(basename "$dir")
                echo "  - $type_name"
            fi
        done
    else
        echo "  (none - template directory not found)"
    fi
    exit 0
fi

# List types
if [[ "${1:-}" == "--list-types" ]]; then
    echo "Available agent templates:"
    if [[ -d "$TEMPLATE_DIR" ]]; then
        for dir in "$TEMPLATE_DIR"/*/; do
            if [[ -d "$dir" ]]; then
                type_name=$(basename "$dir")
                echo "  - $type_name"
            fi
        done
    else
        echo "  (none - template directory not found)"
    fi
    exit 0
fi

# Parse arguments
AGENTNAME=""
WORKSTREAM=""
AGENT_TYPE="generic"

for arg in "$@"; do
    case $arg in
        --type=*)
            AGENT_TYPE="${arg#*=}"
            ;;
        --*)
            # Skip other options
            ;;
        *)
            if [[ -z "$AGENTNAME" ]]; then
                AGENTNAME="$arg"
            elif [[ -z "$WORKSTREAM" ]]; then
                WORKSTREAM="$arg"
            fi
            ;;
    esac
done

if [ -z "$AGENTNAME" ] || [ -z "$WORKSTREAM" ]; then
  echo "Usage: ./tools/create-agent <agentname> <workstream> [--type=<template>]"
  echo ""
  echo "Examples:"
  echo "  ./tools/create-agent agent-manager agents"
  echo "  ./tools/create-agent ui-specialist web --type=ux-dev"
  echo ""
  echo "Note: Workstream must exist first. Create with:"
  echo "  ./tools/create-workstream <name>"
  echo ""
  echo "Run with --list-types to see available templates."
  exit 1
fi

DIR="claude/agents/$AGENTNAME"
WORKSTREAM_DIR="claude/workstreams/$WORKSTREAM"
TIMESTAMP=$(./tools/now 2>/dev/null || date '+%Y-%m-%d %H:%M')
AGENT_TEMPLATE_DIR="$TEMPLATE_DIR/$AGENT_TYPE"

# Check agent doesn't exist
if [ -d "$DIR" ]; then
  echo "Error: Agent '$AGENTNAME' already exists at $DIR"
  exit 1
fi

# Check workstream exists
if [ ! -d "$WORKSTREAM_DIR" ]; then
  echo "Error: Workstream '$WORKSTREAM' doesn't exist at $WORKSTREAM_DIR"
  echo ""
  echo "Create workstream first: ./tools/create-workstream $WORKSTREAM"
  exit 1
fi

# Check template exists
if [ ! -d "$AGENT_TEMPLATE_DIR" ]; then
  echo "Error: Agent template '$AGENT_TYPE' not found at $AGENT_TEMPLATE_DIR"
  echo ""
  echo "Available templates:"
  for dir in "$TEMPLATE_DIR"/*/; do
      if [[ -d "$dir" ]]; then
          type_name=$(basename "$dir")
          echo "  - $type_name"
      fi
  done
  exit 1
fi

echo "Creating agent: $AGENTNAME (workstream: $WORKSTREAM, type: $AGENT_TYPE)"
mkdir -p "$DIR/backups/latest"
mkdir -p "$DIR/backups/archive"
mkdir -p "$DIR/logs"

# Function to replace placeholders in template
apply_template() {
    local template_file="$1"
    local output_file="$2"

    if [[ -f "$template_file" ]]; then
        sed -e "s/{{AGENT_NAME}}/$AGENTNAME/g" \
            -e "s/{{WORKSTREAM}}/$WORKSTREAM/g" \
            -e "s/{{TIMESTAMP}}/$TIMESTAMP/g" \
            "$template_file" > "$output_file"
    fi
}

# Apply template files
apply_template "$AGENT_TEMPLATE_DIR/agent.md" "$DIR/agent.md"
apply_template "$AGENT_TEMPLATE_DIR/KNOWLEDGE.md" "$DIR/KNOWLEDGE.md"
apply_template "$AGENT_TEMPLATE_DIR/ONBOARDING.md" "$DIR/ONBOARDING.md"

# WORKLOG.md (not templated - standard format)
cat > "$DIR/WORKLOG.md" << EOF
# $AGENTNAME Work Log

## Completed Sprints

(None yet)

## Format

- epic###-sprint### - [Summary] | [Date]
  - Iteration 01: [Description]
EOF

# ADHOC-WORKLOG.md (not templated - standard format)
AGENTNAME_UPPER=$(echo "$AGENTNAME" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
cat > "$DIR/ADHOC-WORKLOG.md" << EOF
# $AGENTNAME Ad-Hoc Work Log

## Latest

(None yet)

---

## Format

## ${AGENTNAME_UPPER}-ADHOC-#### | YYYY-MM-DD HH:MM

**Task:** [Description]
**Status:** Completed
**Files:** [List]
EOF

# IDEAS.md (not templated - standard format)
cat > "$DIR/IDEAS.md" << EOF
# $AGENTNAME Ideas & Observations

### YYYY-MM-DD | I noticed

[Observation]

### YYYY-MM-DD | I have an idea

[Proposal]
**Deferred because:** [Reason]
EOF

# logs/permissions.md (not templated - standard format)
cat > "$DIR/logs/permissions.md" << EOF
# $AGENTNAME Permission Request Log

| Date | Tool | Command | Reason | Outcome |
|------|------|---------|--------|---------|
EOF

# Create agent folder in all principal cloud storage locations
echo ""
for principal_dir in claude/principals/*/; do
  cloud_link="${principal_dir}resources/cloud"
  if [ -L "$cloud_link" ] && [ -d "$cloud_link" ]; then
    agent_cloud_dir="$cloud_link/$AGENTNAME"
    if [ ! -d "$agent_cloud_dir" ]; then
      mkdir -p "$agent_cloud_dir"
      echo "Created cloud folder: $agent_cloud_dir"
    fi
  fi
done

echo ""
echo "Created: $DIR/"
echo "  Template: $AGENT_TYPE"
echo ""
echo "Start with: ./tools/myclaude $WORKSTREAM $AGENTNAME"
