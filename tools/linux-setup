#!/bin/bash
#
# Setup recommended CLI tools for The Agency on Linux
#
# Usage: ./tools/linux-setup [--all]
#
# Supports: apt (Debian/Ubuntu), dnf (Fedora), pacman (Arch)
#

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "linux-setup" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.1-20260114-000006"

# Defaults
VERBOSE=false
INSTALL_ALL=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Parse arguments
for arg in "$@"; do
    case $arg in
        --version|-v)
            echo "linux-setup $TOOL_VERSION"
            exit 0
            ;;
        --verbose)
            VERBOSE=true
            ;;
        --all)
            INSTALL_ALL=true
            ;;
        --help|-h)
            echo "linux-setup - Setup CLI tools for The Agency on Linux"
            echo ""
            echo "Usage: ./tools/linux-setup [--all]"
            echo ""
            echo "Options:"
            echo "  --all          Install all recommended tools (default: essential only)"
            echo "  --verbose      Show verbose output"
            echo "  --version, -v  Show tool version"
            echo "  --help, -h     Show this help"
            exit 0
            ;;
    esac
done

install_tool() {
    local tool="$1"
    local desc="$2"
    local pkg="${PKG_NAMES[$tool]}"

    if command -v "$tool" &> /dev/null; then
        verbose_echo "${GREEN}✓ $tool${NC} - already installed"
    else
        log_step "Installing $tool - $desc"
        $INSTALL_CMD "$pkg"
        echo -e "${GREEN}✓ $tool${NC} - installed"
    fi
}

main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "linux-setup [run: ${RUN_ID:-none}]"

    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  The Agency - Linux Setup${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Detect package manager
    if command -v apt &> /dev/null; then
        PKG_MGR="apt"
        INSTALL_CMD="sudo apt install -y"
    elif command -v dnf &> /dev/null; then
        PKG_MGR="dnf"
        INSTALL_CMD="sudo dnf install -y"
    elif command -v pacman &> /dev/null; then
        PKG_MGR="pacman"
        INSTALL_CMD="sudo pacman -S --noconfirm"
    else
        log_error "No supported package manager found (apt, dnf, pacman)"
        echo "Install these tools manually:"
        echo "  Essential: jq, gh (GitHub CLI), tree"
        echo "  Enhanced:  yq, fzf, bat, ripgrep"
        trap - EXIT
        log_end "$RUN_ID" "failure" 1 0 "No supported package manager"
        exit 1
    fi

    verbose_echo "Detected package manager: ${GREEN}$PKG_MGR${NC}"
    echo ""

    # Package name mapping (some differ by distro)
    declare -A PKG_NAMES
    case $PKG_MGR in
        apt)
            PKG_NAMES=(
                [jq]="jq"
                [gh]="gh"
                [tree]="tree"
                [yq]="yq"
                [fzf]="fzf"
                [bat]="bat"
                [rg]="ripgrep"
            )
            ;;
        dnf)
            PKG_NAMES=(
                [jq]="jq"
                [gh]="gh"
                [tree]="tree"
                [yq]="yq"
                [fzf]="fzf"
                [bat]="bat"
                [rg]="ripgrep"
            )
            ;;
        pacman)
            PKG_NAMES=(
                [jq]="jq"
                [gh]="github-cli"
                [tree]="tree"
                [yq]="yq"
                [fzf]="fzf"
                [bat]="bat"
                [rg]="ripgrep"
            )
            ;;
    esac

    # Essential tools
    echo -e "${BLUE}Essential Tools:${NC}"
    echo ""
    install_tool "jq" "JSON processor"
    install_tool "gh" "GitHub CLI"
    install_tool "tree" "Directory visualization"

    # Enhanced tools if --all
    if [[ "$INSTALL_ALL" == "true" ]]; then
        echo ""
        echo -e "${BLUE}Enhanced Tools:${NC}"
        echo ""
        install_tool "yq" "YAML processor"
        install_tool "fzf" "Fuzzy finder"
        install_tool "bat" "Better cat"
        install_tool "rg" "Fast search (ripgrep)"
    fi

    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  Setup Complete!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    if [[ "$INSTALL_ALL" != "true" ]]; then
        echo "Run with --all to install enhanced tools:"
        echo -e "  ${BLUE}./tools/linux-setup --all${NC}"
        echo ""
    fi

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Linux setup complete"
}

main
