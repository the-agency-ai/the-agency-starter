#!/bin/bash
# secret - CLI for the Secret Service API
#
# Manage secrets, vault, access control, and audit trails.
#
# Usage:
#   ./tools/secret <command> [options]
#
# Vault Commands:
#   vault init                Initialize vault with passphrase
#   vault unlock              Unlock vault with passphrase
#   vault lock                Lock vault
#   vault status              Check vault status
#
# Secret Commands:
#   create <name>             Create a new secret
#   list                      List all secrets
#   get <name>                Fetch decrypted secret value
#   show <name>               Show secret metadata only
#   update <name>             Update secret metadata
#   rotate <name>             Rotate secret value
#   delete <name>             Delete a secret
#
# Tagging:
#   tag <name> --tool=<tool>    Add a tool tag
#   untag <name> --tool=<tool>  Remove a tool tag
#
# Access Control:
#   grant <name>              Grant access to a secret
#   revoke <name>             Revoke access from a secret
#
# Audit:
#   audit <name>              View audit log for a secret
#
# Options:
#   --type=<type>             Secret type (api_key, password, token, certificate, ssh_key, other)
#   --service=<service>       Service name (e.g., GitHub, AWS)
#   --description=<desc>      Description of the secret
#   --tool=<tool>             Tool name for tagging
#   --to=<identity>           Identity to grant access (e.g., agent:housekeeping)
#   --from=<identity>         Identity to revoke access from
#   --permission=<perm>       Permission level (read, use, manage)
#   --json                    Output in JSON format
#   -h, --help                Show this help
#   -v, --version             Show version
#
# Examples:
#   ./tools/secret vault init
#   ./tools/secret create github-token --type=api_key --service=GitHub
#   ./tools/secret list --service=GitHub
#   ./tools/secret get github-token
#   ./tools/secret tag github-token --tool=gh
#   ./tools/secret grant github-token --to=agent:housekeeping --permission=read
#   ./tools/secret audit github-token

set -e

# Tool version
TOOL_VERSION="1.0.0"

# API configuration
API_BASE="${SECRET_SERVICE_URL:-http://localhost:3141/api/secret}"
AGENCY_USER="${AGENCY_USER:-principal:jordan}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Output format
JSON_OUTPUT=false

# Parse global options first
while [[ $# -gt 0 ]]; do
    case $1 in
        --version|-v)
            echo "secret $TOOL_VERSION"
            exit 0
            ;;
        --help|-h)
            head -50 "$0" | tail -49 | sed 's/^# //' | sed 's/^#//'
            exit 0
            ;;
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        *)
            break
            ;;
    esac
done

# Helper: make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"

    local url="${API_BASE}${endpoint}"
    local curl_args=(-s -w "\n%{http_code}" -X "$method" -H "X-Agency-User: $AGENCY_USER")

    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi

    local response
    response=$(curl "${curl_args[@]}" "$url" 2>/dev/null) || {
        echo -e "${RED}Error: Failed to connect to Secret Service at $url${NC}" >&2
        echo "Is the service running? Start it with: npm run dev (in secret-service directory)" >&2
        exit 1
    }

    # Split response and status code
    local body status_code
    body=$(echo "$response" | sed '$d')
    status_code=$(echo "$response" | tail -1)

    # Check for errors
    if [[ "$status_code" -ge 400 ]]; then
        local error_msg
        error_msg=$(echo "$body" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('error','Unknown error'))" 2>/dev/null || echo "$body")
        echo -e "${RED}Error ($status_code): $error_msg${NC}" >&2
        exit 1
    fi

    echo "$body"
}

# Helper: prompt for passphrase
prompt_passphrase() {
    local prompt="${1:-Enter passphrase}"
    local passphrase
    read -s -p "$prompt: " passphrase
    echo >&2
    echo "$passphrase"
}

# Helper: prompt for secret value
prompt_secret_value() {
    local value
    read -s -p "Enter secret value: " value
    echo >&2
    echo "$value"
}

# Helper: format JSON output or pretty print
format_output() {
    local json="$1"
    if [[ "$JSON_OUTPUT" == "true" ]]; then
        echo "$json"
    else
        echo "$json" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if isinstance(data, dict):
        for k, v in data.items():
            if isinstance(v, (dict, list)):
                print(f'{k}: {json.dumps(v, indent=2)}')
            else:
                print(f'{k}: {v}')
    elif isinstance(data, list):
        for item in data:
            if isinstance(item, dict):
                print('---')
                for k, v in item.items():
                    print(f'  {k}: {v}')
            else:
                print(item)
    else:
        print(data)
except:
    print(sys.stdin.read())
" 2>/dev/null || echo "$json"
    fi
}

# Helper: lookup secret ID by name
lookup_secret_id() {
    local name="$1"
    local response
    response=$(api_request GET "/list")

    local id
    id=$(echo "$response" | python3 -c "
import sys, json
data = json.load(sys.stdin)
secrets = data.get('secrets', [])
name = '$name'
for s in secrets:
    if s.get('name') == name:
        print(s.get('id'))
        break
" 2>/dev/null)

    if [[ -z "$id" ]]; then
        echo -e "${RED}Error: Secret '$name' not found${NC}" >&2
        exit 1
    fi

    echo "$id"
}

# Command: vault
cmd_vault() {
    local action="${1:-}"
    shift || true

    case "$action" in
        init)
            echo -e "${BLUE}Initializing vault...${NC}"
            local passphrase
            passphrase=$(prompt_passphrase "Enter new vault passphrase")
            local confirm
            confirm=$(prompt_passphrase "Confirm passphrase")

            if [[ "$passphrase" != "$confirm" ]]; then
                echo -e "${RED}Error: Passphrases do not match${NC}"
                exit 1
            fi

            local data
            data=$(python3 -c "import json; print(json.dumps({'passphrase': '$passphrase'}))")
            local response
            response=$(api_request POST "/vault/init" "$data")
            echo -e "${GREEN}Vault initialized successfully${NC}"
            format_output "$response"
            ;;

        unlock)
            local passphrase
            passphrase=$(prompt_passphrase "Enter vault passphrase")

            local data
            data=$(python3 -c "import json; print(json.dumps({'passphrase': '$passphrase'}))")
            local response
            response=$(api_request POST "/vault/unlock" "$data")
            echo -e "${GREEN}Vault unlocked${NC}"
            ;;

        lock)
            local response
            response=$(api_request POST "/vault/lock" "{}")
            echo -e "${GREEN}Vault locked${NC}"
            ;;

        status)
            local response
            response=$(api_request GET "/vault/status")
            format_output "$response"
            ;;

        *)
            echo "Usage: secret vault <init|unlock|lock|status>"
            exit 1
            ;;
    esac
}

# Command: create
cmd_create() {
    local name="${1:-}"
    shift || true

    if [[ -z "$name" ]]; then
        echo "Usage: secret create <name> [--type=...] [--service=...] [--description=...]"
        exit 1
    fi

    # Parse options
    local type="other"
    local service=""
    local description=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --type=*)
                type="${1#*=}"
                shift
                ;;
            --service=*)
                service="${1#*=}"
                shift
                ;;
            --description=*)
                description="${1#*=}"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    # Prompt for secret value
    local value
    value=$(prompt_secret_value)

    # Build JSON payload
    local data
    data=$(python3 -c "
import json
payload = {
    'name': '$name',
    'value': '$value',
    'type': '$type'
}
if '$service':
    payload['service'] = '$service'
if '$description':
    payload['description'] = '$description'
print(json.dumps(payload))
")

    local response
    response=$(api_request POST "/create" "$data")
    echo -e "${GREEN}Secret created: $name${NC}"
    format_output "$response"
}

# Command: list
cmd_list() {
    local service=""
    local type=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --service=*)
                service="${1#*=}"
                shift
                ;;
            --type=*)
                type="${1#*=}"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    local response
    response=$(api_request GET "/list")

    # Filter if needed
    if [[ -n "$service" || -n "$type" ]]; then
        response=$(echo "$response" | python3 -c "
import sys, json
data = json.load(sys.stdin)
secrets = data.get('secrets', [])
service_filter = '$service'
type_filter = '$type'

filtered = []
for s in secrets:
    if service_filter and s.get('service') != service_filter:
        continue
    if type_filter and s.get('type') != type_filter:
        continue
    filtered.append(s)

print(json.dumps({'secrets': filtered}))
")
    fi

    if [[ "$JSON_OUTPUT" == "true" ]]; then
        echo "$response"
    else
        echo "$response" | python3 -c "
import sys, json
data = json.load(sys.stdin)
secrets = data.get('secrets', [])
if not secrets:
    print('No secrets found')
else:
    print(f'Found {len(secrets)} secret(s):')
    print()
    for s in secrets:
        name = s.get('name', 'unknown')
        stype = s.get('type', 'other')
        service = s.get('service', '-')
        created = s.get('createdAt', '-')[:10] if s.get('createdAt') else '-'
        print(f'  {name}')
        print(f'    Type: {stype} | Service: {service} | Created: {created}')
"
    fi
}

# Command: get (fetch decrypted value)
cmd_get() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo "Usage: secret get <name>"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    local response
    response=$(api_request GET "/fetch/$id")

    if [[ "$JSON_OUTPUT" == "true" ]]; then
        echo "$response"
    else
        echo "$response" | python3 -c "
import sys, json
data = json.load(sys.stdin)
value = data.get('value', '')
print(value)
"
    fi
}

# Command: show (metadata only)
cmd_show() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo "Usage: secret show <name>"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    local response
    response=$(api_request GET "/get/$id")
    format_output "$response"
}

# Command: update
cmd_update() {
    local name="${1:-}"
    shift || true

    if [[ -z "$name" ]]; then
        echo "Usage: secret update <name> [--description=...]"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    # Parse options
    local description=""
    local service=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --description=*)
                description="${1#*=}"
                shift
                ;;
            --service=*)
                service="${1#*=}"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    # Build JSON payload
    local data
    data=$(python3 -c "
import json
payload = {}
if '$description':
    payload['description'] = '$description'
if '$service':
    payload['service'] = '$service'
print(json.dumps(payload))
")

    local response
    response=$(api_request POST "/update/$id" "$data")
    echo -e "${GREEN}Secret updated: $name${NC}"
    format_output "$response"
}

# Command: rotate
cmd_rotate() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo "Usage: secret rotate <name>"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    # Prompt for new value
    local value
    value=$(prompt_secret_value)

    local data
    data=$(python3 -c "import json; print(json.dumps({'value': '$value'}))")

    local response
    response=$(api_request POST "/rotate/$id" "$data")
    echo -e "${GREEN}Secret rotated: $name${NC}"
    format_output "$response"
}

# Command: delete
cmd_delete() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo "Usage: secret delete <name>"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    # Confirm deletion
    read -p "Are you sure you want to delete '$name'? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled"
        exit 0
    fi

    local response
    response=$(api_request POST "/delete/$id" "{}")
    echo -e "${GREEN}Secret deleted: $name${NC}"
}

# Command: tag
cmd_tag() {
    local name="${1:-}"
    shift || true

    if [[ -z "$name" ]]; then
        echo "Usage: secret tag <name> --tool=<tool>"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    # Parse options
    local tool=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --tool=*)
                tool="${1#*=}"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    if [[ -z "$tool" ]]; then
        echo "Usage: secret tag <name> --tool=<tool>"
        exit 1
    fi

    local data
    data=$(python3 -c "import json; print(json.dumps({'tag': 'tool:$tool'}))")

    local response
    response=$(api_request POST "/tag/$id" "$data")
    echo -e "${GREEN}Tag 'tool:$tool' added to $name${NC}"
}

# Command: untag
cmd_untag() {
    local name="${1:-}"
    shift || true

    if [[ -z "$name" ]]; then
        echo "Usage: secret untag <name> --tool=<tool>"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    # Parse options
    local tool=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --tool=*)
                tool="${1#*=}"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    if [[ -z "$tool" ]]; then
        echo "Usage: secret untag <name> --tool=<tool>"
        exit 1
    fi

    local data
    data=$(python3 -c "import json; print(json.dumps({'tag': 'tool:$tool'}))")

    local response
    response=$(api_request POST "/untag/$id" "$data")
    echo -e "${GREEN}Tag 'tool:$tool' removed from $name${NC}"
}

# Command: grant
cmd_grant() {
    local name="${1:-}"
    shift || true

    if [[ -z "$name" ]]; then
        echo "Usage: secret grant <name> --to=<identity> --permission=<perm>"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    # Parse options
    local to=""
    local permission="read"

    while [[ $# -gt 0 ]]; do
        case $1 in
            --to=*)
                to="${1#*=}"
                shift
                ;;
            --permission=*)
                permission="${1#*=}"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    if [[ -z "$to" ]]; then
        echo "Usage: secret grant <name> --to=<identity> --permission=<perm>"
        echo "Example: secret grant my-secret --to=agent:housekeeping --permission=read"
        exit 1
    fi

    local data
    data=$(python3 -c "import json; print(json.dumps({'identity': '$to', 'permission': '$permission'}))")

    local response
    response=$(api_request POST "/grant/$id" "$data")
    echo -e "${GREEN}Granted '$permission' access to '$to' for $name${NC}"
}

# Command: revoke
cmd_revoke() {
    local name="${1:-}"
    shift || true

    if [[ -z "$name" ]]; then
        echo "Usage: secret revoke <name> --from=<identity>"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    # Parse options
    local from=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --from=*)
                from="${1#*=}"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    if [[ -z "$from" ]]; then
        echo "Usage: secret revoke <name> --from=<identity>"
        echo "Example: secret revoke my-secret --from=agent:housekeeping"
        exit 1
    fi

    local data
    data=$(python3 -c "import json; print(json.dumps({'identity': '$from'}))")

    local response
    response=$(api_request POST "/revoke/$id" "$data")
    echo -e "${GREEN}Revoked access from '$from' for $name${NC}"
}

# Command: audit
cmd_audit() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo "Usage: secret audit <name>"
        exit 1
    fi

    local id
    id=$(lookup_secret_id "$name")

    local response
    response=$(api_request GET "/audit/$id")

    if [[ "$JSON_OUTPUT" == "true" ]]; then
        echo "$response"
    else
        echo -e "${CYAN}Audit log for: $name${NC}"
        echo
        echo "$response" | python3 -c "
import sys, json
data = json.load(sys.stdin)
entries = data.get('entries', [])
if not entries:
    print('No audit entries found')
else:
    for e in entries:
        ts = e.get('timestamp', '-')[:19].replace('T', ' ')
        action = e.get('action', '-')
        actor = e.get('actor', '-')
        details = e.get('details', '')
        print(f'  [{ts}] {action} by {actor}')
        if details:
            print(f'    {details}')
"
    fi
}

# Main command dispatch
COMMAND="${1:-}"
shift || true

case "$COMMAND" in
    vault)
        cmd_vault "$@"
        ;;
    create)
        cmd_create "$@"
        ;;
    list)
        cmd_list "$@"
        ;;
    get)
        cmd_get "$@"
        ;;
    show)
        cmd_show "$@"
        ;;
    update)
        cmd_update "$@"
        ;;
    rotate)
        cmd_rotate "$@"
        ;;
    delete)
        cmd_delete "$@"
        ;;
    tag)
        cmd_tag "$@"
        ;;
    untag)
        cmd_untag "$@"
        ;;
    grant)
        cmd_grant "$@"
        ;;
    revoke)
        cmd_revoke "$@"
        ;;
    audit)
        cmd_audit "$@"
        ;;
    ""|help|--help|-h)
        head -50 "$0" | tail -49 | sed 's/^# //' | sed 's/^#//'
        ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        echo "Use: ./tools/secret --help"
        exit 1
        ;;
esac
