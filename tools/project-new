#!/bin/bash
#
# project-new - Create a new project from The Agency Starter
#
# Usage:
#   project-new my-app                    # Creates ./my-app
#   project-new ~/code/my-app             # Creates at specific path
#   project-new my-app --no-launch        # Don't launch housekeeping after
#   project-new my-app --verbose          # Show detailed logging
#

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.2.0-20260114-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Defaults
NO_LAUNCH=false
VERBOSE=false

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "project-new $TOOL_VERSION"
    exit 0
fi

# Get the starter directory (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
STARTER_DIR="$(dirname "$SCRIPT_DIR")"

# Parse arguments
PROJECT_PATH=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --no-launch)
            NO_LAUNCH=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            echo "Usage: project-new <project-name-or-path> [options]"
            echo ""
            echo "Options:"
            echo "  --no-launch    Don't launch housekeeping after creation"
            echo "  --verbose      Show detailed logging"
            echo "  -h, --help     Show this help"
            echo ""
            echo "Examples:"
            echo "  project-new my-app              # Creates ./my-app"
            echo "  project-new ~/code/my-app       # Creates at ~/code/my-app"
            echo "  project-new my-app --no-launch  # Create without launching"
            exit 0
            ;;
        *)
            if [ -z "$PROJECT_PATH" ]; then
                PROJECT_PATH="$1"
            else
                log_error "Unknown argument: $1"
                exit 1
            fi
            shift
            ;;
    esac
done

# Require project path
if [ -z "$PROJECT_PATH" ]; then
    log_error "Project name or path required"
    echo ""
    echo "Usage: project-new <project-name-or-path> [--verbose]"
    echo ""
    echo "Examples:"
    echo "  project-new my-app"
    echo "  project-new ~/code/my-app"
    exit 1
fi

# Resolve to absolute path
if [[ "$PROJECT_PATH" != /* ]]; then
    PROJECT_PATH="$(pwd)/$PROJECT_PATH"
fi

PROJECT_NAME="$(basename "$PROJECT_PATH")"

# Validate project name
if [[ ! "$PROJECT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    log_error "Invalid project name: $PROJECT_NAME"
    echo "Use only letters, numbers, hyphens, and underscores."
    exit 1
fi

# Check if directory exists
if [ -d "$PROJECT_PATH" ]; then
    log_error "Directory already exists: $PROJECT_PATH"
    echo "Please choose a different name or remove the existing directory."
    exit 1
fi

# Main function
main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    RUN_ID=$(log_start "project-new" "agency-tool" "$@" 2>/dev/null) || true
    echo "project-new [run: ${RUN_ID:-none}]"

    # Banner
    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  Creating New Agency Project${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "Project: ${GREEN}$PROJECT_NAME${NC}"
    echo -e "Path:    ${GREEN}$PROJECT_PATH${NC}"
    echo ""

    # Create project directory
    log_step "Creating project directory..."
    mkdir -p "$PROJECT_PATH"

    # Copy starter files (excluding git, node_modules, build artifacts, the SDK itself)
    log_step "Copying starter files..."
    rsync -a \
        --exclude='.git' \
        --exclude='node_modules' \
        --exclude='.next' \
        --exclude='target' \
        --exclude='dist' \
        --exclude='*.dmg' \
        --exclude='*.app' \
        --exclude='.DS_Store' \
        "$STARTER_DIR/" "$PROJECT_PATH/"

    cd "$PROJECT_PATH"

    # Initialize fresh git repo
    log_step "Initializing git repository..."
    git init --quiet
    git add -A
    git commit -m "Initial commit from The Agency Starter" --quiet

    # Make tools executable
    chmod +x tools/* 2>/dev/null || true

    # Configure principal with current user
    SYSTEM_USER=$(whoami)
    log_step "Configuring for user: $SYSTEM_USER"
    if [ -f "claude/config/agency.yaml" ]; then
        sed -i.bak "s/your_username: YourName/$SYSTEM_USER: $SYSTEM_USER/" claude/config/agency.yaml 2>/dev/null || \
        sed -i '' "s/your_username: YourName/$SYSTEM_USER: $SYSTEM_USER/" claude/config/agency.yaml
        rm -f claude/config/agency.yaml.bak
    fi

    # Get starter version
    STARTER_VERSION="unknown"
    if [[ -f "$STARTER_DIR/VERSION" ]]; then
        STARTER_VERSION=$(cat "$STARTER_DIR/VERSION" | tr -d '[:space:]')
    fi
    NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    # Generate manifest.json
    log_step "Generating project manifest..."
    mkdir -p .agency

    # Build components JSON from registry.json
    COMPONENTS_JSON=""
    if [[ -f "$STARTER_DIR/registry.json" ]]; then
        # Extract component names and versions from registry.json
        COMPONENTS_JSON=$(cat "$STARTER_DIR/registry.json" | python3 -c "
import json, sys
data = json.load(sys.stdin)
components = {}
for name, info in data.get('components', {}).items():
    components[name] = {
        'version': info.get('version', 'unknown'),
        'status': 'installed',
        'dependencies': 'pending' if info.get('install_hook') else 'none',
        'installed_at': '$NOW'
    }
print(json.dumps(components, indent=4))
" 2>/dev/null) || COMPONENTS_JSON='{}'
    else
        COMPONENTS_JSON='{}'
    fi

    cat > .agency/manifest.json << EOF
{
  "schema_version": "1.0",
  "project": {
    "name": "$PROJECT_NAME",
    "created_at": "$NOW",
    "starter_version": "$STARTER_VERSION"
  },
  "source": {
    "type": "local",
    "path": "$STARTER_DIR"
  },
  "components": $COMPONENTS_JSON,
  "files": {}
}
EOF
    verbose_echo "  Project manifest created: .agency/manifest.json"

    # Register project in starter's projects.json
    log_step "Registering project in starter..."
    STARTER_PROJECTS_FILE="$STARTER_DIR/.agency/projects.json"
    mkdir -p "$STARTER_DIR/.agency"

    if [[ ! -f "$STARTER_PROJECTS_FILE" ]]; then
        # Create new projects.json
        cat > "$STARTER_PROJECTS_FILE" << EOF
{
  "schema_version": "1.0",
  "projects": []
}
EOF
    fi

    # Add project to registry using python for safe JSON manipulation
    python3 << EOF
import json

projects_file = "$STARTER_PROJECTS_FILE"
with open(projects_file, 'r') as f:
    data = json.load(f)

# Add new project
new_project = {
    "name": "$PROJECT_NAME",
    "path": "$PROJECT_PATH",
    "created_at": "$NOW",
    "starter_version": "$STARTER_VERSION",
    "status": "current"
}
data['projects'].append(new_project)

with open(projects_file, 'w') as f:
    json.dump(data, f, indent=2)
EOF
    verbose_echo "  Project registered in starter"

    # Run install hooks for components that have them
    log_step "Running component install hooks..."
    if [[ -f "$STARTER_DIR/registry.json" ]]; then
        # Extract and run install hooks
        python3 << EOF
import json
import subprocess
import os

with open("$STARTER_DIR/registry.json", 'r') as f:
    data = json.load(f)

project_path = "$PROJECT_PATH"
verbose = "$VERBOSE" == "true"

for name, info in data.get('components', {}).items():
    hook = info.get('install_hook')
    if hook:
        if verbose:
            print(f"  Running install hook for {name}...")
        # Run hook in project directory
        try:
            result = subprocess.run(
                hook,
                shell=True,
                cwd=project_path,
                capture_output=True,
                text=True
            )
            if result.returncode == 0:
                if verbose:
                    print(f"    {name}: install hook completed")
                # Update manifest to mark dependencies as installed
                manifest_path = os.path.join(project_path, '.agency/manifest.json')
                with open(manifest_path, 'r') as f:
                    manifest = json.load(f)
                if name in manifest.get('components', {}):
                    manifest['components'][name]['dependencies'] = 'installed'
                with open(manifest_path, 'w') as f:
                    json.dump(manifest, f, indent=2)
            else:
                if verbose:
                    print(f"    {name}: install hook failed (non-fatal)")
                    print(f"    stderr: {result.stderr[:200] if result.stderr else 'none'}")
        except Exception as e:
            if verbose:
                print(f"    {name}: install hook error: {e}")
EOF
    fi
    verbose_echo "  Install hooks completed"

    # Success
    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  Project Created!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "Your project is ready at: ${GREEN}$PROJECT_PATH${NC}"
    echo ""

    if [ "$NO_LAUNCH" = true ]; then
        echo "To get started:"
        echo ""
        echo -e "  ${BLUE}cd $PROJECT_PATH${NC}"
        echo -e "  ${BLUE}./tools/myclaude housekeeping captain${NC}"
        echo ""
        echo "Then type: /welcome"
        echo ""
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "Project $PROJECT_NAME created (no-launch)"
    else
        # Ask if they want to launch now
        echo -e "${BLUE}Ready to meet your first agent?${NC}"
        echo ""

        read -p "Launch housekeeping now? [Y/n] " launch_now 2>/dev/null || launch_now="Y"
        launch_now=${launch_now:-Y}

        if [[ "$launch_now" =~ ^[Yy]$ ]]; then
            echo ""
            log_info "Launching housekeeping agent..."
            echo ""
            echo "Once inside, type: /welcome"
            echo ""
            sleep 1

            trap - EXIT
            log_end "$RUN_ID" "success" 0 0 "Project $PROJECT_NAME created, launching agent"

            # Launch myclaude
            exec ./tools/myclaude housekeeping captain
        else
            echo ""
            echo "When you're ready:"
            echo ""
            echo -e "  ${BLUE}cd $PROJECT_PATH${NC}"
            echo -e "  ${BLUE}./tools/myclaude housekeeping captain${NC}"
            echo ""
            echo "Then type: /welcome"
            echo ""
            trap - EXIT
            log_end "$RUN_ID" "success" 0 0 "Project $PROJECT_NAME created"
        fi
    fi
}

main
