#!/bin/bash
#
# dependencies-check - Verify all Agency dependencies are installed
#
# Usage:
#   dependencies-check              # Check all dependencies
#   dependencies-check --verbose    # Show detailed output
#   dependencies-check --fix        # Attempt to install missing deps
#

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.0.0-20260118-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Defaults
VERBOSE=false
FIX=false
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
DEPS_FILE="$PROJECT_ROOT/claude/config/agency-dependencies.yaml"

# Logging functions
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

usage() {
    cat << EOF
Usage: dependencies-check [options]

Verify all Agency dependencies are installed.

Options:
  --fix            Attempt to install missing dependencies
  --verbose        Show detailed output
  -v, --version    Show version
  -h, --help       Show this help

Examples:
  dependencies-check              # Check all
  dependencies-check --verbose    # Detailed output
  dependencies-check --fix        # Install missing deps
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --fix)
            FIX=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -v|--version)
            echo "dependencies-check $TOOL_VERSION"
            exit 0
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Check if yq is available (needed to parse yaml)
if ! command -v yq &> /dev/null; then
    log_error "yq is required but not installed."
    echo ""
    echo "Install yq first:"
    if [[ "$(uname)" == "Darwin" ]]; then
        echo "  brew install yq"
    else
        echo "  sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
        echo "  sudo chmod +x /usr/local/bin/yq"
    fi
    exit 1
fi

# Check if dependencies file exists
if [[ ! -f "$DEPS_FILE" ]]; then
    log_error "Dependencies file not found: $DEPS_FILE"
    exit 1
fi

main() {
    RUN_ID=$(log_start "dependencies-check" "agency-tool" "$@" 2>/dev/null) || true
    echo "dependencies-check [run: ${RUN_ID:-none}]"

    local missing=0
    local installed=0
    local total=0
    local platform

    # Detect platform
    if [[ "$(uname)" == "Darwin" ]]; then
        platform="darwin"
    else
        platform="linux"
    fi

    verbose_echo ""
    verbose_echo "Checking Agency dependencies..."
    verbose_echo ""

    # Get number of dependencies
    total=$(yq '.dependencies | length' "$DEPS_FILE")

    # Check each dependency
    for i in $(seq 0 $((total - 1))); do
        local name=$(yq ".dependencies[$i].name" "$DEPS_FILE")
        local check_cmd=$(yq ".dependencies[$i].check" "$DEPS_FILE")
        local min_version=$(yq ".dependencies[$i].min_version // \"\"" "$DEPS_FILE")
        local version_cmd=$(yq ".dependencies[$i].version_cmd // \"\"" "$DEPS_FILE")
        local breaks=$(yq ".dependencies[$i].breaks" "$DEPS_FILE")

        # Check if installed
        if eval "$check_cmd" &> /dev/null; then
            # Check version if required
            if [[ -n "$min_version" ]] && [[ -n "$version_cmd" ]]; then
                local current_version=$(eval "$version_cmd" 2>/dev/null || echo "0.0")

                # Simple version comparison (major.minor)
                local min_major=$(echo "$min_version" | cut -d. -f1)
                local min_minor=$(echo "$min_version" | cut -d. -f2)
                local cur_major=$(echo "$current_version" | cut -d. -f1)
                local cur_minor=$(echo "$current_version" | cut -d. -f2)

                if [[ "$cur_major" -lt "$min_major" ]] || \
                   [[ "$cur_major" -eq "$min_major" && "$cur_minor" -lt "$min_minor" ]]; then
                    if [[ "$VERBOSE" == "true" ]]; then
                        echo -e "  ${YELLOW}⚠${NC} $name: version $current_version < $min_version"
                    fi
                    ((missing++))
                else
                    if [[ "$VERBOSE" == "true" ]]; then
                        echo -e "  ${GREEN}✓${NC} $name ($current_version)"
                    fi
                    ((installed++))
                fi
            else
                if [[ "$VERBOSE" == "true" ]]; then
                    echo -e "  ${GREEN}✓${NC} $name"
                fi
                ((installed++))
            fi
        else
            if [[ "$VERBOSE" == "true" ]]; then
                echo -e "  ${RED}✗${NC} $name - missing (breaks: $breaks)"
            fi
            ((missing++))

            # Try to fix if requested
            if [[ "$FIX" == "true" ]]; then
                local install_cmd=$(yq ".dependencies[$i].install.$platform // .dependencies[$i].install.all // \"\"" "$DEPS_FILE")
                if [[ -n "$install_cmd" ]]; then
                    echo "  Installing $name..."
                    if eval "$install_cmd"; then
                        echo -e "  ${GREEN}✓${NC} $name installed"
                        ((missing--))
                        ((installed++))
                    else
                        echo -e "  ${RED}✗${NC} Failed to install $name"
                    fi
                fi
            fi
        fi
    done

    echo ""
    if [[ $missing -eq 0 ]]; then
        echo -e "${GREEN}✓${NC} All $total dependencies installed"
        log_end "$RUN_ID" "success" 0 0 "All $total dependencies OK" 2>/dev/null || true
        exit 0
    else
        echo -e "${RED}✗${NC} $missing of $total dependencies missing"
        echo ""
        if [[ "$FIX" != "true" ]]; then
            echo "Run with --fix to attempt installation:"
            echo "  ./tools/dependencies-check --fix"
        fi
        log_end "$RUN_ID" "failure" 1 0 "$missing dependencies missing" 2>/dev/null || true
        exit 1
    fi
}

main "$@"
