#!/bin/bash
# starter-cleanup - Clean up starter test artifacts
#
# Usage:
#   ./tools/starter-cleanup           # Clean test directory
#   ./tools/starter-cleanup --all     # Clean all test artifacts

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "starter-cleanup" "agency-tool" "$@" 2>/dev/null) || true

TOOL_VERSION="1.0.0-20260114-000003"

# Defaults
VERBOSE=false

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEST_DIR="$(dirname "$PROJECT_ROOT")/test/starter-test-run"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Main
main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "starter-cleanup [run: ${RUN_ID:-none}]"

    case "${1:-}" in
        --version|-v)
            echo "starter-cleanup $TOOL_VERSION"
            ;;
        --help|-h)
            echo "starter-cleanup - Clean up starter test artifacts"
            echo ""
            echo "Usage:"
            echo "  ./tools/starter-cleanup           # Clean test directory"
            echo "  ./tools/starter-cleanup --all     # Clean all test artifacts"
            echo "  ./tools/starter-cleanup --verbose # Show detailed output"
            ;;
        --verbose)
            VERBOSE=true
            main "${@:2}"
            return
            ;;
        --all|-a)
            log_step "Cleaning all test artifacts..."
            # Only remove directories that are clearly test artifacts
            for dir in "starter-test-run" "test-install" "the-agency-starter"; do
                local target="$PROJECT_ROOT/test/$dir"
                if [[ -d "$target" ]]; then
                    rm -rf "$target"
                    verbose_echo "  Removed: $target"
                fi
            done
            verbose_echo -e "${GREEN}Done.${NC}"
            ;;
        *)
            log_step "Cleaning starter-test artifacts..."
            # Safety check: ensure TEST_DIR is within expected boundaries
            if [[ -z "$TEST_DIR" || "$TEST_DIR" != *"/test/"* ]]; then
                log_error "Refusing to remove non-test directory: $TEST_DIR"
                exit 1
            fi
            if [[ -d "$TEST_DIR" ]]; then
                rm -rf "$TEST_DIR"
                verbose_echo -e "${GREEN}Removed: $TEST_DIR${NC}"
            else
                verbose_echo "Nothing to clean."
            fi
            ;;
    esac

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Cleanup complete" 2>/dev/null || true
}

main "$@"
