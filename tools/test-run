#!/bin/bash
# Run unit tests only (skip integration tests)
#
# Usage: ./tools/test-run
#
# Why this exists:
#   Integration tests are slow and require API keys/servers
#   Unit tests are fast and self-contained
#   Pre-commit should be fast (< 30s)
#
# How it works:
#   Sets CI=true which triggers describe.skipIf(CI) in integration tests
#   Runs test command across all packages
#   Integration tests automatically skip
#
# Configure in package.json:
#   "scripts": { "test": "vitest run" }

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "test-run" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "test-run $TOOL_VERSION"
    exit 0
fi

# Help
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  sed -n '2,15p' "$0" | sed 's/^# //' | sed 's/^#//'
  exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

echo "Running unit tests (integration tests will be skipped)..."
echo ""

# Set CI=true to skip integration tests (describe.skipIf(CI))
export CI=true

# Detect package manager and run tests
if [ -f "pnpm-lock.yaml" ]; then
  # pnpm monorepo
  if pnpm test 2>&1 | grep -E "(PASS|FAIL|Test Files|Tests|Duration|✓|✗)"; then
    echo ""
    echo "✓ All unit tests passed"
    exit 0
  else
    echo ""
    echo "❌ Tests failed - see output above"
    exit 1
  fi
elif [ -f "yarn.lock" ]; then
  # yarn
  yarn test
elif [ -f "package-lock.json" ]; then
  # npm
  npm test
else
  echo "No package manager lock file found"
  echo "Skipping unit tests"
  exit 0
fi
