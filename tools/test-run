#!/bin/bash
# Run unit tests only (skip integration tests)
#
# Usage: ./tools/test-run [--verbose]
#
# Why this exists:
#   Integration tests are slow and require API keys/servers
#   Unit tests are fast and self-contained
#   Pre-commit should be fast (< 30s)
#
# How it works:
#   Sets CI=true which triggers describe.skipIf(CI) in integration tests
#   Runs test command across all packages
#   Integration tests automatically skip
#
# Configure in package.json:
#   "scripts": { "test": "vitest run" }

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.1.0-20260114-000010"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Defaults
VERBOSE=false

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "test-run $TOOL_VERSION"
    exit 0
fi

# Help
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  sed -n '2,15p' "$0" | sed 's/^# //' | sed 's/^#//'
  exit 0
fi

# Parse arguments
for arg in "$@"; do
    case $arg in
        --verbose)
            VERBOSE=true
            ;;
    esac
done

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

# Main function
main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    RUN_ID=$(log_start "test-run" "agency-tool" "$@" 2>/dev/null) || true
    echo "test-run [run: ${RUN_ID:-none}]"

    log_step "Running unit tests (integration tests will be skipped)..."
    echo ""

    # Set CI=true to skip integration tests (describe.skipIf(CI))
    export CI=true

    # Detect package manager and run tests
    if [ -f "pnpm-lock.yaml" ]; then
      # pnpm monorepo
      if pnpm test 2>&1 | grep -E "(PASS|FAIL|Test Files|Tests|Duration|✓|✗)"; then
        echo ""
        echo "✓ All unit tests passed"
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "All unit tests passed"
        exit 0
      else
        echo ""
        log_error "Tests failed - see output above"
        trap - EXIT
        log_end "$RUN_ID" "failure" 1 0 "Tests failed"
        exit 1
      fi
    elif [ -f "yarn.lock" ]; then
      # yarn
      yarn test
      TEST_EXIT=$?
      trap - EXIT
      if [ $TEST_EXIT -eq 0 ]; then
        log_end "$RUN_ID" "success" 0 0 "All unit tests passed"
      else
        log_end "$RUN_ID" "failure" $TEST_EXIT 0 "Tests failed"
      fi
      exit $TEST_EXIT
    elif [ -f "package-lock.json" ]; then
      # npm - check if test script exists first
      TEST_OUTPUT=$(npm test 2>&1) || true
      TEST_EXIT=$?

      if echo "$TEST_OUTPUT" | grep -q "Missing script"; then
        echo "No tests configured"
        echo "✓"
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "No tests to run"
        exit 0
      fi

      trap - EXIT
      if [ $TEST_EXIT -eq 0 ]; then
        echo "✓"
        log_end "$RUN_ID" "success" 0 ${#TEST_OUTPUT} "All unit tests passed"
      else
        echo "✗"
        log_end "$RUN_ID" "failure" $TEST_EXIT ${#TEST_OUTPUT} "Tests failed"
        # Verbose output available via: ./tools/agency-service log run $RUN_ID
      fi
      exit $TEST_EXIT
    else
      log_warn "No package manager lock file found"
      log_warn "Skipping unit tests"
      trap - EXIT
      log_end "$RUN_ID" "success" 0 0 "No tests to run"
      exit 0
    fi
}

main
