#!/bin/bash
# Log tool use from Claude Code PostToolUse hook
#
# This script receives JSON via stdin from Claude Code's PostToolUse hook
# and logs the execution to the agency-service database.
#
# Usage: Called automatically by PostToolUse hook
#
# Input (via stdin):
#   {
#     "session_id": "...",
#     "tool_name": "Bash",
#     "tool_input": { "command": "...", "description": "..." },
#     "tool_response": { "exitCode": 0, "stdout": "...", "stderr": "..." }
#   }

# Fail silently - don't break Claude Code if logging fails
set +e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_SERVICE_URL="${LOG_SERVICE_URL:-http://127.0.0.1:3141}"

# Read JSON from stdin
INPUT=$(cat)

# Check if input is empty
if [ -z "$INPUT" ]; then
    exit 0
fi

# Extract fields using jq (silently fail if not available)
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // empty' 2>/dev/null)
if [ -z "$TOOL_NAME" ]; then
    exit 0
fi

# Extract common fields
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id // empty' 2>/dev/null)

# Handle different tool types
case "$TOOL_NAME" in
    Bash)
        COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command // empty' 2>/dev/null)
        DESCRIPTION=$(echo "$INPUT" | jq -r '.tool_input.description // empty' 2>/dev/null)
        EXIT_CODE=$(echo "$INPUT" | jq -r '.tool_response.exitCode // 0' 2>/dev/null)
        SUMMARY="$DESCRIPTION"
        ;;
    Read)
        COMMAND=$(echo "$INPUT" | jq -r '.tool_input.file_path // empty' 2>/dev/null)
        DESCRIPTION="Read file"
        EXIT_CODE=0
        SUMMARY="$COMMAND"
        ;;
    Write)
        COMMAND=$(echo "$INPUT" | jq -r '.tool_input.file_path // empty' 2>/dev/null)
        DESCRIPTION="Write file"
        EXIT_CODE=0
        SUMMARY="$COMMAND"
        ;;
    Edit)
        COMMAND=$(echo "$INPUT" | jq -r '.tool_input.file_path // empty' 2>/dev/null)
        DESCRIPTION="Edit file"
        EXIT_CODE=0
        SUMMARY="$COMMAND"
        ;;
    Glob|Grep)
        COMMAND=$(echo "$INPUT" | jq -r '.tool_input.pattern // empty' 2>/dev/null)
        DESCRIPTION="Search: $COMMAND"
        EXIT_CODE=0
        SUMMARY="$COMMAND"
        ;;
    Task)
        COMMAND=$(echo "$INPUT" | jq -r '.tool_input.subagent_type // empty' 2>/dev/null)
        PROMPT=$(echo "$INPUT" | jq -r '.tool_input.prompt // empty' 2>/dev/null | head -c 100)
        DESCRIPTION="Spawn $COMMAND subagent"
        EXIT_CODE=0
        SUMMARY="$COMMAND: ${PROMPT}..."
        ;;
    WebFetch)
        COMMAND=$(echo "$INPUT" | jq -r '.tool_input.url // empty' 2>/dev/null)
        DESCRIPTION="Fetch URL"
        EXIT_CODE=0
        SUMMARY="$COMMAND"
        ;;
    WebSearch)
        COMMAND=$(echo "$INPUT" | jq -r '.tool_input.query // empty' 2>/dev/null)
        DESCRIPTION="Web search"
        EXIT_CODE=0
        SUMMARY="$COMMAND"
        ;;
    TodoWrite)
        TODO_COUNT=$(echo "$INPUT" | jq -r '.tool_input.todos | length // 0' 2>/dev/null)
        COMMAND="$TODO_COUNT todos"
        DESCRIPTION="Update todos"
        EXIT_CODE=0
        SUMMARY="$TODO_COUNT items"
        ;;
    NotebookEdit)
        COMMAND=$(echo "$INPUT" | jq -r '.tool_input.notebook_path // empty' 2>/dev/null)
        DESCRIPTION="Edit notebook"
        EXIT_CODE=0
        SUMMARY="$COMMAND"
        ;;
    AskUserQuestion)
        QUESTION=$(echo "$INPUT" | jq -r '.tool_input.questions[0].question // empty' 2>/dev/null | head -c 100)
        COMMAND="question"
        DESCRIPTION="Ask user"
        EXIT_CODE=0
        SUMMARY="${QUESTION}..."
        ;;
    *)
        # Log other tools with basic info
        COMMAND="$TOOL_NAME"
        DESCRIPTION="Tool use"
        EXIT_CODE=0
        SUMMARY="$TOOL_NAME executed"
        ;;
esac

# Sanitize command - remove potential secrets
SANITIZED_COMMAND="$COMMAND"
if echo "$COMMAND" | grep -qiE "(password|secret|token|key|api_key|bearer|auth)" 2>/dev/null; then
    SANITIZED_COMMAND="[REDACTED - may contain secrets]"
fi

# Truncate long commands
if [ ${#SANITIZED_COMMAND} -gt 500 ]; then
    SANITIZED_COMMAND="${SANITIZED_COMMAND:0:500}..."
fi

# Determine status
STATUS="success"
if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "" ]; then
    STATUS="failure"
fi

# Log to agency-service
# Using the tool_runs table schema - toolType must be agency-tool|bash|mcp, args must be array
# REQUEST-0068: Use --arg to safely handle special characters in SANITIZED_COMMAND
JSON_PAYLOAD=$(jq -n \
    --arg tool "$TOOL_NAME" \
    --arg toolType "bash" \
    --arg cmd "$SANITIZED_COMMAND" \
    --arg sessionId "$SESSION_ID" \
    '{tool: $tool, toolType: $toolType, args: [$cmd], sessionId: $sessionId}' 2>/dev/null)

if [ -n "$JSON_PAYLOAD" ]; then
    # Start the run
    RESPONSE=$(curl -s --connect-timeout 1 --max-time 2 \
        -X POST "${LOG_SERVICE_URL}/api/log/run/start" \
        -H "Content-Type: application/json" \
        -d "$JSON_PAYLOAD" 2>/dev/null) || exit 0

    RUN_ID=$(echo "$RESPONSE" | jq -r '.runId // empty' 2>/dev/null)

    if [ -n "$RUN_ID" ]; then
        # End the run immediately with status
        # Ensure exit code is a number
        EXIT_CODE_NUM="${EXIT_CODE:-0}"
        if ! [[ "$EXIT_CODE_NUM" =~ ^[0-9]+$ ]]; then
            EXIT_CODE_NUM=0
        fi

        END_PAYLOAD=$(jq -n \
            --arg status "$STATUS" \
            --argjson exitCode "$EXIT_CODE_NUM" \
            --arg summary "$SUMMARY" \
            '{status: $status, exitCode: $exitCode, summary: $summary}' 2>/dev/null)

        curl -s --connect-timeout 1 --max-time 2 \
            -X POST "${LOG_SERVICE_URL}/api/log/run/end/${RUN_ID}" \
            -H "Content-Type: application/json" \
            -d "$END_PAYLOAD" >/dev/null 2>&1
    fi
fi

exit 0
