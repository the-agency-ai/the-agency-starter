#!/bin/bash
# Send a message to agents or principals
#
# Usage:
#   ./tools/message-send --to all "Your message"
#   ./tools/message-send --to agent:housekeeping "Your message"
#   ./tools/message-send --to principal:jordan "Your message"
#   ./tools/message-send --to workstream:web "Your message"
#   ./tools/message-send --to agent:foo,agent:bar "Your message"
#   ./tools/message-send --to all --subject "Title" "Your message"
#
# Identifies sender by AGENTNAME env var, or PRINCIPAL, or config

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "message-send" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.1.0-20260120-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "message-send $TOOL_VERSION"
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
DB="$REPO_ROOT/claude/data/messages.db"

# Initialize database if needed
init_db() {
  if [ ! -f "$DB" ]; then
    sqlite3 "$DB" <<'SQL'
CREATE TABLE IF NOT EXISTS messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  timestamp TEXT DEFAULT (datetime('now')),
  from_type TEXT NOT NULL,
  from_name TEXT NOT NULL,
  to_type TEXT NOT NULL,
  to_name TEXT,
  subject TEXT,
  content TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS recipients (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  message_id INTEGER NOT NULL,
  recipient_type TEXT NOT NULL,
  recipient_name TEXT NOT NULL,
  read_at TEXT,
  FOREIGN KEY (message_id) REFERENCES messages(id),
  UNIQUE(message_id, recipient_type, recipient_name)
);

CREATE INDEX IF NOT EXISTS idx_recipients_lookup ON recipients(recipient_type, recipient_name, read_at);
CREATE INDEX IF NOT EXISTS idx_messages_timestamp ON messages(timestamp DESC);
SQL
  fi
}

# Escape string for safe SQL insertion (prevent SQL injection)
escape_sql() {
  # Replace single quotes with two single quotes
  echo "$1" | sed "s/'/''/g"
}

# Validate identifier (alphanumeric, hyphens, underscores only)
validate_identifier() {
  local val="$1"
  if [[ "$val" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "$val"
  else
    echo ""
  fi
}

# Determine who I am
get_identity() {
  if [ -n "$AGENTNAME" ]; then
    echo "agent:$AGENTNAME"
  elif [ -n "$PRINCIPAL" ]; then
    echo "principal:$PRINCIPAL"
  else
    local principal=$("$REPO_ROOT/tools/principal" 2>/dev/null || echo "")
    if [ -n "$principal" ] && [ "$principal" != "unknown" ]; then
      echo "principal:$principal"
    else
      echo ""
    fi
  fi
}

# Get all agents
get_all_agents() {
  for dir in "$REPO_ROOT"/claude/agents/*/; do
    if [ -d "$dir" ]; then
      basename "$dir"
    fi
  done
}

# Get all principals
get_all_principals() {
  for dir in "$REPO_ROOT"/claude/principals/*/; do
    if [ -d "$dir" ]; then
      basename "$dir"
    fi
  done
}

# Get agents in a workstream
# Checks: 1) **Workstream:** field in agent.md, 2) agent name matches workstream
get_workstream_agents() {
  local ws="$1"
  for dir in "$REPO_ROOT"/claude/agents/*/; do
    if [ -d "$dir" ]; then
      local agent_name=$(basename "$dir")
      # Check if agent name matches workstream
      if [ "$agent_name" = "$ws" ]; then
        echo "$agent_name"
      # Or check agent.md for explicit workstream assignment
      elif [ -f "$dir/agent.md" ] && grep -q "\*\*Workstream:\*\* $ws" "$dir/agent.md" 2>/dev/null; then
        echo "$agent_name"
      fi
    fi
  done
}

show_usage() {
  echo "Usage: ./tools/message-send --to <recipient> [--subject <subject>] <message>"
  echo ""
  echo "Recipients:"
  echo "  all                  - Broadcast to all agents and principals"
  echo "  agents               - All agents"
  echo "  principals           - All principals"
  echo "  agent:<name>         - Specific agent"
  echo "  principal:<name>     - Specific principal"
  echo "  workstream:<name>    - All agents in a workstream"
  echo "  agent:a,agent:b,...  - Comma-separated list"
  echo ""
  echo "Options:"
  echo "  --subject, -s        - Message subject"
  echo ""
  echo "Examples:"
  echo "  ./tools/message-send --to all 'Build complete'"
  echo "  ./tools/message-send --to agent:housekeeping -s 'Review' 'Please check docs'"
  echo "  ./tools/message-send --to workstream:web 'Frontend updated'"
  echo "  ./tools/message-send --to agent:foo,agent:bar 'Sync up'"
  exit 1
}

init_db

# Parse arguments
TO=""
SUBJECT=""
MESSAGE=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --to)
      TO="$2"
      shift 2
      ;;
    --subject|-s)
      SUBJECT="$2"
      shift 2
      ;;
    --help|-h)
      show_usage
      ;;
    *)
      MESSAGE="$1"
      shift
      ;;
  esac
done

if [ -z "$TO" ] || [ -z "$MESSAGE" ]; then
  show_usage
fi

IDENTITY=$(get_identity)
if [ -z "$IDENTITY" ]; then
  echo "Error: Cannot determine sender. Set AGENTNAME or PRINCIPAL env var."
  exit 1
fi

FROM_TYPE="${IDENTITY%%:*}"
FROM_NAME="${IDENTITY#*:}"

# Validate and escape identity values (prevent SQL injection)
FROM_TYPE=$(validate_identifier "$FROM_TYPE")
FROM_NAME=$(validate_identifier "$FROM_NAME")

if [ -z "$FROM_TYPE" ] || [ -z "$FROM_NAME" ]; then
  echo "Error: Invalid sender identity format."
  exit 1
fi

# Escape all values for SQL
FROM_TYPE_ESC=$(escape_sql "$FROM_TYPE")
FROM_NAME_ESC=$(escape_sql "$FROM_NAME")
MESSAGE_ESCAPED=$(escape_sql "$MESSAGE")
SUBJECT_ESCAPED=$(escape_sql "$SUBJECT")
TO_ESCAPED=$(escape_sql "$TO")

# Insert message
if [ -n "$SUBJECT" ]; then
  MSG_ID=$(sqlite3 "$DB" "INSERT INTO messages (from_type, from_name, to_type, to_name, subject, content) VALUES ('$FROM_TYPE_ESC', '$FROM_NAME_ESC', 'custom', '$TO_ESCAPED', '$SUBJECT_ESCAPED', '$MESSAGE_ESCAPED'); SELECT last_insert_rowid();")
else
  MSG_ID=$(sqlite3 "$DB" "INSERT INTO messages (from_type, from_name, to_type, to_name, content) VALUES ('$FROM_TYPE_ESC', '$FROM_NAME_ESC', 'custom', '$TO_ESCAPED', '$MESSAGE_ESCAPED'); SELECT last_insert_rowid();")
fi

# Add recipients based on TO format
add_recipient() {
  local rtype="$1"
  local rname="$2"
  # Validate recipient identifiers
  local rtype_valid=$(validate_identifier "$rtype")
  local rname_valid=$(validate_identifier "$rname")
  if [ -z "$rtype_valid" ] || [ -z "$rname_valid" ]; then
    echo "Warning: Invalid recipient '$rtype:$rname', skipping"
    return
  fi
  local rtype_esc=$(escape_sql "$rtype_valid")
  local rname_esc=$(escape_sql "$rname_valid")
  sqlite3 "$DB" "INSERT OR IGNORE INTO recipients (message_id, recipient_type, recipient_name) VALUES ($MSG_ID, '$rtype_esc', '$rname_esc');"
}

RECIPIENT_COUNT=0

# Handle comma-separated list
if [[ "$TO" == *","* ]]; then
  IFS=',' read -ra TARGETS <<< "$TO"
  for target in "${TARGETS[@]}"; do
    case "$target" in
      agent:*)
        add_recipient "agent" "${target#agent:}"
        ((RECIPIENT_COUNT++))
        ;;
      principal:*)
        add_recipient "principal" "${target#principal:}"
        ((RECIPIENT_COUNT++))
        ;;
      *)
        echo "Warning: Unknown recipient format '$target', skipping"
        ;;
    esac
  done
  echo "Message #$MSG_ID sent to $RECIPIENT_COUNT recipients."
else
  # Single recipient
  case "$TO" in
    all)
      for agent in $(get_all_agents); do
        add_recipient "agent" "$agent"
        ((RECIPIENT_COUNT++))
      done
      for principal in $(get_all_principals); do
        add_recipient "principal" "$principal"
        ((RECIPIENT_COUNT++))
      done
      echo "Message #$MSG_ID sent to all ($RECIPIENT_COUNT recipients)."
      ;;
    agents)
      for agent in $(get_all_agents); do
        add_recipient "agent" "$agent"
        ((RECIPIENT_COUNT++))
      done
      echo "Message #$MSG_ID sent to all agents ($RECIPIENT_COUNT)."
      ;;
    principals)
      for principal in $(get_all_principals); do
        add_recipient "principal" "$principal"
        ((RECIPIENT_COUNT++))
      done
      echo "Message #$MSG_ID sent to all principals ($RECIPIENT_COUNT)."
      ;;
    workstream:*)
      WS_NAME="${TO#workstream:}"
      for agent in $(get_workstream_agents "$WS_NAME"); do
        add_recipient "agent" "$agent"
        ((RECIPIENT_COUNT++))
      done
      if [ "$RECIPIENT_COUNT" -eq 0 ]; then
        echo "Warning: No agents found in workstream '$WS_NAME'"
      else
        echo "Message #$MSG_ID sent to workstream:$WS_NAME ($RECIPIENT_COUNT agents)."
      fi
      ;;
    agent:*)
      add_recipient "agent" "${TO#agent:}"
      echo "Message #$MSG_ID sent to $TO."
      ;;
    principal:*)
      add_recipient "principal" "${TO#principal:}"
      echo "Message #$MSG_ID sent to $TO."
      RECIPIENT_COUNT=1
      ;;
    *)
      echo "Error: Invalid recipient format '$TO'"
      show_usage
      ;;
  esac
fi

# Log completion
log_end "$RUN_ID" "success" 0 0 "Sent message #$MSG_ID to $RECIPIENT_COUNT recipient(s)" 2>/dev/null || true
