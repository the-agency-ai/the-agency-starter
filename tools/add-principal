#!/bin/bash
#
# add-principal - Add a new principal to an existing Agency project
#
# Use this when joining an existing Agency project or adding
# another principal to a project you manage.
#
# Usage:
#   add-principal                   # Interactive (adds yourself)
#   add-principal --name alice      # Add specific principal
#   add-principal --help            # Show help
#

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.0.0-20260118-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Defaults
VERBOSE=false
PRINCIPAL_NAME=""
SET_AS_CURRENT=true
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Logging functions
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

usage() {
    cat << EOF
Usage: add-principal [options]

Add a new principal to an existing Agency project. Use this when:
- You're joining an existing Agency project
- You want to add another principal (e.g., a team member)

Options:
  --name NAME        Principal name to create
  --no-set-current   Don't set as AGENCY_PRINCIPAL
  --verbose          Show detailed output
  -v, --version      Show version
  -h, --help         Show this help

Examples:
  add-principal                 # Interactive, adds yourself
  add-principal --name alice    # Add alice as principal
  add-principal --name bob --no-set-current
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --name)
            PRINCIPAL_NAME="$2"
            shift 2
            ;;
        --no-set-current)
            SET_AS_CURRENT=false
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -v|--version)
            echo "add-principal $TOOL_VERSION"
            exit 0
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Check we're in an Agency project
if [[ ! -f "$PROJECT_ROOT/claude/config/agency.yaml" ]]; then
    log_error "Not in an Agency project (missing claude/config/agency.yaml)"
    echo "Run this from an Agency project root."
    exit 1
fi

main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    RUN_ID=$(log_start "add-principal" "agency-tool" "$@" 2>/dev/null) || true
    echo "add-principal [run: ${RUN_ID:-none}]"

    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  Add Principal to Agency${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Get principal name
    if [[ -z "$PRINCIPAL_NAME" ]]; then
        SUGGESTED_NAME=$(whoami)
        echo "Adding a new principal to this Agency project."
        echo ""
        read -p "Principal name [$SUGGESTED_NAME]: " PRINCIPAL_NAME
        PRINCIPAL_NAME="${PRINCIPAL_NAME:-$SUGGESTED_NAME}"
    fi

    # Validate principal name
    if [[ ! "$PRINCIPAL_NAME" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
        log_error "Invalid principal name: $PRINCIPAL_NAME"
        echo "Name must start with a letter and contain only letters, numbers, hyphens, underscores."
        exit 1
    fi

    # Convert to lowercase
    PRINCIPAL_NAME=$(echo "$PRINCIPAL_NAME" | tr '[:upper:]' '[:lower:]')

    # Check if principal already exists
    PRINCIPAL_DIR="$PROJECT_ROOT/claude/principals/$PRINCIPAL_NAME"
    if [[ -d "$PRINCIPAL_DIR" ]]; then
        log_warn "Principal already exists: $PRINCIPAL_NAME"
        echo ""

        if [[ "$SET_AS_CURRENT" == "true" ]]; then
            echo "Setting as current principal..."
        else
            echo "No changes needed."
            exit 0
        fi
    else
        log_step "Creating principal: $PRINCIPAL_NAME"

        # Create principal from template
        TEMPLATE_DIR="$PROJECT_ROOT/claude/templates/principal"
        if [[ -d "$TEMPLATE_DIR" ]]; then
            log_info "Creating principal from template..."
            mkdir -p "$PRINCIPAL_DIR"
            cp -r "$TEMPLATE_DIR/"* "$PRINCIPAL_DIR/" 2>/dev/null || true

            # Replace template placeholders
            if [[ -f "$PRINCIPAL_DIR/README.md" ]]; then
                if [[ "$(uname)" == "Darwin" ]]; then
                    sed -i '' "s/{{PRINCIPAL_NAME}}/$PRINCIPAL_NAME/g" "$PRINCIPAL_DIR/README.md"
                else
                    sed -i "s/{{PRINCIPAL_NAME}}/$PRINCIPAL_NAME/g" "$PRINCIPAL_DIR/README.md"
                fi
            fi

            verbose_echo "  Principal directory created: $PRINCIPAL_DIR"
        else
            # No template, create minimal structure
            log_info "Creating minimal principal structure..."
            mkdir -p "$PRINCIPAL_DIR"/{requests,artifacts,resources,config}
            touch "$PRINCIPAL_DIR/requests/.gitkeep"
            touch "$PRINCIPAL_DIR/artifacts/.gitkeep"
            touch "$PRINCIPAL_DIR/resources/.gitkeep"
            touch "$PRINCIPAL_DIR/config/.gitkeep"
        fi

        echo -e "  ${GREEN}✓${NC} Created claude/principals/$PRINCIPAL_NAME/"
    fi

    # Set as current principal
    if [[ "$SET_AS_CURRENT" == "true" ]]; then
        log_step "Setting as current principal..."
        EXPORT_LINE="export AGENCY_PRINCIPAL=\"$PRINCIPAL_NAME\""
        SHELL_PROFILE=""

        # Determine shell profile
        if [[ -f "$HOME/.zshrc" ]]; then
            SHELL_PROFILE="$HOME/.zshrc"
        elif [[ -f "$HOME/.bashrc" ]]; then
            SHELL_PROFILE="$HOME/.bashrc"
        elif [[ -f "$HOME/.bash_profile" ]]; then
            SHELL_PROFILE="$HOME/.bash_profile"
        fi

        if [[ -n "$SHELL_PROFILE" ]]; then
            # Check if already set
            if ! grep -q "AGENCY_PRINCIPAL" "$SHELL_PROFILE" 2>/dev/null; then
                echo "" >> "$SHELL_PROFILE"
                echo "# The Agency principal identity" >> "$SHELL_PROFILE"
                echo "$EXPORT_LINE" >> "$SHELL_PROFILE"
                verbose_echo "  Added AGENCY_PRINCIPAL to $SHELL_PROFILE"
            else
                # Update existing
                if [[ "$(uname)" == "Darwin" ]]; then
                    sed -i '' "s/^export AGENCY_PRINCIPAL=.*/$EXPORT_LINE/" "$SHELL_PROFILE"
                else
                    sed -i "s/^export AGENCY_PRINCIPAL=.*/$EXPORT_LINE/" "$SHELL_PROFILE"
                fi
                verbose_echo "  Updated AGENCY_PRINCIPAL in $SHELL_PROFILE"
            fi

            echo -e "  ${GREEN}✓${NC} Set AGENCY_PRINCIPAL=$PRINCIPAL_NAME in $SHELL_PROFILE"
        fi

        # Export for current session
        export AGENCY_PRINCIPAL="$PRINCIPAL_NAME"
    fi

    # Success
    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  Principal Added!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "Welcome to the team, ${GREEN}$PRINCIPAL_NAME${NC}!"
    echo ""
    echo "Your principal directory: claude/principals/$PRINCIPAL_NAME/"
    echo ""
    echo "Get started with:"
    echo ""
    echo -e "  ${BLUE}./tools/myclaude housekeeping captain${NC}"
    echo ""

    if [[ -n "${SHELL_PROFILE:-}" ]] && [[ "$SET_AS_CURRENT" == "true" ]]; then
        echo -e "${YELLOW}Note:${NC} Run 'source $SHELL_PROFILE' or start a new terminal"
        echo "      for AGENCY_PRINCIPAL to take effect."
        echo ""
    fi

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Added principal $PRINCIPAL_NAME" 2>/dev/null || true
}

main "$@"
