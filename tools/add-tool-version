#!/bin/bash
#
# add-tool-version - Add version metadata to a tool
#
# Usage: ./tools/add-tool-version <toolname> [version]
#
# Adds TOOL_VERSION and --version/-v handling to a tool.
# Default version: 1.0.0-20260109-000001
#

set -e

TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "add-tool-version $TOOL_VERSION"
    exit 0
fi

TOOLNAME="$1"
VERSION="${2:-1.0.0-20260109-000001}"

if [ -z "$TOOLNAME" ]; then
    echo "Usage: ./tools/add-tool-version <toolname> [version]"
    echo ""
    echo "Examples:"
    echo "  ./tools/add-tool-version backup-session"
    echo "  ./tools/add-tool-version config 1.0.0-20260109-000002"
    exit 1
fi

TOOL_PATH="tools/$TOOLNAME"

if [ ! -f "$TOOL_PATH" ]; then
    echo "Error: Tool not found: $TOOL_PATH"
    exit 1
fi

# Check if already versioned
if grep -q "^TOOL_VERSION=" "$TOOL_PATH"; then
    CURRENT=$(grep "^TOOL_VERSION=" "$TOOL_PATH" | head -1)
    echo "Already versioned: $TOOLNAME ($CURRENT)"
    exit 0
fi

# Create temp file
TEMP_FILE=$(mktemp)

# Strategy: insert after 'set -e' line, or after header comments if no 'set -e'
awk -v version="$VERSION" -v toolname="$TOOLNAME" '
BEGIN {
    inserted = 0
    found_set_e = 0
    header_done = 0
    buffer = ""
}
{
    # Check if this is a set -e line
    if (!inserted && /^set -e/) {
        print $0
        print ""
        print "# Tool version"
        print "TOOL_VERSION=\"" version "\""
        print ""
        print "# Version check"
        print "if [[ \"${1:-}\" == \"--version\" || \"${1:-}\" == \"-v\" ]]; then"
        print "    echo \"" toolname " $TOOL_VERSION\""
        print "    exit 0"
        print "fi"
        inserted = 1
        found_set_e = 1
        next
    }

    # If no set -e found yet and we hit first non-comment non-empty line after shebang
    if (!inserted && !found_set_e && !/^#/ && !/^$/ && NR > 1) {
        # Insert version block before this line
        print ""
        print "# Tool version"
        print "TOOL_VERSION=\"" version "\""
        print ""
        print "# Version check"
        print "if [[ \"${1:-}\" == \"--version\" || \"${1:-}\" == \"-v\" ]]; then"
        print "    echo \"" toolname " $TOOL_VERSION\""
        print "    exit 0"
        print "fi"
        print ""
        inserted = 1
    }

    print $0
}
' "$TOOL_PATH" > "$TEMP_FILE"

# Verify and move
if grep -q "^TOOL_VERSION=" "$TEMP_FILE"; then
    mv "$TEMP_FILE" "$TOOL_PATH"
    chmod +x "$TOOL_PATH"
    echo "Added version $VERSION to $TOOLNAME"
else
    rm "$TEMP_FILE"
    echo "ERROR: Failed to add version to $TOOLNAME"
    exit 1
fi
