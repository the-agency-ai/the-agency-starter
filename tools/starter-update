#!/bin/bash
#
# starter-update - Update local Agency Starter from GitHub
#
# Usage:
#   starter-update              # Update starter from GitHub
#   starter-update --dry-run    # Show what would change
#

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.0.0-20260118-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Defaults
VERBOSE=false
DRY_RUN=false
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Logging functions
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

usage() {
    cat << EOF
Usage: starter-update [options]

Update local Agency Starter from GitHub.

This tool is for updating your local copy of the-agency-starter
from the upstream GitHub repository. It preserves local changes
and shows conflicts.

Options:
  --dry-run        Show what would change without applying
  --verbose        Show detailed output
  -v, --version    Show version
  -h, --help       Show this help

Examples:
  starter-update              # Update from GitHub
  starter-update --dry-run    # Preview changes
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -v|--version)
            echo "starter-update $TOOL_VERSION"
            exit 0
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

main() {
    RUN_ID=$(log_start "starter-update" "agency-tool" "$@" 2>/dev/null) || true
    echo "starter-update [run: ${RUN_ID:-none}]"

    # Check we're in the starter repo
    if [[ ! -f "$PROJECT_ROOT/.agency-starter" ]]; then
        log_error "Not in the Agency Starter directory"
        echo ""
        echo "This tool is for updating the-agency-starter itself."
        echo "To update a project, use: ./tools/agency-update"
        exit 1
    fi

    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${BLUE}  Starter Update (DRY RUN)${NC}"
    else
        echo -e "${BLUE}  Starter Update${NC}"
    fi
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Check for uncommitted changes
    if ! git diff --quiet 2>/dev/null || ! git diff --cached --quiet 2>/dev/null; then
        log_warn "You have uncommitted changes"
        echo ""
        if [[ "$DRY_RUN" != "true" ]]; then
            read -p "Continue anyway? [y/N] " continue_anyway
            if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
                echo "Aborted."
                exit 0
            fi
        fi
    fi

    # Check if remote is configured
    if ! git remote get-url origin &>/dev/null; then
        log_error "No git remote configured"
        echo "Set up remote: git remote add origin https://github.com/jmagar/the-agency-starter.git"
        exit 1
    fi

    log_step "Fetching updates from GitHub..."
    if [[ "$DRY_RUN" == "true" ]]; then
        echo "  Would run: git fetch origin"
    else
        git fetch origin
    fi

    # Show what would change
    log_step "Checking for updates..."
    local behind=$(git rev-list HEAD..origin/main --count 2>/dev/null || echo "0")

    if [[ "$behind" == "0" ]]; then
        echo -e "  ${GREEN}✓${NC} Already up to date"
        log_end "$RUN_ID" "success" 0 0 "Already up to date" 2>/dev/null || true
        exit 0
    fi

    echo "  $behind commit(s) behind origin/main"
    echo ""

    # Show commit log
    verbose_echo "Recent upstream commits:"
    git log HEAD..origin/main --oneline | head -10

    if [[ "$DRY_RUN" == "true" ]]; then
        echo ""
        echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${YELLOW}  Dry run - no changes made${NC}"
        echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo ""
        echo "Run without --dry-run to apply updates."
        log_end "$RUN_ID" "success" 0 0 "Dry run complete" 2>/dev/null || true
        exit 0
    fi

    # Pull changes
    log_step "Pulling updates..."
    if git pull --rebase origin main; then
        echo -e "  ${GREEN}✓${NC} Updates applied"

        # Make tools executable
        chmod +x "$PROJECT_ROOT/tools/"* 2>/dev/null || true

        echo ""
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${GREEN}  Starter Updated!${NC}"
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        log_end "$RUN_ID" "success" 0 0 "Updated successfully" 2>/dev/null || true
    else
        log_error "Pull failed - you may have conflicts"
        echo ""
        echo "Resolve conflicts and run: git rebase --continue"
        log_end "$RUN_ID" "failure" 1 0 "Pull failed" 2>/dev/null || true
        exit 1
    fi
}

main "$@"
