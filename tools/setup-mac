#!/bin/bash
#
# Setup recommended CLI tools for The Agency on macOS
#
# Usage: ./tools/setup-mac [--all]
#
# Without flags: installs essential tools only
# With --all: installs all recommended tools
#

set -e

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "setup-mac $TOOL_VERSION"
    exit 0
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Check we're on macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    echo -e "${RED}This script is for macOS only.${NC}"
    echo "For other platforms, install these tools manually:"
    echo "  Essential: jq, gh, tree"
    echo "  Enhanced:  yq, fzf, bat, ripgrep"
    exit 1
fi

# Check for Homebrew
if ! command -v brew &> /dev/null; then
    echo -e "${YELLOW}Homebrew not found. Installing...${NC}"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  The Agency - macOS Setup${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Essential tools
ESSENTIAL_TOOLS=(
    "jq:JSON processor - parse API responses, config files"
    "gh:GitHub CLI - PR creation, issue management"
    "tree:Directory visualization"
)

# Enhanced tools (--all)
ENHANCED_TOOLS=(
    "yq:YAML processor - edit config.yaml programmatically"
    "fzf:Fuzzy finder - quick tool/file discovery"
    "bat:Better cat with syntax highlighting"
    "ripgrep:Fast search (rg) - find code quickly"
)

install_tool() {
    local tool="${1%%:*}"
    local desc="${1#*:}"

    if command -v "$tool" &> /dev/null; then
        echo -e "${GREEN}✓ $tool${NC} - already installed"
    else
        echo -e "${YELLOW}Installing $tool${NC} - $desc"
        brew install "$tool"
        echo -e "${GREEN}✓ $tool${NC} - installed"
    fi
}

# Install essential tools
echo -e "${BLUE}Essential Tools:${NC}"
echo ""
for tool in "${ESSENTIAL_TOOLS[@]}"; do
    install_tool "$tool"
done

# Install enhanced tools if --all
if [[ "$1" == "--all" ]]; then
    echo ""
    echo -e "${BLUE}Enhanced Tools:${NC}"
    echo ""
    for tool in "${ENHANCED_TOOLS[@]}"; do
        install_tool "$tool"
    done
fi

echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}  Setup Complete!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

if [[ "$1" != "--all" ]]; then
    echo "Run with --all to install enhanced tools:"
    echo -e "  ${BLUE}./tools/setup-mac --all${NC}"
    echo ""
fi

echo "Tool purposes:"
echo "  jq     - Parse JSON (API responses, package.json)"
echo "  gh     - GitHub operations (PRs, issues, releases)"
echo "  tree   - Visualize project structure"
if [[ "$1" == "--all" ]]; then
    echo "  yq     - Edit YAML configs programmatically"
    echo "  fzf    - Fuzzy search (try: ./tools/find-tool | fzf)"
    echo "  bat    - Syntax-highlighted file viewing"
    echo "  rg     - Lightning-fast code search"
fi
echo ""
