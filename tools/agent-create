#!/bin/bash
# Create a new agent identity
#
# Usage: ./tools/agent-create <agentname> <workstream> [--type=<template>]
#
# Many-to-one mapping: Multiple agents can work on the same workstream
# Agent name may differ from workstream name
#
# Options:
#   --type=<template>  Use a specific agent template (default: generic)
#   --verbose          Show detailed logging
#
# Creates:
#   claude/agents/{agentname}/
#     - agent.md, WORKLOG.md, ADHOC-WORKLOG.md
#     - IDEAS.md, KNOWLEDGE.md, ONBOARDING.md
#     - backups/, logs/

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.2.0-20260114-000004"

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEMPLATE_DIR="$PROJECT_ROOT/claude/agents/templates"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Defaults
VERBOSE=false

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Escape sed special characters to prevent injection
escape_sed() {
    printf '%s\n' "$1" | sed 's/[&/\]/\\&/g'
}

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "agent-create $TOOL_VERSION"
    exit 0
fi

# Help
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    echo "agent-create - Create a new agent identity"
    echo ""
    echo "Usage: ./tools/agent-create <agentname> <workstream> [--type=<template>] [--verbose]"
    echo ""
    echo "Arguments:"
    echo "  agentname     Name for the new agent"
    echo "  workstream    Workstream the agent belongs to (must exist)"
    echo ""
    echo "Options:"
    echo "  --type=<template>  Use a specific agent template (default: generic)"
    echo "  --list-types       List available agent templates"
    echo "  --verbose          Show detailed logging"
    echo "  --version, -v      Show version"
    echo "  --help, -h         Show this help"
    echo ""
    echo "Examples:"
    echo "  ./tools/agent-create agent-manager agents"
    echo "  ./tools/agent-create ui-specialist web --type=ux-dev"
    echo "  ./tools/agent-create backend-dev api --type=generic"
    echo ""
    echo "Available templates:"
    if [[ -d "$TEMPLATE_DIR" ]]; then
        for dir in "$TEMPLATE_DIR"/*/; do
            if [[ -d "$dir" ]]; then
                type_name=$(basename "$dir")
                echo "  - $type_name"
            fi
        done
    else
        echo "  (none - template directory not found)"
    fi
    exit 0
fi

# List types
if [[ "${1:-}" == "--list-types" ]]; then
    echo "Available agent templates:"
    if [[ -d "$TEMPLATE_DIR" ]]; then
        for dir in "$TEMPLATE_DIR"/*/; do
            if [[ -d "$dir" ]]; then
                type_name=$(basename "$dir")
                echo "  - $type_name"
            fi
        done
    else
        echo "  (none - template directory not found)"
    fi
    exit 0
fi

# Parse arguments
AGENTNAME=""
WORKSTREAM=""
AGENT_TYPE="generic"

for arg in "$@"; do
    case $arg in
        --type=*)
            AGENT_TYPE="${arg#*=}"
            ;;
        --verbose)
            VERBOSE=true
            ;;
        --*)
            # Skip other options
            ;;
        *)
            if [[ -z "$AGENTNAME" ]]; then
                AGENTNAME="$arg"
            elif [[ -z "$WORKSTREAM" ]]; then
                WORKSTREAM="$arg"
            fi
            ;;
    esac
done

if [ -z "$AGENTNAME" ] || [ -z "$WORKSTREAM" ]; then
  log_error "Missing required arguments"
  echo ""
  echo "Usage: ./tools/agent-create <agentname> <workstream> [--type=<template>] [--verbose]"
  echo ""
  echo "Examples:"
  echo "  ./tools/agent-create agent-manager agents"
  echo "  ./tools/agent-create ui-specialist web --type=ux-dev"
  echo ""
  echo "Note: Workstream must exist first. Create with:"
  echo "  ./tools/workstream-create <name>"
  echo ""
  echo "Run with --list-types to see available templates."
  exit 1
fi

DIR="claude/agents/$AGENTNAME"
WORKSTREAM_DIR="claude/workstreams/$WORKSTREAM"
TIMESTAMP=$(./tools/now 2>/dev/null || date '+%Y-%m-%d %H:%M')
AGENT_TEMPLATE_DIR="$TEMPLATE_DIR/$AGENT_TYPE"

# Main function
main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    RUN_ID=$(log_start "agent-create" "agency-tool" "$@" 2>/dev/null) || true
    echo "agent-create [run: ${RUN_ID:-none}]"

    # Check agent doesn't exist
    if [ -d "$DIR" ]; then
      log_error "Agent '$AGENTNAME' already exists at $DIR"
      trap - EXIT
      log_end "$RUN_ID" "failure" 1 0 "Agent already exists"
      exit 1
    fi

    # Check workstream exists
    if [ ! -d "$WORKSTREAM_DIR" ]; then
      log_error "Workstream '$WORKSTREAM' doesn't exist at $WORKSTREAM_DIR"
      echo ""
      echo "Create workstream first: ./tools/workstream-create $WORKSTREAM"
      trap - EXIT
      log_end "$RUN_ID" "failure" 1 0 "Workstream not found"
      exit 1
    fi

    # Check template exists
    if [ ! -d "$AGENT_TEMPLATE_DIR" ]; then
      log_error "Agent template '$AGENT_TYPE' not found at $AGENT_TEMPLATE_DIR"
      echo ""
      echo "Available templates:"
      for dir in "$TEMPLATE_DIR"/*/; do
          if [[ -d "$dir" ]]; then
              type_name=$(basename "$dir")
              echo "  - $type_name"
          fi
      done
      trap - EXIT
      log_end "$RUN_ID" "failure" 1 0 "Template not found"
      exit 1
    fi

    log_step "Creating agent: $AGENTNAME (workstream: $WORKSTREAM, type: $AGENT_TYPE)"
    mkdir -p "$DIR/backups/latest"
    mkdir -p "$DIR/backups/archive"
    mkdir -p "$DIR/logs"

    # Function to replace placeholders in template
    apply_template() {
        local template_file="$1"
        local output_file="$2"

        if [[ -f "$template_file" ]]; then
            # Escape sed special characters to prevent injection
            local agent_escaped workstream_escaped timestamp_escaped
            agent_escaped=$(escape_sed "$AGENTNAME")
            workstream_escaped=$(escape_sed "$WORKSTREAM")
            timestamp_escaped=$(escape_sed "$TIMESTAMP")

            sed -e "s/{{AGENT_NAME}}/$agent_escaped/g" \
                -e "s/{{WORKSTREAM}}/$workstream_escaped/g" \
                -e "s/{{TIMESTAMP}}/$timestamp_escaped/g" \
                "$template_file" > "$output_file"
        fi
    }

    # Apply template files
    apply_template "$AGENT_TEMPLATE_DIR/agent.md" "$DIR/agent.md"
    apply_template "$AGENT_TEMPLATE_DIR/KNOWLEDGE.md" "$DIR/KNOWLEDGE.md"
    apply_template "$AGENT_TEMPLATE_DIR/ONBOARDING.md" "$DIR/ONBOARDING.md"

    # WORKLOG.md (not templated - standard format)
    cat > "$DIR/WORKLOG.md" << EOF
# $AGENTNAME Work Log

## Completed Sprints

(None yet)

## Format

- epic###-sprint### - [Summary] | [Date]
  - Iteration 01: [Description]
EOF

    # ADHOC-WORKLOG.md (not templated - standard format)
    AGENTNAME_UPPER=$(echo "$AGENTNAME" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
    cat > "$DIR/ADHOC-WORKLOG.md" << EOF
# $AGENTNAME Ad-Hoc Work Log

## Latest

(None yet)

---

## Format

## ${AGENTNAME_UPPER}-ADHOC-#### | YYYY-MM-DD HH:MM

**Task:** [Description]
**Status:** Completed
**Files:** [List]
EOF

    # IDEAS.md (not templated - standard format)
    cat > "$DIR/IDEAS.md" << EOF
# $AGENTNAME Ideas & Observations

### YYYY-MM-DD | I noticed

[Observation]

### YYYY-MM-DD | I have an idea

[Proposal]
**Deferred because:** [Reason]
EOF

    # logs/permissions.md (not templated - standard format)
    cat > "$DIR/logs/permissions.md" << EOF
# $AGENTNAME Permission Request Log

| Date | Tool | Command | Reason | Outcome |
|------|------|---------|--------|---------|
EOF

    # Create agent folder in all principal cloud storage locations
    verbose_echo ""
    for principal_dir in claude/principals/*/; do
      cloud_link="${principal_dir}resources/cloud"
      if [ -L "$cloud_link" ] && [ -d "$cloud_link" ]; then
        agent_cloud_dir="$cloud_link/$AGENTNAME"
        if [ ! -d "$agent_cloud_dir" ]; then
          mkdir -p "$agent_cloud_dir"
          verbose_echo "Created cloud folder: $agent_cloud_dir"
        fi
      fi
    done

    echo ""
    echo "Created: $DIR/"
    log_info "Template: $AGENT_TYPE"
    echo ""
    echo "Start with: ./tools/myclaude $WORKSTREAM $AGENTNAME"

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Agent $AGENTNAME created"
}

main
