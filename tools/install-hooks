#!/bin/bash
# Install git hooks for The Agency
#
# Usage:
#   ./tools/install-hooks
#
# This installs:
#   - pre-commit: Runs quality gates before every commit
#
# To bypass hooks (use sparingly): git commit --no-verify

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
HOOKS_DIR="$REPO_ROOT/.git/hooks"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Installing git hooks..."

# Create hooks directory if needed
mkdir -p "$HOOKS_DIR"

# Install pre-commit hook
cat > "$HOOKS_DIR/pre-commit" << 'EOF'
#!/bin/bash
# Pre-commit hook for The Agency
# Enforces quality gates before every commit
#
# Runs: ./tools/commit-precheck
# Blocks commit if any gate fails
#
# To bypass (use sparingly): git commit --no-verify

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Running pre-commit quality gates...${NC}"

# Check if commit-precheck exists
if [ ! -x "./tools/commit-precheck" ]; then
    echo -e "${RED}Error: ./tools/commit-precheck not found or not executable${NC}"
    exit 1
fi

# Run quality gates
if ./tools/commit-precheck; then
    echo -e "${GREEN}✓ All quality gates passed${NC}"
    exit 0
else
    echo -e "${RED}✗ Quality gates failed - commit blocked${NC}"
    echo -e "${YELLOW}Fix issues above or use 'git commit --no-verify' to bypass${NC}"
    exit 1
fi
EOF

chmod +x "$HOOKS_DIR/pre-commit"
echo -e "${GREEN}✓ Installed pre-commit hook${NC}"

echo ""
echo -e "${GREEN}Done! Hooks installed.${NC}"
echo -e "${YELLOW}Note: Use 'git commit --no-verify' to bypass hooks if needed.${NC}"
