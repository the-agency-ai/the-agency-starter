#!/bin/bash
# secrets-scan - Scan for secrets in staged files or entire repo
#
# Usage:
#   ./tools/secrets-scan              # Scan entire repo
#   ./tools/secrets-scan --staged     # Scan only staged files (for pre-commit)
#   ./tools/secrets-scan --help       # Show help
#
# Exit codes:
#   0 - No secrets found
#   1 - Secrets detected

set -e

TOOL_VERSION="1.0.0-20260115-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Parse arguments
STAGED_ONLY=false
VERBOSE=false

for arg in "$@"; do
    case $arg in
        --staged|-s)
            STAGED_ONLY=true
            ;;
        --verbose|-v)
            VERBOSE=true
            ;;
        --version)
            echo "secrets-scan $TOOL_VERSION"
            exit 0
            ;;
        --help|-h)
            echo "secrets-scan - Detect secrets in files before commit"
            echo ""
            echo "Usage:"
            echo "  ./tools/secrets-scan              # Scan entire repo"
            echo "  ./tools/secrets-scan --staged     # Scan only staged files"
            echo "  ./tools/secrets-scan --verbose    # Show matching patterns"
            echo ""
            echo "Patterns detected:"
            echo "  - API keys (GUMROAD_, ANTHROPIC_, OPENAI_, etc.)"
            echo "  - Access tokens (sk-ant-, ghp_, gho_, discord tokens)"
            echo "  - OAuth credentials (client_secret, app_secret)"
            echo "  - Private keys (RSA, SSH, PGP)"
            echo "  - Password assignments"
            echo ""
            echo "Exit codes:"
            echo "  0 - No secrets found"
            echo "  1 - Secrets detected"
            exit 0
            ;;
    esac
done

# Secret patterns to detect
# Format: "pattern_name|regex"
SECRET_PATTERNS=(
    # API Keys (various services)
    "GUMROAD_KEY|GUMROAD_[A-Z_]*=[A-Za-z0-9_-]{20,}"
    "ANTHROPIC_KEY|sk-ant-[A-Za-z0-9_-]{20,}"
    "OPENAI_KEY|sk-[A-Za-z0-9]{48}"
    "STRIPE_KEY|sk_live_[A-Za-z0-9]{24,}"
    "AWS_KEY|AKIA[A-Z0-9]{16}"

    # GitHub tokens
    "GITHUB_PAT|ghp_[A-Za-z0-9]{36}"
    "GITHUB_OAUTH|gho_[A-Za-z0-9]{36}"
    "GITHUB_APP|ghu_[A-Za-z0-9]{36}"
    "GITHUB_REFRESH|ghr_[A-Za-z0-9]{36}"

    # Discord
    "DISCORD_TOKEN|[MN][A-Za-z0-9]{23,27}\.[A-Za-z0-9_-]{6}\.[A-Za-z0-9_-]{27}"
    "DISCORD_WEBHOOK|discord(app)?\.com/api/webhooks/[0-9]+/[A-Za-z0-9_-]+"

    # OAuth/App secrets
    "APP_SECRET|app_secret[\"']?\s*[:=]\s*[\"'][A-Za-z0-9_-]{20,}[\"']"
    "CLIENT_SECRET|client_secret[\"']?\s*[:=]\s*[\"'][A-Za-z0-9_-]{20,}[\"']"
    "ACCESS_TOKEN|access_token[\"']?\s*[:=]\s*[\"'][A-Za-z0-9_-]{20,}[\"']"

    # Private keys
    "RSA_KEY|-----BEGIN RSA PRIVATE KEY-----"
    "SSH_KEY|-----BEGIN OPENSSH PRIVATE KEY-----"
    "PGP_KEY|-----BEGIN PGP PRIVATE KEY BLOCK-----"
    "EC_KEY|-----BEGIN EC PRIVATE KEY-----"

    # Generic patterns
    "PASSWORD_ASSIGN|password\s*[:=]\s*[\"'][^\"']{8,}[\"']"
    "SECRET_ASSIGN|secret\s*[:=]\s*[\"'][^\"']{20,}[\"']"
)

# Files to exclude from scanning
EXCLUDE_PATTERNS=(
    "*.md"
    "*.txt"
    "package-lock.json"
    "pnpm-lock.yaml"
    "yarn.lock"
    "*.sample"
    ".git/*"
)

# Build grep exclude arguments
build_exclude_args() {
    local args=""
    for pattern in "${EXCLUDE_PATTERNS[@]}"; do
        args="$args --exclude=$pattern"
    done
    echo "$args"
}

# Get files to scan
get_files() {
    if [[ "$STAGED_ONLY" == "true" ]]; then
        git -C "$PROJECT_ROOT" diff --cached --name-only --diff-filter=ACM
    else
        find "$PROJECT_ROOT" -type f \
            -not -path "*/.git/*" \
            -not -path "*/node_modules/*" \
            -not -name "*.md" \
            -not -name "*.txt" \
            -not -name "package-lock.json" \
            -not -name "pnpm-lock.yaml" \
            2>/dev/null
    fi
}

# Main scan
main() {
    local found_secrets=false
    local files

    files=$(get_files)

    if [[ -z "$files" ]]; then
        [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}No files to scan${NC}"
        exit 0
    fi

    echo "Scanning for secrets..."

    for pattern_entry in "${SECRET_PATTERNS[@]}"; do
        local name="${pattern_entry%%|*}"
        local regex="${pattern_entry#*|}"

        # Use grep to find matches
        while IFS= read -r file; do
            if [[ -f "$PROJECT_ROOT/$file" ]]; then
                local matches
                matches=$(grep -nE "$regex" "$PROJECT_ROOT/$file" 2>/dev/null || true)

                if [[ -n "$matches" ]]; then
                    found_secrets=true
                    echo -e "${RED}DETECTED: $name${NC}"
                    echo "  File: $file"
                    if [[ "$VERBOSE" == "true" ]]; then
                        echo "$matches" | head -3 | sed 's/^/    /'
                    fi
                    echo ""
                fi
            fi
        done <<< "$files"
    done

    if [[ "$found_secrets" == "true" ]]; then
        echo -e "${RED}============================================${NC}"
        echo -e "${RED}SECRETS DETECTED - COMMIT BLOCKED${NC}"
        echo -e "${RED}============================================${NC}"
        echo ""
        echo "Remove the secrets before committing."
        echo "If these are false positives, use:"
        echo "  git commit --no-verify"
        exit 1
    else
        echo -e "${GREEN}No secrets detected${NC}"
        exit 0
    fi
}

main
