#!/bin/bash
# Create a new observation document
#
# Usage:
#   ./tools/observe --summary "agents directory has session backups outside backups/"
#   ./tools/observe --summary "build is slow" --details "Noticed during CI"
#
# Observations are things you notice that may not need immediate action
# but could become the basis for a request later.

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "observe" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260114-000007"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Defaults
VERBOSE=false

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "observe $TOOL_VERSION"
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

show_usage() {
  echo "Usage: ./tools/observe --summary <summary> [options]"
  echo ""
  echo "Required:"
  echo "  --summary, -s      Brief summary (used in filename and title)"
  echo ""
  echo "Options:"
  echo "  --details, -d      Detailed description of the observation"
  echo "  --principal        Override principal (defaults to PRINCIPAL env or config)"
  echo "  --verbose          Enable verbose logging"
  echo ""
  echo "Examples:"
  echo "  ./tools/observe -s 'Session backups not in backups directory'"
  echo "  ./tools/observe -s 'Build is slow' -d 'Takes 5+ minutes in CI'"
  exit 1
}

# Determine principal
get_principal() {
  if [ -n "$PRINCIPAL" ]; then
    echo "$PRINCIPAL"
  else
    local p=$("$REPO_ROOT/tools/principal" 2>/dev/null || echo "")
    if [ -n "$p" ] && [ "$p" != "unknown" ]; then
      echo "$p"
    else
      echo ""
    fi
  fi
}

# Get next observe number by scanning existing files
get_next_number() {
  local highest=0

  # Scan all OBSERVE files in principals directory
  shopt -s nullglob
  for f in "$REPO_ROOT"/claude/principals/*/observations/OBSERVE-*.md; do
    if [ -f "$f" ]; then
      local fname=$(basename "$f")
      local num=$(echo "$fname" | sed -n 's/OBSERVE-[^-]*-\([0-9]*\)-.*/\1/p')
      if [ -n "$num" ]; then
        num=$((10#$num))
        if [ "$num" -gt "$highest" ]; then
          highest=$num
        fi
      fi
    fi
  done
  shopt -u nullglob

  echo $((highest + 1))
}

# Convert summary to filename-safe slug
slugify() {
  echo "$1" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-' | cut -c1-50
}

# Parse arguments
SUMMARY=""
DETAILS=""
PRINCIPAL_OVERRIDE=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --summary|-s)
      SUMMARY="$2"
      shift 2
      ;;
    --details|-d)
      DETAILS="$2"
      shift 2
      ;;
    --principal)
      PRINCIPAL_OVERRIDE="$2"
      shift 2
      ;;
    --verbose)
      VERBOSE=true
      shift
      ;;
    --help|-h)
      show_usage
      ;;
    *)
      echo "Unknown option: $1"
      show_usage
      ;;
  esac
done

# Validate required arguments
if [ -z "$SUMMARY" ]; then
  echo "Error: --summary is required"
  show_usage
fi

# Determine principal
if [ -n "$PRINCIPAL_OVERRIDE" ]; then
  OBS_PRINCIPAL="$PRINCIPAL_OVERRIDE"
else
  OBS_PRINCIPAL=$(get_principal)
fi

if [ -z "$OBS_PRINCIPAL" ]; then
  echo "Error: Cannot determine principal. Set PRINCIPAL env var or use --principal."
  exit 1
fi

# Determine observer
if [ -n "$AGENTNAME" ]; then
  OBSERVED_BY="agent:$AGENTNAME (on behalf of $OBS_PRINCIPAL)"
else
  OBSERVED_BY="principal:$OBS_PRINCIPAL"
fi

# Get next number
NUMBER=$(get_next_number)
NUMBER_PADDED=$(printf "%04d" "$NUMBER")

# Create filename
SLUG=$(slugify "$SUMMARY")
FILENAME="OBSERVE-${OBS_PRINCIPAL}-${NUMBER_PADDED}-${SLUG}.md"

# Ensure observations directory exists
OBS_DIR="$REPO_ROOT/claude/principals/$OBS_PRINCIPAL/observations"
mkdir -p "$OBS_DIR"

# Full path
FILEPATH="$OBS_DIR/$FILENAME"

# Get current date
DATE=$(date +%Y-%m-%d)

# Generate content
CONTENT=$(cat <<EOF
# OBSERVE-${OBS_PRINCIPAL}-${NUMBER_PADDED}-${SLUG}

**Status:** Open
**Observed By:** ${OBSERVED_BY}
**Created:** ${DATE}
**Updated:** ${DATE}

## Summary

${SUMMARY}

## Observation

${DETAILS:-"<!-- What did you observe? Describe what you noticed. -->"}

## Context

<!-- Where did you observe this? What were you doing? -->

## Potential Impact

<!-- Why might this matter? What could happen if not addressed? -->

## Related

<!-- Links to related files, requests, or observations -->

---

## Notes

### ${DATE} - Created
- Observation recorded by ${OBSERVED_BY}
EOF
)

main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "observe [run: ${RUN_ID:-none}]"

    # Write file
    echo "$CONTENT" > "$FILEPATH"

    echo "Created: $FILEPATH"

    trap - EXIT  # Clear trap
    log_end "$RUN_ID" "success" 0 0 "Observation created" 2>/dev/null || true
}

main
