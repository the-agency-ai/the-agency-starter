#!/bin/bash
# Show instructions for session start
# Displays active instructions + recently completed (7 days) for current agent
#
# Usage:
#   instruction-show              # Show for current agent
#   instruction-show --all        # Show all instructions
#
# Environment:
#   WORKSTREAM - Current workstream
#   AGENTNAME  - Current agent name

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "instruction-show" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "instruction-show $TOOL_VERSION"
    exit 0
fi

# Find repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

PRINCIPALS_DIR="$REPO_ROOT/claude/principals"

# Get agent identity
AGENT_WS="${WORKSTREAM:-unknown}"
AGENT_NAME="${AGENTNAME:-unknown}"
SHOW_ALL=false

# Parse options
while [[ $# -gt 0 ]]; do
  case $1 in
    --all|-a)
      SHOW_ALL=true
      shift
      ;;
    *)
      shift
      ;;
  esac
done

# Get date 7 days ago
CUTOFF_DATE=$(date -v-7d +%Y-%m-%d 2>/dev/null || date -d '7 days ago' +%Y-%m-%d 2>/dev/null)

# Find instructions
ACTIVE_INSTRUCTIONS=""
RECENT_INSTRUCTIONS=""

for principal_dir in "$PRINCIPALS_DIR"/*/; do
  INSTRUCTIONS_DIR="$principal_dir/instructions"

  if [[ ! -d "$INSTRUCTIONS_DIR" ]]; then
    continue
  fi

  for filepath in "$INSTRUCTIONS_DIR"/INSTR-*.md; do
    if [[ ! -f "$filepath" ]]; then
      continue
    fi

    # Get instruction details
    FILENAME=$(basename "$filepath" .md)
    INSTR_NUM=$(echo "$FILENAME" | grep -oE 'INSTR-[0-9]+' | head -1)

    # Get fields from file
    STATUS=$(grep -m1 "^\*\*Status:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*Status:\*\* //' || echo "Unknown")
    TO=$(grep -m1 "^\*\*To:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*To:\*\* //' || echo "")
    TITLE=$(grep -m1 "^# INSTR-" "$filepath" 2>/dev/null | sed 's/^# INSTR-[0-9]*: //' || echo "Unknown")
    PRINCIPAL=$(grep -m1 "^\*\*Principal:\*\*" "$filepath" 2>/dev/null | sed 's/.*\*\*Principal:\*\* //' || echo "?")

    # Check if this instruction is for current agent
    if [[ "$SHOW_ALL" == false ]]; then
      TO_WS=$(echo "$TO" | cut -d'/' -f1)
      TO_AGENT=$(echo "$TO" | cut -d'/' -f2)

      if [[ "$TO_WS" != "$AGENT_WS" ]] && [[ "$TO_AGENT" != "$AGENT_NAME" ]]; then
        continue
      fi
    fi

    if [[ "$STATUS" == "Active" ]]; then
      ACTIVE_INSTRUCTIONS="${ACTIVE_INSTRUCTIONS}ðŸ”µ $INSTR_NUM: $TITLE (from $PRINCIPAL)\n"
    elif [[ "$STATUS" == "Completed" ]]; then
      # Check if completed within last 7 days
      COMPLETED_DATE=$(grep -m1 "^\*\*Completed:\*\*" "$filepath" 2>/dev/null | sed -E 's/.*([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/' || echo "")

      if [[ -n "$COMPLETED_DATE" ]] && [[ "$COMPLETED_DATE" > "$CUTOFF_DATE" ]]; then
        RECENT_INSTRUCTIONS="${RECENT_INSTRUCTIONS}âœ… $INSTR_NUM: $TITLE (completed $COMPLETED_DATE)\n"
      fi
    fi
  done
done

# Only output if there's something to show
if [[ -n "$ACTIVE_INSTRUCTIONS" ]] || [[ -n "$RECENT_INSTRUCTIONS" ]]; then
  echo ""
  echo "  ðŸ“‹ Instructions for $AGENT_WS/$AGENT_NAME:"
  echo ""

  if [[ -n "$ACTIVE_INSTRUCTIONS" ]]; then
    echo "  Active:"
    echo -e "$ACTIVE_INSTRUCTIONS" | while read line; do
      if [[ -n "$line" ]]; then
        echo "     $line"
      fi
    done
  fi

  if [[ -n "$RECENT_INSTRUCTIONS" ]]; then
    echo ""
    echo "  Recently Completed (7 days):"
    echo -e "$RECENT_INSTRUCTIONS" | while read line; do
      if [[ -n "$line" ]]; then
        echo "     $line"
      fi
    done
  fi
  echo ""
else
  echo ""
  echo "  ðŸ“‹ No active or recent instructions for $AGENT_WS/$AGENT_NAME"
  echo ""
fi
