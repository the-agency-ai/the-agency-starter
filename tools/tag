#!/bin/bash
# Create properly formatted tags for work items and releases
#
# Usage:
#   ./tools/tag REQUEST-jordan-0017 impl      # REQUEST-jordan-0017-impl
#   ./tools/tag REQUEST-jordan-0017 review    # REQUEST-jordan-0017-review
#   ./tools/tag REQUEST-jordan-0017 tests     # REQUEST-jordan-0017-tests
#   ./tools/tag REQUEST-jordan-0017 complete  # REQUEST-jordan-0017-complete
#   ./tools/tag release 0.6.0                 # v0.6.0
#   ./tools/tag release 0.6.0 rc1             # v0.6.0-rc1
#
# Options:
#   --push, -p    Push tag to remote after creating
#   --message, -m Custom tag message
#   --dry-run     Show what would be done without doing it
#   --list        List tags for a work item
#
# Valid stages: impl, review, tests, complete

set -e

TOOL_VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Valid stages for work items
VALID_STAGES="impl review tests complete"

# Parse options
PUSH=false
DRY_RUN=false
LIST=false
MESSAGE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --version|-v)
            echo "tag $TOOL_VERSION"
            exit 0
            ;;
        --help|-h)
            head -20 "$0" | tail -19 | sed 's/^# //' | sed 's/^#//'
            exit 0
            ;;
        --push|-p)
            PUSH=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --list)
            LIST=true
            shift
            ;;
        --message|-m)
            MESSAGE="$2"
            shift 2
            ;;
        *)
            break
            ;;
    esac
done

# List mode
if [ "$LIST" = true ]; then
    PATTERN="${1:-}"
    if [ -z "$PATTERN" ]; then
        echo -e "${RED}Error: Provide a work item pattern to list tags${NC}"
        echo "Usage: ./tools/tag --list REQUEST-jordan-0017"
        exit 1
    fi
    echo "Tags matching $PATTERN:"
    git tag -l "${PATTERN}*" | sort -V
    exit 0
fi

# Require at least 2 arguments
if [ $# -lt 2 ]; then
    echo -e "${RED}Error: Missing arguments${NC}"
    echo "Usage: ./tools/tag <work-item> <stage>"
    echo "       ./tools/tag release <version> [suffix]"
    echo ""
    echo "Examples:"
    echo "  ./tools/tag REQUEST-jordan-0017 impl"
    echo "  ./tools/tag release 0.6.0"
    echo "  ./tools/tag release 0.6.0 rc1"
    exit 1
fi

ITEM="$1"
STAGE="$2"
SUFFIX="${3:-}"

# Determine tag format
if [ "$ITEM" = "release" ]; then
    # Release tag
    VERSION="$STAGE"
    if [ -n "$SUFFIX" ]; then
        TAG_NAME="v${VERSION}-${SUFFIX}"
    else
        TAG_NAME="v${VERSION}"
    fi

    # Validate version format (semver)
    if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}Error: Invalid version format. Use semver (e.g., 0.6.0)${NC}"
        exit 1
    fi

    DEFAULT_MESSAGE="Release ${TAG_NAME}"
else
    # Work item tag (REQUEST, BUG, etc.)

    # Validate stage
    if ! echo "$VALID_STAGES" | grep -qw "$STAGE"; then
        echo -e "${RED}Error: Invalid stage '$STAGE'${NC}"
        echo "Valid stages: $VALID_STAGES"
        exit 1
    fi

    TAG_NAME="${ITEM}-${STAGE}"
    DEFAULT_MESSAGE="${ITEM} - ${STAGE} phase complete"
fi

# Use custom message or default
TAG_MESSAGE="${MESSAGE:-$DEFAULT_MESSAGE}"

# Check if tag already exists
if git tag -l "$TAG_NAME" | grep -q "$TAG_NAME"; then
    echo -e "${YELLOW}Warning: Tag '$TAG_NAME' already exists${NC}"
    read -p "Delete and recreate? (y/N) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        if [ "$DRY_RUN" = true ]; then
            echo "[DRY RUN] Would delete tag: $TAG_NAME"
        else
            git tag -d "$TAG_NAME"
            if [ "$PUSH" = true ]; then
                git push origin ":refs/tags/$TAG_NAME" 2>/dev/null || true
            fi
        fi
    else
        echo "Aborted."
        exit 1
    fi
fi

# Create the tag
if [ "$DRY_RUN" = true ]; then
    echo "[DRY RUN] Would create tag: $TAG_NAME"
    echo "[DRY RUN] Message: $TAG_MESSAGE"
    if [ "$PUSH" = true ]; then
        echo "[DRY RUN] Would push to remote"
    fi
else
    git tag -a "$TAG_NAME" -m "$TAG_MESSAGE"
    echo -e "${GREEN}Created tag: $TAG_NAME${NC}"

    if [ "$PUSH" = true ]; then
        git push origin "$TAG_NAME"
        echo -e "${GREEN}Pushed tag to remote${NC}"
    else
        echo -e "${YELLOW}Tip: Use --push to push to remote, or run: git push origin $TAG_NAME${NC}"
    fi
fi
