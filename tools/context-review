#!/bin/bash
# context-review - Review saved session context
#
# Usage:
#   ./tools/context-review [--verbose]           # Formatted view
#   ./tools/context-review --raw [--verbose]     # Show raw JSONL
#   ./tools/context-review --summary [--verbose] # Last checkpoint + parked items
#
# Why this exists:
#   Allows users and agents to review what context has been saved

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "context-review" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260114-000005"

# Defaults
VERBOSE=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Main function
main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    verbose_echo "context-review [run: ${RUN_ID:-none}]"

    local MODE=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --version|-v)
                echo "context-review $TOOL_VERSION"
                exit 0
                ;;
            --help|-h)
                echo "context-review - Review saved session context"
                echo ""
                echo "Usage:"
                echo "  ./tools/context-review [--verbose]"
                echo "  ./tools/context-review --raw [--verbose]"
                echo "  ./tools/context-review --summary [--verbose]"
                echo ""
                echo "Options:"
                echo "  --raw         Show raw JSONL"
                echo "  --summary     Show last checkpoint + parked items"
                echo "  --verbose     Show detailed logging"
                echo "  --version, -v Show tool version"
                echo "  --help, -h    Show this help"
                exit 0
                ;;
            --verbose)
                VERBOSE=true
                shift
                ;;
            --raw|--summary)
                MODE="$1"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    local AGENTNAME=$(./tools/agentname)
    local CONTEXT_FILE="claude/agents/$AGENTNAME/backups/latest/context.jsonl"

    log_step "Checking context file"
    if [[ ! -f "$CONTEXT_FILE" ]]; then
        log_error "No context file found at $CONTEXT_FILE"
        trap - EXIT
        log_end "$RUN_ID" "failure" 1 0 "No context file found"
        exit 1
    fi

    case "$MODE" in
        --raw)
            log_step "Displaying raw context"
            cat "$CONTEXT_FILE"
            ;;
        --summary)
            log_step "Displaying summary"
            echo "Last Checkpoint:"
            grep '"type":"checkpoint"' "$CONTEXT_FILE" | tail -1 | \
                sed 's/.*"content":"\(.*\)"}/\1/'
            echo ""
            echo "Parked Items:"
            grep '"type":"park"' "$CONTEXT_FILE" | \
                sed 's/.*"content":"\(.*\)"}/\1/'
            ;;
        *)
            log_step "Displaying formatted context"
            # Formatted view
            echo "=== Session Context for $AGENTNAME ==="
            cat "$CONTEXT_FILE" | while IFS= read -r line; do
                TYPE=$(echo "$line" | grep -o '"type":"[^"]*"' | cut -d'"' -f4)
                TIME=$(echo "$line" | grep -o '"timestamp":"[^"]*"' | cut -d'"' -f4 | cut -d' ' -f2)
                CONTENT=$(echo "$line" | sed 's/.*"content":"\(.*\)"}/\1/')

                case "$TYPE" in
                    checkpoint) printf "[%s] ✓ %s\n" "$TIME" "$CONTENT" ;;
                    park)       printf "[%s] ⏸ %s\n" "$TIME" "$CONTENT" ;;
                    append)     printf "[%s] • %s\n" "$TIME" "$CONTENT" ;;
                esac
            done
            ;;
    esac

    trap - EXIT  # Clear trap
    log_end "$RUN_ID" "success" 0 0 "Context reviewed" 2>/dev/null || true
}

main "$@"
