#!/bin/bash
#
# adhoc-log - Log ad-hoc (out-of-plan) work to agent's ADHOC-WORKLOG.md
#
# Usage:
#   ./tools/adhoc-log "Title" "Why" "What" "Impact"
#   ./tools/adhoc-log --interactive
#
# This tool helps agents track unplanned work that occurs outside
# the Epic → Sprint → Iteration workflow.
#
# Required environment:
#   AGENTNAME - Current agent name
#
# Output:
#   Creates entry in claude/agents/{AGENTNAME}/ADHOC-WORKLOG.md
#

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "adhoc-log" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "adhoc-log $TOOL_VERSION"
    exit 0
fi

# Get agent name
if [ -z "$AGENTNAME" ]; then
    AGENTNAME=$(./tools/agentname 2>/dev/null || echo "")
fi

if [ -z "$AGENTNAME" ]; then
    echo "Error: AGENTNAME not set. Run with AGENTNAME=yourname or set environment variable." >&2
    exit 1
fi

# Normalize to lowercase
AGENTNAME_LOWER=$(echo "$AGENTNAME" | tr '[:upper:]' '[:lower:]')
AGENTNAME_UPPER=$(echo "$AGENTNAME" | tr '[:lower:]' '[:upper:]')

# Paths
ADHOC_FILE="claude/agents/${AGENTNAME_LOWER}/ADHOC-WORKLOG.md"

if [ ! -f "$ADHOC_FILE" ]; then
    echo "Error: ADHOC-WORKLOG.md not found at $ADHOC_FILE" >&2
    echo "Creating empty ADHOC-WORKLOG.md..." >&2
    mkdir -p "$(dirname "$ADHOC_FILE")"
    cat > "$ADHOC_FILE" << 'TEMPLATE'
# Ad-Hoc Work Log

Work done outside Epic → Sprint → Iteration workflow.

**Format:** `{WORKSTREAM}-ADHOC-{number}`

This is the primary documentation for ad-hoc work - there are no backing sprint docs.

**Order:** Most recent first (reverse chronological) - use `head` to see latest work

---

TEMPLATE
fi

# Get timestamp
TIMESTAMP=$(./tools/now 2>/dev/null || date '+%Y-%m-%d %H:%M')

# Find next ADHOC ID by counting existing entries
LAST_ID=$(grep -oE "${AGENTNAME_UPPER}-ADHOC-[0-9]+" "$ADHOC_FILE" 2>/dev/null | grep -oE '[0-9]+$' | sort -n | tail -1 || echo "0")
NEXT_ID=$(printf "%04d" $((10#${LAST_ID:-0} + 1)))
ADHOC_ID="${AGENTNAME_UPPER}-ADHOC-${NEXT_ID}"

# Interactive mode
if [ "$1" == "--interactive" ] || [ "$1" == "-i" ]; then
    echo "=== Log Ad-Hoc Work ===" >&2
    echo "Agent: $AGENTNAME_LOWER" >&2
    echo "Next ID: $ADHOC_ID" >&2
    echo "" >&2

    read -p "Title: " TITLE
    echo "" >&2
    echo "Why (what triggered this work):" >&2
    read -p "> " WHY
    echo "" >&2
    echo "What (brief summary of what was done):" >&2
    read -p "> " WHAT
    echo "" >&2
    echo "Impact (what changed, who benefits):" >&2
    read -p "> " IMPACT
else
    # Argument mode
    if [ $# -lt 4 ]; then
        echo "Usage: ./tools/adhoc-log \"Title\" \"Why\" \"What\" \"Impact\"" >&2
        echo "   or: ./tools/adhoc-log --interactive" >&2
        echo "" >&2
        echo "Creates entry in: $ADHOC_FILE" >&2
        echo "Next ID would be: $ADHOC_ID" >&2
        exit 1
    fi

    TITLE="$1"
    WHY="$2"
    WHAT="$3"
    IMPACT="$4"
fi

# Build the entry
ENTRY=$(cat << EOF

## ${ADHOC_ID} | ${TIMESTAMP}

**${TITLE}**

**Why:** ${WHY}

**What:** ${WHAT}

**Impact:** ${IMPACT}

**Files Created:** (fill in)

**Files Modified:** (fill in)

**Related:** (fill in if applicable)

---
EOF
)

# Find the line with the first "---" after the header and insert after it
# The header ends with "---" so we insert after that
HEADER_END=$(grep -n "^---$" "$ADHOC_FILE" | head -1 | cut -d: -f1)

if [ -z "$HEADER_END" ]; then
    # No header separator, append to end
    echo "$ENTRY" >> "$ADHOC_FILE"
else
    # Insert after header separator (most recent first)
    head -n "$HEADER_END" "$ADHOC_FILE" > "${ADHOC_FILE}.tmp"
    echo "$ENTRY" >> "${ADHOC_FILE}.tmp"
    tail -n +"$((HEADER_END + 1))" "$ADHOC_FILE" >> "${ADHOC_FILE}.tmp"
    mv "${ADHOC_FILE}.tmp" "$ADHOC_FILE"
fi

echo "Created: $ADHOC_ID" >&2
echo "File: $ADHOC_FILE" >&2
echo "" >&2
echo "Entry added. Remember to fill in:" >&2
echo "  - Files Created" >&2
echo "  - Files Modified" >&2
echo "  - Related (if applicable)" >&2
echo "" >&2
echo "View with: head -60 $ADHOC_FILE" >&2

# Output the ID for scripting
echo "$ADHOC_ID"
