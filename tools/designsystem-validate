#!/bin/bash
# designsystem-validate - Validate a design system for completeness
#
# Usage:
#   ./tools/designsystem-validate <path>
#   ./tools/designsystem-validate claude/knowledge/design-systems/acme-001
#
# Checks:
#   - Required files present
#   - No placeholder values remaining
#   - Valid hex color format
#   - No critical gaps outstanding

# Don't use set -e as we want to continue on check failures
# set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source log helper for tool tracking
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Start logging
RUN_ID=$(log_start "designsystem-validate" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260114-000002"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
DIM='\033[2m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Counters
CHECKS_RUN=0
CHECKS_PASSED=0
CHECKS_FAILED=0
WARNINGS=0

# Defaults
VERBOSE=false
STRICT=false

# Parse arguments
show_help() {
    echo "designsystem-validate - Validate a design system for completeness"
    echo ""
    echo "Usage:"
    echo "  ./tools/designsystem-validate <path>"
    echo ""
    echo "Arguments:"
    echo "  path    Path to design system directory"
    echo ""
    echo "Options:"
    echo "  --help, -h     Show this help message"
    echo "  --version, -v  Show version"
    echo "  --strict       Exit non-zero on warnings (default: only on errors)"
    echo "  --verbose      Enable verbose logging"
    echo ""
    echo "Examples:"
    echo "  ./tools/designsystem-validate claude/knowledge/design-systems/acme-001"
    echo ""
    echo "Checks performed:"
    echo "  - Required files present (INDEX.md, colors.md, etc.)"
    echo "  - No placeholder values (#??????, ??px)"
    echo "  - Valid hex color format"
    echo "  - No critical gaps outstanding in GAPS.md"
}

for arg in "$@"; do
    case $arg in
        --help|-h)
            show_help
            exit 0
            ;;
        --version|-v)
            echo "designsystem-validate $TOOL_VERSION"
            exit 0
            ;;
        --strict)
            STRICT=true
            ;;
        --verbose)
            VERBOSE=true
            ;;
    esac
done

# Get path (skip option arguments)
DESIGN_SYSTEM_PATH=""
for arg in "$@"; do
    case $arg in
        --*) ;;
        *)
            DESIGN_SYSTEM_PATH="$arg"
            break
            ;;
    esac
done

if [[ -z "$DESIGN_SYSTEM_PATH" ]]; then
    echo -e "${RED}Error: Missing required path argument${NC}"
    echo ""
    echo "Usage: ./tools/designsystem-validate <path>"
    exit 1
fi

# Resolve path
if [[ ! "$DESIGN_SYSTEM_PATH" = /* ]]; then
    DESIGN_SYSTEM_PATH="$PROJECT_ROOT/$DESIGN_SYSTEM_PATH"
fi

# Check directory exists
if [[ ! -d "$DESIGN_SYSTEM_PATH" ]]; then
    echo -e "${RED}Error: Directory not found: $DESIGN_SYSTEM_PATH${NC}"
    exit 1
fi

# Get design system name from path
SYSTEM_NAME=$(basename "$DESIGN_SYSTEM_PATH")

main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "designsystem-validate [run: ${RUN_ID:-none}]"
    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  Design System Validation: ${SYSTEM_NAME}${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

# Helper functions
check_pass() {
    echo -e "  ${GREEN}✓${NC} $1"
    ((CHECKS_PASSED++))
    ((CHECKS_RUN++))
}

check_fail() {
    echo -e "  ${RED}✗${NC} $1"
    ((CHECKS_FAILED++))
    ((CHECKS_RUN++))
}

check_warn() {
    echo -e "  ${YELLOW}⚠${NC} $1"
    ((WARNINGS++))
}

# ============================================
# Check 1: Required files present
# ============================================
echo -e "${BLUE}[1/5] Required Files${NC}"

REQUIRED_FILES=(
    "INDEX.md"
    "GAPS.md"
    "GAP-RESOLUTION.md"
    "colors.md"
    "typography.md"
    "spacing.md"
    "tailwind-config.md"
)

OPTIONAL_FILES=(
    "effects.md"
    "assets.md"
)

for file in "${REQUIRED_FILES[@]}"; do
    if [[ -f "$DESIGN_SYSTEM_PATH/$file" ]]; then
        check_pass "$file exists"
    else
        check_fail "$file missing (required)"
    fi
done

for file in "${OPTIONAL_FILES[@]}"; do
    if [[ -f "$DESIGN_SYSTEM_PATH/$file" ]]; then
        check_pass "$file exists (optional)"
    else
        check_warn "$file missing (optional)"
    fi
done

echo ""

# ============================================
# Check 2: No placeholder hex values
# ============================================
echo -e "${BLUE}[2/5] Placeholder Values${NC}"

# Check for #?????? placeholder hex values
PLACEHOLDER_HEX=$(grep -r "#??????" "$DESIGN_SYSTEM_PATH"/*.md 2>/dev/null | wc -l | tr -d ' ')
if [[ "$PLACEHOLDER_HEX" -eq 0 ]]; then
    check_pass "No placeholder hex values (#??????)"
else
    check_fail "$PLACEHOLDER_HEX placeholder hex values found (#??????)"
fi

# Check for ??px placeholder measurements
PLACEHOLDER_PX=$(grep -r "??px" "$DESIGN_SYSTEM_PATH"/*.md 2>/dev/null | wc -l | tr -d ' ')
if [[ "$PLACEHOLDER_PX" -eq 0 ]]; then
    check_pass "No placeholder measurements (??px)"
else
    check_fail "$PLACEHOLDER_PX placeholder measurements found (??px)"
fi

# Check for {{PLACEHOLDER}} template variables
PLACEHOLDER_TEMPLATE=$(grep -r "{{[A-Z_]*}}" "$DESIGN_SYSTEM_PATH"/*.md 2>/dev/null | wc -l | tr -d ' ')
if [[ "$PLACEHOLDER_TEMPLATE" -eq 0 ]]; then
    check_pass "No template placeholders ({{...}})"
else
    check_fail "$PLACEHOLDER_TEMPLATE template placeholders found"
fi

# Check for [TODO] markers
PLACEHOLDER_TODO=$(grep -ri "\[TODO\]" "$DESIGN_SYSTEM_PATH"/*.md 2>/dev/null | wc -l | tr -d ' ')
if [[ "$PLACEHOLDER_TODO" -eq 0 ]]; then
    check_pass "No [TODO] markers"
else
    check_warn "$PLACEHOLDER_TODO [TODO] markers found"
fi

echo ""

# ============================================
# Check 3: Valid hex colors in colors.md
# ============================================
echo -e "${BLUE}[3/5] Color Format Validation${NC}"

if [[ -f "$DESIGN_SYSTEM_PATH/colors.md" ]]; then
    # Extract hex values and validate format
    # Valid: #RGB, #RRGGBB, #RRGGBBAA (case insensitive)
    INVALID_HEX=$(grep -oE '#[0-9A-Fa-f?]+' "$DESIGN_SYSTEM_PATH/colors.md" 2>/dev/null | \
        grep -vE '^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$' | \
        grep -v "#??????" | \
        wc -l | tr -d ' ')

    if [[ "$INVALID_HEX" -eq 0 ]]; then
        check_pass "All hex colors are valid format"
    else
        check_fail "$INVALID_HEX invalid hex color formats found"
    fi

    # Count defined colors
    COLOR_COUNT=$(grep -oE '#[0-9A-Fa-f]{6}' "$DESIGN_SYSTEM_PATH/colors.md" 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$COLOR_COUNT" -gt 0 ]]; then
        check_pass "$COLOR_COUNT color values defined"
    else
        check_warn "No color values found"
    fi
else
    check_fail "colors.md not found"
fi

echo ""

# ============================================
# Check 4: GAPS.md status
# ============================================
echo -e "${BLUE}[4/5] Gap Status${NC}"

if [[ -f "$DESIGN_SYSTEM_PATH/GAPS.md" ]]; then
    # Check for critical gaps
    CRITICAL_GAPS=$(grep -c "## Critical Gaps" "$DESIGN_SYSTEM_PATH/GAPS.md" 2>/dev/null || echo "0")

    # Count unchecked critical items (lines with "- [ ]" after Critical Gaps section)
    UNCHECKED_CRITICAL=$(sed -n '/## Critical Gaps/,/## Medium Gaps/p' "$DESIGN_SYSTEM_PATH/GAPS.md" 2>/dev/null | \
        grep -c "\- \[ \]" || echo "0")

    if [[ "$UNCHECKED_CRITICAL" -eq 0 ]]; then
        check_pass "No outstanding critical gaps"
    else
        check_fail "$UNCHECKED_CRITICAL critical gaps outstanding"
    fi

    # Count all unchecked items
    UNCHECKED_TOTAL=$(grep -c "\- \[ \]" "$DESIGN_SYSTEM_PATH/GAPS.md" 2>/dev/null || echo "0")
    if [[ "$UNCHECKED_TOTAL" -gt 0 ]]; then
        check_warn "$UNCHECKED_TOTAL total gaps outstanding"
    else
        check_pass "All gaps resolved"
    fi
else
    check_fail "GAPS.md not found"
fi

echo ""

# ============================================
# Check 5: Tailwind config validity
# ============================================
echo -e "${BLUE}[5/5] Tailwind Configuration${NC}"

if [[ -f "$DESIGN_SYSTEM_PATH/tailwind-config.md" ]]; then
    # Check for basic structure
    if grep -q "theme:" "$DESIGN_SYSTEM_PATH/tailwind-config.md" 2>/dev/null; then
        check_pass "Tailwind theme block present"
    else
        check_fail "Tailwind theme block not found"
    fi

    if grep -q "colors:" "$DESIGN_SYSTEM_PATH/tailwind-config.md" 2>/dev/null; then
        check_pass "Colors configuration present"
    else
        check_warn "Colors configuration not found"
    fi

    if grep -q "fontSize:" "$DESIGN_SYSTEM_PATH/tailwind-config.md" 2>/dev/null; then
        check_pass "Typography configuration present"
    else
        check_warn "Typography configuration not found"
    fi

    if grep -q "spacing:" "$DESIGN_SYSTEM_PATH/tailwind-config.md" 2>/dev/null; then
        check_pass "Spacing configuration present"
    else
        check_warn "Spacing configuration not found"
    fi
else
    check_fail "tailwind-config.md not found"
fi

echo ""

# ============================================
# Summary
# ============================================
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  Summary${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo "  Checks run:    $CHECKS_RUN"
echo "  Passed:        $CHECKS_PASSED"
echo "  Failed:        $CHECKS_FAILED"
echo "  Warnings:      $WARNINGS"
echo ""

    if [[ $CHECKS_FAILED -eq 0 && $WARNINGS -eq 0 ]]; then
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${GREEN}  VALID - Design system is complete${NC}"
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        trap - EXIT  # Clear trap
        log_end "$RUN_ID" "success" "0" "0" "Valid: $CHECKS_PASSED/$CHECKS_RUN passed" 2>/dev/null || true
        exit 0
    elif [[ $CHECKS_FAILED -eq 0 ]]; then
        echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${YELLOW}  VALID WITH WARNINGS - Review optional items${NC}"
        echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        trap - EXIT  # Clear trap
        log_end "$RUN_ID" "success" "0" "0" "Valid with $WARNINGS warnings" 2>/dev/null || true
        if [[ "$STRICT" == "true" ]]; then
            exit 1
        fi
        exit 0
    else
        echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${RED}  INCOMPLETE - $CHECKS_FAILED issue(s) need resolution${NC}"
        echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        trap - EXIT  # Clear trap
        log_end "$RUN_ID" "failure" "1" "0" "Failed: $CHECKS_FAILED issues" 2>/dev/null || true
        exit 1
    fi
}

main
