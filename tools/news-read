#!/bin/bash
# Tool: news-read
# Purpose: Read unread news messages and mark them as read by current agent
# Usage: ./tools/news-read
# Returns: All ACTIVE messages not yet read by current agent

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "news-read" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "news-read $TOOL_VERSION"
    exit 0
fi

# Auto-load .env.local if it exists
if [[ -f ".env.local" ]]; then
  set -a
  source .env.local
  set +a
fi

NEWS_FILE="claude/agents/collaboration/NEWS.md"

# Get agent name
AGENTNAME=$(./tools/agentname 2>/dev/null || echo "unknown")
COMMIT_PREFIX=$(./tools/commit-prefix 2>/dev/null || echo "unknown/unknown:")

if [[ "$AGENTNAME" == "unknown" ]]; then
  echo "Warning: AGENTNAME not set. Cannot track read status properly."
fi

# Function to handle merge conflicts
handle_merge_conflict() {
  echo "Merge conflict detected. Attempting to resolve..."
  git checkout --theirs "$NEWS_FILE" 2>/dev/null || true
  git add "$NEWS_FILE"
  echo "Resolved by accepting remote version."
  return 0
}

# Step 1: Pull latest
echo "Pulling latest changes..."
git pull --rebase 2>/dev/null || {
  git rebase --abort 2>/dev/null || true
  git pull || {
    if git diff --name-only --diff-filter=U | grep -q "$NEWS_FILE"; then
      handle_merge_conflict
    fi
  }
}

# Step 2: Check if NEWS.md exists
if [[ ! -f "$NEWS_FILE" ]]; then
  echo "No news file found. Nothing to read."
  exit 0
fi

# Step 3: Find all ACTIVE messages not read by this agent
# Use awk to parse the file and find unread messages
UNREAD_MESSAGES=$(awk -v agent="$AGENTNAME" '
BEGIN { in_message = 0; is_active = 0; is_unread = 0; message = ""; message_id = "" }

/^### NEWS-[0-9]+/ {
  # Output previous message if it was unread
  if (in_message && is_active && is_unread) {
    print message
    print "---"
  }
  # Start new message
  in_message = 1
  is_active = 0
  is_unread = 1
  message = $0 "\n"
  message_id = $2
  next
}

in_message {
  message = message $0 "\n"

  # Check if ACTIVE
  if ($0 ~ /\*\*Status:\*\* ACTIVE/) {
    is_active = 1
  }

  # Check if already read by this agent
  if ($0 ~ /\*\*Read by:\*\*/) {
    if (index($0, agent) > 0) {
      is_unread = 0
    }
  }

  # End of message (next message starts or end of file section)
  if ($0 ~ /^---$/) {
    if (is_active && is_unread) {
      print message
    }
    in_message = 0
    is_active = 0
    is_unread = 1
    message = ""
  }
}

END {
  if (in_message && is_active && is_unread) {
    print message
    print "---"
  }
}
' "$NEWS_FILE")

# Step 4: Display unread messages
if [[ -z "$UNREAD_MESSAGES" || "$UNREAD_MESSAGES" == "---" ]]; then
  echo ""
  echo "No unread news messages for agent: $AGENTNAME"
  echo ""
  exit 0
fi

echo ""
echo "=== UNREAD NEWS FOR $AGENTNAME ==="
echo ""
echo "$UNREAD_MESSAGES"
echo ""

# Step 5: Mark messages as read by this agent
# Add agent name to the "Read by:" line for each ACTIVE message not yet containing agent
CHANGES_MADE=0

# Create a temporary file with updates
awk -v agent="$AGENTNAME" '
BEGIN { in_active_message = 0 }

/^### NEWS-[0-9]+/ {
  in_active_message = 0
  print
  next
}

/\*\*Status:\*\* ACTIVE/ {
  in_active_message = 1
  print
  next
}

/\*\*Status:\*\* READ/ {
  in_active_message = 0
  print
  next
}

/\*\*Read by:\*\*/ {
  if (in_active_message && index($0, agent) == 0) {
    # Agent not in list, add them
    # Remove trailing whitespace and add agent
    sub(/[[:space:]]*$/, "", $0)
    print $0 ", " agent
  } else {
    print
  }
  next
}

{ print }
' "$NEWS_FILE" > "$NEWS_FILE.tmp"

# Check if changes were made
if ! diff -q "$NEWS_FILE" "$NEWS_FILE.tmp" > /dev/null 2>&1; then
  mv "$NEWS_FILE.tmp" "$NEWS_FILE"
  CHANGES_MADE=1
else
  rm "$NEWS_FILE.tmp"
fi

# Step 6: Commit and push if changes were made
if [[ $CHANGES_MADE -eq 1 ]]; then
  git add "$NEWS_FILE"
  COMMIT_MSG="$COMMIT_PREFIX chore: mark news as read by $AGENTNAME

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

  git commit -m "$COMMIT_MSG

[skip ci]" || {
    echo "Nothing to commit"
  }

  # Push using sync tool
  echo "Syncing changes..."
  ./tools/sync || {
    echo "Sync failed"
  }

  echo "Marked messages as read by: $AGENTNAME"
fi
