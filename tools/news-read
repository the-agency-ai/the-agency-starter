#!/bin/bash
# Tool: news-read
# Purpose: Read unread news messages and mark them as read by current agent
# Usage: ./tools/news-read
# Returns: All ACTIVE messages not yet read by current agent

set -e

# Tool version
TOOL_VERSION="1.0.1-20260114-000004"

# Defaults
VERBOSE=false

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "news-read $TOOL_VERSION"
    exit 0
fi

# Parse flags
while [[ $# -gt 0 ]]; do
    case $1 in
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help|-h)
            echo "Usage: ./tools/news-read [--verbose]"
            echo ""
            echo "Options:"
            echo "  --verbose    Show detailed output"
            echo "  --version    Show tool version"
            echo "  --help       Show this help"
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Auto-load .env.local if it exists
if [[ -f ".env.local" ]]; then
  set -a
  source .env.local
  set +a
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

NEWS_FILE="claude/agents/collaboration/NEWS.md"

# Main function
main() {
    # Trap unexpected exits
    trap 'if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then log_end "$RUN_ID" "failure" $? 0 "Unexpected exit"; fi' EXIT

    echo "news-read [run: ${RUN_ID:-none}]"

    RUN_ID=$(log_start "news-read" "agency-tool" "$@" 2>/dev/null) || true

    # Get agent name
    AGENTNAME=$(./tools/agentname 2>/dev/null || echo "unknown")
    COMMIT_PREFIX=$(./tools/commit-prefix 2>/dev/null || echo "unknown/unknown:")

    if [[ "$AGENTNAME" == "unknown" ]]; then
      log_warn "AGENTNAME not set. Cannot track read status properly."
    fi

    # Function to handle merge conflicts
    handle_merge_conflict() {
      log_info "Merge conflict detected. Attempting to resolve..."
      git checkout --theirs "$NEWS_FILE" 2>/dev/null || true
      git add "$NEWS_FILE"
      log_info "Resolved by accepting remote version."
      return 0
    }

    # Step 1: Pull latest
    log_step "Pulling latest changes..."
    git pull --rebase 2>/dev/null || {
      git rebase --abort 2>/dev/null || true
      git pull || {
        if git diff --name-only --diff-filter=U | grep -q "$NEWS_FILE"; then
          handle_merge_conflict
        fi
      }
    }

    # Step 2: Check if NEWS.md exists
    if [[ ! -f "$NEWS_FILE" ]]; then
      echo "No news file found. Nothing to read."
      trap - EXIT
      if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then
          log_end "$RUN_ID" "success" "0" "0" "No news file"
      fi
      exit 0
    fi

    # Step 3: Find all ACTIVE messages not read by this agent
    # Use awk to parse the file and find unread messages
    log_step "Finding unread messages for $AGENTNAME..."
    UNREAD_MESSAGES=$(awk -v agent="$AGENTNAME" '
BEGIN { in_message = 0; is_active = 0; is_unread = 0; message = ""; message_id = "" }

/^### NEWS-[0-9]+/ {
  # Output previous message if it was unread
  if (in_message && is_active && is_unread) {
    print message
    print "---"
  }
  # Start new message
  in_message = 1
  is_active = 0
  is_unread = 1
  message = $0 "\n"
  message_id = $2
  next
}

in_message {
  message = message $0 "\n"

  # Check if ACTIVE
  if ($0 ~ /\*\*Status:\*\* ACTIVE/) {
    is_active = 1
  }

  # Check if already read by this agent
  if ($0 ~ /\*\*Read by:\*\*/) {
    if (index($0, agent) > 0) {
      is_unread = 0
    }
  }

  # End of message (next message starts or end of file section)
  if ($0 ~ /^---$/) {
    if (is_active && is_unread) {
      print message
    }
    in_message = 0
    is_active = 0
    is_unread = 1
    message = ""
  }
}

END {
  if (in_message && is_active && is_unread) {
    print message
    print "---"
  }
}
' "$NEWS_FILE")

    # Step 4: Display unread messages
    if [[ -z "$UNREAD_MESSAGES" || "$UNREAD_MESSAGES" == "---" ]]; then
      echo ""
      echo "No unread news messages for agent: $AGENTNAME"
      echo ""
      trap - EXIT
      if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then
          log_end "$RUN_ID" "success" "0" "0" "No unread messages"
      fi
      exit 0
    fi

    echo ""
    echo "=== UNREAD NEWS FOR $AGENTNAME ==="
    echo ""
    echo "$UNREAD_MESSAGES"
    echo ""

    # Step 5: Mark messages as read by this agent
    # Add agent name to the "Read by:" line for each ACTIVE message not yet containing agent
    log_step "Marking messages as read..."
    CHANGES_MADE=0

    # Create a temporary file with updates
    awk -v agent="$AGENTNAME" '
BEGIN { in_active_message = 0 }

/^### NEWS-[0-9]+/ {
  in_active_message = 0
  print
  next
}

/\*\*Status:\*\* ACTIVE/ {
  in_active_message = 1
  print
  next
}

/\*\*Status:\*\* READ/ {
  in_active_message = 0
  print
  next
}

/\*\*Read by:\*\*/ {
  if (in_active_message && index($0, agent) == 0) {
    # Agent not in list, add them
    # Remove trailing whitespace and add agent
    sub(/[[:space:]]*$/, "", $0)
    print $0 ", " agent
  } else {
    print
  }
  next
}

{ print }
' "$NEWS_FILE" > "$NEWS_FILE.tmp"

    # Check if changes were made
    if ! diff -q "$NEWS_FILE" "$NEWS_FILE.tmp" > /dev/null 2>&1; then
      mv "$NEWS_FILE.tmp" "$NEWS_FILE"
      CHANGES_MADE=1
    else
      rm "$NEWS_FILE.tmp"
    fi

    # Step 6: Commit and push if changes were made
    if [[ $CHANGES_MADE -eq 1 ]]; then
      log_step "Committing read status..."
      git add "$NEWS_FILE"
      COMMIT_MSG="$COMMIT_PREFIX chore: mark news as read by $AGENTNAME

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

      git commit -m "$COMMIT_MSG

[skip ci]" || {
        verbose_echo "Nothing to commit"
      }

      # Push using sync tool
      log_step "Syncing changes..."
      ./tools/sync || {
        log_warn "Sync failed"
      }

      verbose_echo "Marked messages as read by: $AGENTNAME"
    fi

    trap - EXIT
    if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then
        log_end "$RUN_ID" "success" "0" "0" "News read by $AGENTNAME"
    fi
}

main
