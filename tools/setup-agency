#!/bin/bash
#
# setup-agency - First-time Agency setup for new projects
#
# This script runs OUTSIDE Claude Code to handle interactive setup.
# It creates the first principal and initializes the project.
#
# Usage:
#   setup-agency                    # Interactive setup
#   setup-agency --principal alice  # Non-interactive with name
#   setup-agency --help             # Show help
#

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Tool version
TOOL_VERSION="1.0.0-20260118-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Defaults
VERBOSE=false
PRINCIPAL_NAME=""
SKIP_VAULT=false
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Logging functions
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

usage() {
    cat << EOF
Usage: setup-agency [options]

First-time Agency setup for new projects. Creates your principal
directory and initializes the Agency environment.

Options:
  --principal NAME   Set principal name (skips prompt)
  --skip-vault       Skip vault initialization
  --verbose          Show detailed output
  -v, --version      Show version
  -h, --help         Show this help

Examples:
  setup-agency                      # Interactive setup
  setup-agency --principal alice    # Non-interactive
  setup-agency --principal bob --skip-vault
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --principal)
            PRINCIPAL_NAME="$2"
            shift 2
            ;;
        --skip-vault)
            SKIP_VAULT=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -v|--version)
            echo "setup-agency $TOOL_VERSION"
            exit 0
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Check we're in an Agency project
if [[ ! -f "$PROJECT_ROOT/claude/config/agency.yaml" ]]; then
    log_error "Not in an Agency project (missing claude/config/agency.yaml)"
    echo "Run this from an Agency project root."
    exit 1
fi

# Check if already set up
if [[ -f "$PROJECT_ROOT/.agency-setup-complete" ]]; then
    log_warn "Agency already set up. To add another principal, use: ./tools/add-principal"
    exit 0
fi

# Check if this is the starter template
if [[ -f "$PROJECT_ROOT/.agency-starter" ]]; then
    log_error "This is the starter template. Create a project first:"
    echo ""
    echo "  ./tools/project-create my-project"
    echo ""
    exit 1
fi

main() {
    # Initialize RUN_ID before trap to avoid referencing undefined variable
    RUN_ID=$(log_start "setup-agency" "agency-tool" "$@" 2>/dev/null) || true

    # Trap unexpected exits
    trap 'log_end "${RUN_ID:-}" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "setup-agency [run: ${RUN_ID:-none}]"

    # Banner
    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  The Agency - First Time Setup${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Get principal name
    if [[ -z "$PRINCIPAL_NAME" ]]; then
        # Suggest system username
        SUGGESTED_NAME=$(whoami)
        echo -e "What's your name? This will be your principal identity."
        echo ""
        read -p "Principal name [$SUGGESTED_NAME]: " PRINCIPAL_NAME
        PRINCIPAL_NAME="${PRINCIPAL_NAME:-$SUGGESTED_NAME}"
    fi

    # Validate principal name
    if [[ ! "$PRINCIPAL_NAME" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
        log_error "Invalid principal name: $PRINCIPAL_NAME"
        echo "Name must start with a letter and contain only letters, numbers, hyphens, underscores."
        exit 1
    fi

    # Convert to lowercase
    PRINCIPAL_NAME=$(echo "$PRINCIPAL_NAME" | tr '[:upper:]' '[:lower:]')

    log_step "Creating principal: $PRINCIPAL_NAME"

    # Check if principal already exists
    PRINCIPAL_DIR="$PROJECT_ROOT/claude/principals/$PRINCIPAL_NAME"
    if [[ -d "$PRINCIPAL_DIR" ]]; then
        log_warn "Principal directory already exists: $PRINCIPAL_DIR"
        echo "Continuing with existing directory..."
    else
        # Create principal from template
        TEMPLATE_DIR="$PROJECT_ROOT/claude/templates/principal"
        if [[ -d "$TEMPLATE_DIR" ]]; then
            log_info "Creating principal from template..."
            mkdir -p "$PRINCIPAL_DIR"
            cp -r "$TEMPLATE_DIR/"* "$PRINCIPAL_DIR/" 2>/dev/null || true

            # Replace template placeholders
            if [[ -f "$PRINCIPAL_DIR/README.md" ]]; then
                if [[ "$(uname)" == "Darwin" ]]; then
                    sed -i '' "s/{{PRINCIPAL_NAME}}/$PRINCIPAL_NAME/g" "$PRINCIPAL_DIR/README.md"
                else
                    sed -i "s/{{PRINCIPAL_NAME}}/$PRINCIPAL_NAME/g" "$PRINCIPAL_DIR/README.md"
                fi
            fi

            verbose_echo "  Principal directory created: $PRINCIPAL_DIR"
        else
            # No template, create minimal structure
            log_info "Creating minimal principal structure..."
            mkdir -p "$PRINCIPAL_DIR"/{requests,artifacts,resources,config}
            touch "$PRINCIPAL_DIR/requests/.gitkeep"
            touch "$PRINCIPAL_DIR/artifacts/.gitkeep"
            touch "$PRINCIPAL_DIR/resources/.gitkeep"
            touch "$PRINCIPAL_DIR/config/.gitkeep"
        fi
    fi

    # Update agency.yaml with principal
    log_step "Updating configuration..."
    if [[ -f "$PROJECT_ROOT/claude/config/agency.yaml" ]]; then
        # Add principal to principals section if not present
        if ! grep -q "^  $PRINCIPAL_NAME:" "$PROJECT_ROOT/claude/config/agency.yaml" 2>/dev/null; then
            # Check if there's a your_username placeholder
            if grep -q "your_username:" "$PROJECT_ROOT/claude/config/agency.yaml"; then
                if [[ "$(uname)" == "Darwin" ]]; then
                    sed -i '' "s/your_username: YourName/$PRINCIPAL_NAME: $PRINCIPAL_NAME/" "$PROJECT_ROOT/claude/config/agency.yaml"
                else
                    sed -i "s/your_username: YourName/$PRINCIPAL_NAME: $PRINCIPAL_NAME/" "$PROJECT_ROOT/claude/config/agency.yaml"
                fi
            fi
        fi
        verbose_echo "  Configuration updated"
    fi

    # Set AGENCY_PRINCIPAL in shell profile
    log_step "Setting up environment..."
    EXPORT_LINE="export AGENCY_PRINCIPAL=\"$PRINCIPAL_NAME\""
    SHELL_PROFILE=""

    # Determine shell profile
    if [[ -f "$HOME/.zshrc" ]]; then
        SHELL_PROFILE="$HOME/.zshrc"
    elif [[ -f "$HOME/.bashrc" ]]; then
        SHELL_PROFILE="$HOME/.bashrc"
    elif [[ -f "$HOME/.bash_profile" ]]; then
        SHELL_PROFILE="$HOME/.bash_profile"
    fi

    if [[ -n "$SHELL_PROFILE" ]]; then
        # Check if already set
        if ! grep -q "AGENCY_PRINCIPAL" "$SHELL_PROFILE" 2>/dev/null; then
            echo "" >> "$SHELL_PROFILE"
            echo "# The Agency principal identity" >> "$SHELL_PROFILE"
            echo "$EXPORT_LINE" >> "$SHELL_PROFILE"
            verbose_echo "  Added AGENCY_PRINCIPAL to $SHELL_PROFILE"
        else
            # Update existing
            if [[ "$(uname)" == "Darwin" ]]; then
                sed -i '' "s/^export AGENCY_PRINCIPAL=.*/$EXPORT_LINE/" "$SHELL_PROFILE"
            else
                sed -i "s/^export AGENCY_PRINCIPAL=.*/$EXPORT_LINE/" "$SHELL_PROFILE"
            fi
            verbose_echo "  Updated AGENCY_PRINCIPAL in $SHELL_PROFILE"
        fi
    fi

    # Export for current session
    export AGENCY_PRINCIPAL="$PRINCIPAL_NAME"

    # Initialize vault (optional)
    if [[ "$SKIP_VAULT" != "true" ]]; then
        log_step "Initializing secret vault..."
        if [[ -x "$PROJECT_ROOT/tools/secret" ]]; then
            echo ""
            echo "The Agency uses an encrypted vault for secrets."
            echo "Set a passphrase to protect your vault."
            echo ""

            # Check if vault already exists
            if "$PROJECT_ROOT/tools/secret" vault status > /dev/null 2>&1; then
                verbose_echo "  Vault already initialized"
            else
                # Try to init vault - this may need interactive input
                if ! "$PROJECT_ROOT/tools/secret" vault init 2>/dev/null; then
                    log_warn "Vault initialization skipped (can be done later with: ./tools/secret vault init)"
                fi
            fi
        else
            log_info "Secret service not available, skipping vault setup"
        fi
    fi

    # Create setup complete marker
    log_step "Finalizing setup..."
    cat > "$PROJECT_ROOT/.agency-setup-complete" << EOF
# The Agency Setup Complete
# Created: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
# Principal: $PRINCIPAL_NAME
EOF

    # Success
    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  Setup Complete!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "Welcome, ${GREEN}$PRINCIPAL_NAME${NC}!"
    echo ""
    echo "Your principal directory: claude/principals/$PRINCIPAL_NAME/"
    echo ""
    echo "Next steps:"
    echo ""
    echo -e "  ${BLUE}./tools/myclaude housekeeping captain${NC}"
    echo ""
    echo "Then type: /welcome"
    echo ""

    if [[ -n "$SHELL_PROFILE" ]]; then
        echo -e "${YELLOW}Note:${NC} Run 'source $SHELL_PROFILE' or start a new terminal"
        echo "      for AGENCY_PRINCIPAL to take effect."
        echo ""
    fi

    trap - EXIT
    log_end "$RUN_ID" "success" 0 0 "Setup complete for $PRINCIPAL_NAME" 2>/dev/null || true
}

main "$@"
