#!/bin/bash
# Create a new request document
#
# Usage:
#   ./tools/request --agent housekeeping --summary "fix logging"
#   ./tools/request --agent web --summary "add dark mode" --priority High
#   ./tools/request --agent housekeeping --summary "docs" --no-notify
#
# By default, sends a message to notify the assigned agent.
# Use --no-notify to skip notification.

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "request" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260114-000010"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "request $TOOL_VERSION"
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
TEMPLATES_DIR="$REPO_ROOT/claude/templates"

# Defaults
VERBOSE=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

show_usage() {
  echo "Usage: ./tools/request --agent <agent> --summary <summary> [options]"
  echo ""
  echo "Required:"
  echo "  --agent, -a        Agent to assign this request to"
  echo "  --summary, -s      Brief summary (used in filename and title)"
  echo ""
  echo "Options:"
  echo "  --priority, -p     Priority: Low, Normal (default), High, Critical"
  echo "  --principal        Override principal (defaults to PRINCIPAL env or config)"
  echo "  --no-notify        Don't send notification message to agent"
  echo "  --details, -d      Detailed description (if not provided, opens in editor)"
  echo "  --verbose          Show detailed logging"
  echo ""
  echo "Examples:"
  echo "  ./tools/request -a housekeeping -s 'Update documentation'"
  echo "  ./tools/request -a web -s 'Add dark mode' -p High"
  echo "  ./tools/request -a housekeeping -s 'Fix bug' --no-notify"
  exit 1
}

# Determine principal
get_principal() {
  if [ -n "$PRINCIPAL" ]; then
    echo "$PRINCIPAL"
  else
    local p=$("$REPO_ROOT/tools/principal" 2>/dev/null || echo "")
    if [ -n "$p" ] && [ "$p" != "unknown" ]; then
      echo "$p"
    else
      echo ""
    fi
  fi
}

# Get next request number by scanning existing files
get_next_number() {
  local highest=0

  # Scan all REQUEST files in principals directory
  shopt -s nullglob
  for f in "$REPO_ROOT"/claude/principals/*/requests/REQUEST-*.md; do
    if [ -f "$f" ]; then
      # Extract number from filename: REQUEST-{PRINCIPAL}-{NUMBER}-...
      local fname=$(basename "$f")
      local num=$(echo "$fname" | sed -n 's/REQUEST-[^-]*-\([0-9]*\)-.*/\1/p')
      if [ -n "$num" ]; then
        num=$((10#$num))  # Force decimal interpretation
        if [ "$num" -gt "$highest" ]; then
          highest=$num
        fi
      fi
    fi
  done
  shopt -u nullglob

  echo $((highest + 1))
}

# Convert summary to filename-safe slug
slugify() {
  echo "$1" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-' | cut -c1-50
}

# Parse arguments
AGENT=""
SUMMARY=""
PRIORITY="Normal"
PRINCIPAL_OVERRIDE=""
NOTIFY=true
DETAILS=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --agent|-a)
      AGENT="$2"
      shift 2
      ;;
    --summary|-s)
      SUMMARY="$2"
      shift 2
      ;;
    --priority|-p)
      PRIORITY="$2"
      shift 2
      ;;
    --principal)
      PRINCIPAL_OVERRIDE="$2"
      shift 2
      ;;
    --no-notify)
      NOTIFY=false
      shift
      ;;
    --details|-d)
      DETAILS="$2"
      shift 2
      ;;
    --verbose)
      VERBOSE=true
      shift
      ;;
    --help|-h)
      show_usage
      ;;
    *)
      log_error "Unknown option: $1"
      show_usage
      ;;
  esac
done

# Main function
main() {
  # Trap unexpected exits
  trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

  echo "request [run: ${RUN_ID:-none}]"

  # Validate required arguments
  if [ -z "$AGENT" ] || [ -z "$SUMMARY" ]; then
    log_error "--agent and --summary are required"
    trap - EXIT
    log_end "$RUN_ID" "failure" 1 0 "Missing required arguments"
    show_usage
  fi

  # Determine principal
  if [ -n "$PRINCIPAL_OVERRIDE" ]; then
    REQ_PRINCIPAL="$PRINCIPAL_OVERRIDE"
  else
    REQ_PRINCIPAL=$(get_principal)
  fi

  if [ -z "$REQ_PRINCIPAL" ]; then
    log_error "Cannot determine principal. Set PRINCIPAL env var or use --principal."
    trap - EXIT
    log_end "$RUN_ID" "failure" 1 0 "Cannot determine principal"
    exit 1
  fi

  # Determine requester - always attribute to principal
  # AGENTNAME context is informational but shouldn't change attribution
  REQUESTED_BY="$REQ_PRINCIPAL"

  # Get next number
  NUMBER=$(get_next_number)
  NUMBER_PADDED=$(printf "%04d" "$NUMBER")

  # Create filename
  SLUG=$(slugify "$SUMMARY")
  FILENAME="REQUEST-${REQ_PRINCIPAL}-${NUMBER_PADDED}-${AGENT}-${SLUG}.md"

  # Ensure requests directory exists
  REQUESTS_DIR="$REPO_ROOT/claude/principals/$REQ_PRINCIPAL/requests"
  mkdir -p "$REQUESTS_DIR"

  # Full path
  FILEPATH="$REQUESTS_DIR/$FILENAME"

  # Get current date
  DATE=$(date +%Y-%m-%d)

  # Generate content from template or inline
  CONTENT=$(cat <<EOF
# REQUEST-${REQ_PRINCIPAL}-${NUMBER_PADDED}: ${SUMMARY}

**Status:** Open
**Priority:** ${PRIORITY}
**Requested By:** ${REQUESTED_BY}
**Assigned To:** ${AGENT}
**Created:** ${DATE}
**Updated:** ${DATE}

## Summary

${SUMMARY}

## Details

${DETAILS:-"<!-- Detailed description of what you're requesting -->"}

## Acceptance Criteria

- [ ] Criteria 1
- [ ] Criteria 2

## Work Completed

<!-- Document completed work here -->

---

## Activity Log

### ${DATE} - Created
- Request created by ${REQUESTED_BY}
EOF
)

  # Write file
  echo "$CONTENT" > "$FILEPATH"

  echo ""
  echo "Request ready: REQUEST-${REQ_PRINCIPAL}-${NUMBER_PADDED}"
  echo "  File: $FILEPATH"
  echo "  Principal: $REQ_PRINCIPAL"
  echo "  Assigned to: $AGENT"
  echo "  Priority: $PRIORITY"

  # Notify agent if requested
  if [ "$NOTIFY" = true ]; then
    if [ -f "$REPO_ROOT/tools/message-send" ]; then
      "$REPO_ROOT/tools/message-send" --to "agent:$AGENT" --subject "New Request: $SUMMARY" \
        "You have a new request: REQUEST-${REQ_PRINCIPAL}-${NUMBER_PADDED}

Summary: $SUMMARY
Priority: $PRIORITY
From: $REQUESTED_BY

View: claude/principals/$REQ_PRINCIPAL/requests/$FILENAME" 2>/dev/null || true
      verbose_echo "Notification sent to agent:$AGENT"
    else
      log_warn "message-send tool not found, skipping notification"
    fi
  fi

  trap - EXIT
  log_end "$RUN_ID" "success" 0 0 "Created REQUEST-${REQ_PRINCIPAL}-${NUMBER_PADDED}"
}

main
