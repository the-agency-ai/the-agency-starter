#!/bin/bash
# Set tab status indicator via shape prefix in tab title
#
# Usage:
#   ./tools/tab-status available    # ● Circle - ready for input
#   ./tools/tab-status working      # ◐ Half-circle - processing
#   ./tools/tab-status attention    # ▲ Triangle - needs user input
#   ./tools/tab-status clear        # Remove status, just agent name
#
# Accessibility: Uses distinct SHAPES (not just colors) so colorblind users
# can distinguish states. Colors are secondary cues via iTerm tab backgrounds.
#
# Works in: iTerm2 (with tab colors), Terminal.app, Ghostty, Kitty
#
# iTerm2 Features:
#   - Sets tab title with shape prefix
#   - Sets tab background color to match status (secondary cue)
#   - Sets user variable for status bar/badge use
#
# Note: Agent name is read from $AGENTNAME.

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "tab-status" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260114-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "tab-status $TOOL_VERSION"
    exit 0
fi

# Help check
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    cat << 'HELP'
tab-status - Set iTerm tab status indicator

Usage:
  ./tools/tab-status <status>

Status options:
  available    Blue ● Circle - ready for input
  working      Green ◐ Half-circle - processing
  attention    Red ▲ Triangle - needs user input
  clear        Remove status indicator

Examples:
  ./tools/tab-status available
  ./tools/tab-status working
  ./tools/tab-status attention

Notes:
  - Uses shapes for accessibility (colorblind-friendly)
  - Works with iTerm2, Terminal.app, Ghostty, Kitty
  - Reads agent name from $AGENTNAME environment variable
  - Called automatically by Claude Code hooks
HELP
    exit 0
fi

STATUS="${1:-available}"
AGENT="${AGENTNAME:-agent}"

# Status definitions: indicator SHAPE and RGB colors
# Shapes are primary (accessible), colors are secondary (iTerm background)
case "$STATUS" in
  available|ready|idle)
    INDICATOR="●"  # Filled circle = stable, ready
    # Blue: RGB(59, 130, 246)
    R=59 G=130 B=246
    ;;
  working|busy|processing)
    INDICATOR="◐"  # Half-circle = in progress
    # Green: RGB(34, 197, 94)
    R=34 G=197 B=94
    ;;
  attention|alert|input|permission)
    INDICATOR="▲"  # Triangle = attention needed
    # Red: RGB(239, 68, 68)
    R=239 G=68 B=68
    ;;
  clear|none)
    INDICATOR=""
    R="" G="" B=""
    ;;
  *)
    echo "Unknown status: $STATUS"
    echo "Valid: available, working, attention, clear"
    exit 1
    ;;
esac

# Build title
if [ -n "$INDICATOR" ]; then
  TITLE="$INDICATOR $AGENT"
else
  TITLE="$AGENT"
fi

# Write escape sequences directly to controlling terminal
# Hooks run in subprocess, so we MUST use /dev/tty to reach the actual terminal
# If /dev/tty isn't available, silently exit (can't set status)
if [ ! -w /dev/tty ]; then
  exit 0
fi

# Set tab title via OSC 0 (works everywhere)
printf '\033]0;%s\007' "$TITLE" > /dev/tty

# iTerm2 tab color - always try it (TERM_PROGRAM may not be set in hooks)
# These escape sequences are harmless on non-iTerm terminals
if [ -n "$R" ]; then
  printf '\033]6;1;bg;red;brightness;%d\a' "$R" > /dev/tty
  printf '\033]6;1;bg;green;brightness;%d\a' "$G" > /dev/tty
  printf '\033]6;1;bg;blue;brightness;%d\a' "$B" > /dev/tty
else
  # Reset to default
  printf '\033]6;1;bg;*;default\a' > /dev/tty
fi

# iTerm2 user variables (for badge/status bar)
STATUS_B64=$(echo -n "$STATUS" | base64)
printf '\033]1337;SetUserVar=%s=%s\007' "agentStatus" "$STATUS_B64" > /dev/tty

AGENT_B64=$(echo -n "$AGENT" | base64)
printf '\033]1337;SetUserVar=%s=%s\007' "agentName" "$AGENT_B64" > /dev/tty
