#!/bin/bash
#
# myclaude - Launch a Claude Code agent with workstream context
#
# Usage:
#   ./tools/myclaude WORKSTREAM AGENTNAME [initial_prompt]
#   ./tools/myclaude --update           # Update Claude Code to latest
#   ./tools/myclaude --rollback         # Rollback to previous version
#   ./tools/myclaude --version          # Show Claude Code version
#
# Examples:
#   ./tools/myclaude housekeeping housekeeping
#   ./tools/myclaude web web "Fix the login bug"
#   ./tools/myclaude agents agent-manager
#

set -e

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get project root (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Handle special flags first
case "${1:-}" in
    --update)
        echo -e "${BLUE}Updating Claude Code...${NC}"
        npm install -g @anthropic-ai/claude-code@latest
        echo -e "${GREEN}Claude Code updated to:${NC} $(claude --version)"
        exit 0
        ;;
    --rollback)
        VERSIONS_DIR="$HOME/.local/share/claude/versions"
        if [ ! -d "$VERSIONS_DIR" ]; then
            echo -e "${RED}No versions directory found${NC}"
            exit 1
        fi

        echo -e "${BLUE}Available versions:${NC}"
        VERSIONS=($(ls -1 "$VERSIONS_DIR" | sort -V))
        CURRENT=$(claude --version 2>/dev/null || echo "unknown")

        for i in "${!VERSIONS[@]}"; do
            v="${VERSIONS[$i]}"
            if [ "$v" = "$CURRENT" ]; then
                echo "  $((i+1)). $v (current)"
            else
                echo "  $((i+1)). $v"
            fi
        done

        echo ""
        read -p "Select version to rollback to (1-${#VERSIONS[@]}): " choice

        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#VERSIONS[@]}" ]; then
            SELECTED="${VERSIONS[$((choice-1))]}"
            SYMLINK="$HOME/.local/bin/claude"
            TARGET="$VERSIONS_DIR/$SELECTED"

            if [ -f "$TARGET" ]; then
                ln -sf "$TARGET" "$SYMLINK"
                echo -e "${GREEN}Rolled back to: $SELECTED${NC}"
            else
                echo -e "${RED}Version file not found: $TARGET${NC}"
                exit 1
            fi
        else
            echo -e "${RED}Invalid selection${NC}"
            exit 1
        fi
        exit 0
        ;;
    --version|-v)
        echo "myclaude $TOOL_VERSION"
        echo ""
        echo -e "${BLUE}Claude Code version:${NC} $(claude --version)"
        echo -e "${BLUE}The Agency version:${NC} $(cat "$PROJECT_ROOT/VERSION" 2>/dev/null || echo 'unknown')"
        exit 0
        ;;
esac

# Parse arguments
WORKSTREAM="${1:-}"
AGENTNAME="${2:-}"
INITIAL_PROMPT="${3:-}"

# Validate
if [ -z "$WORKSTREAM" ] || [ -z "$AGENTNAME" ]; then
    echo -e "${RED}Usage: ./tools/myclaude WORKSTREAM AGENTNAME [prompt]${NC}"
    echo ""
    echo "Available agents:"
    for agent_dir in "$PROJECT_ROOT"/claude/agents/*/; do
        if [ -d "$agent_dir" ] && [ -f "$agent_dir/agent.md" ]; then
            agent=$(basename "$agent_dir")
            echo "  - $agent"
        fi
    done
    exit 1
fi

# Check agent exists
AGENT_DIR="$PROJECT_ROOT/claude/agents/$AGENTNAME"
if [ ! -d "$AGENT_DIR" ]; then
    echo -e "${RED}Agent not found: $AGENTNAME${NC}"
    echo "Create it with: ./tools/create-agent $WORKSTREAM $AGENTNAME"
    exit 1
fi

# Set environment
export WORKSTREAM="$WORKSTREAM"
export AGENTNAME="$AGENTNAME"
export PROJECT_ROOT="$PROJECT_ROOT"

# Get principal from config (maps system username to principal)
if [ -x "$PROJECT_ROOT/tools/config" ]; then
    PRINCIPAL=$("$PROJECT_ROOT/tools/config" get-principal 2>/dev/null || echo "unknown")
    export PRINCIPAL="$PRINCIPAL"
fi

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}  Launching: ${GREEN}$AGENTNAME${NC} ${BLUE}on workstream: ${GREEN}$WORKSTREAM${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Check for unread messages
if [ -x "$PROJECT_ROOT/tools/read-messages" ]; then
    UNREAD=$("$PROJECT_ROOT/tools/read-messages" --count 2>/dev/null || echo "0")
    if [ "$UNREAD" -gt 0 ]; then
        echo -e "${YELLOW}  ðŸ“¬ You have $UNREAD unread message(s). Run ./tools/read-messages${NC}"
    fi
fi
echo ""

# Build claude command
CLAUDE_CMD="claude"

# Add initial prompt if provided
if [ -n "$INITIAL_PROMPT" ]; then
    CLAUDE_CMD="$CLAUDE_CMD --prompt \"$INITIAL_PROMPT\""
fi

# Launch claude in project directory
cd "$PROJECT_ROOT"
eval "$CLAUDE_CMD"
