#!/bin/bash
#
# myclaude - Launch a Claude Code agent with workstream context
#
# Usage:
#   ./tools/myclaude WORKSTREAM AGENTNAME [initial_prompt]
#   ./tools/myclaude --update           # Update Claude Code to latest
#   ./tools/myclaude --rollback         # Rollback to previous version
#   ./tools/myclaude --version          # Show Claude Code version
#
# Examples:
#   ./tools/myclaude housekeeping captain
#   ./tools/myclaude web web "Fix the login bug"
#   ./tools/myclaude agents agent-manager
#

set -e

# Tool version
TOOL_VERSION="1.2.0-20260115-000001"

# Source log helper for tool tracking
SCRIPT_DIR_EARLY="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR_EARLY/_log-helper" ]]; then
    source "$SCRIPT_DIR_EARLY/_log-helper"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Defaults
VERBOSE=false

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Check if required services are ready (auto-installs everything)
# Returns: 0 if all services ready
check_services() {
    local project_root="$1"
    local service_dir="$project_root/source/services/agency-service"
    local bun_path="${HOME}/.bun/bin/bun"
    local service_url="http://127.0.0.1:3141"

    log_step "Checking Agency Service..."

    # 1. Check if service directory exists
    if [[ ! -d "$service_dir" ]]; then
        log_info "Agency Service directory not found - skipping service check"
        return 0
    fi

    # 2. Check if Bun is installed - auto-install if missing
    if [[ ! -x "$bun_path" ]]; then
        echo -e "${BLUE}Installing Bun runtime...${NC}"
        curl -fsSL https://bun.sh/install | bash
        export PATH="$HOME/.bun/bin:$PATH"
        bun_path="${HOME}/.bun/bin/bun"
        if [[ -x "$bun_path" ]]; then
            echo -e "${GREEN}âœ“ Bun installed${NC}"
        else
            log_error "Failed to install Bun - some features may not work"
            return 0
        fi
    fi

    # 3. Check if dependencies are installed - auto-install if missing
    if [[ ! -d "$service_dir/node_modules" ]]; then
        echo -e "${BLUE}Installing Agency Service dependencies...${NC}"
        cd "$service_dir"
        "$bun_path" install --silent 2>/dev/null || "$bun_path" install
        cd "$project_root"
        echo -e "${GREEN}âœ“ Dependencies installed${NC}"
    fi

    # 4. Check if service is running - auto-start if not
    if curl -s --connect-timeout 1 "$service_url/health" > /dev/null 2>&1; then
        log_info "Agency Service is running"
        return 0
    fi

    # Auto-start the service
    echo -e "${BLUE}Starting Agency Service...${NC}"
    if [[ -x "$project_root/tools/agency-service" ]]; then
        "$project_root/tools/agency-service" start > /dev/null 2>&1 || true
        sleep 1
        if curl -s --connect-timeout 1 "$service_url/health" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“ Agency Service started${NC}"
        else
            log_warn "Failed to start Agency Service - continuing anyway"
        fi
    else
        log_warn "Agency Service tool not found"
    fi

    return 0
}

# Get project root (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Handle special flags first
case "${1:-}" in
    --verbose)
        VERBOSE=true
        shift
        ;;
    --update)
        log_info "Updating Claude Code..."
        npm install -g @anthropic-ai/claude-code@latest
        log_info "Claude Code updated to: $(claude --version)"
        exit 0
        ;;
    --rollback)
        VERSIONS_DIR="$HOME/.local/share/claude/versions"
        if [ ! -d "$VERSIONS_DIR" ]; then
            log_error "No versions directory found"
            exit 1
        fi

        log_info "Available versions:"
        VERSIONS=($(ls -1 "$VERSIONS_DIR" | sort -V))
        CURRENT=$(claude --version 2>/dev/null || echo "unknown")

        for i in "${!VERSIONS[@]}"; do
            v="${VERSIONS[$i]}"
            if [ "$v" = "$CURRENT" ]; then
                echo "  $((i+1)). $v (current)"
            else
                echo "  $((i+1)). $v"
            fi
        done

        echo ""
        read -p "Select version to rollback to (1-${#VERSIONS[@]}): " choice

        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#VERSIONS[@]}" ]; then
            SELECTED="${VERSIONS[$((choice-1))]}"
            SYMLINK="$HOME/.local/bin/claude"
            TARGET="$VERSIONS_DIR/$SELECTED"

            if [ -f "$TARGET" ]; then
                ln -sf "$TARGET" "$SYMLINK"
                log_info "Rolled back to: $SELECTED"
            else
                log_error "Version file not found: $TARGET"
                exit 1
            fi
        else
            log_error "Invalid selection"
            exit 1
        fi
        exit 0
        ;;
    --version|-v)
        echo "myclaude $TOOL_VERSION"
        echo ""
        echo -e "${BLUE}Claude Code version:${NC} $(claude --version)"
        echo -e "${BLUE}The Agency version:${NC} $(cat "$PROJECT_ROOT/VERSION" 2>/dev/null || echo 'unknown')"
        exit 0
        ;;
esac

# Parse additional flags
while [[ $# -gt 0 ]]; do
    case $1 in
        --verbose)
            VERBOSE=true
            shift
            ;;
        *)
            break
            ;;
    esac
done

# Parse arguments
WORKSTREAM="${1:-}"
AGENTNAME="${2:-}"
INITIAL_PROMPT="${3:-}"

# Validate
if [ -z "$WORKSTREAM" ] || [ -z "$AGENTNAME" ]; then
    log_error "Usage: ./tools/myclaude WORKSTREAM AGENTNAME [prompt] [--verbose]"
    echo ""
    echo "Available agents:"
    for agent_dir in "$PROJECT_ROOT"/claude/agents/*/; do
        if [ -d "$agent_dir" ] && [ -f "$agent_dir/agent.md" ]; then
            agent=$(basename "$agent_dir")
            echo "  - $agent"
        fi
    done
    exit 1
fi

# Check agent exists
AGENT_DIR="$PROJECT_ROOT/claude/agents/$AGENTNAME"
if [ ! -d "$AGENT_DIR" ]; then
    log_error "Agent not found: $AGENTNAME"
    echo "Create it with: ./tools/agent-create $WORKSTREAM $AGENTNAME"
    exit 1
fi

# Set environment
export WORKSTREAM="$WORKSTREAM"
export AGENTNAME="$AGENTNAME"
export AGENT_NAME="$AGENTNAME"  # Also set AGENT_NAME for log helper
export PROJECT_ROOT="$PROJECT_ROOT"

# Main function
main() {
    # Trap unexpected exits
    trap 'log_end "$LOG_RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "myclaude [run: ${LOG_RUN_ID:-none}]"
    echo ""

    # Start logging this tool run
    LOG_RUN_ID=""
    if type log_start &>/dev/null; then
        LOG_RUN_ID=$(log_start "myclaude" "agency-tool" "$WORKSTREAM" "$AGENTNAME" "$INITIAL_PROMPT")
    fi

    # Get principal from config (maps system username to principal)
    if [ -x "$PROJECT_ROOT/tools/config" ]; then
        PRINCIPAL=$("$PROJECT_ROOT/tools/config" get-principal 2>/dev/null || echo "unknown")
        export PRINCIPAL="$PRINCIPAL"
    fi

    # Check and start required services (Agency Service provides Secret Service, Log Service, etc.)
    check_services "$PROJECT_ROOT"

    # Set up vault session token for Claude Code to access secrets
    if [ -x "$PROJECT_ROOT/tools/secret" ]; then
        # Check vault status
        VAULT_STATUS=$("$PROJECT_ROOT/tools/secret" vault status 2>/dev/null | grep -o 'status: [a-z]*' | cut -d' ' -f2 || echo "unknown")

        if [ "$VAULT_STATUS" = "locked" ]; then
            log_warn "Vault is locked. Please unlock to enable secret access."
            "$PROJECT_ROOT/tools/secret" vault unlock
            VAULT_STATUS="unlocked"
        fi

        if [ "$VAULT_STATUS" = "unlocked" ]; then
            # Generate a session token for this Claude session
            SESSION_TOKEN=$("$PROJECT_ROOT/tools/secret" vault session generate "$AGENTNAME-session" 2>/dev/null || echo "")
            if [ -n "$SESSION_TOKEN" ]; then
                export VAULT_SESSION_TOKEN="$SESSION_TOKEN"
                log_info "âœ“ Vault session token generated"
            fi
        elif [ "$VAULT_STATUS" = "uninitialized" ]; then
            log_warn "Vault not initialized. Run: ./tools/secret vault init"
        fi
    fi

    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}  Launching: ${GREEN}$AGENTNAME${NC} ${BLUE}on workstream: ${GREEN}$WORKSTREAM${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    # Check for unread messages
    if [ -x "$PROJECT_ROOT/tools/message-read" ]; then
        UNREAD=$("$PROJECT_ROOT/tools/message-read" --count 2>/dev/null || echo "0")
        if [ "$UNREAD" -gt 0 ]; then
            echo -e "${YELLOW}  ðŸ“¬ You have $UNREAD unread message(s). Run ./tools/message-read${NC}"
        fi
    fi
    echo ""

    # Build claude command
    CLAUDE_CMD="claude --model opus"

    # Add initial prompt if provided
    if [ -n "$INITIAL_PROMPT" ]; then
        CLAUDE_CMD="$CLAUDE_CMD --prompt \"$INITIAL_PROMPT\""
    fi

    # Launch claude in project directory
    cd "$PROJECT_ROOT"

    # Run claude and capture exit code
    CLAUDE_EXIT=0
    eval "$CLAUDE_CMD" || CLAUDE_EXIT=$?

    # End logging
    trap - EXIT  # Clear trap
    if type log_end &>/dev/null && [[ -n "$LOG_RUN_ID" ]]; then
        if [[ $CLAUDE_EXIT -eq 0 ]]; then
            log_end "$LOG_RUN_ID" "success" "$CLAUDE_EXIT" "0" "Agent session: $AGENTNAME on $WORKSTREAM"
        else
            log_end "$LOG_RUN_ID" "failure" "$CLAUDE_EXIT" "0" "Agent session failed: $AGENTNAME"
        fi
    fi

    exit $CLAUDE_EXIT
}

main
