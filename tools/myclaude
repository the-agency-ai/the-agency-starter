#!/bin/bash
#
# myclaude - Launch a Claude Code agent with workstream context
#
# Usage:
#   ./tools/myclaude WORKSTREAM AGENTNAME [initial_prompt]
#   ./tools/myclaude --update           # Update Claude Code to latest
#   ./tools/myclaude --rollback         # Rollback to previous version
#   ./tools/myclaude --version          # Show Claude Code version
#
# Examples:
#   ./tools/myclaude housekeeping housekeeping
#   ./tools/myclaude web web "Fix the login bug"
#   ./tools/myclaude agents agent-manager
#

set -e

# Tool version
TOOL_VERSION="1.0.1-20260110-000001"

# Source log helper for tool tracking
SCRIPT_DIR_EARLY="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR_EARLY/_log-helper" ]]; then
    source "$SCRIPT_DIR_EARLY/_log-helper"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get project root (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Handle special flags first
case "${1:-}" in
    --update)
        echo -e "${BLUE}Updating Claude Code...${NC}"
        npm install -g @anthropic-ai/claude-code@latest
        echo -e "${GREEN}Claude Code updated to:${NC} $(claude --version)"
        exit 0
        ;;
    --rollback)
        VERSIONS_DIR="$HOME/.local/share/claude/versions"
        if [ ! -d "$VERSIONS_DIR" ]; then
            echo -e "${RED}No versions directory found${NC}"
            exit 1
        fi

        echo -e "${BLUE}Available versions:${NC}"
        VERSIONS=($(ls -1 "$VERSIONS_DIR" | sort -V))
        CURRENT=$(claude --version 2>/dev/null || echo "unknown")

        for i in "${!VERSIONS[@]}"; do
            v="${VERSIONS[$i]}"
            if [ "$v" = "$CURRENT" ]; then
                echo "  $((i+1)). $v (current)"
            else
                echo "  $((i+1)). $v"
            fi
        done

        echo ""
        read -p "Select version to rollback to (1-${#VERSIONS[@]}): " choice

        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#VERSIONS[@]}" ]; then
            SELECTED="${VERSIONS[$((choice-1))]}"
            SYMLINK="$HOME/.local/bin/claude"
            TARGET="$VERSIONS_DIR/$SELECTED"

            if [ -f "$TARGET" ]; then
                ln -sf "$TARGET" "$SYMLINK"
                echo -e "${GREEN}Rolled back to: $SELECTED${NC}"
            else
                echo -e "${RED}Version file not found: $TARGET${NC}"
                exit 1
            fi
        else
            echo -e "${RED}Invalid selection${NC}"
            exit 1
        fi
        exit 0
        ;;
    --version|-v)
        echo "myclaude $TOOL_VERSION"
        echo ""
        echo -e "${BLUE}Claude Code version:${NC} $(claude --version)"
        echo -e "${BLUE}The Agency version:${NC} $(cat "$PROJECT_ROOT/VERSION" 2>/dev/null || echo 'unknown')"
        exit 0
        ;;
esac

# Parse arguments
WORKSTREAM="${1:-}"
AGENTNAME="${2:-}"
INITIAL_PROMPT="${3:-}"

# Validate
if [ -z "$WORKSTREAM" ] || [ -z "$AGENTNAME" ]; then
    echo -e "${RED}Usage: ./tools/myclaude WORKSTREAM AGENTNAME [prompt]${NC}"
    echo ""
    echo "Available agents:"
    for agent_dir in "$PROJECT_ROOT"/claude/agents/*/; do
        if [ -d "$agent_dir" ] && [ -f "$agent_dir/agent.md" ]; then
            agent=$(basename "$agent_dir")
            echo "  - $agent"
        fi
    done
    exit 1
fi

# Check agent exists
AGENT_DIR="$PROJECT_ROOT/claude/agents/$AGENTNAME"
if [ ! -d "$AGENT_DIR" ]; then
    echo -e "${RED}Agent not found: $AGENTNAME${NC}"
    echo "Create it with: ./tools/agent-create $WORKSTREAM $AGENTNAME"
    exit 1
fi

# Set environment
export WORKSTREAM="$WORKSTREAM"
export AGENTNAME="$AGENTNAME"
export AGENT_NAME="$AGENTNAME"  # Also set AGENT_NAME for log helper
export PROJECT_ROOT="$PROJECT_ROOT"

# Start logging this tool run
LOG_RUN_ID=""
if type log_start &>/dev/null; then
    LOG_RUN_ID=$(log_start "myclaude" "agency-tool" "$WORKSTREAM" "$AGENTNAME" "$INITIAL_PROMPT")
fi

# Get principal from config (maps system username to principal)
if [ -x "$PROJECT_ROOT/tools/config" ]; then
    PRINCIPAL=$("$PROJECT_ROOT/tools/config" get-principal 2>/dev/null || echo "unknown")
    export PRINCIPAL="$PRINCIPAL"
fi

# Start Agency Service if not running (provides Secret Service, Log Service, etc.)
if [ -x "$PROJECT_ROOT/tools/agency-service" ]; then
    if ! curl -s --connect-timeout 1 "http://127.0.0.1:3141/health" > /dev/null 2>&1; then
        echo -e "${BLUE}Starting Agency Service...${NC}"
        "$PROJECT_ROOT/tools/agency-service" start > /dev/null 2>&1 || true
        sleep 1  # Give service time to start
    fi
fi

# Set up vault session token for Claude Code to access secrets
if [ -x "$PROJECT_ROOT/tools/secret" ]; then
    # Check vault status
    VAULT_STATUS=$("$PROJECT_ROOT/tools/secret" vault status 2>/dev/null | grep -o 'status: [a-z]*' | cut -d' ' -f2 || echo "unknown")

    if [ "$VAULT_STATUS" = "locked" ]; then
        echo -e "${YELLOW}Vault is locked. Please unlock to enable secret access.${NC}"
        "$PROJECT_ROOT/tools/secret" vault unlock
        VAULT_STATUS="unlocked"
    fi

    if [ "$VAULT_STATUS" = "unlocked" ]; then
        # Generate a session token for this Claude session
        SESSION_TOKEN=$("$PROJECT_ROOT/tools/secret" vault session generate "$AGENTNAME-session" 2>/dev/null || echo "")
        if [ -n "$SESSION_TOKEN" ]; then
            export VAULT_SESSION_TOKEN="$SESSION_TOKEN"
            echo -e "${GREEN}âœ“ Vault session token generated${NC}"
        fi
    elif [ "$VAULT_STATUS" = "uninitialized" ]; then
        echo -e "${YELLOW}Vault not initialized. Run: ./tools/secret vault init${NC}"
    fi
fi

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}  Launching: ${GREEN}$AGENTNAME${NC} ${BLUE}on workstream: ${GREEN}$WORKSTREAM${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Check for unread messages
if [ -x "$PROJECT_ROO./tools/message-read" ]; then
    UNREAD=$("$PROJECT_ROO./tools/message-read" --count 2>/dev/null || echo "0")
    if [ "$UNREAD" -gt 0 ]; then
        echo -e "${YELLOW}  ðŸ“¬ You have $UNREAD unread message(s). Run ./tools/message-read${NC}"
    fi
fi
echo ""

# Build claude command
CLAUDE_CMD="claude"

# Add initial prompt if provided
if [ -n "$INITIAL_PROMPT" ]; then
    CLAUDE_CMD="$CLAUDE_CMD --prompt \"$INITIAL_PROMPT\""
fi

# Launch claude in project directory
cd "$PROJECT_ROOT"

# Run claude and capture exit code
CLAUDE_EXIT=0
eval "$CLAUDE_CMD" || CLAUDE_EXIT=$?

# End logging
if type log_end &>/dev/null && [[ -n "$LOG_RUN_ID" ]]; then
    if [[ $CLAUDE_EXIT -eq 0 ]]; then
        log_end "$LOG_RUN_ID" "success" "$CLAUDE_EXIT" "0" "Agent session: $AGENTNAME on $WORKSTREAM"
    else
        log_end "$LOG_RUN_ID" "failure" "$CLAUDE_EXIT" "0" "Agent session failed: $AGENTNAME"
    fi
fi

exit $CLAUDE_EXIT
