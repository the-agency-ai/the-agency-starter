#!/bin/bash
#
# archive-session - Archive current session to principal's session history
#
# Usage:
#   ./tools/archive-session "short description"
#   ./tools/archive-session --from FILE "short description"
#
# Creates: principals/{PRINCIPAL}/sessions/{AGENTNAME}/YYYYMMDD-HHMM-{WORKSTREAM}-{AGENT}-{DESC}.md
#
# Examples:
#   ./tools/archive-session "agencybench-setup"
#   ./tools/archive-session --from SESSION-BACKUP-2026-01-08.md "cookbooks-research"

set -e

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "archive-session $TOOL_VERSION"
    exit 0
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get context
WORKSTREAM="${WORKSTREAM:-housekeeping}"
AGENTNAME="${AGENTNAME:-housekeeping}"
PRINCIPAL="${PRINCIPAL:-jordan}"

# Parse arguments
SOURCE_FILE=""
DESCRIPTION=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --from|-f)
            SOURCE_FILE="$2"
            shift 2
            ;;
        *)
            DESCRIPTION="$1"
            shift
            ;;
    esac
done

if [ -z "$DESCRIPTION" ]; then
    echo "Usage: ./tools/archive-session \"short-description\""
    echo "       ./tools/archive-session --from FILE \"short-description\""
    exit 1
fi

# Sanitize description for filename (lowercase, hyphens, no spaces)
SAFE_DESC=$(echo "$DESCRIPTION" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-')

# Generate timestamp
TIMESTAMP=$(date +%Y%m%d-%H%M)

# Build filename
FILENAME="${TIMESTAMP}-${WORKSTREAM}-${AGENTNAME}-${SAFE_DESC}.md"

# Ensure sessions directory exists
SESSIONS_DIR="$PROJECT_ROOT/claude/principals/$PRINCIPAL/sessions/$AGENTNAME"
mkdir -p "$SESSIONS_DIR"

ARCHIVE_PATH="$SESSIONS_DIR/$FILENAME"

# Determine source content
if [ -n "$SOURCE_FILE" ]; then
    # Check if it's a full path or relative to agent dir
    if [ -f "$SOURCE_FILE" ]; then
        SOURCE_PATH="$SOURCE_FILE"
    elif [ -f "$PROJECT_ROOT/claude/agents/$AGENTNAME/$SOURCE_FILE" ]; then
        SOURCE_PATH="$PROJECT_ROOT/claude/agents/$AGENTNAME/$SOURCE_FILE"
    else
        echo "Source file not found: $SOURCE_FILE"
        exit 1
    fi

    # Copy with header
    cat > "$ARCHIVE_PATH" << EOF
---
archived: $(date +%Y-%m-%d\ %H:%M)
workstream: $WORKSTREAM
agent: $AGENTNAME
principal: $PRINCIPAL
source: $SOURCE_FILE
---

EOF
    cat "$SOURCE_PATH" >> "$ARCHIVE_PATH"
else
    # Create new session archive from template
    cat > "$ARCHIVE_PATH" << EOF
---
archived: $(date +%Y-%m-%d\ %H:%M)
workstream: $WORKSTREAM
agent: $AGENTNAME
principal: $PRINCIPAL
---

# Session Archive: $DESCRIPTION

## Summary

[Brief summary of what was accomplished]

## Key Decisions

-

## Files Changed

-

## Next Steps

-

---

*Archived $(date +%Y-%m-%d\ %H:%M)*
EOF
fi

echo -e "${GREEN}Session archived:${NC}"
echo -e "${BLUE}  $ARCHIVE_PATH${NC}"
echo ""
echo "Structure: principals/{principal}/sessions/{agent}/YYYYMMDD-HHMM-{workstream}-{agent}-{desc}.md"
