#!/bin/bash
# Spawn review subagents for the development workflow
#
# Usage:
#   ./tools/review-spawn REQUEST-jordan-0065 code      # Spawn 2 code reviewers + 1 security
#   ./tools/review-spawn REQUEST-jordan-0065 test      # Spawn 2 test reviewers
#   ./tools/review-spawn REQUEST-jordan-0065 --show    # Show prompts without spawning
#
# This tool generates the prompts for review subagents. The prompts are
# designed to be used with Claude Code's Task tool (subagent_type=general-purpose).
#
# Review Types:
#   code  - Spawn 2+ code reviewers and 1+ security reviewer
#   test  - Spawn 2+ test reviewers
#
# Options:
#   --show        Display prompts instead of spawning
#   --count N     Override reviewer count (default: 2 for code/test, 1 for security)
#   --verbose     Show detailed output

set -euo pipefail

TOOL_VERSION="1.0.0-20260118-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Defaults
SHOW_ONLY=false
VERBOSE=false
CODE_COUNT=2
SECURITY_COUNT=1
TEST_COUNT=2

# Parse options
while [[ $# -gt 0 ]]; do
    case $1 in
        --version|-v)
            echo "review-spawn $TOOL_VERSION"
            exit 0
            ;;
        --help|-h)
            head -20 "$0" | tail -19 | sed 's/^# //' | sed 's/^#//'
            exit 0
            ;;
        --show)
            SHOW_ONLY=true
            shift
            ;;
        --count)
            CODE_COUNT="$2"
            TEST_COUNT="$2"
            shift 2
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        *)
            break
            ;;
    esac
done

WORK_ITEM="${1:-}"
REVIEW_TYPE="${2:-}"

if [ -z "$WORK_ITEM" ] || [ -z "$REVIEW_TYPE" ]; then
    echo -e "${RED}Error: Missing arguments${NC}"
    echo "Usage: ./tools/review-spawn <work-item> <code|test> [--show]"
    echo ""
    echo "Examples:"
    echo "  ./tools/review-spawn REQUEST-jordan-0065 code"
    echo "  ./tools/review-spawn REQUEST-jordan-0065 test --show"
    exit 1
fi

# Validate review type
if [ "$REVIEW_TYPE" != "code" ] && [ "$REVIEW_TYPE" != "test" ]; then
    echo -e "${RED}Error: Invalid review type '$REVIEW_TYPE'${NC}"
    echo "Valid types: code, test"
    exit 1
fi

# Generate code review prompt
generate_code_review_prompt() {
    local reviewer_num=$1
    cat << EOF
You are Code Reviewer #${reviewer_num} for ${WORK_ITEM}.

Review all code changes since the last tagged stage. Focus on:

1. **Code Quality** - Readability, maintainability, naming conventions
2. **Error Handling** - Proper error propagation, edge cases
3. **API Design** - Consistent patterns, clear interfaces
4. **Performance** - Obvious inefficiencies, N+1 queries
5. **Best Practices** - Framework conventions, no anti-patterns

## Output Format

Return findings as a numbered list:

1. **[SEVERITY]** \`file:line\` - Issue description
   - Recommendation: How to fix

Severity: CRITICAL, HIGH, MEDIUM, LOW, INFO

## Important
- Focus on substantive issues, not style nitpicks
- Each finding must include file:line reference
- Provide actionable recommendations
- Do NOT apply fixes - just report findings
EOF
}

# Generate security review prompt
generate_security_review_prompt() {
    cat << EOF
You are a Security Reviewer for ${WORK_ITEM}.

Review all code changes since the last tagged stage. Check for:

1. **Injection** - SQL, command, XSS, template injection
2. **Auth/Authz** - Bypass, missing checks, session issues
3. **Input Validation** - Untrusted input, type coercion, boundaries
4. **Secrets** - Hardcoded secrets, logging, insecure storage
5. **Path Operations** - Traversal, symlinks, permissions
6. **Crypto** - Weak algorithms, key management

## Output Format

1. **[SEVERITY]** \`file:line\` - Vulnerability description
   - CWE: CWE-XXX (name)
   - OWASP: Category if applicable
   - Recommendation: How to fix
   - Impact: What could happen if exploited

Severity: CRITICAL, HIGH, MEDIUM, LOW

## Important
- All findings must include CWE ID
- Critical/High findings block release
- Do NOT apply fixes - just report findings
EOF
}

# Generate test review prompt
generate_test_review_prompt() {
    local reviewer_num=$1
    cat << EOF
You are Test Reviewer #${reviewer_num} for ${WORK_ITEM}.

Review the implementation and existing tests. Identify missing test coverage:

1. **Functional Tests** - Happy path, APIs, assertions, state changes
2. **Edge Cases** - Boundaries, empty inputs, large inputs, unicode
3. **Error Scenarios** - Invalid inputs, failures, timeouts
4. **Security Tests** - Validation, auth, injection attempts, path traversal
5. **Integration Tests** - Component interactions, mocks, database ops

## Output Format

1. **[PRIORITY]** Test: description
   - File: Where to add
   - Type: unit | integration | e2e | security
   - Setup: Required mocks/fixtures
   - Assertions: What to verify

Priority: CRITICAL, HIGH, MEDIUM, LOW

## Important
- Prioritize security tests
- Include setup requirements
- Specify exact assertions
- Do NOT write the tests - just describe what's needed
EOF
}

# Display prompts
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}  Review Spawn: ${WORK_ITEM} (${REVIEW_TYPE})${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo ""

if [ "$REVIEW_TYPE" = "code" ]; then
    # Code review prompts
    for i in $(seq 1 $CODE_COUNT); do
        echo -e "${GREEN}━━━ Code Reviewer #${i} ━━━${NC}"
        echo ""
        generate_code_review_prompt $i
        echo ""
        echo -e "${CYAN}───────────────────────────────────────────────────────────────${NC}"
        echo ""
    done

    # Security review prompt
    echo -e "${YELLOW}━━━ Security Reviewer ━━━${NC}"
    echo ""
    generate_security_review_prompt
    echo ""
    echo -e "${CYAN}───────────────────────────────────────────────────────────────${NC}"
    echo ""

    echo -e "${GREEN}Spawn Instructions:${NC}"
    echo "1. Use Claude Code's Task tool with subagent_type='general-purpose'"
    echo "2. Spawn ${CODE_COUNT} code reviewers in parallel"
    echo "3. Spawn ${SECURITY_COUNT} security reviewer(s)"
    echo "4. Wait for all to complete"
    echo "5. Use consolidation template to merge findings"
    echo ""
    echo -e "${YELLOW}Template: claude/templates/prompts/consolidation.md${NC}"

elif [ "$REVIEW_TYPE" = "test" ]; then
    # Test review prompts
    for i in $(seq 1 $TEST_COUNT); do
        echo -e "${GREEN}━━━ Test Reviewer #${i} ━━━${NC}"
        echo ""
        generate_test_review_prompt $i
        echo ""
        echo -e "${CYAN}───────────────────────────────────────────────────────────────${NC}"
        echo ""
    done

    echo -e "${GREEN}Spawn Instructions:${NC}"
    echo "1. Use Claude Code's Task tool with subagent_type='general-purpose'"
    echo "2. Spawn ${TEST_COUNT} test reviewers in parallel"
    echo "3. Wait for all to complete"
    echo "4. Use consolidation template to merge findings"
    echo ""
    echo -e "${YELLOW}Template: claude/templates/prompts/consolidation.md${NC}"
fi
