#!/bin/bash
# Save review findings to structured JSON file
#
# Usage:
#   ./tools/findings-save WORK-ITEM STAGE REVIEW-TYPE < findings.json
#   cat findings.json | ./tools/findings-save REQUEST-jordan-0065 impl code
#
# Arguments:
#   WORK-ITEM    Work item ID (REQUEST-jordan-0065, SPRINT-web-2026w03, etc.)
#   STAGE        Development stage: impl, review, tests
#   REVIEW-TYPE  Review type: code, security, test
#
# The tool:
#   1. Reads JSON findings from stdin
#   2. Validates against finding.schema.json
#   3. Saves to claude/logs/reviews/{WORK-ITEM}/{review-type}-review-{N}.json
#   4. Auto-increments N if file exists
#
# Options:
#   --dry-run    Show what would be saved without writing
#   --no-validate Skip schema validation
#   --help       Show this help
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SCHEMAS_DIR="$REPO_ROOT/claude/schemas"
REVIEWS_DIR="$REPO_ROOT/claude/logs/reviews"
VALIDATOR="$REPO_ROOT/tests/schemas/validate-schema.py"

# Source log helper for tool tracking, with no-op fallbacks
RUN_ID="none"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
    RUN_ID=$(log_start "findings-save" "agency-tool" "$@" 2>/dev/null) || RUN_ID="none"
else
    log_end() { :; }
fi

# Defaults
DRY_RUN=false
VALIDATE=true

show_help() {
    sed -n '2,/^$/p' "$0" | sed 's/^# //' | sed 's/^#//'
    exit 0
}

# Parse options
POSITIONAL=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            show_help
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --no-validate)
            VALIDATE=false
            shift
            ;;
        -*)
            echo "findings-save [run: $RUN_ID]" >&2
            echo "Unknown option: $1" >&2
            echo "✗" >&2
            log_end "$RUN_ID" 1 "" "Unknown option: $1"
            exit 1
            ;;
        *)
            POSITIONAL+=("$1")
            shift
            ;;
    esac
done

# Restore positional parameters
if [[ ${#POSITIONAL[@]} -gt 0 ]]; then
    set -- "${POSITIONAL[@]}"
else
    set --
fi

# Validate arguments
if [[ $# -lt 3 ]]; then
    echo "findings-save [run: $RUN_ID]" >&2
    echo "Usage: ./tools/findings-save WORK-ITEM STAGE REVIEW-TYPE < findings.json" >&2
    echo "✗" >&2
    log_end "$RUN_ID" 1 "" "Missing arguments"
    exit 1
fi

WORK_ITEM="$1"
STAGE="$2"
REVIEW_TYPE="$3"

# Validate work item (prevent path traversal and invalid formats)
if [[ "$WORK_ITEM" =~ \.\.|/ ]]; then
    echo "findings-save [run: $RUN_ID]" >&2
    echo "Invalid work item: $WORK_ITEM (cannot contain '..' or '/')" >&2
    echo "✗" >&2
    log_end "$RUN_ID" 1 "" "Invalid work item: path traversal"
    exit 1
fi

if [[ ! "$WORK_ITEM" =~ ^[A-Z]+-[a-zA-Z0-9-]+-[a-zA-Z0-9]+$ ]]; then
    echo "findings-save [run: $RUN_ID]" >&2
    echo "Invalid work item format: $WORK_ITEM" >&2
    echo "Expected format: TYPE-name-id (e.g., REQUEST-jordan-0065)" >&2
    echo "✗" >&2
    log_end "$RUN_ID" 1 "" "Invalid work item format"
    exit 1
fi

# Validate stage
if [[ ! "$STAGE" =~ ^(impl|review|tests)$ ]]; then
    echo "findings-save [run: $RUN_ID]" >&2
    echo "Invalid stage: $STAGE (must be impl, review, or tests)" >&2
    echo "✗" >&2
    log_end "$RUN_ID" 1 "" "Invalid stage: $STAGE"
    exit 1
fi

# Validate review type
if [[ ! "$REVIEW_TYPE" =~ ^(code|security|test)$ ]]; then
    echo "findings-save [run: $RUN_ID]" >&2
    echo "Invalid review type: $REVIEW_TYPE (must be code, security, or test)" >&2
    echo "✗" >&2
    log_end "$RUN_ID" 1 "" "Invalid review type: $REVIEW_TYPE"
    exit 1
fi

# Read stdin into temp file
TEMP_INPUT=$(mktemp)
trap "rm -f '$TEMP_INPUT'" EXIT

cat > "$TEMP_INPUT"

# Check for empty input
if [[ ! -s "$TEMP_INPUT" ]]; then
    echo "findings-save [run: $RUN_ID]" >&2
    echo "Empty input - no data provided on stdin" >&2
    echo "✗" >&2
    log_end "$RUN_ID" 1 "" "Empty input"
    exit 1
fi

# Check if input is valid JSON
if ! python3 -c "import json; json.load(open('$TEMP_INPUT'))" 2>/dev/null; then
    echo "findings-save [run: $RUN_ID]" >&2
    echo "Invalid JSON input" >&2
    echo "✗" >&2
    log_end "$RUN_ID" 1 "" "Invalid JSON input"
    exit 1
fi

# Validate against schema if enabled
if [[ "$VALIDATE" == "true" ]]; then
    SCHEMA_FILE="$SCHEMAS_DIR/finding.schema.json"
    if [[ ! -f "$SCHEMA_FILE" ]]; then
        echo "findings-save [run: $RUN_ID]" >&2
        echo "Schema not found: $SCHEMA_FILE" >&2
        echo "✗" >&2
        log_end "$RUN_ID" 1 "" "Schema not found"
        exit 1
    fi

    if [[ -f "$VALIDATOR" ]]; then
        if ! python3 "$VALIDATOR" "$SCHEMA_FILE" "$TEMP_INPUT" 2>/dev/null; then
            echo "findings-save [run: $RUN_ID]" >&2
            echo "Schema validation failed" >&2
            python3 "$VALIDATOR" "$SCHEMA_FILE" "$TEMP_INPUT" 2>&1 | head -5 >&2
            echo "✗" >&2
            log_end "$RUN_ID" 1 "" "Schema validation failed"
            exit 1
        fi
    else
        # Fallback: basic JSON structure check
        if ! python3 -c "
import json
with open('$TEMP_INPUT') as f:
    data = json.load(f)
    required = ['schema_version', 'work_item', 'stage', 'review_type', 'reviewer', 'timestamp', 'findings']
    missing = [k for k in required if k not in data]
    if missing:
        raise ValueError(f'Missing required fields: {missing}')
" 2>/dev/null; then
            echo "findings-save [run: $RUN_ID]" >&2
            echo "Validation failed: missing required fields" >&2
            echo "✗" >&2
            log_end "$RUN_ID" 1 "" "Missing required fields"
            exit 1
        fi
    fi
fi

# Create output directory
OUTPUT_DIR="$REVIEWS_DIR/$WORK_ITEM"
if [[ "$DRY_RUN" == "false" ]]; then
    if ! mkdir -p "$OUTPUT_DIR"; then
        echo "findings-save [run: $RUN_ID]" >&2
        echo "Failed to create directory: $OUTPUT_DIR" >&2
        echo "✗" >&2
        log_end "$RUN_ID" 1 "" "Failed to create directory"
        exit 1
    fi
fi

# Find next available file number
N=1
while [[ -f "$OUTPUT_DIR/${REVIEW_TYPE}-review-${N}.json" ]]; do
    ((N++))
done

OUTPUT_FILE="$OUTPUT_DIR/${REVIEW_TYPE}-review-${N}.json"

if [[ "$DRY_RUN" == "true" ]]; then
    echo "findings-save [run: $RUN_ID]"
    echo "Would save to: $OUTPUT_FILE"
    echo "[dry-run]"
    log_end "$RUN_ID" 0 "[dry-run]" ""
    exit 0
fi

# Write output file with pretty formatting
if ! python3 -c "
import json
import sys

temp_input = sys.argv[1]
output_file = sys.argv[2]

try:
    with open(temp_input) as f:
        data = json.load(f)
    with open(output_file, 'w') as f:
        json.dump(data, f, indent=2)
        f.write('\n')
except Exception as e:
    print(f'Write error: {e}', file=sys.stderr)
    sys.exit(1)
" "$TEMP_INPUT" "$OUTPUT_FILE"; then
    echo "findings-save [run: $RUN_ID]" >&2
    echo "Failed to write output file" >&2
    echo "✗" >&2
    log_end "$RUN_ID" 1 "" "Write failed"
    exit 1
fi

# Output
echo "findings-save [run: $RUN_ID]"
echo "Saved: $OUTPUT_FILE"
echo "✓"

log_end "$RUN_ID" 0 "Saved: $OUTPUT_FILE" ""
