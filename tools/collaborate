#!/bin/bash
# Tool: collaborate
# Purpose: Create inter-agent collaboration request documents
# Usage: ./tools/collaborate "target-agent" "subject" "description"
# Example: ./tools/collaborate "analytics" "API Design Review" "Need feedback on analytics endpoint design"

set -e

# Tool version
TOOL_VERSION="1.0.2-20260114-000001"

# Defaults
VERBOSE=false

# Source log helper for tool tracking
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "collaborate $TOOL_VERSION"
    exit 0
fi

# Parse flags
while [[ $# -gt 0 ]]; do
    case $1 in
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help|-h)
            echo "Usage: ./tools/collaborate [--verbose] \"target-agent\" \"subject\" \"description\""
            echo "Example: ./tools/collaborate \"analytics\" \"API Design Review\" \"Need feedback on analytics endpoint design\""
            echo ""
            echo "Options:"
            echo "  --verbose    Show detailed output"
            echo "  --version    Show tool version"
            echo "  --help       Show this help"
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Auto-load .env.local if it exists
if [[ -f ".env.local" ]]; then
  set -a
  source .env.local
  set +a
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

COLLAB_DIR="claude/agents/collaboration"

# Validate arguments
if [[ $# -lt 3 ]]; then
  echo "Usage: ./tools/collaborate [--verbose] \"target-agent\" \"subject\" \"description\""
  echo "Example: ./tools/collaborate \"analytics\" \"API Design Review\" \"Need feedback on analytics endpoint design\""
  exit 1
fi

TARGET_AGENT="$1"
SUBJECT="$2"
DESCRIPTION="$3"

# Main function
main() {
    # Trap unexpected exits
    trap 'if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then log_end "$RUN_ID" "failure" $? 0 "Unexpected exit"; fi' EXIT

    echo "collaborate [run: ${RUN_ID:-none}]"

    # Start logging
    RUN_ID=""
    if type log_start &>/dev/null; then
        RUN_ID=$(log_start "collaborate" "agency-tool" "$TARGET_AGENT" "$SUBJECT")
    fi

    # Get current timestamp
    TIMESTAMP=$(./tools/now 2>/dev/null || date "+%Y-%m-%d %H:%M:%S %Z")
    DATE=$(echo "$TIMESTAMP" | cut -d' ' -f1)
    FULL_TIMESTAMP="$TIMESTAMP"

    # Get agent name and workstream for attribution
    SOURCE_AGENT=$(./tools/agentname 2>/dev/null || echo "unknown")
    SOURCE_WORKSTREAM=$(./tools/workstream 2>/dev/null || echo "unknown")
    COMMIT_PREFIX=$(./tools/commit-prefix 2>/dev/null || echo "unknown/unknown:")

    # Function to handle merge conflicts
    handle_merge_conflict() {
      log_info "Merge conflict detected. Attempting to resolve..."
      # For collaboration files, prefer remote version and retry
      git checkout --theirs "$COLLAB_DIR"
      git add "$COLLAB_DIR"
      log_info "Resolved by accepting remote version. Will retry operation."
      return 0
    }

    # Step 1: Pull latest
    log_step "Pulling latest changes..."
    git pull --rebase 2>/dev/null || {
      # If rebase fails due to conflicts, abort and try regular pull
      git rebase --abort 2>/dev/null || true
      git pull || {
        # If regular pull also has conflicts, handle them
        if git diff --name-only --diff-filter=U | grep -q "$COLLAB_DIR"; then
          handle_merge_conflict
        fi
      }
    }

    # Step 2: Ensure collaboration directory exists
    mkdir -p "$COLLAB_DIR"

    # Step 3: Find the highest existing COLLABORATE ID for this source agent
    # Pattern: FROM-{source-workstream}-{source-agent}-COLLABORATE-####-YYYY-MM-DD.md
    PATTERN="FROM-${SOURCE_WORKSTREAM}-${SOURCE_AGENT}-COLLABORATE-"
    HIGHEST_ID=$(find "$COLLAB_DIR" -name "${PATTERN}*.md" 2>/dev/null | grep -oE 'COLLABORATE-[0-9]+' | grep -oE '[0-9]+' | sed 's/^0*//' | sort -n | tail -1)
    if [[ -z "$HIGHEST_ID" ]]; then
      HIGHEST_ID=0
    fi
    NEW_ID=$((HIGHEST_ID + 1))
    NEW_ID_FORMATTED=$(printf "%04d" $NEW_ID)

    # Step 4: Create filename
    FILENAME="${COLLAB_DIR}/FROM-${SOURCE_WORKSTREAM}-${SOURCE_AGENT}-COLLABORATE-${NEW_ID_FORMATTED}-${DATE}.md"

    # Step 5: Create collaboration request document
    log_step "Creating collaboration request: COLLABORATE-${NEW_ID_FORMATTED}"
    cat > "$FILENAME" << EOF
# Collaboration Request

**ID:** COLLABORATE-${NEW_ID_FORMATTED}
**From:** ${SOURCE_AGENT} (${SOURCE_WORKSTREAM})
**To:** ${TARGET_AGENT}
**Date:** ${FULL_TIMESTAMP}
**Status:** Open

## Subject: ${SUBJECT}

## Request

${DESCRIPTION}

## Response

(To be filled by target agent using ./tools/collaboration-respond)

---

**Note:** Use \`./tools/collaboration-respond "${FILENAME}" "response"\` to respond.
EOF

    verbose_echo "Created collaboration request: COLLABORATE-${NEW_ID_FORMATTED}"

    # Step 6: Stage and commit
    log_step "Committing collaboration request..."
    git add "$FILENAME"
    COMMIT_MSG="$COMMIT_PREFIX chore: create COLLABORATE-${NEW_ID_FORMATTED} from ${SOURCE_AGENT} to ${TARGET_AGENT}

Subject: ${SUBJECT}

${DESCRIPTION}

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

    git commit -m "$COMMIT_MSG

[skip ci]" || {
      log_error "Nothing to commit (file may already exist)"
      trap - EXIT
      if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then
          log_end "$RUN_ID" "failure" "1" "0" "Nothing to commit"
      fi
      exit 0
    }

    # Step 7: Push using sync tool
    log_step "Syncing changes..."
    ./tools/sync || {
      log_error "Sync failed"
      trap - EXIT
      if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then
          log_end "$RUN_ID" "failure" "1" "0" "Sync failed for COLLABORATE-${NEW_ID_FORMATTED}"
      fi
      exit 1
    }

    echo ""
    echo "Successfully created collaboration request:"
    echo "  ID: COLLABORATE-${NEW_ID_FORMATTED}"
    echo "  From: ${SOURCE_AGENT} (${SOURCE_WORKSTREAM})"
    echo "  To: ${TARGET_AGENT}"
    echo "  Subject: ${SUBJECT}"
    echo "  File: ${FILENAME}"
    echo ""
    verbose_echo "Target agent can respond using:"
    verbose_echo "  ./tools/collaboration-respond \"${FILENAME}\" \"response text\""

    # End logging - success
    trap - EXIT
    if type log_end &>/dev/null && [[ -n "$RUN_ID" ]]; then
        log_end "$RUN_ID" "success" "0" "0" "COLLABORATE-${NEW_ID_FORMATTED}: ${SOURCE_AGENT} -> ${TARGET_AGENT}"
    fi
}

main
