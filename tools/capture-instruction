#!/bin/bash
# Capture an instruction from a Principal
#
# Usage:
#   capture-instruction -t "Title" ["Content"]
#   capture-instruction -p jordan -w housekeeping -a housekeeping -t "Title"
#
# Options:
#   -p, --principal    Principal name (default: $PRINCIPAL or mapped from whoami)
#   -w, --workstream   Workstream (default: $WORKSTREAM)
#   -a, --agent        Agent name (default: $AGENTNAME)
#   -t, --title        Instruction title (required)
#   -o, --origin       Origin: principal-directed (default) or agent-suggested
#   -e, --edit         Force open in editor even if content provided
#   -h, --help         Show this help
#
# If content is provided as final argument, creates instruction with that content.
# If no content, opens in editor for detailed writing.
#
# Examples:
#   # From Claude session (agent provides content):
#   capture-instruction -t "Commit prefix" "Every commit should have {ws}/{agent}: prefix"
#
#   # From command line (opens editor):
#   capture-instruction -p jordan -w housekeeping -a housekeeping -t "Principal workflow"

set -e

# Find repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

PRINCIPALS_DIR="$REPO_ROOT/claude/principals"

# Defaults from environment
OPT_PRINCIPAL="${PRINCIPAL:-}"
OPT_WORKSTREAM="${WORKSTREAM:-}"
OPT_AGENT="${AGENTNAME:-}"
OPT_TITLE=""
OPT_ORIGIN="principal-directed"
OPT_EDIT=false
CONTENT=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -p|--principal)
      OPT_PRINCIPAL="$2"
      shift 2
      ;;
    -w|--workstream)
      OPT_WORKSTREAM="$2"
      shift 2
      ;;
    -a|--agent)
      OPT_AGENT="$2"
      shift 2
      ;;
    -t|--title)
      OPT_TITLE="$2"
      shift 2
      ;;
    -o|--origin)
      OPT_ORIGIN="$2"
      shift 2
      ;;
    -e|--edit)
      OPT_EDIT=true
      shift
      ;;
    -h|--help)
      head -30 "$0" | tail -28
      exit 0
      ;;
    -*)
      echo "Unknown option: $1"
      exit 1
      ;;
    *)
      # Remaining argument is content
      CONTENT="$1"
      shift
      ;;
  esac
done

# Validate title
if [[ -z "$OPT_TITLE" ]]; then
  echo "Error: Title is required (-t \"Title\")"
  echo "Usage: capture-instruction -t \"Title\" [\"Content\"]"
  exit 1
fi

# Determine principal if not set
if [[ -z "$OPT_PRINCIPAL" ]]; then
  # Try to get from config
  OPT_PRINCIPAL=$("$SCRIPT_DIR/principal" 2>/dev/null || echo "")

  # Fallback to username
  if [[ -z "$OPT_PRINCIPAL" ]] || [[ "$OPT_PRINCIPAL" == "unknown" ]]; then
    OPT_PRINCIPAL=$(whoami)
  fi
fi

# Validate workstream and agent (warn if not set)
if [[ -z "$OPT_WORKSTREAM" ]]; then
  echo "Warning: Workstream not specified. Use -w or set WORKSTREAM env var."
  OPT_WORKSTREAM="unknown"
fi

if [[ -z "$OPT_AGENT" ]]; then
  echo "Warning: Agent not specified. Use -a or set AGENTNAME env var."
  OPT_AGENT="unknown"
fi

# Ensure principal directory exists
PRINCIPAL_DIR="$PRINCIPALS_DIR/$OPT_PRINCIPAL"
INSTRUCTIONS_DIR="$PRINCIPAL_DIR/instructions"
mkdir -p "$INSTRUCTIONS_DIR"

# Get timezone from config or default to UTC
TIMEZONE=$("$SCRIPT_DIR/config" get project.timezone 2>/dev/null || echo "UTC")

# Create principal.md if it doesn't exist
if [[ ! -f "$PRINCIPAL_DIR/principal.md" ]]; then
  cat > "$PRINCIPAL_DIR/principal.md" << EOF
# Principal: $OPT_PRINCIPAL

**ID:** $OPT_PRINCIPAL
**Created:** $(TZ="$TIMEZONE" date '+%Y-%m-%d %H:%M %Z')

## Authority

(To be defined)

## Instructions

See \`./instructions/\` for active and completed instructions from this principal.
EOF
  echo "Created principal profile: $PRINCIPAL_DIR/principal.md"
fi

# Find next instruction number with atomic locking
# This prevents race conditions when multiple agents run concurrently
COUNTER_FILE="$PRINCIPALS_DIR/.instruction-counter"
LOCK_DIR="$PRINCIPALS_DIR/.instruction-counter.lock"

# Portable locking using mkdir (atomic on all POSIX systems)
# Retry with exponential backoff
MAX_RETRIES=10
RETRY_COUNT=0
while ! mkdir "$LOCK_DIR" 2>/dev/null; do
  RETRY_COUNT=$((RETRY_COUNT + 1))
  if [[ $RETRY_COUNT -ge $MAX_RETRIES ]]; then
    echo "Error: Could not acquire lock after $MAX_RETRIES attempts" >&2
    exit 1
  fi
  sleep 0.$((RANDOM % 5 + 1))  # Random backoff 0.1-0.5s
done

# Ensure lock is released on exit (success or failure)
trap 'rmdir "$LOCK_DIR" 2>/dev/null' EXIT

# Read current counter (or scan if counter file doesn't exist/is corrupted)
if [[ -f "$COUNTER_FILE" ]] && [[ -s "$COUNTER_FILE" ]]; then
  CURRENT_NUM=$(cat "$COUNTER_FILE" 2>/dev/null | tr -d '[:space:]')
  if ! [[ "$CURRENT_NUM" =~ ^[0-9]+$ ]]; then
    CURRENT_NUM=0
  fi
else
  # Initialize from existing files (one-time migration)
  CURRENT_NUM=$(find "$PRINCIPALS_DIR" -name "INSTR-*.md" 2>/dev/null | grep -oE 'INSTR-[0-9]+' | grep -oE '[0-9]+' | sort -n | tail -1)
  if [[ -z "$CURRENT_NUM" ]]; then
    CURRENT_NUM=0
  fi
fi

# Increment and save
NEXT_NUM=$((CURRENT_NUM + 1))
echo "$NEXT_NUM" > "$COUNTER_FILE"

# Lock is automatically released by trap on EXIT

NEXT_NUM_FMT=$(printf "%04d" $NEXT_NUM)

# Create slug from title
SLUG=$(echo "$OPT_TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-' | cut -c1-40)

# Build filename
FILENAME="INSTR-${NEXT_NUM_FMT}-${OPT_PRINCIPAL}-${OPT_WORKSTREAM}-${OPT_AGENT}-${SLUG}.md"
FILEPATH="$INSTRUCTIONS_DIR/$FILENAME"

# Get timestamp
TIMESTAMP=$(TZ="$TIMEZONE" date '+%Y-%m-%d %H:%M %Z')

# Create instruction file
cat > "$FILEPATH" << EOF
# INSTR-${NEXT_NUM_FMT}: ${OPT_TITLE}

**Principal:** ${OPT_PRINCIPAL}
**Date:** ${TIMESTAMP}
**To:** ${OPT_WORKSTREAM}/${OPT_AGENT}
**Origin:** ${OPT_ORIGIN}
**Status:** Active

## Directive

${CONTENT:-[Describe the instruction here]}

## Context

[Why this matters, any background]

## Scope

[What's in/out of scope]

---

## Outcome

**Completed:** (pending)
**By:** ${OPT_WORKSTREAM}/${OPT_AGENT}

(To be filled when instruction is completed)

## Artifacts

- (Links to PRs, files, completions)
EOF

echo "Created instruction: $FILEPATH"

# Open in editor if no content provided or --edit flag
if [[ -z "$CONTENT" ]] || [[ "$OPT_EDIT" == true ]]; then
  # Try to read editor preference from principal's preferences.yaml
  PREFS_FILE="$PRINCIPAL_DIR/preferences.yaml"
  if [[ -f "$PREFS_FILE" ]] && command -v yq &> /dev/null; then
    EDITOR_CMD=$(yq -r '.editor // "code"' "$PREFS_FILE")
    EDITOR_WAIT=$(yq -r '.editor_wait // "true"' "$PREFS_FILE")
  else
    EDITOR_CMD="${EDITOR:-code}"
    EDITOR_WAIT="true"
  fi

  echo "Opening in editor: $EDITOR_CMD"

  if [[ "$EDITOR_WAIT" == "true" ]] && [[ "$EDITOR_CMD" == "code" ]]; then
    "$EDITOR_CMD" --wait "$FILEPATH"
  else
    "$EDITOR_CMD" "$FILEPATH"
  fi
fi

echo ""
echo "Instruction ready: INSTR-${NEXT_NUM_FMT}"
echo "  File: $FILEPATH"
echo "  Principal: $OPT_PRINCIPAL"
echo "  To: ${OPT_WORKSTREAM}/${OPT_AGENT}"

# Update the instructions index
"$SCRIPT_DIR/update-instruction-index" > /dev/null 2>&1 || true
