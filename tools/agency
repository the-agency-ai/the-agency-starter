#!/bin/bash
# agency - Unified CLI for Agency Work Item Management
#
# Manage requests, bugs, ideas, and observations from one tool.
#
# Usage:
#   ./tools/agency <resource> <command> [options]
#
# Resources:
#   request       Work requests from principals
#   bug           Bug reports and tracking
#   idea          Ideas and brainstorming
#   observation   Observations and notes
#
# Common Commands (all resources):
#   list          List items with filtering
#   get <id>      Get a specific item
#   create        Create a new item
#   update <id>   Update an item
#   delete <id>   Delete an item
#   stats         Get statistics
#
# Request Commands:
#   ./tools/agency request list [--status=...] [--principal=...] [--workstream=...]
#   ./tools/agency request get <requestId>
#   ./tools/agency request create --title="..." --principal=... --workstream=...
#   ./tools/agency request update <requestId> [--status=...] [--priority=...]
#   ./tools/agency request approve <requestId>
#   ./tools/agency request reject <requestId>
#   ./tools/agency request assign <requestId> --agent=...
#   ./tools/agency request complete <requestId>
#   ./tools/agency request stats
#
# Bug Commands:
#   ./tools/agency bug list [--status=...] [--assignee=...] [--workstream=...]
#   ./tools/agency bug get <bugId>
#   ./tools/agency bug create --summary="..." --workstream=... [--reporter=...]
#   ./tools/agency bug update <bugId> [--status=...] [--assignee=...]
#   ./tools/agency bug assign <bugId> --assignee=...
#   ./tools/agency bug resolve <bugId> [--resolution=...]
#   ./tools/agency bug stats
#
# Idea Commands:
#   ./tools/agency idea list [--status=...] [--source=...] [--tags=...]
#   ./tools/agency idea get <ideaId>
#   ./tools/agency idea create --title="..." --source=... [--tags=...]
#   ./tools/agency idea update <ideaId> [--status=...] [--tags=...]
#   ./tools/agency idea promote <ideaId> --request=...
#   ./tools/agency idea explore <ideaId>
#   ./tools/agency idea park <ideaId>
#   ./tools/agency idea discard <ideaId>
#   ./tools/agency idea stats
#
# Observation Commands:
#   ./tools/agency observation list [--type=...] [--observer=...] [--context=...]
#   ./tools/agency observation get <observationId>
#   ./tools/agency observation create --content="..." --type=... [--observer=...]
#   ./tools/agency observation update <observationId> [--content=...] [--tags=...]
#   ./tools/agency observation link <observationId> --request=... | --bug=... | --idea=...
#   ./tools/agency observation archive <observationId>
#   ./tools/agency observation stats
#
# Global Options:
#   --json                    Output in JSON format
#   --sortBy=<field>          Sort by field (createdAt, updatedAt, title, status)
#   --sortOrder=<asc|desc>    Sort direction (default: desc)
#   --search=<term>           Search in title/content
#   --limit=<n>               Limit results (default: 50)
#   --offset=<n>              Offset for pagination
#   -h, --help                Show this help
#   -v, --version             Show version
#
# Examples:
#   ./tools/agency request list --status=in_progress
#   ./tools/agency bug create --summary="Fix login bug" --workstream=auth
#   ./tools/agency idea list --tags=ui,tooling --sortBy=createdAt
#   ./tools/agency observation create --content="API is slow" --type=performance
#   ./tools/agency request stats --json

set -e

# Tool version
TOOL_VERSION="1.0.0"

# API configuration
API_BASE="${AGENCY_SERVICE_URL:-http://localhost:3141/api}"
AGENCY_USER="${AGENCY_USER:-principal:jordan}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Output format
JSON_OUTPUT=false

# Global query params
SORT_BY=""
SORT_ORDER=""
SEARCH=""
LIMIT=""
OFFSET=""

# Parse global options first (modifies global variables)
parse_global_options() {
    REMAINING_ARGS=()
    while [[ $# -gt 0 ]]; do
        case $1 in
            --version|-v)
                echo "agency $TOOL_VERSION"
                exit 0
                ;;
            --help|-h)
                head -70 "$0" | tail -69 | sed 's/^# //' | sed 's/^#//'
                exit 0
                ;;
            --json)
                JSON_OUTPUT=true
                shift
                ;;
            --sortBy=*)
                SORT_BY="${1#*=}"
                shift
                ;;
            --sortOrder=*)
                SORT_ORDER="${1#*=}"
                shift
                ;;
            --search=*)
                SEARCH="${1#*=}"
                shift
                ;;
            --limit=*)
                LIMIT="${1#*=}"
                shift
                ;;
            --offset=*)
                OFFSET="${1#*=}"
                shift
                ;;
            *)
                REMAINING_ARGS+=("$1")
                shift
                ;;
        esac
    done
}

# Helper: make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"

    local url="${API_BASE}${endpoint}"
    local curl_args=(-s -w "\n%{http_code}" -X "$method" -H "X-Agency-User: $AGENCY_USER")

    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi

    local response
    response=$(curl "${curl_args[@]}" "$url" 2>/dev/null) || {
        echo -e "${RED}Error: Failed to connect to Agency Service at $url${NC}" >&2
        echo "Is the service running? Start it with: cd source/services/agency-service && bun run dev" >&2
        exit 1
    }

    # Split response and status code
    local body status_code
    body=$(echo "$response" | sed '$d')
    status_code=$(echo "$response" | tail -1)

    # Check for errors
    if [[ "$status_code" -ge 400 ]]; then
        local error_msg
        error_msg=$(echo "$body" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('error','Unknown error'))" 2>/dev/null || echo "$body")
        echo -e "${RED}Error ($status_code): $error_msg${NC}" >&2
        exit 1
    fi

    echo "$body"
}

# Helper: build query string
build_query_string() {
    local query=""
    local first=true

    for param in "$@"; do
        if [[ -n "$param" ]]; then
            if [[ "$first" == "true" ]]; then
                query="?$param"
                first=false
            else
                query="${query}&${param}"
            fi
        fi
    done

    # Add global params
    [[ -n "$SORT_BY" ]] && query="${query:+"$query&"}${query:+}${query:?"?"}sortBy=$SORT_BY"
    [[ -n "$SORT_ORDER" ]] && query="${query}&sortOrder=$SORT_ORDER"
    [[ -n "$SEARCH" ]] && query="${query}&search=$SEARCH"
    [[ -n "$LIMIT" ]] && query="${query}&limit=$LIMIT"
    [[ -n "$OFFSET" ]] && query="${query}&offset=$OFFSET"

    echo "$query"
}

# Helper: format JSON output or pretty print
format_output() {
    local json="$1"
    local resource="${2:-item}"

    if [[ "$JSON_OUTPUT" == "true" ]]; then
        echo "$json"
    else
        echo "$json" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    resource = '$resource'

    def format_value(v):
        if isinstance(v, (dict, list)):
            return json.dumps(v, indent=2)
        return str(v) if v is not None else '-'

    if isinstance(data, dict):
        # Check if it's a list response
        if 'requests' in data or 'bugs' in data or 'ideas' in data or 'observations' in data:
            items = data.get('requests') or data.get('bugs') or data.get('ideas') or data.get('observations') or []
            total = data.get('total', len(items))
            print(f'Found {total} {resource}(s):')
            print()
            for item in items:
                id_field = next((k for k in ['requestId', 'bugId', 'ideaId', 'observationId'] if k in item), 'id')
                title_field = next((k for k in ['title', 'summary', 'content'] if k in item), None)
                print(f\"  {item.get(id_field, '-')}\")
                if title_field:
                    title = item.get(title_field, '')[:60]
                    print(f\"    {title}{'...' if len(item.get(title_field, '')) > 60 else ''}\")
                status = item.get('status', '-')
                created = item.get('createdAt', '-')[:10] if item.get('createdAt') else '-'
                print(f\"    Status: {status} | Created: {created}\")
                print()
        else:
            # Single item
            for k, v in data.items():
                print(f'{k}: {format_value(v)}')
    elif isinstance(data, list):
        for item in data:
            print('---')
            for k, v in item.items():
                print(f'  {k}: {format_value(v)}')
    else:
        print(data)
except Exception as e:
    print(f'Error formatting: {e}', file=sys.stderr)
    print(sys.stdin.read())
" 2>/dev/null || echo "$json"
    fi
}

# ============================================================================
# REQUEST COMMANDS
# ============================================================================

cmd_request() {
    local action="${1:-list}"
    shift || true

    case "$action" in
        list)
            request_list "$@"
            ;;
        get)
            request_get "$@"
            ;;
        create)
            request_create "$@"
            ;;
        update)
            request_update "$@"
            ;;
        approve)
            request_approve "$@"
            ;;
        reject)
            request_reject "$@"
            ;;
        assign)
            request_assign "$@"
            ;;
        complete)
            request_complete "$@"
            ;;
        stats)
            request_stats "$@"
            ;;
        *)
            echo "Usage: agency request <list|get|create|update|approve|reject|assign|complete|stats>"
            exit 1
            ;;
    esac
}

request_list() {
    local status="" principal="" workstream="" assignee=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --status=*) status="${1#*=}"; shift ;;
            --principal=*) principal="${1#*=}"; shift ;;
            --workstream=*) workstream="${1#*=}"; shift ;;
            --assignee=*) assignee="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local params=()
    [[ -n "$status" ]] && params+=("status=$status")
    [[ -n "$principal" ]] && params+=("principal=$principal")
    [[ -n "$workstream" ]] && params+=("workstream=$workstream")
    [[ -n "$assignee" ]] && params+=("assignee=$assignee")

    local query=$(build_query_string "${params[@]}")
    local response
    response=$(api_request GET "/request/list${query}")
    format_output "$response" "request"
}

request_get() {
    local request_id="${1:-}"
    if [[ -z "$request_id" ]]; then
        echo "Usage: agency request get <requestId>"
        exit 1
    fi

    local response
    response=$(api_request GET "/request/get/$request_id")
    format_output "$response" "request"
}

request_create() {
    local title="" summary="" principal="" workstream="" priority="Medium" reporter="" reporter_type=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --title=*) title="${1#*=}"; shift ;;
            --summary=*) summary="${1#*=}"; shift ;;
            --description=*) summary="${1#*=}"; shift ;;  # Alias for summary
            --principal=*) principal="${1#*=}"; shift ;;
            --workstream=*) workstream="${1#*=}"; shift ;;
            --priority=*) priority="${1#*=}"; shift ;;
            --reporter=*) reporter="${1#*=}"; shift ;;
            --reporter-type=*) reporter_type="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    if [[ -z "$title" || -z "$principal" ]]; then
        echo "Usage: agency request create --title=\"...\" --principal=... [--summary=...] [--workstream=...]"
        exit 1
    fi

    # Default summary to title if not provided
    if [[ -z "$summary" ]]; then
        summary="$title"
    fi

    # Default reporter to AGENCY_USER if not provided
    if [[ -z "$reporter" ]]; then
        reporter="${AGENCY_USER#*:}"
        reporter_type="${AGENCY_USER%%:*}"
    fi
    if [[ -z "$reporter_type" ]]; then
        reporter_type="principal"
    fi

    # Capitalize priority if needed
    case "$priority" in
        low|Low) priority="Low" ;;
        medium|Medium) priority="Medium" ;;
        high|High) priority="High" ;;
        critical|Critical) priority="Critical" ;;
    esac

    local data
    data=$(jq -n \
        --arg title "$title" \
        --arg summary "$summary" \
        --arg principal "$principal" \
        --arg priority "$priority" \
        --arg reporter_type "$reporter_type" \
        --arg reporter "$reporter" \
        --arg workstream "$workstream" \
        '{
            title: $title,
            summary: $summary,
            principalName: $principal,
            priority: $priority,
            reporterType: $reporter_type,
            reporterName: $reporter
        } + (if $workstream != "" then {workstream: $workstream} else {} end)')

    local response
    response=$(api_request POST "/request/create" "$data")
    echo -e "${GREEN}Request created${NC}"
    format_output "$response" "request"
}

request_update() {
    local request_id="${1:-}"
    shift || true

    if [[ -z "$request_id" ]]; then
        echo "Usage: agency request update <requestId> [--status=...] [--priority=...]"
        exit 1
    fi

    local status="" priority="" title="" description=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --status=*) status="${1#*=}"; shift ;;
            --priority=*) priority="${1#*=}"; shift ;;
            --title=*) title="${1#*=}"; shift ;;
            --description=*) description="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local data
    data=$(jq -n \
        --arg status "$status" \
        --arg priority "$priority" \
        --arg title "$title" \
        --arg description "$description" \
        '{}
        + (if $status != "" then {status: $status} else {} end)
        + (if $priority != "" then {priority: $priority} else {} end)
        + (if $title != "" then {title: $title} else {} end)
        + (if $description != "" then {summary: $description} else {} end)')

    local response
    response=$(api_request POST "/request/update/$request_id" "$data")
    echo -e "${GREEN}Request updated${NC}"
    format_output "$response" "request"
}

request_approve() {
    local request_id="${1:-}"
    if [[ -z "$request_id" ]]; then
        echo "Usage: agency request approve <requestId>"
        exit 1
    fi

    local response
    response=$(api_request POST "/request/approve/$request_id" "{}")
    echo -e "${GREEN}Request approved${NC}"
    format_output "$response" "request"
}

request_reject() {
    local request_id="${1:-}"
    shift || true

    if [[ -z "$request_id" ]]; then
        echo "Usage: agency request reject <requestId> [--reason=...]"
        exit 1
    fi

    local reason=""
    while [[ $# -gt 0 ]]; do
        case $1 in
            --reason=*) reason="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local data
    data=$(jq -n --arg reason "$reason" \
        'if $reason != "" then {reason: $reason} else {} end')

    local response
    response=$(api_request POST "/request/reject/$request_id" "$data")
    echo -e "${YELLOW}Request rejected${NC}"
    format_output "$response" "request"
}

request_assign() {
    local request_id="${1:-}"
    shift || true

    if [[ -z "$request_id" ]]; then
        echo "Usage: agency request assign <requestId> --agent=..."
        exit 1
    fi

    local agent=""
    while [[ $# -gt 0 ]]; do
        case $1 in
            --agent=*) agent="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    if [[ -z "$agent" ]]; then
        echo "Usage: agency request assign <requestId> --agent=..."
        exit 1
    fi

    local data
    data=$(jq -n --arg assignee "$agent" '{assigneeName: $assignee, assigneeType: "agent"}')

    local response
    response=$(api_request POST "/request/assign/$request_id" "$data")
    echo -e "${GREEN}Request assigned to $agent${NC}"
    format_output "$response" "request"
}

request_complete() {
    local request_id="${1:-}"
    if [[ -z "$request_id" ]]; then
        echo "Usage: agency request complete <requestId>"
        exit 1
    fi

    local response
    response=$(api_request POST "/request/complete/$request_id" "{}")
    echo -e "${GREEN}Request completed${NC}"
    format_output "$response" "request"
}

request_stats() {
    local response
    response=$(api_request GET "/request/stats")
    format_output "$response" "request"
}

# ============================================================================
# BUG COMMANDS
# ============================================================================

cmd_bug() {
    local action="${1:-list}"
    shift || true

    case "$action" in
        list)
            bug_list "$@"
            ;;
        get)
            bug_get "$@"
            ;;
        create)
            bug_create "$@"
            ;;
        update)
            bug_update "$@"
            ;;
        assign)
            bug_assign "$@"
            ;;
        resolve)
            bug_resolve "$@"
            ;;
        stats)
            bug_stats "$@"
            ;;
        *)
            echo "Usage: agency bug <list|get|create|update|assign|resolve|stats>"
            exit 1
            ;;
    esac
}

bug_list() {
    local status="" assignee="" workstream="" reporter="" tags=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --status=*) status="${1#*=}"; shift ;;
            --assignee=*) assignee="${1#*=}"; shift ;;
            --workstream=*) workstream="${1#*=}"; shift ;;
            --reporter=*) reporter="${1#*=}"; shift ;;
            --tags=*) tags="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local params=()
    [[ -n "$status" ]] && params+=("status=$status")
    [[ -n "$assignee" ]] && params+=("assignee=$assignee")
    [[ -n "$workstream" ]] && params+=("workstream=$workstream")
    [[ -n "$reporter" ]] && params+=("reporter=$reporter")
    [[ -n "$tags" ]] && params+=("tags=$tags")

    local query=$(build_query_string "${params[@]}")
    local response
    response=$(api_request GET "/bug/list${query}")
    format_output "$response" "bug"
}

bug_get() {
    local bug_id="${1:-}"
    if [[ -z "$bug_id" ]]; then
        echo "Usage: agency bug get <bugId>"
        exit 1
    fi

    local response
    response=$(api_request GET "/bug/get/$bug_id")
    format_output "$response" "bug"
}

bug_create() {
    local summary="" workstream="" reporter="" description="" tags=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --summary=*) summary="${1#*=}"; shift ;;
            --workstream=*) workstream="${1#*=}"; shift ;;
            --reporter=*) reporter="${1#*=}"; shift ;;
            --description=*) description="${1#*=}"; shift ;;
            --tags=*) tags="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    if [[ -z "$summary" || -z "$workstream" ]]; then
        echo "Usage: agency bug create --summary=\"...\" --workstream=..."
        exit 1
    fi

    local data
    data=$(jq -n \
        --arg summary "$summary" \
        --arg workstream "$workstream" \
        --arg reporter "$reporter" \
        --arg description "$description" \
        --arg tags "$tags" \
        '{
            summary: $summary,
            workstream: $workstream
        }
        + (if $reporter != "" then {reporterName: $reporter} else {} end)
        + (if $description != "" then {description: $description} else {} end)
        + (if $tags != "" then {tags: ($tags | split(",") | map(gsub("^\\s+|\\s+$"; "")))} else {} end)')

    local response
    response=$(api_request POST "/bug/create" "$data")
    echo -e "${GREEN}Bug created${NC}"
    format_output "$response" "bug"
}

bug_update() {
    local bug_id="${1:-}"
    shift || true

    if [[ -z "$bug_id" ]]; then
        echo "Usage: agency bug update <bugId> [--status=...] [--assignee=...]"
        exit 1
    fi

    local status="" assignee="" summary="" description="" tags=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --status=*) status="${1#*=}"; shift ;;
            --assignee=*) assignee="${1#*=}"; shift ;;
            --summary=*) summary="${1#*=}"; shift ;;
            --description=*) description="${1#*=}"; shift ;;
            --tags=*) tags="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local data
    data=$(jq -n \
        --arg status "$status" \
        --arg assignee "$assignee" \
        --arg summary "$summary" \
        --arg description "$description" \
        --arg tags "$tags" \
        '{}
        + (if $status != "" then {status: $status} else {} end)
        + (if $assignee != "" then {assigneeName: $assignee} else {} end)
        + (if $summary != "" then {summary: $summary} else {} end)
        + (if $description != "" then {description: $description} else {} end)
        + (if $tags != "" then {tags: ($tags | split(",") | map(gsub("^\\s+|\\s+$"; "")))} else {} end)')

    local response
    response=$(api_request POST "/bug/update/$bug_id" "$data")
    echo -e "${GREEN}Bug updated${NC}"
    format_output "$response" "bug"
}

bug_assign() {
    local bug_id="${1:-}"
    shift || true

    if [[ -z "$bug_id" ]]; then
        echo "Usage: agency bug assign <bugId> --assignee=..."
        exit 1
    fi

    local assignee=""
    while [[ $# -gt 0 ]]; do
        case $1 in
            --assignee=*) assignee="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    if [[ -z "$assignee" ]]; then
        echo "Usage: agency bug assign <bugId> --assignee=..."
        exit 1
    fi

    local data
    data=$(jq -n --arg assignee "$assignee" '{assigneeName: $assignee}')

    local response
    response=$(api_request POST "/bug/update/$bug_id" "$data")
    echo -e "${GREEN}Bug assigned to $assignee${NC}"
    format_output "$response" "bug"
}

bug_resolve() {
    local bug_id="${1:-}"
    shift || true

    if [[ -z "$bug_id" ]]; then
        echo "Usage: agency bug resolve <bugId> [--resolution=...]"
        exit 1
    fi

    local resolution=""
    while [[ $# -gt 0 ]]; do
        case $1 in
            --resolution=*) resolution="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local data
    data=$(jq -n --arg resolution "$resolution" \
        '{status: "Fixed"} + (if $resolution != "" then {resolution: $resolution} else {} end)')

    local response
    response=$(api_request POST "/bug/update/$bug_id" "$data")
    echo -e "${GREEN}Bug resolved${NC}"
    format_output "$response" "bug"
}

bug_stats() {
    local response
    response=$(api_request GET "/bug/stats")
    format_output "$response" "bug"
}

# ============================================================================
# IDEA COMMANDS
# ============================================================================

cmd_idea() {
    local action="${1:-list}"
    shift || true

    case "$action" in
        list)
            idea_list "$@"
            ;;
        get)
            idea_get "$@"
            ;;
        create)
            idea_create "$@"
            ;;
        update)
            idea_update "$@"
            ;;
        promote)
            idea_promote "$@"
            ;;
        explore)
            idea_explore "$@"
            ;;
        park)
            idea_park "$@"
            ;;
        discard)
            idea_discard "$@"
            ;;
        stats)
            idea_stats "$@"
            ;;
        *)
            echo "Usage: agency idea <list|get|create|update|promote|explore|park|discard|stats>"
            exit 1
            ;;
    esac
}

idea_list() {
    local status="" source="" tags=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --status=*) status="${1#*=}"; shift ;;
            --source=*) source="${1#*=}"; shift ;;
            --tags=*) tags="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local params=()
    [[ -n "$status" ]] && params+=("status=$status")
    [[ -n "$source" ]] && params+=("source=$source")
    [[ -n "$tags" ]] && params+=("tags=$tags")

    local query=$(build_query_string "${params[@]}")
    local response
    response=$(api_request GET "/idea/list${query}")
    format_output "$response" "idea"
}

idea_get() {
    local idea_id="${1:-}"
    if [[ -z "$idea_id" ]]; then
        echo "Usage: agency idea get <ideaId>"
        exit 1
    fi

    local response
    response=$(api_request GET "/idea/get/$idea_id")
    format_output "$response" "idea"
}

idea_create() {
    local title="" source="" source_type="agent" description="" tags=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --title=*) title="${1#*=}"; shift ;;
            --source=*) source="${1#*=}"; shift ;;
            --source-type=*) source_type="${1#*=}"; shift ;;
            --description=*) description="${1#*=}"; shift ;;
            --tags=*) tags="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    if [[ -z "$title" || -z "$source" ]]; then
        echo "Usage: agency idea create --title=\"...\" --source=..."
        exit 1
    fi

    local data
    data=$(jq -n \
        --arg title "$title" \
        --arg source "$source" \
        --arg source_type "$source_type" \
        --arg description "$description" \
        --arg tags "$tags" \
        '{
            title: $title,
            sourceName: $source,
            sourceType: $source_type,
            tags: (if $tags != "" then ($tags | split(",") | map(gsub("^\\s+|\\s+$"; ""))) else [] end)
        }
        + (if $description != "" then {description: $description} else {} end)')

    local response
    response=$(api_request POST "/idea/create" "$data")
    echo -e "${GREEN}Idea created${NC}"
    format_output "$response" "idea"
}

idea_update() {
    local idea_id="${1:-}"
    shift || true

    if [[ -z "$idea_id" ]]; then
        echo "Usage: agency idea update <ideaId> [--status=...] [--tags=...]"
        exit 1
    fi

    local status="" title="" description="" tags=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --status=*) status="${1#*=}"; shift ;;
            --title=*) title="${1#*=}"; shift ;;
            --description=*) description="${1#*=}"; shift ;;
            --tags=*) tags="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local data
    data=$(jq -n \
        --arg status "$status" \
        --arg title "$title" \
        --arg description "$description" \
        --arg tags "$tags" \
        '{}
        + (if $status != "" then {status: $status} else {} end)
        + (if $title != "" then {title: $title} else {} end)
        + (if $description != "" then {description: $description} else {} end)
        + (if $tags != "" then {tags: ($tags | split(",") | map(gsub("^\\s+|\\s+$"; "")))} else {} end)')

    local response
    response=$(api_request POST "/idea/update/$idea_id" "$data")
    echo -e "${GREEN}Idea updated${NC}"
    format_output "$response" "idea"
}

idea_promote() {
    local idea_id="${1:-}"
    shift || true

    if [[ -z "$idea_id" ]]; then
        echo "Usage: agency idea promote <ideaId> --request=..."
        exit 1
    fi

    local request=""
    while [[ $# -gt 0 ]]; do
        case $1 in
            --request=*) request="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    if [[ -z "$request" ]]; then
        echo "Usage: agency idea promote <ideaId> --request=..."
        exit 1
    fi

    local data
    data=$(jq -n --arg request "$request" '{requestId: $request}')

    local response
    response=$(api_request POST "/idea/promote/$idea_id" "$data")
    echo -e "${GREEN}Idea promoted to $request${NC}"
    format_output "$response" "idea"
}

idea_explore() {
    local idea_id="${1:-}"
    if [[ -z "$idea_id" ]]; then
        echo "Usage: agency idea explore <ideaId>"
        exit 1
    fi

    local response
    response=$(api_request POST "/idea/explore/$idea_id" "{}")
    echo -e "${CYAN}Idea marked for exploration${NC}"
    format_output "$response" "idea"
}

idea_park() {
    local idea_id="${1:-}"
    if [[ -z "$idea_id" ]]; then
        echo "Usage: agency idea park <ideaId>"
        exit 1
    fi

    local response
    response=$(api_request POST "/idea/park/$idea_id" "{}")
    echo -e "${YELLOW}Idea parked${NC}"
    format_output "$response" "idea"
}

idea_discard() {
    local idea_id="${1:-}"
    if [[ -z "$idea_id" ]]; then
        echo "Usage: agency idea discard <ideaId>"
        exit 1
    fi

    local response
    response=$(api_request POST "/idea/discard/$idea_id" "{}")
    echo -e "${RED}Idea discarded${NC}"
    format_output "$response" "idea"
}

idea_stats() {
    local response
    response=$(api_request GET "/idea/stats")
    format_output "$response" "idea"
}

# ============================================================================
# OBSERVATION COMMANDS
# ============================================================================

cmd_observation() {
    local action="${1:-list}"
    shift || true

    case "$action" in
        list)
            observation_list "$@"
            ;;
        get)
            observation_get "$@"
            ;;
        create)
            observation_create "$@"
            ;;
        update)
            observation_update "$@"
            ;;
        link)
            observation_link "$@"
            ;;
        archive)
            observation_archive "$@"
            ;;
        stats)
            observation_stats "$@"
            ;;
        *)
            echo "Usage: agency observation <list|get|create|update|link|archive|stats>"
            exit 1
            ;;
    esac
}

observation_list() {
    local type="" observer="" context="" tags=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --type=*) type="${1#*=}"; shift ;;
            --observer=*) observer="${1#*=}"; shift ;;
            --context=*) context="${1#*=}"; shift ;;
            --tags=*) tags="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local params=()
    [[ -n "$type" ]] && params+=("observationType=$type")
    [[ -n "$observer" ]] && params+=("observer=$observer")
    [[ -n "$context" ]] && params+=("context=$context")
    [[ -n "$tags" ]] && params+=("tags=$tags")

    local query=$(build_query_string "${params[@]}")
    local response
    response=$(api_request GET "/observation/list${query}")
    format_output "$response" "observation"
}

observation_get() {
    local observation_id="${1:-}"
    if [[ -z "$observation_id" ]]; then
        echo "Usage: agency observation get <observationId>"
        exit 1
    fi

    local response
    response=$(api_request GET "/observation/get/$observation_id")
    format_output "$response" "observation"
}

observation_create() {
    local title="" summary="" category="note" reporter="" reporter_type="agent" context="" tags="" workstream=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --title=*) title="${1#*=}"; shift ;;
            --summary=*) summary="${1#*=}"; shift ;;
            --content=*) summary="${1#*=}"; shift ;;  # Alias for summary
            --category=*) category="${1#*=}"; shift ;;
            --type=*) category="${1#*=}"; shift ;;  # Alias for category
            --reporter=*) reporter="${1#*=}"; shift ;;
            --reporter-type=*) reporter_type="${1#*=}"; shift ;;
            --context=*) context="${1#*=}"; shift ;;
            --workstream=*) workstream="${1#*=}"; shift ;;
            --tags=*) tags="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    if [[ -z "$summary" ]]; then
        echo "Usage: agency observation create --summary=\"...\" [--title=...] [--category=...]"
        exit 1
    fi

    # Default title to first 50 chars of summary if not provided
    if [[ -z "$title" ]]; then
        title="${summary:0:50}"
    fi

    # Default reporter to AGENCY_USER if not provided
    if [[ -z "$reporter" ]]; then
        reporter="${AGENCY_USER#*:}"  # Extract name part from 'type:name'
        reporter_type="${AGENCY_USER%%:*}"  # Extract type part
    fi

    local data
    data=$(jq -n \
        --arg title "$title" \
        --arg summary "$summary" \
        --arg category "$category" \
        --arg reporter_type "$reporter_type" \
        --arg reporter "$reporter" \
        --arg context "$context" \
        --arg workstream "$workstream" \
        --arg tags "$tags" \
        '{
            title: $title,
            summary: $summary,
            category: $category,
            reporterType: $reporter_type,
            reporterName: $reporter,
            tags: (if $tags != "" then ($tags | split(",") | map(gsub("^\\s+|\\s+$"; ""))) else [] end)
        }
        + (if $context != "" then {contextPath: $context} else {} end)
        + (if $workstream != "" then {workstream: $workstream} else {} end)')

    local response
    response=$(api_request POST "/observation/create" "$data")
    echo -e "${GREEN}Observation created${NC}"
    format_output "$response" "observation"
}

observation_update() {
    local observation_id="${1:-}"
    shift || true

    if [[ -z "$observation_id" ]]; then
        echo "Usage: agency observation update <observationId> [--content=...] [--tags=...]"
        exit 1
    fi

    local content="" tags=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --content=*) content="${1#*=}"; shift ;;
            --tags=*) tags="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local data
    data=$(jq -n \
        --arg content "$content" \
        --arg tags "$tags" \
        '{}
        + (if $content != "" then {summary: $content} else {} end)
        + (if $tags != "" then {tags: ($tags | split(",") | map(gsub("^\\s+|\\s+$"; "")))} else {} end)')

    local response
    response=$(api_request POST "/observation/update/$observation_id" "$data")
    echo -e "${GREEN}Observation updated${NC}"
    format_output "$response" "observation"
}

observation_link() {
    local observation_id="${1:-}"
    shift || true

    if [[ -z "$observation_id" ]]; then
        echo "Usage: agency observation link <observationId> --request=... | --bug=... | --idea=..."
        exit 1
    fi

    local request="" bug="" idea=""
    while [[ $# -gt 0 ]]; do
        case $1 in
            --request=*) request="${1#*=}"; shift ;;
            --bug=*) bug="${1#*=}"; shift ;;
            --idea=*) idea="${1#*=}"; shift ;;
            *) shift ;;
        esac
    done

    local link_type="" link_id=""
    if [[ -n "$request" ]]; then
        link_type="request"
        link_id="$request"
    elif [[ -n "$bug" ]]; then
        link_type="bug"
        link_id="$bug"
    elif [[ -n "$idea" ]]; then
        link_type="idea"
        link_id="$idea"
    else
        echo "Usage: agency observation link <observationId> --request=... | --bug=... | --idea=..."
        exit 1
    fi

    local data
    data=$(jq -n --arg link_type "$link_type" --arg link_id "$link_id" \
        '{linkType: $link_type, linkId: $link_id}')

    local response
    response=$(api_request POST "/observation/link/$observation_id" "$data")
    echo -e "${GREEN}Observation linked to $link_type $link_id${NC}"
    format_output "$response" "observation"
}

observation_archive() {
    local observation_id="${1:-}"
    if [[ -z "$observation_id" ]]; then
        echo "Usage: agency observation archive <observationId>"
        exit 1
    fi

    local response
    response=$(api_request POST "/observation/archive/$observation_id" "{}")
    echo -e "${YELLOW}Observation archived${NC}"
    format_output "$response" "observation"
}

observation_stats() {
    local response
    response=$(api_request GET "/observation/stats")
    format_output "$response" "observation"
}

# ============================================================================
# MAIN DISPATCH
# ============================================================================

# Parse global options
parse_global_options "$@"
set -- "${REMAINING_ARGS[@]}"

RESOURCE="${1:-}"
shift || true

case "$RESOURCE" in
    request|req|r)
        cmd_request "$@"
        ;;
    bug|b)
        cmd_bug "$@"
        ;;
    idea|i)
        cmd_idea "$@"
        ;;
    observation|obs|o)
        cmd_observation "$@"
        ;;
    ""|help|--help|-h)
        head -70 "$0" | tail -69 | sed 's/^# //' | sed 's/^#//'
        ;;
    --version|-v)
        echo "agency $TOOL_VERSION"
        ;;
    *)
        echo -e "${RED}Unknown resource: $RESOURCE${NC}"
        echo "Use: ./tools/agency --help"
        echo "Resources: request, bug, idea, observation"
        exit 1
        ;;
esac
