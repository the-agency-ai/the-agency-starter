#!/bin/bash
# Tool: resolve-nit
# Purpose: Mark a nit as addressed with resolution details
# Usage: ./tools/resolve-nit AGENTNIT-#### "Resolution description"
# Example: ./tools/resolve-nit AGENTNIT-0005 "Created ./tools/collaborate script"

set -e

# Find repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_ROOT"

# Auto-load .env.local if it exists
if [[ -f ".env.local" ]]; then
  set -a
  source .env.local
  set +a
fi

NITS_FILE="claude/workstream-agent-nits.md"

# Validate arguments
if [[ $# -lt 2 ]]; then
  echo "Usage: ./tools/resolve-nit AGENTNIT-#### \"Resolution description\""
  echo "Example: ./tools/resolve-nit AGENTNIT-0005 \"Created ./tools/collaborate script\""
  exit 1
fi

NIT_ID="$1"
RESOLUTION="$2"

# Normalize NIT ID format (accept with or without AGENTNIT- prefix)
if [[ ! "$NIT_ID" =~ ^AGENTNIT- ]]; then
  NIT_ID="AGENTNIT-$NIT_ID"
fi

# Get current timestamp
TIMESTAMP=$("$SCRIPT_DIR/now" 2>/dev/null || date "+%Y-%m-%d %H:%M:%S %Z")
DATE=$(echo "$TIMESTAMP" | cut -d' ' -f1)

# Get agent name for attribution
AGENTNAME=$("$SCRIPT_DIR/agentname" 2>/dev/null || echo "unknown")
COMMIT_PREFIX=$("$SCRIPT_DIR/commit-prefix" 2>/dev/null || echo "unknown/unknown:")

# Function to handle merge conflicts
handle_merge_conflict() {
  echo "Merge conflict detected. Accepting remote and re-applying resolution..."
  git checkout --theirs "$NITS_FILE"
  git add "$NITS_FILE"
  return 0
}

# Step 1: Pull latest
echo "Pulling latest changes..."
git pull --rebase 2>/dev/null || {
  git rebase --abort 2>/dev/null || true
  git pull || {
    if git diff --name-only --diff-filter=U | grep -q "$NITS_FILE"; then
      handle_merge_conflict
    fi
  }
}

# Step 2: Verify the NIT exists
if ! grep -q "^\*\*$NIT_ID\*\*:" "$NITS_FILE"; then
  echo "Error: $NIT_ID not found in $NITS_FILE"
  echo ""
  echo "Available NITs:"
  grep -oE '\*\*AGENTNIT-[0-9]+\*\*' "$NITS_FILE" | tr -d '*' | sort -u
  exit 1
fi

# Step 3: Check if already addressed
if grep -A5 "^\*\*$NIT_ID\*\*:" "$NITS_FILE" | grep -q "Status:\*\* Addressed"; then
  echo "Warning: $NIT_ID is already marked as Addressed"
  echo "Updating resolution anyway..."
fi

# Step 4: Update the status line
# Find the line with Status: Open and replace it with Addressed + resolution
# This is complex in bash, so we use a temp file approach

TMP_FILE=$(mktemp)
FOUND=0
IN_NIT_BLOCK=0

while IFS= read -r line; do
  # Check if we're entering the target NIT block
  if [[ "$line" =~ ^\*\*$NIT_ID\*\*: ]]; then
    IN_NIT_BLOCK=1
    echo "$line" >> "$TMP_FILE"
    continue
  fi

  # Check if we're leaving the NIT block (next NIT or new section)
  if [[ $IN_NIT_BLOCK -eq 1 ]] && [[ "$line" =~ ^\*\*AGENTNIT- || "$line" =~ ^## || "$line" =~ ^### ]]; then
    IN_NIT_BLOCK=0
  fi

  # If we're in the target NIT block and find Status line
  if [[ $IN_NIT_BLOCK -eq 1 ]] && [[ "$line" =~ ^-\ \*\*Status:\*\* ]]; then
    # Replace with Addressed status
    echo "- **Status:** Addressed" >> "$TMP_FILE"
    echo "- **Resolution:** $RESOLUTION" >> "$TMP_FILE"
    echo "- **Resolved by:** $AGENTNAME" >> "$TMP_FILE"
    echo "- **Resolved date:** $DATE" >> "$TMP_FILE"
    FOUND=1
    continue
  fi

  # Skip old resolution lines if re-resolving
  if [[ $IN_NIT_BLOCK -eq 1 ]] && [[ "$line" =~ ^-\ \*\*Resolution:\*\* ]]; then
    continue
  fi
  if [[ $IN_NIT_BLOCK -eq 1 ]] && [[ "$line" =~ ^-\ \*\*Resolved\ by:\*\* ]]; then
    continue
  fi
  if [[ $IN_NIT_BLOCK -eq 1 ]] && [[ "$line" =~ ^-\ \*\*Resolved\ date:\*\* ]]; then
    continue
  fi

  echo "$line" >> "$TMP_FILE"
done < "$NITS_FILE"

if [[ $FOUND -eq 0 ]]; then
  echo "Error: Could not find Status line for $NIT_ID"
  rm -f "$TMP_FILE"
  exit 1
fi

# Step 5: Replace original file
mv "$TMP_FILE" "$NITS_FILE"

echo "Marked $NIT_ID as Addressed"

# Step 6: Stage and commit
git add "$NITS_FILE"
COMMIT_MSG="$COMMIT_PREFIX chore: resolve $NIT_ID

Resolution: $RESOLUTION
Resolved by: $AGENTNAME

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

git commit -m "$COMMIT_MSG

[skip ci]" || {
  echo "Nothing to commit"
  exit 0
}

# Step 7: Push using sync tool
echo "Syncing changes..."
"$SCRIPT_DIR/sync" || {
  echo "Sync failed"
  exit 1
}

echo ""
echo "Successfully resolved nit:"
echo "  ID: $NIT_ID"
echo "  Resolution: $RESOLUTION"
echo "  Resolved by: $AGENTNAME"
echo "  File: $NITS_FILE"
