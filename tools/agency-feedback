#!/bin/bash
# Agency Feedback Tool
# Captures feedback for the-agency-starter framework
#
# Usage: ./tools/agency-feedback "title" "description"
#
# Creates a GitHub issue on the-agency-starter repo with structured feedback.
# If GitHub access unavailable, saves locally to claude/feedback/

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "agency-feedback" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.1-20260114-000008"

# Defaults
VERBOSE=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Parse arguments
TITLE=""
DESCRIPTION=""

for arg in "$@"; do
    case $arg in
        --version|-v)
            echo "agency-feedback $TOOL_VERSION"
            exit 0
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help|-h)
            echo "agency-feedback - Submit feedback to the-agency-starter"
            echo ""
            echo "Usage: ./tools/agency-feedback \"title\" \"description\""
            echo ""
            echo "Examples:"
            echo "  ./tools/agency-feedback \"Need tool for X\" \"When doing Y, I needed Z\""
            echo "  ./tools/agency-feedback \"Docs gap: hooks\" \"The hooks documentation doesn't cover...\""
            echo ""
            echo "Options:"
            echo "  --verbose      Show verbose output"
            echo "  --version, -v  Show tool version"
            echo "  --help, -h     Show this help"
            exit 0
            ;;
        *)
            if [ -z "$TITLE" ]; then
                TITLE="$arg"
            elif [ -z "$DESCRIPTION" ]; then
                DESCRIPTION="$arg"
            fi
            ;;
    esac
done

main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "agency-feedback [run: ${RUN_ID:-none}]"

    if [ -z "$TITLE" ]; then
        log_error "Title required"
        echo ""
        echo "Usage: ./tools/agency-feedback \"title\" \"description\""
        echo ""
        echo "Examples:"
        echo "  ./tools/agency-feedback \"Need tool for X\" \"When doing Y, I needed Z\""
        echo "  ./tools/agency-feedback \"Docs gap: hooks\" \"The hooks documentation doesn't cover...\""
        trap - EXIT
        log_end "$RUN_ID" "failure" 1 0 "Title required"
        exit 1
    fi

    # Get agent context if available
    AGENT="${AGENTNAME:-unknown}"
    WORKSTREAM_NAME="${WORKSTREAM:-unknown}"
    PROJECT_DIR="$(pwd)"
    AGENCY_ROOT="$(dirname "$SCRIPT_DIR")"

    # Build the issue body
    BODY="## Feedback from Agent

**Agent:** ${AGENT}
**Workstream:** ${WORKSTREAM_NAME}
**Project:** ${PROJECT_DIR}
**Date:** $(date '+%Y-%m-%d %H:%M %Z')

## Description

${DESCRIPTION:-No description provided.}

## Context

This feedback was captured during active development using The Agency multi-agent framework.

---
*Submitted via \`./tools/agency-feedback\`*"

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  Agency Feedback"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "  Title: ${TITLE}"
    echo "  Agent: ${AGENT}"
    echo "  Project: ${PROJECT_DIR}"
    echo ""

    # Check if gh is available and authenticated
    if ! command -v gh &> /dev/null; then
        log_warn "GitHub CLI not installed"
        echo "  Saving feedback locally instead..."

        FEEDBACK_DIR="${AGENCY_ROOT}/claude/feedback"
        mkdir -p "$FEEDBACK_DIR"

        FEEDBACK_FILE="${FEEDBACK_DIR}/$(date '+%Y%m%d-%H%M%S')-${AGENT}.md"
        echo "# Feedback: ${TITLE}" > "$FEEDBACK_FILE"
        echo "" >> "$FEEDBACK_FILE"
        echo "$BODY" >> "$FEEDBACK_FILE"

        echo "  Saved to: ${FEEDBACK_FILE}"
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "Feedback saved locally"
        exit 0
    fi

    # Try to create the issue
    if gh issue create --repo jordandm/the-agency-starter \
        --title "Feedback: ${TITLE}" \
        --body "$BODY" \
        --label "feedback" 2>/dev/null; then
        echo "  ✓ Issue created on the-agency-starter"
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "Feedback submitted to GitHub"
    else
        # Fallback: save locally if repo doesn't exist or no access
        log_warn "Could not create GitHub issue"
        echo "  Saving feedback locally instead..."

        FEEDBACK_DIR="${AGENCY_ROOT}/claude/feedback"
        mkdir -p "$FEEDBACK_DIR"

        FEEDBACK_FILE="${FEEDBACK_DIR}/$(date '+%Y%m%d-%H%M%S')-${AGENT}.md"
        echo "# Feedback: ${TITLE}" > "$FEEDBACK_FILE"
        echo "" >> "$FEEDBACK_FILE"
        echo "$BODY" >> "$FEEDBACK_FILE"

        echo "  Saved to: ${FEEDBACK_FILE}"
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "Feedback saved locally (GitHub unavailable)"
    fi

    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
}

main
