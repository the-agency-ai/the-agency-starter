#!/bin/bash
# Mark an instruction as completed with outcome summary
#
# Usage:
#   complete-instruction INSTR-0001 "What was done"
#   complete-instruction 1 "Created tools, updated docs"
#
# This updates the instruction file:
# - Changes Status to Completed
# - Fills in the Outcome section
# - Adds completion date and agent

set -e

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "complete-instruction $TOOL_VERSION"
    exit 0
fi

# Find repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

PRINCIPALS_DIR="$REPO_ROOT/claude/principals"

if [[ $# -lt 2 ]]; then
  echo "Usage: complete-instruction INSTR-#### \"What was done\""
  echo "       complete-instruction #### \"Outcome summary\""
  exit 1
fi

# Normalize instruction ID
INSTR_ID="$1"
OUTCOME="$2"

# Strip INSTR- prefix if present
INSTR_ID="${INSTR_ID#INSTR-}"
# Pad to 4 digits
INSTR_NUM=$(printf "%04d" "$INSTR_ID" 2>/dev/null || echo "$INSTR_ID")

# Get agent info
AGENT_WS="${WORKSTREAM:-unknown}"
AGENT_NAME="${AGENTNAME:-unknown}"

# Get timezone from config or default to UTC
TIMEZONE=$("$SCRIPT_DIR/config" get project.timezone 2>/dev/null || echo "UTC")
TIMESTAMP=$(TZ="$TIMEZONE" date '+%Y-%m-%d %H:%M %Z')

# Search for instruction file
FOUND_FILE=""
for principal_dir in "$PRINCIPALS_DIR"/*/; do
  MATCH=$(find "$principal_dir/instructions" -name "INSTR-${INSTR_NUM}-*.md" 2>/dev/null | head -1)
  if [[ -n "$MATCH" ]]; then
    FOUND_FILE="$MATCH"
    break
  fi
done

if [[ -z "$FOUND_FILE" ]]; then
  echo "Error: Instruction INSTR-$INSTR_NUM not found"
  exit 1
fi

echo "Completing: INSTR-$INSTR_NUM"
echo "  File: $FOUND_FILE"

# Update status
sed -i '' 's/\*\*Status:\*\* Active/\*\*Status:\*\* Completed/' "$FOUND_FILE"

# Update outcome section
# Find the line with "**Completed:** (pending)" and replace it
sed -i '' "s/\*\*Completed:\*\* (pending)/\*\*Completed:\*\* $TIMESTAMP/" "$FOUND_FILE"

# Find the line with "**By:**" and ensure it has the agent
sed -i '' "s/\*\*By:\*\* .*/\*\*By:\*\* $AGENT_WS\/$AGENT_NAME/" "$FOUND_FILE"

# Add outcome text after "(To be filled when instruction is completed)"
# Using Python for reliable multiline handling
python3 - "$FOUND_FILE" "$OUTCOME" << 'PYTHON_EOF'
import sys

filepath = sys.argv[1]
outcome = sys.argv[2]

with open(filepath, 'r') as f:
    content = f.read()

# Replace the placeholder text with actual outcome
placeholder = "(To be filled when instruction is completed)"
if placeholder in content:
    content = content.replace(placeholder, outcome)

with open(filepath, 'w') as f:
    f.write(content)
PYTHON_EOF

echo ""
echo "âœ… Instruction INSTR-$INSTR_NUM marked as Completed"
echo "   Completed by: $AGENT_WS/$AGENT_NAME"
echo "   Completed at: $TIMESTAMP"
echo ""
echo "Don't forget to update the Artifacts section with links to PRs, files, etc."

# Update the instructions index
"$SCRIPT_DIR/update-instruction-index" > /dev/null 2>&1 || true
