#!/bin/bash
# figma-diff - Visual comparison between Figma mockup and deployed implementation
#
# Usage:
#   ./tools/figma-diff <mockup-path> <url> [--viewport=<width>x<height>]
#   ./tools/figma-diff source/home-desktop.png http://localhost:3000 --viewport=1440x900
#
# This tool:
#   1. Screenshots the deployed URL at specified viewport
#   2. Loads the Figma mockup image
#   3. Generates a visual comparison report
#   4. Outputs side-by-side comparison

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source log helper for tool tracking
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

# Start logging
RUN_ID=$(log_start "figma-diff" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260114-000003"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Defaults
VERBOSE=false

# Help
show_help() {
    echo "figma-diff - Visual comparison between mockup and implementation"
    echo ""
    echo "Usage:"
    echo "  ./tools/figma-diff <mockup-path> <url> [options]"
    echo ""
    echo "Arguments:"
    echo "  mockup-path  Path to Figma mockup image (PNG)"
    echo "  url          URL to screenshot and compare"
    echo ""
    echo "Options:"
    echo "  --viewport=<WxH>   Viewport size (default: 1440x900)"
    echo "  --output=<dir>     Output directory (default: claude/data/figma-diffs/)"
    echo "  --help, -h         Show this help"
    echo "  --version, -v      Show version"
    echo "  --verbose          Enable verbose logging"
    echo ""
    echo "Examples:"
    echo "  ./tools/figma-diff mockup.png http://localhost:3000"
    echo "  ./tools/figma-diff home-desktop.png http://localhost:3000 --viewport=1920x1080"
    echo ""
    echo "Dependencies:"
    echo "  - Puppeteer/Playwright for screenshots (via ./tools/browser)"
    echo "  - ImageMagick for image comparison (optional)"
}

# Parse arguments
MOCKUP_PATH=""
URL=""
VIEWPORT="1440x900"
OUTPUT_DIR="$PROJECT_ROOT/claude/data/figma-diffs"

for arg in "$@"; do
    case $arg in
        --help|-h)
            show_help
            exit 0
            ;;
        --version|-v)
            echo "figma-diff $TOOL_VERSION"
            exit 0
            ;;
        --viewport=*)
            VIEWPORT="${arg#*=}"
            ;;
        --output=*)
            OUTPUT_DIR="${arg#*=}"
            ;;
        --verbose)
            VERBOSE=true
            ;;
        --*)
            log_error "Unknown option: $arg"
            exit 1
            ;;
        *)
            if [[ -z "$MOCKUP_PATH" ]]; then
                MOCKUP_PATH="$arg"
            elif [[ -z "$URL" ]]; then
                URL="$arg"
            fi
            ;;
    esac
done

# Validate arguments
if [[ -z "$MOCKUP_PATH" ]]; then
    log_error "Missing required argument: mockup-path"
    echo ""
    show_help
    exit 1
fi

if [[ -z "$URL" ]]; then
    log_error "Missing required argument: url"
    echo ""
    show_help
    exit 1
fi

# Check mockup exists
if [[ ! -f "$MOCKUP_PATH" ]]; then
    log_error "Mockup file not found: $MOCKUP_PATH"
    exit 1
fi

# Parse viewport
VIEWPORT_WIDTH=$(echo "$VIEWPORT" | cut -d'x' -f1)
VIEWPORT_HEIGHT=$(echo "$VIEWPORT" | cut -d'x' -f2)

if [[ -z "$VIEWPORT_WIDTH" || -z "$VIEWPORT_HEIGHT" ]]; then
    log_error "Invalid viewport format. Use WIDTHxHEIGHT (e.g., 1440x900)"
    exit 1
fi

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Generate timestamp for this comparison
TIMESTAMP=$(date '+%Y-%m-%d-%H%M%S')
COMPARISON_DIR="$OUTPUT_DIR/$TIMESTAMP"
mkdir -p "$COMPARISON_DIR"

main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    echo "figma-diff [run: ${RUN_ID:-none}]"
    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  Figma Visual Diff${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "  Mockup:    $MOCKUP_PATH"
    echo "  URL:       $URL"
    echo "  Viewport:  ${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}"
    echo "  Output:    $COMPARISON_DIR/"
    echo ""

# Copy mockup to comparison directory
log_step "Copying mockup..."
cp "$MOCKUP_PATH" "$COMPARISON_DIR/mockup.png"
log_info "Mockup copied"

# Take screenshot of URL
log_step "Taking screenshot of $URL..."

SCREENSHOT_PATH="$COMPARISON_DIR/screenshot.png"

# Check if browser tool exists
if [[ -x "$PROJECT_ROOT/tools/browser" ]]; then
    # Use browser tool if available
    "$PROJECT_ROOT/tools/browser" screenshot "$URL" \
        --output="$SCREENSHOT_PATH" \
        --viewport="${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}" 2>/dev/null || {
        log_warn "Browser tool screenshot failed, trying fallback..."
        # Fallback to curl for basic URL check
        if curl -s -o /dev/null -w "%{http_code}" "$URL" | grep -q "200"; then
            log_warn "URL is accessible but screenshot requires browser tool"
            echo "Manual screenshot required. Please:"
            echo "  1. Open $URL in browser"
            echo "  2. Set viewport to ${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}"
            echo "  3. Take screenshot"
            echo "  4. Save to $SCREENSHOT_PATH"
        else
            log_error "URL not accessible: $URL"
        fi
    }
else
    log_warn "Browser tool not available at $PROJECT_ROOT/tools/browser"
    echo ""
    echo "To take screenshot manually:"
    echo "  1. Open $URL in browser"
    echo "  2. Set viewport to ${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}"
    echo "  3. Take screenshot and save to: $SCREENSHOT_PATH"
    echo ""

    # Try to check if URL is at least accessible
    if command -v curl &> /dev/null; then
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL" 2>/dev/null || echo "000")
        if [[ "$HTTP_CODE" == "200" ]]; then
            log_info "URL is accessible (HTTP $HTTP_CODE)"
        else
            log_warn "URL returned HTTP $HTTP_CODE"
        fi
    fi
fi

# Generate comparison report
log_step "Generating comparison report..."

REPORT_PATH="$COMPARISON_DIR/report.md"
cat > "$REPORT_PATH" << EOF
# Visual Diff Report

Generated: $(date '+%Y-%m-%d %H:%M:%S')

## Comparison Details

| Property | Value |
|----------|-------|
| Mockup | $(basename "$MOCKUP_PATH") |
| URL | $URL |
| Viewport | ${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT} |

## Files

| File | Description |
|------|-------------|
| [mockup.png](mockup.png) | Original Figma mockup |
| [screenshot.png](screenshot.png) | Implementation screenshot |

## Visual Comparison

### Mockup
![Mockup](mockup.png)

### Implementation
![Screenshot](screenshot.png)

## Manual Comparison Checklist

### Layout
- [ ] Header height matches
- [ ] Content width matches
- [ ] Spacing between sections matches
- [ ] Footer position matches

### Colors
- [ ] Background colors match
- [ ] Text colors match
- [ ] Accent colors match
- [ ] Hover states match (if applicable)

### Typography
- [ ] Font families match
- [ ] Font sizes match
- [ ] Font weights match
- [ ] Line heights match
- [ ] Letter spacing matches

### Spacing
- [ ] Padding matches
- [ ] Margins match
- [ ] Gap between elements matches

### Components
- [ ] Buttons match
- [ ] Cards match
- [ ] Navigation matches
- [ ] Forms match (if applicable)

## Issues Found

| Issue | Expected | Actual | Severity |
|-------|----------|--------|----------|
| (Fill in after comparison) | | | |

## Recommendations

1. Review each checkbox above
2. Document any issues in the table
3. Update components to match design
4. Re-run comparison after fixes

---

*Generated by figma-diff v$TOOL_VERSION*
EOF

# Check if ImageMagick is available for automated diff
if command -v compare &> /dev/null && [[ -f "$SCREENSHOT_PATH" ]]; then
    log_step "Generating pixel diff (ImageMagick)..."

    DIFF_PATH="$COMPARISON_DIR/diff.png"

    # Generate difference image
    compare -metric AE \
        "$COMPARISON_DIR/mockup.png" \
        "$SCREENSHOT_PATH" \
        "$DIFF_PATH" 2>&1 | head -1 || {
        log_warn "Pixel diff generation failed (images may be different sizes)"
    }

    if [[ -f "$DIFF_PATH" ]]; then
        log_info "Pixel diff generated: diff.png"

        # Add to report
        cat >> "$REPORT_PATH" << EOF

## Automated Pixel Diff

![Diff](diff.png)

*Red areas indicate differences between mockup and implementation.*
EOF
    fi
else
    if [[ ! -f "$SCREENSHOT_PATH" ]]; then
        log_warn "Screenshot not available - manual screenshot needed"
    elif ! command -v compare &> /dev/null; then
        log_warn "ImageMagick not installed - pixel diff not generated"
        echo ""
        echo "To enable automated pixel diff:"
        echo "  brew install imagemagick"
    fi
fi

    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  Comparison Complete${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Output: $COMPARISON_DIR/"
    echo ""
    echo "Files:"
    ls -la "$COMPARISON_DIR/" | grep -v "^d" | grep -v "^total" | awk '{print "  " $NF}'
    echo ""
    echo "Next steps:"
    echo "  1. Review report: $REPORT_PATH"
    echo "  2. Compare images side-by-side"
    echo "  3. Document issues in report"
    echo "  4. Fix implementation"
    echo "  5. Re-run comparison"
    echo ""

    trap - EXIT  # Clear trap
    log_end "$RUN_ID" "success" "0" "0" "Comparison generated" 2>/dev/null || true
}

main
