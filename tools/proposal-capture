#!/bin/bash
# Tool: proposal-capture
# Purpose: Create a new proposal for discussion/definition
# Usage: ./tools/proposal-capture -t "Title" [-p project] [-w workstream]

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "proposal-capture" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260114-000009"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "proposal-capture $TOOL_VERSION"
    exit 0
fi

# Find repo root
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_ROOT"

# Defaults
VERBOSE=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Help
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    cat << 'EOF'
Usage: proposal-capture -t "Title" [-p project] [-w workstream] [-s status] [--verbose]

Options:
  -t, --title       Proposal title (required)
  -p, --project     Project name (default: agency)
  -w, --workstream  Workstream name (alternative to project)
  -s, --status      Initial status (default: draft)
  -P, --priority    Priority: high, medium, low (default: medium)
  --verbose         Show detailed logging
  -h, --help        Show this help

Examples:
  proposal-capture -t "Tool Ecosystem" -p agency
  proposal-capture -t "New Feature" -w web
  proposal-capture -t "Context Stack" -p agency -P high

Status lifecycle:
  draft → discussing → defined → approved → implementing → completed
EOF
    exit 0
fi

# Parse args
TITLE=""
PROJECT="agency"
WORKSTREAM=""
STATUS="draft"
PRIORITY="medium"

while [[ $# -gt 0 ]]; do
    case $1 in
        -t|--title) TITLE="$2"; shift 2 ;;
        -p|--project) PROJECT="$2"; WORKSTREAM=""; shift 2 ;;
        -w|--workstream) WORKSTREAM="$2"; PROJECT=""; shift 2 ;;
        -s|--status) STATUS="$2"; shift 2 ;;
        -P|--priority) PRIORITY="$2"; shift 2 ;;
        --verbose) VERBOSE=true; shift ;;
        *) shift ;;
    esac
done

# Main function
main() {
  # Trap unexpected exits
  trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

  echo "proposal-capture [run: ${RUN_ID:-none}]"

  if [[ -z "$TITLE" ]]; then
    log_error "Title is required (-t \"Title\")"
    trap - EXIT
    log_end "$RUN_ID" "failure" 1 0 "Missing required argument: title"
    exit 1
  fi

  # Determine directory
  if [[ -n "$WORKSTREAM" ]]; then
    PROP_DIR="$REPO_ROOT/claude/proposals/workstreams/$WORKSTREAM"
    PROP_PREFIX="PROP-WS-$(echo "$WORKSTREAM" | tr '[:lower:]' '[:upper:]')"
  else
    PROP_DIR="$REPO_ROOT/claude/proposals/projects/$PROJECT"
    PROP_PREFIX="PROP-PROJ-$(echo "$PROJECT" | tr '[:lower:]' '[:upper:]')"
  fi

  mkdir -p "$PROP_DIR"

  # Get next number
  NEXT_NUM=1
  if [[ -f "$PROP_DIR/.prop-counter" ]]; then
    NEXT_NUM=$(($(cat "$PROP_DIR/.prop-counter") + 1))
  fi
  echo "$NEXT_NUM" > "$PROP_DIR/.prop-counter"

  # Format number
  NUM_PADDED=$(printf "%04d" "$NEXT_NUM")

  # Create short name from title
  SHORT_NAME=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-' | cut -c1-40)

  # Full ID and filename
  PROP_ID="PROP-$NUM_PADDED"
  FILENAME="$PROP_ID-$SHORT_NAME.md"
  FILEPATH="$PROP_DIR/$FILENAME"

  # Get current date
  DATE=$(date +"%Y-%m-%d")

  # Create proposal file
  cat > "$FILEPATH" << EOF
# $PROP_ID: $TITLE

**Status:** $STATUS
**Priority:** $PRIORITY
**Created:** $DATE
**Author:** $(whoami)
**Project:** ${PROJECT:-$WORKSTREAM}

## Problem

What problem does this solve?

(Fill in)

## Proposal

What's the proposed solution?

(Fill in)

## Key Points

- Point 1
- Point 2

## Open Questions

- [ ] Question 1?
- [ ] Question 2?

## Dependencies

- Related proposals: (none yet)
- Related INSTRs: (none yet)

## When Approved

- Becomes: INSTR-XXXX
- Assigned to: (TBD)
- Target: (TBD)

---

## Discussion Log

### $DATE - Created
Initial proposal created.
EOF

  echo ""
  echo "Proposal ready: $PROP_ID"
  echo "  File: $FILEPATH"
  echo "  Status: $STATUS"
  echo "  Priority: $PRIORITY"

  # Open in editor if available
  if command -v code &> /dev/null; then
    verbose_echo "Opening in editor: code"
    code "$FILEPATH"
  fi

  trap - EXIT
  log_end "$RUN_ID" "success" 0 0 "Created $PROP_ID"
}

main
