#!/usr/bin/env bash
#
# migrate-secrets - Copy existing secrets to the Secret Service vault
#
# Usage: ./tools/migrate-secrets [--dry-run]
#
# This script:
# 1. Initializes the vault (if not already initialized)
# 2. Copies secrets from claude/principals/jordan/resources/secrets/*.env
# 3. Preserves originals in place
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Config
SECRET_SERVICE_URL="${SECRET_SERVICE_URL:-http://localhost:3141/api/secret}"
AGENCY_USER="${AGENCY_USER:-principal:jordan}"
SECRETS_DIR="$PROJECT_ROOT/claude/principals/jordan/resources/secrets"
DRY_RUN=false

# Parse args
while [[ $# -gt 0 ]]; do
  case $1 in
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --help|-h)
      echo "Usage: $0 [--dry-run]"
      echo ""
      echo "Migrates existing secrets to the Secret Service vault."
      echo "Originals are preserved in place."
      echo ""
      echo "Options:"
      echo "  --dry-run    Show what would be migrated without doing it"
      exit 0
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      exit 1
      ;;
  esac
done

echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo -e "${CYAN}  Secret Migration Tool${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo ""

if $DRY_RUN; then
  echo -e "${YELLOW}DRY RUN MODE - No changes will be made${NC}"
  echo ""
fi

# Check if service is running
echo -e "${BLUE}Checking Secret Service...${NC}"
if ! curl -s -H "X-Agency-User: $AGENCY_USER" "$SECRET_SERVICE_URL/vault/status" > /dev/null 2>&1; then
  echo -e "${RED}Error: Secret Service not available at $SECRET_SERVICE_URL${NC}"
  echo -e "${YELLOW}Start it with: cd services/agency-service && bun run dev${NC}"
  exit 1
fi
echo -e "${GREEN}✓ Service is running${NC}"
echo ""

# Check vault status - API returns {"status":"uninitialized|locked|unlocked",...}
VAULT_STATUS=$(curl -s -H "X-Agency-User: $AGENCY_USER" "$SECRET_SERVICE_URL/vault/status")
VAULT_STATE=$(echo "$VAULT_STATUS" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)

echo -e "${BLUE}Vault Status: $VAULT_STATE${NC}"
echo ""

# Initialize vault if needed
if [[ "$VAULT_STATE" == "uninitialized" ]]; then
  echo -e "${YELLOW}Vault not initialized. Initializing...${NC}"
  if $DRY_RUN; then
    echo -e "${YELLOW}[DRY RUN] Would initialize vault${NC}"
  else
    echo -n "Enter passphrase for new vault: "
    read -s PASSPHRASE
    echo ""
    echo -n "Confirm passphrase: "
    read -s PASSPHRASE2
    echo ""

    if [[ "$PASSPHRASE" != "$PASSPHRASE2" ]]; then
      echo -e "${RED}Passphrases don't match${NC}"
      exit 1
    fi

    INIT_RESULT=$(curl -s -X POST -H "X-Agency-User: $AGENCY_USER" "$SECRET_SERVICE_URL/vault/init" \
      -H "Content-Type: application/json" \
      -d "{\"passphrase\": \"$PASSPHRASE\"}")

    echo -e "${GREEN}✓ Vault initialized${NC}"
    echo ""
    echo -e "${YELLOW}SAVE THESE RECOVERY CODES:${NC}"
    echo "$INIT_RESULT" | grep -o '"codes":\[[^]]*\]' | sed 's/"codes":\[//' | sed 's/\]//' | tr ',' '\n' | tr -d '"'
    echo ""
  fi
fi

# Unlock vault if needed
if [[ "$VAULT_STATE" == "locked" ]]; then
  echo -e "${YELLOW}Vault is locked. Unlocking...${NC}"
  if $DRY_RUN; then
    echo -e "${YELLOW}[DRY RUN] Would unlock vault${NC}"
  else
    echo -n "Enter vault passphrase: "
    read -s PASSPHRASE
    echo ""

    UNLOCK_RESULT=$(curl -s -X POST -H "X-Agency-User: $AGENCY_USER" "$SECRET_SERVICE_URL/vault/unlock" \
      -H "Content-Type: application/json" \
      -d "{\"passphrase\": \"$PASSPHRASE\"}")

    if echo "$UNLOCK_RESULT" | grep -q '"error"'; then
      echo -e "${RED}Failed to unlock vault${NC}"
      echo "$UNLOCK_RESULT"
      exit 1
    fi

    echo -e "${GREEN}✓ Vault unlocked${NC}"
  fi
fi
echo ""

# Function to create a secret
create_secret() {
  local name="$1"
  local value="$2"
  local type="$3"
  local service="$4"
  local description="$5"

  echo -e "  ${BLUE}Creating:${NC} $name (type: $type, service: $service)"

  if $DRY_RUN; then
    echo -e "    ${YELLOW}[DRY RUN] Would create secret${NC}"
    return
  fi

  # Check if secret already exists
  EXISTING=$(curl -s -H "X-Agency-User: $AGENCY_USER" "$SECRET_SERVICE_URL/list?search=$name" | grep -o "\"name\":\"$name\"" || true)
  if [[ -n "$EXISTING" ]]; then
    echo -e "    ${YELLOW}⚠ Already exists, skipping${NC}"
    return
  fi

  # Escape JSON
  local escaped_value=$(echo -n "$value" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
  local escaped_desc=$(echo -n "$description" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

  RESULT=$(curl -s -X POST "$SECRET_SERVICE_URL/create" \
    -H "Content-Type: application/json" \
    -H "X-Agency-User: $AGENCY_USER" \
    -d "{
      \"name\": \"$name\",
      \"value\": $escaped_value,
      \"secretType\": \"$type\",
      \"serviceName\": \"$service\",
      \"description\": $escaped_desc,
      \"ownerType\": \"principal\",
      \"ownerName\": \"jordan\"
    }")

  if echo "$RESULT" | grep -q '"error"'; then
    echo -e "    ${RED}✗ Failed: $(echo "$RESULT" | grep -o '"message":"[^"]*"')${NC}"
  else
    echo -e "    ${GREEN}✓ Created${NC}"
  fi
}

# Migrate GitHub secrets
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo -e "${CYAN}  Migrating GitHub Secrets${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"

if [[ -f "$SECRETS_DIR/github.env" ]]; then
  source "$SECRETS_DIR/github.env"

  create_secret "github-workshop-token" "$AGENCY_TOKEN_WORKSHOP" "token" "GitHub" \
    "Workshop Beta Token (READ-ONLY) - Expires Jan 12 2026"

  create_secret "github-admin-token" "$AGENCY_TOKEN_ADMIN" "token" "GitHub" \
    "Full Access Token (ADMIN) - No expiry"
else
  echo -e "${YELLOW}  No github.env found${NC}"
fi
echo ""

# Migrate Discord secrets
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo -e "${CYAN}  Migrating Discord Secrets${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"

if [[ -f "$SECRETS_DIR/discord.env" ]]; then
  source "$SECRETS_DIR/discord.env"

  create_secret "discord-client-id" "$DISCORD_CLIENT_ID" "api_key" "Discord" \
    "Discord Application Client ID"

  create_secret "discord-client-secret" "$DISCORD_CLIENT_SECRET" "api_key" "Discord" \
    "Discord Application Client Secret"

  create_secret "discord-bot-token" "$DISCORD_BOT_TOKEN" "token" "Discord" \
    "Discord Bot Token"
else
  echo -e "${YELLOW}  No discord.env found${NC}"
fi
echo ""

# Migrate Gumroad secrets
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo -e "${CYAN}  Migrating Gumroad Secrets${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"

if [[ -f "$SECRETS_DIR/gumroad.env" ]]; then
  source "$SECRETS_DIR/gumroad.env"

  create_secret "gumroad-app-id" "$GUMROAD_APP_ID" "api_key" "Gumroad" \
    "Gumroad Application ID"

  create_secret "gumroad-app-secret" "$GUMROAD_APP_SECRET" "api_key" "Gumroad" \
    "Gumroad Application Secret"

  create_secret "gumroad-access-token" "$GUMROAD_ACCESS_TOKEN" "token" "Gumroad" \
    "Gumroad Access Token"
else
  echo -e "${YELLOW}  No gumroad.env found${NC}"
fi
echo ""

echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  Migration Complete!${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
echo ""
echo -e "${BLUE}Original files preserved in:${NC}"
echo "  $SECRETS_DIR/"
echo ""
echo -e "${BLUE}View migrated secrets:${NC}"
echo "  ./tools/secret list"
echo ""
