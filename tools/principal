#!/bin/bash
# Get current principal name
#
# Usage: ./tools/principal
#
# Returns the principal name for the current system user,
# as configured in claude/config/agency.yaml under principals.
#
# If PRINCIPAL is already set in environment, returns that.
# Otherwise, looks up the current $USER in config.
#
# Why this exists:
#   - Maps system usernames to principal names
#   - Allows multiple people to use same machine with different principals
#   - Configured via claude/config/agency.yaml instead of hardcoding

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "principal" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.1-20260114-000001"

# Defaults
VERBOSE=false

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions (quiet by default)
log_info() { [[ "$VERBOSE" == "true" ]] && echo -e "${GREEN}[INFO]${NC} $1" || true; }
log_warn() { [[ "$VERBOSE" == "true" ]] && echo -e "${YELLOW}[WARN]${NC} $1" || true; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }  # Always show errors
log_step() { [[ "$VERBOSE" == "true" ]] && echo -e "${BLUE}[STEP]${NC} $1" || true; }
verbose_echo() { [[ "$VERBOSE" == "true" ]] && echo "$@" || true; }

# Parse arguments
for arg in "$@"; do
    case $arg in
        --version|-v)
            echo "principal $TOOL_VERSION"
            exit 0
            ;;
        --verbose)
            VERBOSE=true
            ;;
        --help|-h)
            echo "principal - Get current principal name"
            echo ""
            echo "Usage: ./tools/principal"
            echo ""
            echo "Options:"
            echo "  --verbose      Show verbose output"
            echo "  --version, -v  Show tool version"
            echo "  --help, -h     Show this help"
            exit 0
            ;;
    esac
done

main() {
    # Trap unexpected exits
    trap 'log_end "$RUN_ID" "failure" $? 0 "Unexpected exit" 2>/dev/null || true' EXIT

    verbose_echo "principal [run: ${RUN_ID:-none}]"

    REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

    # If already set in environment, use that
    if [ -n "$PRINCIPAL" ]; then
        verbose_echo "Using PRINCIPAL from environment: $PRINCIPAL"
        echo "$PRINCIPAL"
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "Principal from environment"
        exit 0
    fi

    # Otherwise, get from config
    if [ -x "$REPO_ROOT/tools/config" ]; then
        verbose_echo "Looking up principal from config"
        local principal_name
        principal_name=$("$REPO_ROOT/tools/config" get-principal)
        echo "$principal_name"
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "Principal from config"
        exit 0
    else
        log_warn "config tool not found"
        echo "unknown"
        trap - EXIT
        log_end "$RUN_ID" "success" 0 0 "Principal unknown"
        exit 0
    fi
}

main
