#!/bin/bash
# Get current principal name
#
# Usage: ./tools/principal
#
# Returns the principal name for the current system user,
# as configured in claude/config/agency.yaml under principals.
#
# If PRINCIPAL is already set in environment, returns that.
# Otherwise, looks up the current $USER in config.
#
# Why this exists:
#   - Maps system usernames to principal names
#   - Allows multiple people to use same machine with different principals
#   - Configured via claude/config/agency.yaml instead of hardcoding

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "principal" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "principal $TOOL_VERSION"
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

# If already set in environment, use that
if [ -n "$PRINCIPAL" ]; then
    echo "$PRINCIPAL"
    exit 0
fi

# Otherwise, get from config
if [ -x "$REPO_ROOT/tools/config" ]; then
    "$REPO_ROOT/tools/config" get-principal
else
    echo "unknown"
fi
