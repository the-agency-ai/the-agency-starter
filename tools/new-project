#!/bin/bash
#
# new-project - Create a new project from The Agency Starter
#
# Usage:
#   new-project my-app                    # Creates ./my-app
#   new-project ~/code/my-app             # Creates at specific path
#   new-project my-app --no-launch        # Don't launch housekeeping after
#

set -e

# Tool version
TOOL_VERSION="1.0.0-20260109-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "new-project $TOOL_VERSION"
    exit 0
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get the starter directory (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
STARTER_DIR="$(dirname "$SCRIPT_DIR")"

# Parse arguments
PROJECT_PATH=""
NO_LAUNCH=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --no-launch)
            NO_LAUNCH=true
            shift
            ;;
        -h|--help)
            echo "Usage: new-project <project-name-or-path> [options]"
            echo ""
            echo "Options:"
            echo "  --no-launch    Don't launch housekeeping after creation"
            echo "  -h, --help     Show this help"
            echo ""
            echo "Examples:"
            echo "  new-project my-app              # Creates ./my-app"
            echo "  new-project ~/code/my-app       # Creates at ~/code/my-app"
            echo "  new-project my-app --no-launch  # Create without launching"
            exit 0
            ;;
        *)
            if [ -z "$PROJECT_PATH" ]; then
                PROJECT_PATH="$1"
            else
                echo -e "${RED}Unknown argument: $1${NC}"
                exit 1
            fi
            shift
            ;;
    esac
done

# Require project path
if [ -z "$PROJECT_PATH" ]; then
    echo -e "${RED}Error: Project name or path required${NC}"
    echo ""
    echo "Usage: new-project <project-name-or-path>"
    echo ""
    echo "Examples:"
    echo "  new-project my-app"
    echo "  new-project ~/code/my-app"
    exit 1
fi

# Resolve to absolute path
if [[ "$PROJECT_PATH" != /* ]]; then
    PROJECT_PATH="$(pwd)/$PROJECT_PATH"
fi

PROJECT_NAME="$(basename "$PROJECT_PATH")"

# Validate project name
if [[ ! "$PROJECT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo -e "${RED}Invalid project name: $PROJECT_NAME${NC}"
    echo "Use only letters, numbers, hyphens, and underscores."
    exit 1
fi

# Check if directory exists
if [ -d "$PROJECT_PATH" ]; then
    echo -e "${RED}Directory already exists: $PROJECT_PATH${NC}"
    echo "Please choose a different name or remove the existing directory."
    exit 1
fi

# Banner
echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  Creating New Agency Project${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "Project: ${GREEN}$PROJECT_NAME${NC}"
echo -e "Path:    ${GREEN}$PROJECT_PATH${NC}"
echo ""

# Create project directory
mkdir -p "$PROJECT_PATH"

# Copy starter files (excluding git, node_modules, build artifacts, the SDK itself)
echo "Copying starter files..."
rsync -a \
    --exclude='.git' \
    --exclude='node_modules' \
    --exclude='.next' \
    --exclude='target' \
    --exclude='dist' \
    --exclude='*.dmg' \
    --exclude='*.app' \
    --exclude='.DS_Store' \
    "$STARTER_DIR/" "$PROJECT_PATH/"

cd "$PROJECT_PATH"

# Initialize fresh git repo
echo "Initializing git repository..."
git init --quiet
git add -A
git commit -m "Initial commit from The Agency Starter" --quiet

# Make tools executable
chmod +x tools/* 2>/dev/null || true

# Install bun if not present (needed for agency-service)
BUN_PATH="${HOME}/.bun/bin/bun"
if [[ ! -x "$BUN_PATH" ]]; then
    echo "Installing bun (for agency-service)..."
    curl -fsSL https://bun.sh/install | bash
    export PATH="$HOME/.bun/bin:$PATH"
fi

# Install agency-service dependencies
if [[ -d "services/agency-service" ]]; then
    echo "Installing agency-service dependencies..."
    (cd services/agency-service && "$HOME/.bun/bin/bun" install --silent 2>/dev/null) || true
fi

# Configure principal with current user
SYSTEM_USER=$(whoami)
echo "Configuring for user: $SYSTEM_USER"
if [ -f "claude/config/agency.yaml" ]; then
    sed -i.bak "s/your_username: YourName/$SYSTEM_USER: $SYSTEM_USER/" claude/config/agency.yaml 2>/dev/null || \
    sed -i '' "s/your_username: YourName/$SYSTEM_USER: $SYSTEM_USER/" claude/config/agency.yaml
    rm -f claude/config/agency.yaml.bak
fi

# Success
echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}  Project Created!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "Your project is ready at: ${GREEN}$PROJECT_PATH${NC}"
echo ""

if [ "$NO_LAUNCH" = true ]; then
    echo "To get started:"
    echo ""
    echo -e "  ${BLUE}cd $PROJECT_PATH${NC}"
    echo -e "  ${BLUE}./tools/myclaude housekeeping housekeeping${NC}"
    echo ""
    echo "Then type: /welcome"
    echo ""
else
    # Ask if they want to launch now
    echo -e "${BLUE}Ready to meet your first agent?${NC}"
    echo ""

    read -p "Launch housekeeping now? [Y/n] " launch_now 2>/dev/null || launch_now="Y"
    launch_now=${launch_now:-Y}

    if [[ "$launch_now" =~ ^[Yy]$ ]]; then
        echo ""
        echo -e "${BLUE}Launching housekeeping agent...${NC}"
        echo ""
        echo "Once inside, type: /welcome"
        echo ""
        sleep 1

        # Launch myclaude
        exec ./tools/myclaude housekeeping housekeeping
    else
        echo ""
        echo "When you're ready:"
        echo ""
        echo -e "  ${BLUE}cd $PROJECT_PATH${NC}"
        echo -e "  ${BLUE}./tools/myclaude housekeeping housekeeping${NC}"
        echo ""
        echo "Then type: /welcome"
        echo ""
    fi
fi
