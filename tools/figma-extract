#!/bin/bash
# figma-extract - Extract design tokens from Figma via API
#
# Usage:
#   ./tools/figma-extract <file-key> --name=<brand> --version=<version>
#   ./tools/figma-extract abc123xyz --name=acme --version=001
#
# Prerequisites:
#   1. Store Figma token: ./tools/secret create figma-token --type=api_key --service=Figma
#   2. Get file key from Figma URL: figma.com/file/FILE_KEY/...
#
# This tool:
#   1. Fetches file data from Figma API
#   2. Extracts color, typography, and effect styles
#   3. Creates design system in claude/knowledge/design-systems/<name>-<version>/
#   4. Generates Tailwind config

set -e

TOOL_VERSION="1.0.0-20260113-000001"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source log helper for tool tracking
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }

# Start logging
RUN_ID=$(log_start "figma-extract" "agency-tool" "$@" 2>/dev/null) || true

# Help
show_help() {
    echo "figma-extract - Extract design tokens from Figma via API"
    echo ""
    echo "Usage:"
    echo "  ./tools/figma-extract <file-key> --name=<brand> --version=<version>"
    echo ""
    echo "Arguments:"
    echo "  file-key     Figma file key (from URL: figma.com/file/FILE_KEY/...)"
    echo ""
    echo "Options:"
    echo "  --name=<brand>      Brand/project name (e.g., acme)"
    echo "  --version=<version> Version number (e.g., 001)"
    echo "  --dry-run           Show what would be extracted without creating files"
    echo "  --help, -h          Show this help"
    echo "  --version, -v       Show version"
    echo ""
    echo "Prerequisites:"
    echo "  1. Store Figma token:"
    echo "     ./tools/secret create figma-token --type=api_key --service=Figma"
    echo ""
    echo "  2. Get file key from Figma URL:"
    echo "     https://www.figma.com/file/FILE_KEY/Project-Name"
    echo ""
    echo "Examples:"
    echo "  ./tools/figma-extract abc123xyz --name=acme --version=001"
    echo "  ./tools/figma-extract abc123xyz --name=myproject --version=002 --dry-run"
}

# Parse arguments
FILE_KEY=""
BRAND_NAME=""
VERSION=""
DRY_RUN=false

for arg in "$@"; do
    case $arg in
        --help|-h)
            show_help
            exit 0
            ;;
        --version|-v)
            echo "figma-extract $TOOL_VERSION"
            exit 0
            ;;
        --name=*)
            BRAND_NAME="${arg#*=}"
            ;;
        --version=*)
            VERSION="${arg#*=}"
            ;;
        --dry-run)
            DRY_RUN=true
            ;;
        --*)
            log_error "Unknown option: $arg"
            exit 1
            ;;
        *)
            if [[ -z "$FILE_KEY" ]]; then
                FILE_KEY="$arg"
            fi
            ;;
    esac
done

# Validate arguments
if [[ -z "$FILE_KEY" ]]; then
    log_error "Missing required argument: file-key"
    echo ""
    show_help
    exit 1
fi

if [[ -z "$BRAND_NAME" ]]; then
    log_error "Missing required option: --name=<brand>"
    exit 1
fi

if [[ -z "$VERSION" ]]; then
    log_error "Missing required option: --version=<version>"
    exit 1
fi

# Get Figma token from secret service
log_step "Fetching Figma API token..."
FIGMA_TOKEN=$("$PROJECT_ROOT/tools/secret" get figma-token 2>/dev/null) || true

if [[ -z "$FIGMA_TOKEN" ]]; then
    log_error "Figma token not found in Secret Service"
    echo ""
    echo "To set up Figma API access:"
    echo "  1. Go to Figma > Account Settings > Personal Access Tokens"
    echo "  2. Generate a new token"
    echo "  3. Store it: ./tools/secret create figma-token --type=api_key --service=Figma"
    log_end "$RUN_ID" "failure" "1" "0" "No Figma token" 2>/dev/null || true
    exit 1
fi
log_info "Token retrieved from Secret Service"

# Set up output directory
SYSTEM_NAME="${BRAND_NAME}-${VERSION}"
OUTPUT_DIR="$PROJECT_ROOT/claude/knowledge/design-systems/$SYSTEM_NAME"

if [[ -d "$OUTPUT_DIR" && "$DRY_RUN" != "true" ]]; then
    log_error "Design system already exists: $OUTPUT_DIR"
    echo ""
    echo "Options:"
    echo "  1. Use a different version number"
    echo "  2. Delete existing directory: rm -rf $OUTPUT_DIR"
    exit 1
fi

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  Figma Design System Extraction${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo "  File Key:    $FILE_KEY"
echo "  Brand:       $BRAND_NAME"
echo "  Version:     $VERSION"
echo "  Output:      $OUTPUT_DIR"
echo ""

# Fetch file data from Figma API
log_step "Fetching file data from Figma API..."

FIGMA_API="https://api.figma.com/v1"
TEMP_DIR=$(mktemp -d)
FILE_DATA="$TEMP_DIR/file.json"
STYLES_DATA="$TEMP_DIR/styles.json"

# Fetch file metadata and document
curl -s -H "X-Figma-Token: $FIGMA_TOKEN" \
    "$FIGMA_API/files/$FILE_KEY" > "$FILE_DATA"

# Check for API errors
if grep -q '"err"' "$FILE_DATA" 2>/dev/null; then
    ERROR_MSG=$(grep -o '"message":"[^"]*"' "$FILE_DATA" | head -1 | cut -d'"' -f4)
    log_error "Figma API error: $ERROR_MSG"
    rm -rf "$TEMP_DIR"
    log_end "$RUN_ID" "failure" "1" "0" "API error: $ERROR_MSG" 2>/dev/null || true
    exit 1
fi

# Extract file name
FILE_NAME=$(grep -o '"name":"[^"]*"' "$FILE_DATA" | head -1 | cut -d'"' -f4)
log_info "File: $FILE_NAME"

# Fetch styles
curl -s -H "X-Figma-Token: $FIGMA_TOKEN" \
    "$FIGMA_API/files/$FILE_KEY/styles" > "$STYLES_DATA"

log_info "Data fetched successfully"

if [[ "$DRY_RUN" == "true" ]]; then
    echo ""
    log_warn "DRY RUN - Showing what would be extracted"
    echo ""

    # Count styles
    COLOR_COUNT=$(grep -c '"style_type":"FILL"' "$STYLES_DATA" 2>/dev/null) || COLOR_COUNT=0
    TEXT_COUNT=$(grep -c '"style_type":"TEXT"' "$STYLES_DATA" 2>/dev/null) || TEXT_COUNT=0
    EFFECT_COUNT=$(grep -c '"style_type":"EFFECT"' "$STYLES_DATA" 2>/dev/null) || EFFECT_COUNT=0

    echo "Would extract:"
    echo "  - $COLOR_COUNT color styles"
    echo "  - $TEXT_COUNT text styles"
    echo "  - $EFFECT_COUNT effect styles"
    echo ""
    echo "Would create: $OUTPUT_DIR/"

    rm -rf "$TEMP_DIR"
    log_end "$RUN_ID" "success" "0" "0" "Dry run complete" 2>/dev/null || true
    exit 0
fi

# Create output directory
log_step "Creating design system directory..."
mkdir -p "$OUTPUT_DIR/source"

# Copy raw data for reference
cp "$FILE_DATA" "$OUTPUT_DIR/source/figma-file.json"
cp "$STYLES_DATA" "$OUTPUT_DIR/source/figma-styles.json"

# Extract and process colors
log_step "Extracting colors..."
COLORS_MD="$OUTPUT_DIR/colors.md"
COLORS_JSON="$OUTPUT_DIR/source/colors.json"

cat > "$COLORS_MD" << 'EOF'
# Colors

Extracted from Figma design system.

## Color Palette

| Name | Hex | Usage |
|------|-----|-------|
EOF

# Parse color styles from JSON (basic extraction)
# Note: Full parsing would require jq or a proper JSON parser
echo "[]" > "$COLORS_JSON"

# Count color styles (grep -c returns count, || true handles no matches)
COLOR_COUNT=$(grep -c '"style_type":"FILL"' "$STYLES_DATA" 2>/dev/null) || COLOR_COUNT=0
log_info "Found $COLOR_COUNT color styles"

if [[ $COLOR_COUNT -gt 0 ]]; then
    echo "" >> "$COLORS_MD"
    echo "*$COLOR_COUNT color styles found in Figma. See source/figma-styles.json for raw data.*" >> "$COLORS_MD"
    echo "" >> "$COLORS_MD"
    echo "**Note:** Color extraction requires manual mapping from Figma's RGBA format to hex." >> "$COLORS_MD"
    echo "Review source/figma-styles.json and add colors above." >> "$COLORS_MD"
fi

# Extract and process typography
log_step "Extracting typography..."
TYPOGRAPHY_MD="$OUTPUT_DIR/typography.md"

cat > "$TYPOGRAPHY_MD" << 'EOF'
# Typography

Extracted from Figma design system.

## Text Styles

| Style | Font | Size | Weight | Line Height |
|-------|------|------|--------|-------------|
EOF

# Count text styles
TEXT_COUNT=$(grep -c '"style_type":"TEXT"' "$STYLES_DATA" 2>/dev/null) || TEXT_COUNT=0
log_info "Found $TEXT_COUNT text styles"

if [[ $TEXT_COUNT -gt 0 ]]; then
    echo "" >> "$TYPOGRAPHY_MD"
    echo "*$TEXT_COUNT text styles found in Figma. See source/figma-styles.json for raw data.*" >> "$TYPOGRAPHY_MD"
    echo "" >> "$TYPOGRAPHY_MD"
    echo "**Note:** Typography extraction requires manual mapping." >> "$TYPOGRAPHY_MD"
    echo "Review source/figma-styles.json and add text styles above." >> "$TYPOGRAPHY_MD"
fi

# Extract and process effects
log_step "Extracting effects..."
EFFECTS_MD="$OUTPUT_DIR/effects.md"

cat > "$EFFECTS_MD" << 'EOF'
# Effects

Extracted from Figma design system.

## Shadow Styles

| Name | Type | Offset | Blur | Color |
|------|------|--------|------|-------|
EOF

# Count effect styles
EFFECT_COUNT=$(grep -c '"style_type":"EFFECT"' "$STYLES_DATA" 2>/dev/null) || EFFECT_COUNT=0
log_info "Found $EFFECT_COUNT effect styles"

if [[ $EFFECT_COUNT -gt 0 ]]; then
    echo "" >> "$EFFECTS_MD"
    echo "*$EFFECT_COUNT effect styles found in Figma. See source/figma-styles.json for raw data.*" >> "$EFFECTS_MD"
fi

# Create spacing.md (placeholder - spacing must be inferred from components)
log_step "Creating spacing template..."
cat > "$OUTPUT_DIR/spacing.md" << 'EOF'
# Spacing

Inferred from Figma components.

## Spacing Scale

| Token | Value | Usage |
|-------|-------|-------|
| xs | 4px | Tight spacing |
| sm | 8px | Small gaps |
| md | 16px | Default spacing |
| lg | 24px | Section spacing |
| xl | 32px | Large sections |
| 2xl | 48px | Page sections |

**Note:** Review Figma components to identify actual spacing scale.
EOF

# Create assets.md
log_step "Creating assets template..."
cat > "$OUTPUT_DIR/assets.md" << 'EOF'
# Assets

## Logos

| Name | Path | Notes |
|------|------|-------|
| (none extracted) | | |

## Icons

| Name | Path | Notes |
|------|------|-------|
| (none extracted) | | |

**Note:** Use Figma Export feature to download assets, then add them to source/ directory.
EOF

# Create INDEX.md
log_step "Creating INDEX.md..."
TIMESTAMP=$(date '+%Y-%m-%d %H:%M')
cat > "$OUTPUT_DIR/INDEX.md" << EOF
# $BRAND_NAME Design System (v$VERSION)

Extracted from Figma on $TIMESTAMP.

## Quick Reference

| File | Contents | Status |
|------|----------|--------|
| [colors.md](colors.md) | Color palette | Needs mapping |
| [typography.md](typography.md) | Text styles | Needs mapping |
| [spacing.md](spacing.md) | Spacing scale | Template |
| [effects.md](effects.md) | Shadows, borders | Needs mapping |
| [assets.md](assets.md) | Logos, icons | Not extracted |
| [tailwind-config.md](tailwind-config.md) | Tailwind theme | Template |

## Source

- **Figma File:** $FILE_NAME
- **File Key:** $FILE_KEY
- **Extracted:** $TIMESTAMP

## Extraction Summary

| Type | Count |
|------|-------|
| Color Styles | $COLOR_COUNT |
| Text Styles | $TEXT_COUNT |
| Effect Styles | $EFFECT_COUNT |

## Next Steps

1. Review \`source/figma-styles.json\` for raw style data
2. Map colors to \`colors.md\` (convert RGBA to hex)
3. Map typography to \`typography.md\`
4. Update \`tailwind-config.md\` with values
5. Run \`./tools/designsystem-validate $OUTPUT_DIR\` to check completeness
EOF

# Create GAPS.md
log_step "Creating GAPS.md..."
cat > "$OUTPUT_DIR/GAPS.md" << 'EOF'
# Gaps

## Critical Gaps

- [ ] Color values need manual mapping from RGBA to hex
- [ ] Typography values need manual extraction
- [ ] Spacing scale needs inference from components

## Medium Gaps

- [ ] Effect styles need manual mapping
- [ ] Assets not automatically exported

## Low Gaps

- [ ] Component-level styles not extracted

---

## Resolution Instructions

See [GAP-RESOLUTION.md](GAP-RESOLUTION.md) for how to resolve gaps.
EOF

# Create GAP-RESOLUTION.md
cat > "$OUTPUT_DIR/GAP-RESOLUTION.md" << 'EOF'
# Gap Resolution Guide

## Resolving Color Gaps

1. Open `source/figma-styles.json`
2. Find style entries with `"styleType": "FILL"`
3. Look for the `color` object with `r`, `g`, `b`, `a` values (0-1 range)
4. Convert to hex: `#RRGGBB` where each component = value * 255

**Example:**
```json
{ "r": 0.2, "g": 0.4, "b": 0.8 }
```
Converts to: `#3366CC`

## Resolving Typography Gaps

1. Open `source/figma-styles.json`
2. Find style entries with `"styleType": "TEXT"`
3. Extract font family, size, weight, line height

## Exporting Assets

1. Open Figma file in browser
2. Select assets to export
3. Right-click > Export
4. Choose format (SVG for icons, PNG for images)
5. Save to `source/` directory
6. Update `assets.md` with paths
EOF

# Create tailwind-config.md
log_step "Creating Tailwind config template..."
cat > "$OUTPUT_DIR/tailwind-config.md" << 'EOF'
# Tailwind Configuration

## Theme Extension

```typescript
// tailwind.config.ts
import type { Config } from 'tailwindcss'

const config: Config = {
  theme: {
    extend: {
      colors: {
        // Add colors from colors.md
        // primary: '#??????',
        // secondary: '#??????',
      },
      fontFamily: {
        // Add fonts from typography.md
        // sans: ['Font Name', 'sans-serif'],
      },
      fontSize: {
        // Add text sizes from typography.md
        // 'heading-1': ['32px', { lineHeight: '1.2', fontWeight: '700' }],
      },
      spacing: {
        // Add spacing from spacing.md
        // '18': '4.5rem',
      },
      boxShadow: {
        // Add shadows from effects.md
        // 'card': '0 4px 6px rgba(0, 0, 0, 0.1)',
      },
    },
  },
}

export default config
```

**Note:** Update this config with actual values from the extracted data.
EOF

# Clean up
rm -rf "$TEMP_DIR"

echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}  Extraction Complete${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo "Created: $OUTPUT_DIR/"
echo ""
echo "Files:"
ls -la "$OUTPUT_DIR/" | grep -v "^d" | grep -v "^total" | awk '{print "  " $NF}'
echo ""
echo "Next steps:"
echo "  1. Review source/figma-styles.json for raw data"
echo "  2. Map values to colors.md, typography.md, etc."
echo "  3. Update tailwind-config.md"
echo "  4. Validate: ./tools/designsystem-validate $OUTPUT_DIR"
echo ""

log_end "$RUN_ID" "success" "0" "0" "Created $SYSTEM_NAME" 2>/dev/null || true
