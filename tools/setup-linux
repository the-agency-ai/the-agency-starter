#!/bin/bash
#
# Setup recommended CLI tools for The Agency on Linux
#
# Usage: ./tools/setup-linux [--all]
#
# Supports: apt (Debian/Ubuntu), dnf (Fedora), pacman (Arch)
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  The Agency - Linux Setup${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Detect package manager
if command -v apt &> /dev/null; then
    PKG_MGR="apt"
    INSTALL_CMD="sudo apt install -y"
elif command -v dnf &> /dev/null; then
    PKG_MGR="dnf"
    INSTALL_CMD="sudo dnf install -y"
elif command -v pacman &> /dev/null; then
    PKG_MGR="pacman"
    INSTALL_CMD="sudo pacman -S --noconfirm"
else
    echo -e "${RED}No supported package manager found (apt, dnf, pacman).${NC}"
    echo "Install these tools manually:"
    echo "  Essential: jq, gh (GitHub CLI), tree"
    echo "  Enhanced:  yq, fzf, bat, ripgrep"
    exit 1
fi

echo -e "Detected package manager: ${GREEN}$PKG_MGR${NC}"
echo ""

# Package name mapping (some differ by distro)
declare -A PKG_NAMES
case $PKG_MGR in
    apt)
        PKG_NAMES=(
            [jq]="jq"
            [gh]="gh"
            [tree]="tree"
            [yq]="yq"
            [fzf]="fzf"
            [bat]="bat"
            [rg]="ripgrep"
        )
        ;;
    dnf)
        PKG_NAMES=(
            [jq]="jq"
            [gh]="gh"
            [tree]="tree"
            [yq]="yq"
            [fzf]="fzf"
            [bat]="bat"
            [rg]="ripgrep"
        )
        ;;
    pacman)
        PKG_NAMES=(
            [jq]="jq"
            [gh]="github-cli"
            [tree]="tree"
            [yq]="yq"
            [fzf]="fzf"
            [bat]="bat"
            [rg]="ripgrep"
        )
        ;;
esac

install_tool() {
    local tool="$1"
    local desc="$2"
    local pkg="${PKG_NAMES[$tool]}"

    if command -v "$tool" &> /dev/null; then
        echo -e "${GREEN}✓ $tool${NC} - already installed"
    else
        echo -e "${YELLOW}Installing $tool${NC} - $desc"
        $INSTALL_CMD "$pkg"
        echo -e "${GREEN}✓ $tool${NC} - installed"
    fi
}

# Essential tools
echo -e "${BLUE}Essential Tools:${NC}"
echo ""
install_tool "jq" "JSON processor"
install_tool "gh" "GitHub CLI"
install_tool "tree" "Directory visualization"

# Enhanced tools if --all
if [[ "$1" == "--all" ]]; then
    echo ""
    echo -e "${BLUE}Enhanced Tools:${NC}"
    echo ""
    install_tool "yq" "YAML processor"
    install_tool "fzf" "Fuzzy finder"
    install_tool "bat" "Better cat"
    install_tool "rg" "Fast search (ripgrep)"
fi

echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}  Setup Complete!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

if [[ "$1" != "--all" ]]; then
    echo "Run with --all to install enhanced tools:"
    echo -e "  ${BLUE}./tools/setup-linux --all${NC}"
    echo ""
fi
