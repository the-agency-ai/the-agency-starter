#!/bin/bash
# bug-report - Report a bug to the BugBench tracker
#
# Usage:
#   ./tools/bug-report --workstream bench --summary "Build fails on M1"
#   ./tools/bug-report --workstream bench --summary "..." --description "Details..."
#   ./tools/bug-report --workstream bench --summary "..." --reporter "housekeeping" --assignee "housekeeping"
#
# Options:
#   --workstream, -w    Workstream name (required)
#   --summary, -s       Bug summary (required)
#   --description, -d   Detailed description
#   --reporter, -r      Reporter name (auto-detected if not provided)
#   --reporter-type     Reporter type: agent, principal, system (default: agent)
#   --assignee, -a      Assignee name
#   --assignee-type     Assignee type: agent, principal (default: agent)
#   --xref              Cross-reference (e.g., REQUEST-jordan-0010)
#   --help, -h          Show this help

set -euo pipefail

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "bug-report" "agency-tool" "$@" 2>/dev/null) || true

# Tool version
TOOL_VERSION="1.1.0-20260120-000001"

# Find project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Database location
DB_DIR="$PROJECT_ROOT/claude/data"
DB_PATH="$DB_DIR/bugs.db"

# Default values
WORKSTREAM=""
SUMMARY=""
DESCRIPTION=""
REPORTER_NAME=""
REPORTER_TYPE="agent"
ASSIGNEE_NAME=""
ASSIGNEE_TYPE="agent"
XREF=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --workstream|-w)
            WORKSTREAM="$2"
            shift 2
            ;;
        --summary|-s)
            SUMMARY="$2"
            shift 2
            ;;
        --description|-d)
            DESCRIPTION="$2"
            shift 2
            ;;
        --reporter|-r)
            REPORTER_NAME="$2"
            shift 2
            ;;
        --reporter-type)
            REPORTER_TYPE="$2"
            shift 2
            ;;
        --assignee|-a)
            ASSIGNEE_NAME="$2"
            shift 2
            ;;
        --assignee-type)
            ASSIGNEE_TYPE="$2"
            shift 2
            ;;
        --xref)
            XREF="$2"
            shift 2
            ;;
        --version|-v)
            echo "bug-report $TOOL_VERSION"
            exit 0
            ;;
        --help|-h)
            echo "bug-report - Report a bug to the BugBench tracker"
            echo ""
            echo "Usage:"
            echo "  ./tools/bug-report --workstream bench --summary \"Build fails on M1\""
            echo "  ./tools/bug-report -w bench -s \"...\" -d \"Details...\""
            echo ""
            echo "Options:"
            echo "  --workstream, -w    Workstream name (required)"
            echo "  --summary, -s       Bug summary (required)"
            echo "  --description, -d   Detailed description"
            echo "  --reporter, -r      Reporter name (auto-detected if not provided)"
            echo "  --reporter-type     Reporter type: agent, principal, system (default: agent)"
            echo "  --assignee, -a      Assignee name"
            echo "  --assignee-type     Assignee type: agent, principal (default: agent)"
            echo "  --xref              Cross-reference (e.g., REQUEST-jordan-0010)"
            echo "  --help, -h          Show this help"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Validate required fields
if [[ -z "$WORKSTREAM" ]]; then
    echo "Error: --workstream is required"
    exit 1
fi

if [[ -z "$SUMMARY" ]]; then
    echo "Error: --summary is required"
    exit 1
fi

# Auto-detect reporter if not provided
if [[ -z "$REPORTER_NAME" ]]; then
    if [[ -x "$PROJECT_ROOT/tools/whoami" ]]; then
        WHOAMI_OUTPUT=$("$PROJECT_ROOT/tools/whoami" 2>/dev/null || true)
        if [[ -n "$WHOAMI_OUTPUT" ]]; then
            # Parse whoami output - look for agent name
            REPORTER_NAME=$(echo "$WHOAMI_OUTPUT" | grep -E "^Agent:" | sed 's/Agent: *//' || true)
            if [[ -n "$REPORTER_NAME" ]]; then
                REPORTER_TYPE="agent"
            fi
        fi
    fi

    # Fallback to system
    if [[ -z "$REPORTER_NAME" ]]; then
        REPORTER_NAME="system"
        REPORTER_TYPE="system"
    fi
fi

# Ensure data directory exists
mkdir -p "$DB_DIR"

# Initialize database if it doesn't exist
if [[ ! -f "$DB_PATH" ]]; then
    sqlite3 "$DB_PATH" <<'SCHEMA'
CREATE TABLE IF NOT EXISTS bugs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    bug_id TEXT UNIQUE NOT NULL,
    workstream TEXT NOT NULL,
    summary TEXT NOT NULL,
    description TEXT,
    status TEXT DEFAULT 'Open',
    reporter_type TEXT NOT NULL,
    reporter_name TEXT NOT NULL,
    assignee_type TEXT,
    assignee_name TEXT,
    xref_type TEXT,
    xref_id TEXT,
    created_at TEXT DEFAULT (datetime('now')),
    updated_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS bug_attachments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    bug_id TEXT NOT NULL,
    filename TEXT NOT NULL,
    filepath TEXT NOT NULL,
    mime_type TEXT,
    created_at TEXT DEFAULT (datetime('now')),
    FOREIGN KEY (bug_id) REFERENCES bugs(bug_id)
);

CREATE TABLE IF NOT EXISTS bug_sequences (
    workstream TEXT PRIMARY KEY,
    next_id INTEGER DEFAULT 1
);

CREATE INDEX IF NOT EXISTS idx_bugs_workstream ON bugs(workstream);
CREATE INDEX IF NOT EXISTS idx_bugs_status ON bugs(status);
CREATE INDEX IF NOT EXISTS idx_bugs_assignee ON bugs(assignee_name);
SCHEMA
    echo "Initialized bugs database at $DB_PATH"
fi

# Get next bug ID for this workstream
WORKSTREAM_UPPER=$(echo "$WORKSTREAM" | tr '[:lower:]' '[:upper:]')

# Get or create sequence for this workstream
NEXT_ID=$(sqlite3 "$DB_PATH" "SELECT next_id FROM bug_sequences WHERE workstream = '$WORKSTREAM_UPPER';" 2>/dev/null || echo "")

if [[ -z "$NEXT_ID" ]]; then
    NEXT_ID=1
    sqlite3 "$DB_PATH" "INSERT INTO bug_sequences (workstream, next_id) VALUES ('$WORKSTREAM_UPPER', 2);"
else
    sqlite3 "$DB_PATH" "UPDATE bug_sequences SET next_id = next_id + 1 WHERE workstream = '$WORKSTREAM_UPPER';"
fi

# Format bug ID: BENCH-00001
BUG_ID=$(printf "%s-%05d" "$WORKSTREAM_UPPER" "$NEXT_ID")

# Parse xref if provided
XREF_TYPE=""
XREF_ID=""
if [[ -n "$XREF" ]]; then
    if [[ "$XREF" == REQUEST-* ]]; then
        XREF_TYPE="request"
        XREF_ID="$XREF"
    elif [[ "$XREF" =~ ^[A-Z]+-[0-9]+$ ]]; then
        XREF_TYPE="bug"
        XREF_ID="$XREF"
    else
        XREF_TYPE="other"
        XREF_ID="$XREF"
    fi
fi

# Escape single quotes in strings for SQL
SUMMARY_ESC="${SUMMARY//\'/\'\'}"
DESCRIPTION_ESC="${DESCRIPTION//\'/\'\'}"

# Insert bug into database
sqlite3 "$DB_PATH" <<SQL
INSERT INTO bugs (
    bug_id, workstream, summary, description, status,
    reporter_type, reporter_name, assignee_type, assignee_name,
    xref_type, xref_id
) VALUES (
    '$BUG_ID',
    '$WORKSTREAM_UPPER',
    '$SUMMARY_ESC',
    '$DESCRIPTION_ESC',
    'Open',
    '$REPORTER_TYPE',
    '$REPORTER_NAME',
    $([ -n "$ASSIGNEE_NAME" ] && echo "'$ASSIGNEE_TYPE'" || echo "NULL"),
    $([ -n "$ASSIGNEE_NAME" ] && echo "'$ASSIGNEE_NAME'" || echo "NULL"),
    $([ -n "$XREF_TYPE" ] && echo "'$XREF_TYPE'" || echo "NULL"),
    $([ -n "$XREF_ID" ] && echo "'$XREF_ID'" || echo "NULL")
);
SQL

echo "Created bug: $BUG_ID"
echo "  Summary: $SUMMARY"
echo "  Workstream: $WORKSTREAM_UPPER"
echo "  Reporter: $REPORTER_NAME ($REPORTER_TYPE)"
if [[ -n "$ASSIGNEE_NAME" ]]; then
    echo "  Assignee: $ASSIGNEE_NAME ($ASSIGNEE_TYPE)"
fi
if [[ -n "$XREF" ]]; then
    echo "  XRef: $XREF"
fi

# Notify assignee if one was specified
if [[ -n "$ASSIGNEE_NAME" ]]; then
    NOTIFY_TO="${ASSIGNEE_TYPE}:${ASSIGNEE_NAME}"
    NOTIFY_SUBJECT="[$BUG_ID] New bug assigned to you"
    NOTIFY_BODY="You have been assigned a new bug.

Bug ID: $BUG_ID
Summary: $SUMMARY
Reporter: $REPORTER_NAME ($REPORTER_TYPE)
Workstream: $WORKSTREAM_UPPER"

    if [[ -n "$DESCRIPTION" ]]; then
        NOTIFY_BODY="$NOTIFY_BODY

Description:
$DESCRIPTION"
    fi

    NOTIFY_BODY="$NOTIFY_BODY

View in BugBench or run: ./tools/show-bug $BUG_ID"

    if [[ -x "$PROJECT_ROOT/tools/message-send" ]]; then
        "$PROJECT_ROOT/tools/message-send" --to "$NOTIFY_TO" --subject "$NOTIFY_SUBJECT" "$NOTIFY_BODY" >/dev/null 2>&1 && \
            echo "  Notified: $NOTIFY_TO" || \
            echo "  Warning: Failed to notify assignee"
    fi
fi

# Minimal output (tool output standard)
echo ""
echo "bug-report [run: ${RUN_ID:-none}]"
echo "Created: $BUG_ID"
echo "âœ“"

# Log completion
log_end "$RUN_ID" "success" 0 0 "Created bug $BUG_ID: $SUMMARY" 2>/dev/null || true
