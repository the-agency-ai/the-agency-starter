#!/bin/bash
# Launch AgencyBench desktop application
#
# Usage: ./tools/agency-bench [command] [options]
#
# Commands:
#   (none)  - Launch AgencyBench (default)
#   open    - Open AgencyBench (alias for default)
#   dev     - Run in development mode with hot reload
#   build   - Build production app
#   install - Build and install to system
#   status  - Check if AgencyBench is running
#
# Options:
#   --app=NAME  - Open specific app (docbench, bugbench, etc.)
#   --file=PATH - Open specific file in DocBench

set -e

# Source log helper for telemetry
SCRIPT_DIR="${SCRIPT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)}"
if [[ -f "$SCRIPT_DIR/_log-helper" ]]; then
    source "$SCRIPT_DIR/_log-helper"
fi
RUN_ID=$(log_start "agency-bench" "agency-tool" "$@" 2>/dev/null) || true

TOOL_VERSION="1.0.0-20260111-000001"

# Version check
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    echo "agency-bench $TOOL_VERSION"
    exit 0
fi

# Help
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    echo "AgencyBench - Desktop development environment for The Agency"
    echo ""
    echo "Usage: ./tools/agency-bench [command] [options]"
    echo ""
    echo "Commands:"
    echo "  (none)   Launch AgencyBench (default)"
    echo "  open     Open AgencyBench (alias for default)"
    echo "  dev      Run in development mode with hot reload"
    echo "  build    Build production app"
    echo "  install  Build and install to system"
    echo "  status   Check if AgencyBench is running"
    echo ""
    echo "Options:"
    echo "  --app=NAME   Open specific app (docbench, bugbench, knowledge-indexer, messages)"
    echo "  --file=PATH  Open specific file in DocBench"
    echo ""
    echo "Examples:"
    echo "  ./tools/agency-bench                    # Launch AgencyBench"
    echo "  ./tools/agency-bench --app=docbench     # Open DocBench directly"
    echo "  ./tools/agency-bench --file=README.md   # Open file in DocBench"
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
BENCH_DIR="$REPO_ROOT/source/apps/agency-bench"
BUILD_BUNDLE="$BENCH_DIR/src-tauri/target/release/bundle/macos/AgencyBench.app"
INSTALLED_APP="$HOME/.local/share/the-agency/AgencyBench.app"
DATA_DIR="$HOME/.local/share/the-agency"
PENDING_FILE="$DATA_DIR/pending-open.json"

if [ ! -d "$BENCH_DIR" ]; then
    echo "Error: AgencyBench source not found at $BENCH_DIR"
    exit 1
fi

# Parse options
APP_NAME=""
FILE_PATH=""
for arg in "$@"; do
    case $arg in
        --app=*)
            APP_NAME="${arg#*=}"
            shift
            ;;
        --file=*)
            FILE_PATH="${arg#*=}"
            shift
            ;;
    esac
done

install_app() {
    mkdir -p "$DATA_DIR"
    rm -rf "$INSTALLED_APP"
    cp -R "$BUILD_BUNDLE" "$INSTALLED_APP"
}

ensure_built() {
    if [ ! -d "$INSTALLED_APP" ]; then
        echo "AgencyBench not installed. Building now..."
        echo "(This takes a few minutes the first time)"
        echo ""
        cd "$BENCH_DIR"
        npm run tauri:build 2>&1 | grep -E '(Compiling|Building|Finished|Bundling|Error|error)'
        echo ""
        echo "Installing AgencyBench..."
        install_app
    fi
}

write_pending_open() {
    mkdir -p "$DATA_DIR"
    local json="{}"

    if [ -n "$APP_NAME" ]; then
        json=$(echo "$json" | jq --arg app "$APP_NAME" '. + {app: $app}')
    fi

    if [ -n "$FILE_PATH" ]; then
        # Resolve to absolute path
        local abs_path
        if [[ "$FILE_PATH" = /* ]]; then
            abs_path="$FILE_PATH"
        else
            abs_path="$(cd "$(dirname "$FILE_PATH")" && pwd)/$(basename "$FILE_PATH")"
        fi
        json=$(echo "$json" | jq --arg file "$abs_path" '. + {file: $file}')
    fi

    if [ "$json" != "{}" ]; then
        echo "$json" > "$PENDING_FILE"
    fi
}

launch_app() {
    write_pending_open
    echo "Launching AgencyBench..."
    open "$INSTALLED_APP"
}

case "${1:-open}" in
    open|"")
        ensure_built
        launch_app
        ;;
    dev)
        echo "Starting AgencyBench in development mode..."
        cd "$BENCH_DIR"
        npm run tauri:dev
        ;;
    build)
        echo "Building AgencyBench..."
        cd "$BENCH_DIR"
        npm run tauri:build
        echo ""
        echo "Build complete: $BUILD_BUNDLE"
        ;;
    install)
        echo "Building AgencyBench..."
        cd "$BENCH_DIR"
        npm run tauri:build
        echo ""
        echo "Installing AgencyBench..."
        install_app
        echo "Installed: $INSTALLED_APP"
        ;;
    status)
        if pgrep -f "AgencyBench" > /dev/null 2>&1; then
            echo "AgencyBench is running"
            pgrep -f "AgencyBench"
        else
            echo "AgencyBench is not running"
        fi
        if [ -d "$INSTALLED_APP" ]; then
            echo "Installed at: $INSTALLED_APP"
        else
            echo "Not installed"
        fi
        ;;
    *)
        # Check if it's an option without a command
        if [[ "${1:-}" == --* ]]; then
            ensure_built
            launch_app
        else
            echo "Unknown command: $1"
            echo "Run './tools/agency-bench --help' for usage"
            exit 1
        fi
        ;;
esac
