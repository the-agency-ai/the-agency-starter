# REQUEST-jordan-0014: Directory Cleanup + Release Tool

**Requested By:** principal:jordan

**Assigned To:** housekeeping

**Status:** Open

**Priority:** High (blocking other work)

**Created:** 2026-01-10 15:30 SST

**Updated:** 2026-01-10 15:30 SST

## Summary

Clean up the-agency directory structure and create a release tool for the-agency-starter. This establishes clean patterns before building more services.

**Why now:** We're about to build log-service and test-service. Better to clean up the foundation first than propagate messy structure.

## Current State (Messy)

```
the-agency/
  claude/
    config.yaml              # Lone config file, unclear purpose
    claude-desktop/          # Integration buried in claude/
    logs/
      push-log.md            # Project history mixed with service logs
      services/
        agency-service/      # Service logs in wrong place
    ...
  services/
    agency-service/          # Service without its own logs
```

## Target State (Clean)

```
the-agency/
  history/                   # Project-level history (NEW)
    push-log.md              # Git push history
    releases.md              # Release history (created by release tool)
    CHANGELOG.md             # User-facing changelog

  claude/
    config/                  # Configuration directory (REORGANIZED)
      agency.yaml            # Main agency config (renamed)

    integrations/            # External integrations (NEW)
      claude-desktop/        # Claude Desktop MCP integration
        README.md
        agency-server/
        ...

    agents/                  # Unchanged
    principals/              # Unchanged
    data/                    # Runtime data only
    docs/                    # Unchanged
    ...

  services/
    agency-service/
      src/
      tests/
      logs/                  # Service logs WITH the service (MOVED)
        log-*.log

  tools/
    release-starter          # NEW: Release tool for the-agency-starter
```

## Changes Required

### 1. Create `history/` at project root
```bash
mkdir -p history/
mv claude/logs/push-log.md history/
touch history/releases.md
touch history/CHANGELOG.md
```

**Contents:**
- `push-log.md` - Git push history (used by ./tools/sync)
- `releases.md` - Release history (auto-generated by release tool)
- `CHANGELOG.md` - User-facing changelog (manual + auto)

### 2. Create `claude/config/` directory
```bash
mkdir -p claude/config/
mv claude/config.yaml claude/config/agency.yaml
```

Update tools that reference `claude/config.yaml` to use `claude/config/agency.yaml`.

### 3. Create `claude/integrations/` directory
```bash
mkdir -p claude/integrations/
mv claude/claude-desktop claude/integrations/claude-desktop
```

### 4. Move service logs to service directory
```bash
mkdir -p services/agency-service/logs/
mv claude/logs/services/agency-service/* services/agency-service/logs/
rmdir claude/logs/services/agency-service
rmdir claude/logs/services
```

Update `services/agency-service/src/core/config/index.ts` to use new log path.

### 5. Clean up `claude/logs/`
After moves, `claude/logs/` should be empty or removed:
```bash
rm -rf claude/logs/  # If empty
# OR keep for agent session logs if needed
```

### 6. Create `./tools/release-starter`

```bash
#!/bin/bash
# release-starter - Cut a release of the-agency-starter
#
# Usage:
#   ./tools/release-starter [version]
#   ./tools/release-starter 1.0.0
#   ./tools/release-starter patch  # Auto-increment patch
#   ./tools/release-starter minor  # Auto-increment minor

set -e

VERSION="${1:-patch}"
STARTER_DIR="the-agency-starter"

# Functions:
# - get_current_version() - Read from starter's package.json or VERSION file
# - bump_version() - Increment based on patch/minor/major
# - sync_files() - Copy files from the-agency to starter
# - clean_cruft() - Remove logs, data, .DS_Store, etc.
# - verify_build() - Run verification checks
# - commit_and_tag() - Git commit with tag
# - update_history() - Add to history/releases.md
```

**What it copies:**
- `CLAUDE.md`
- `claude/` (cleaned)
- `tools/` (cleaned)
- `services/` (without logs/data)
- Template/example files

**What it excludes:**
- `*.log` files
- `*.db` files
- `.DS_Store`
- `node_modules/`
- `claude/data/*` (except .gitkeep)
- `history/` (project-specific)
- `services/*/logs/`

**Verification checks:**
- [ ] Required files exist (CLAUDE.md, tools/myclaude, etc.)
- [ ] No secrets in committed files
- [ ] No large binary files
- [ ] Directory structure matches expected
- [ ] Tools are executable
- [ ] No broken symlinks

## Implementation Tasks

### Phase 1: Directory Reorganization
- [ ] Create `history/` directory at project root
- [ ] Move `push-log.md` to `history/`
- [ ] Create `history/releases.md` and `history/CHANGELOG.md`
- [ ] Create `claude/config/` directory
- [ ] Move and rename `config.yaml` to `claude/config/agency.yaml`
- [ ] Create `claude/integrations/` directory
- [ ] Move `claude-desktop/` to `claude/integrations/claude-desktop/`
- [ ] Create `services/agency-service/logs/` directory
- [ ] Move service logs to `services/agency-service/logs/`
- [ ] Remove empty `claude/logs/` directory (or repurpose)
- [ ] Update any tools referencing old paths

### Phase 2: Update References
- [ ] Update `services/agency-service/src/core/config/index.ts` (log path)
- [ ] Update `./tools/agency-service` (log path for `logs` command)
- [ ] Update `./tools/sync` (push-log path)
- [ ] Update any other tools referencing moved files
- [ ] Update `.gitignore` if needed

### Phase 3: Release Tool
- [ ] Create `./tools/release-starter` script
- [ ] Implement version management (read/bump/write)
- [ ] Implement file sync (with exclusions)
- [ ] Implement cruft cleaning
- [ ] Implement verification checks
- [ ] Implement git commit and tag
- [ ] Implement history update
- [ ] Test with dry-run mode

### Phase 4: Verification & Documentation
- [ ] Run release-starter in dry-run mode
- [ ] Verify the-agency-starter has correct structure
- [ ] Update CLAUDE.md if directory structure changed
- [ ] Document new structure in relevant docs

## Acceptance Criteria

**Directory Structure:**
- [ ] `history/` exists at project root with push-log.md, releases.md, CHANGELOG.md
- [ ] `claude/config/agency.yaml` exists (old config.yaml removed)
- [ ] `claude/integrations/claude-desktop/` exists (old claude-desktop/ removed)
- [ ] `services/agency-service/logs/` exists and receives logs
- [ ] `claude/logs/` is removed or repurposed
- [ ] All tools work with new paths

**Release Tool:**
- [ ] `./tools/release-starter --help` shows usage
- [ ] `./tools/release-starter --dry-run` shows what would happen
- [ ] `./tools/release-starter 1.0.0` creates tagged release
- [ ] `./tools/release-starter patch` auto-increments version
- [ ] Verification catches missing required files
- [ ] `history/releases.md` is updated on release

**the-agency-starter:**
- [ ] Has clean directory structure (no cruft)
- [ ] All tools are executable
- [ ] `./tools/myclaude housekeeping housekeeping` works
- [ ] No secrets, logs, or data files included

## File Changes Summary

| Old Path | New Path | Action |
|----------|----------|--------|
| `claude/config.yaml` | `claude/config/agency.yaml` | Move + rename |
| `claude/claude-desktop/` | `claude/integrations/claude-desktop/` | Move |
| `claude/logs/push-log.md` | `history/push-log.md` | Move |
| `claude/logs/services/agency-service/` | `services/agency-service/logs/` | Move |
| `claude/logs/` | (removed) | Delete |
| (new) | `history/releases.md` | Create |
| (new) | `history/CHANGELOG.md` | Create |
| (new) | `tools/release-starter` | Create |

## Tools Requiring Updates

| Tool | Change Needed |
|------|---------------|
| `./tools/sync` | Update push-log.md path |
| `./tools/agency-service` | Update log path for `logs` command |
| `services/agency-service/src/core/config/index.ts` | Update logDir default |
| Any tool reading config.yaml | Update path |

## Testing Plan

1. **After directory moves:**
   - Run `./tools/agency-service start` - verify it starts
   - Run `./tools/agency-service logs` - verify logs work
   - Run `./tools/agency-service test` - verify tests pass
   - Run `./tools/sync` - verify push-log updates

2. **After release tool created:**
   - Run `./tools/release-starter --dry-run` - verify output
   - Run `./tools/release-starter 0.1.0` - cut first release
   - In the-agency-starter: run `./tools/myclaude housekeeping housekeeping "hello"`
   - Verify no cruft in starter

## Risks

- **Tool breakage:** Moving files may break tools. Mitigate by updating references immediately.
- **Git history:** Moving files affects git history. Use `git mv` to preserve history where possible.
- **Timing:** Do this before adding more services to avoid more migrations later.

## Dependencies

None - this is foundational cleanup.

## Blockers for Other Work

- REQUEST-jordan-0011 Phase 2 (should wait for clean structure)
- REQUEST-jordan-0012 (log-service needs clear log directory pattern)
- REQUEST-jordan-0013 (test-service needs clean foundation)

---

## Activity Log

### 2026-01-10 15:30 SST - Created
- Request created based on directory cleanup discussion
- Identified: config/, integrations/, history/, service logs reorganization
- Added release-starter tool requirement with verification
- Marked as blocking for other requests
